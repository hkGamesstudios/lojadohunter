<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOJA DO HUNTER - Celulares e Acessórios</title>
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome - Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    
    <!-- Chart.js - Biblioteca de Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Supabase - Biblioteca de Cliente -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- MODO RÁPIDO (SEM ANIMAÇÕES) --- */
        .fast-mode .modal-content,
        .fast-mode .brand-button, 
        .fast-mode .tool-item, 
        .fast-mode .device-card, 
        .fast-mode .modal-btn, 
        .fast-mode .action-button, 
        .fast-mode .employee-meta-card {
            animation: none !important;
            opacity: 1 !important; /* Garante que os itens fiquem visíveis imediatamente */
        }
        
        /* Remove apenas transições de elementos específicos para não quebrar a lógica de página */
        .fast-mode .brand-button:hover,
        .fast-mode .tool-item:hover,
        .fast-mode .modal-btn:hover,
        .fast-mode .action-button:hover,
        .fast-mode #collaborator-profile-pic:hover,
        .fast-mode .ponto-history-photo:hover,
        .fast-mode .data-input {
            transition: none !important;
        }


        /* CSS Reset e Variáveis de Cor */
        :root {
            --primary-color: #FF6B00; /* Laranja vibrante */
            --secondary-color: #333; /* Cinza escuro para textos */
            --background-color: #f4f4f4; /* Cinza claro para o fundo */
            --card-bg-color: #FFFFFF; /* Branco para os cards */
            --text-light: #666;
            --white: #FFFFFF;
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1); /* Curva para animação com "overshoot" */
        }

        /* Classe para desativar cliques durante a navegação */
        body.navigating * {
            pointer-events: none !important;
            cursor: progress !important;
        }

        /* ================================================= */
        /* == ESTILOS DOS TEMAS                           == */
        /* ================================================= */
            --background-color: #f4f4f4; /* Cinza claro para o fundo */
            --card-bg-color: #FFFFFF; /* Branco para os cards */
            --text-light: #666;
            --white: #FFFFFF;
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1); /* Curva para animação com "overshoot" */
        }

        /* ================================================= */
        /* == ESTILOS DOS TEMAS                           == */
        /* ================================================= */

        /* --- TEMA PADRÃO (Nenhuma alteração, já é o base) --- */

        /* --- TEMA HUNTER (LARANJA) --- */
        body.theme-hunter {
            background: linear-gradient(160deg, #612f00 0%, #a15000 30%, #e67e22 100%);
        }
        .theme-hunter header {
            background-color: rgba(161, 80, 0, 0.5);
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        .theme-hunter .modal-content {
            background: rgba(161, 80, 0, 0.8);
        }
        .theme-hunter #collaborator-page, .theme-hunter #gs-page, .theme-hunter #metas-config-page, .theme-hunter #metas-display-page, .theme-hunter #send-device-page, .theme-hunter #brand-devices-page, .theme-hunter #device-detail-page, .theme-hunter #manager-sales-panel-page, .theme-hunter #closing-page, .theme-hunter #correction-page, .theme-hunter #os-form-page, .theme-hunter #request-stock-page, .theme-hunter #recibos-page, .theme-hunter #quiz-page, .theme-hunter #crediario-calculator-page, .theme-hunter #site-calculator-page, .theme-hunter #loja-calculator-page, .theme-hunter #mt-display-page, .theme-hunter #mt-management-page, .theme-hunter #ponto-verification-page, .theme-hunter #holidays-management-page, .theme-hunter #sundays-management-page, .theme-hunter #ponto-history-page, .theme-hunter #day-off-management-page, .theme-hunter #overtime-management-page, .theme-hunter #device-search-overlay, .theme-hunter #avisos-management-page, .theme-hunter #feedback-page, .theme-hunter #debug-page, .theme-hunter #cash-management-page, .theme-hunter #store-cash-management-page, .theme-hunter #stock-requests-page, .theme-hunter #recibos-submissions-page, .theme-hunter #quiz-submissions-page, .theme-hunter #feedback-submissions-page, .theme-hunter #story-creation-page, .theme-hunter #chat-page, .theme-hunter #chat-conversation-page, .theme-hunter #lollipop-page {
            background: transparent;
        }

        /* --- TEMA ROSA --- */
        body.theme-rosa {
            background: linear-gradient(160deg, #6d1a4f 0%, #c83a7d 30%, #ff69b4 100%);
            --primary-color: #ff1493; /* Deep Pink */
        }
        .theme-rosa header {
            background-color: rgba(200, 58, 125, 0.5);
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        .theme-rosa .modal-content {
            background: rgba(109, 26, 79, 0.8);
        }
        .theme-rosa .logo i { color: #ff1493; }
        .theme-rosa .tool-icon-wrapper { background-color: #ff1493; }
        .theme-rosa #collaborator-profile-pic { border-color: #ff1493; }
        .theme-rosa .gs-action-btn i { color: #ff1493; }
        .theme-rosa .mt-item-card { border-left-color: #ff1493; }
        .theme-rosa .ponto-history-details p strong { color: #ff1493; }
        .theme-rosa .kpi-value { color: #ff1493; }
        .theme-rosa .stock-brand-header { color: #ff1493; }
        .theme-rosa .progress-bar { background: #ff1493; }
        .theme-rosa .data-input:focus { border-color: #ff1493; }
        .theme-rosa #collaborator-page, .theme-rosa #gs-page, .theme-rosa #metas-config-page, .theme-rosa #metas-display-page, .theme-rosa #send-device-page, .theme-rosa #brand-devices-page, .theme-rosa #device-detail-page, .theme-rosa #manager-sales-panel-page, .theme-rosa #closing-page, .theme-rosa #correction-page, .theme-rosa #os-form-page, .theme-rosa #request-stock-page, .theme-rosa #recibos-page, .theme-rosa #quiz-page, .theme-rosa #crediario-calculator-page, .theme-rosa #site-calculator-page, .theme-rosa #loja-calculator-page, .theme-rosa #mt-display-page, .theme-rosa #mt-management-page, .theme-rosa #ponto-verification-page, .theme-rosa #holidays-management-page, .theme-rosa #sundays-management-page, .theme-rosa #ponto-history-page, .theme-rosa #day-off-management-page, .theme-rosa #overtime-management-page, .theme-rosa #device-search-overlay, .theme-rosa #avisos-management-page, .theme-rosa #feedback-page, .theme-rosa #debug-page, .theme-rosa #cash-management-page, .theme-rosa #store-cash-management-page {
            background: linear-gradient(160deg, #6d1a4f 0%, #c83a7d 30%, #ff69b4 100%);
        }

        /* --- TEMA BLACK --- */
        body.theme-black {
            background: #000;
            --primary-color: #00BFFF; /* DeepSkyBlue como contraste */
        }
        .theme-black header {
            background-color: rgba(10, 10, 10, 0.7);
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }
        .theme-black .brand-button, .theme-black .tool-item, .theme-black .modal-btn, .theme-black .action-button {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .theme-black .modal-content {
            background: rgba(15, 15, 15, 0.85);
        }
        .theme-black .logo i { color: #00BFFF; }
        .theme-black .tool-icon-wrapper { background-color: #00BFFF; }
        .theme-black #collaborator-profile-pic { border-color: #00BFFF; }
        .theme-black .gs-action-btn i { color: #00BFFF; }
        .theme-black .mt-item-card { border-left-color: #00BFFF; }
        .theme-black .ponto-history-details p strong { color: #00BFFF; }
        .theme-black .kpi-value { color: #00BFFF; }
        .theme-black .stock-brand-header { color: #00BFFF; }
        .theme-black .progress-bar { background: #00BFFF; }
        .theme-black .data-input:focus { border-color: #00BFFF; }
        .theme-black #collaborator-page, .theme-black #gs-page, .theme-black #metas-config-page, .theme-black #metas-display-page, .theme-black #send-device-page, .theme-black #brand-devices-page, .theme-black #device-detail-page, .theme-black #manager-sales-panel-page, .theme-black #closing-page, .theme-black #correction-page, .theme-black #os-form-page, .theme-black #request-stock-page, .theme-black #recibos-page, .theme-black #quiz-page, .theme-black #crediario-calculator-page, .theme-black #site-calculator-page, .theme-black #loja-calculator-page, .theme-black #mt-display-page, .theme-black #mt-management-page, .theme-black #ponto-verification-page, .theme-black #holidays-management-page, .theme-black #sundays-management-page, .theme-black #ponto-history-page, .theme-black #day-off-management-page, .theme-black #overtime-management-page, .theme-black #device-search-overlay, .theme-black #avisos-management-page, .theme-black #feedback-page, .theme-black #debug-page, .theme-black #cash-management-page, .theme-black #store-cash-management-page {
            background: #000;
        }

        /* --- TEMA CLARO --- */
        body.theme-claro {
            background: #eef2f3;
            color: var(--secondary-color);
        }
        .theme-claro #collaborator-page, .theme-claro #gs-page, .theme-claro #metas-config-page, .theme-claro #metas-display-page, .theme-claro #send-device-page, .theme-claro #brand-devices-page, .theme-claro #device-detail-page, .theme-claro #manager-sales-panel-page, .theme-claro #closing-page, .theme-claro #correction-page, .theme-claro #os-form-page, .theme-claro #request-stock-page, .theme-claro #recibos-page, .theme-claro #quiz-page, .theme-claro #crediario-calculator-page, .theme-claro #site-calculator-page, .theme-claro #loja-calculator-page, .theme-claro #mt-display-page, .theme-claro #mt-management-page, .theme-claro #ponto-verification-page, .theme-claro #holidays-management-page, .theme-claro #sundays-management-page, .theme-claro #ponto-history-page, .theme-claro #day-off-management-page, .theme-claro #overtime-management-page, .theme-claro #device-search-overlay, .theme-claro #avisos-management-page, .theme-claro #feedback-page, .theme-claro #debug-page, .theme-claro #cash-management-page, .theme-claro #store-cash-management-page {
            background: #eef2f3;
            color: var(--secondary-color);
        }
        .theme-claro header {
            background-color: rgba(255, 255, 255, 0.7);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        .theme-claro .logo, .theme-claro .header-icons a {
            color: var(--secondary-color);
        }
        .theme-claro .section-title, .theme-claro .rank-name, .theme-claro .collaborator-header h2, .theme-claro .back-button {
            color: #111;
        }
        .theme-claro .section-title::after {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .theme-claro .brand-button, .theme-claro .tool-item, .theme-claro .modal-btn, .theme-claro .action-button, .theme-claro .gs-action-btn {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: var(--secondary-color);
        }
        .theme-claro .tool-item:hover, .theme-claro .brand-button:hover, .theme-claro .modal-btn:hover, .theme-claro .action-button:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .theme-claro .rank-item, .theme-claro .sales-data-card, .theme-claro .kpi-card, .theme-claro .performance-card, .theme-claro .chart-container, .theme-claro .employee-meta-card, .theme-claro .ponto-history-card {
            background: rgba(255, 255, 255, 0.8);
        }
        .theme-claro .progress-percentage, .theme-claro .ponto-history-details p, .theme-claro .mt-item-card pre, .theme-claro .mt-list-item-text {
            color: #333;
            text-shadow: none;
        }
        .theme-claro .modal-content {
            background: rgba(240, 240, 240, 0.9);
            color: var(--secondary-color);
        }
        .theme-claro .modal-close-btn, .theme-claro .modal-title {
            color: var(--secondary-color);
        }
        .theme-claro .data-input {
            background-color: rgba(0,0,0,0.08);
            border-color: rgba(0,0,0,0.2);
            color: var(--secondary-color);
        }
        .theme-claro .input-group label, .theme-claro .kpi-title, .theme-claro .chart-container h4, .theme-claro .meta-group-title, .theme-claro .ponto-history-justification {
            color: #555;
        }
        .theme-claro #metas-display-content p {
            background: rgba(0,0,0,0.05);
        }
        .theme-claro #monthly-sales-list-container p {
            border-bottom-color: rgba(0,0,0,0.1);
        }
        /* Estilo para os toggles de visibilidade */
        .visibility-toggle {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            width: 40px;
            height: 22px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 11px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .visibility-toggle::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease-in-out;
        }
        .visibility-toggle:checked {
            background-color: var(--primary-color);
        }
        .visibility-toggle:checked::before {
            transform: translateX(18px);
        }


        /* --- TEMA LGBT --- */
                body.theme-lgbt {
            background-color: #1a1a1a; /* Cinza bem escuro */
            background-image: url('https://i.redd.it/15vfoi1r0v741.jpg');
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }

        .theme-lgbt header {
            background-color: rgba(0, 0, 0, 0.4);
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }

        .theme-lgbt .modal-content {
            background: rgba(10, 10, 10, 0.5);
        }

        .theme-lgbt #collaborator-page, .theme-lgbt #gs-page, .theme-lgbt #metas-config-page, .theme-lgbt #metas-display-page, .theme-lgbt #send-device-page, .theme-lgbt #brand-devices-page, .theme-lgbt #device-detail-page, .theme-lgbt #manager-sales-panel-page, .theme-lgbt #closing-page, .theme-lgbt #correction-page, .theme-lgbt #os-form-page, .theme-lgbt #request-stock-page, .theme-lgbt #recibos-page, .theme-lgbt #quiz-page, .theme-lgbt #crediario-calculator-page, .theme-lgbt #site-calculator-page, .theme-lgbt #loja-calculator-page, .theme-lgbt #mt-display-page, .theme-lgbt #mt-management-page, .theme-lgbt #ponto-verification-page, .theme-lgbt #holidays-management-page, .theme-lgbt #sundays-management-page, .theme-lgbt #ponto-history-page, .theme-lgbt #day-off-management-page, .theme-lgbt #overtime-management-page, .theme-lgbt #device-search-overlay, .theme-lgbt #avisos-management-page, .theme-lgbt #feedback-page, .theme-lgbt #debug-page, .theme-lgbt #cash-management-page, .theme-lgbt #store-cash-management-page {
            background: transparent;
        }

/* --- TEMA NATALINO (PADRÃO FORÇADO) --- */
    body.theme-natal {
        background: linear-gradient(160deg, #000000 0%, #3a0000 40%, #8b0000 100%);
    }
    
    .theme-natal header {
        background-color: rgba(40, 0, 0, 0.7);
        border-bottom: 1px solid rgba(255, 50, 50, 0.2);
    }
    
    .theme-natal .modal-content {
    background: rgba(30, 0, 0, 0.85);
    border: 1px solid rgba(255, 0, 0, 0.3);
}

.theme-natal .story-circle-wrapper.has-story {
    background: linear-gradient(45deg, #ff0000, #2ecc71);
}

.theme-natal .story-circle-wrapper img {
    border-color: #3a0000;
    background-color: #3a0000;
}

    /* Esconde o botão de trocar tema */
    #theme-toggle {
        display: none !important;
    }

    /* Efeito de Neve */
    #snow-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
    }

    .snowflake {
        position: absolute;
        top: -2vh;
        color: #fff;
        font-size: 1em;
        font-family: Arial, sans-serif;
        text-shadow: 0 0 5px #000;
        opacity: 0.8;
        animation: snowfall linear infinite;
        will-change: transform;
    }

    @keyframes snowfall {
        0% { transform: translateY(0) rotate(0deg); }
        100% { transform: translateY(110vh) rotate(360deg); }
    }

    /* Animação do Papai Noel */
    @keyframes flySanta {
        from { left: -300px; }
        to { left: 110vw; }
    }

    #santa-animation {
        position: fixed;
        top: 10%;
        width: 250px;
        z-index: 9999;
        pointer-events: none;
        display: none; 
    }

    /* --- TEMA CINZA X --- */
    @keyframes floatUp {
        from { transform: translateY(0) rotate(var(--start-rot)); }
        to { transform: translateY(-120vh) rotate(var(--end-rot)); }
    }

    body.theme-grayx {
        background: linear-gradient(160deg, #111 0%, #4a4a4a 60%, #f0f0f0 100%);
    }

    #floating-x-container, #floating-dots-container, #snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 0; /* Abaixo do conteúdo principal, mas acima do fundo do body */
            pointer-events: none;
        }
        .floating-x {
            position: absolute;
            top: 110vh; /* Começa fora da tela, embaixo */
            color: rgba(255, 255, 255, 0.06);
            font-weight: 900;
            animation: floatUp linear infinite;
            will-change: transform; /* Otimização para animação */
        }
        
        /* Nova animação apenas para flutuação vertical */
        @keyframes dotFloatUp {
            from { transform: translateY(0); }
            to { transform: translateY(-120vh); }
        }

        /* Novas partículas para o Tema Rosa */
        .floating-dot {
            position: absolute;
            top: 110vh;
            background-color: rgba(255, 255, 255, 0.7); /* CORRIGIDO: Mais visível */
            border-radius: 50%;
            animation: dotFloatUp linear infinite; /* CORRIGIDO: Usando a animação correta */
            will-change: transform;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5); /* Adiciona um brilho suave */
        }

        .theme-grayx header, .theme-grayx main, .theme-rosa header, .theme-rosa main, .theme-hunter header, .theme-hunter main {
            position: relative; /* Garante que fiquem sobre a animação */
            z-index: 1;
        }
        .theme-grayx #collaborator-page, .theme-grayx #gs-page, .theme-grayx #metas-config-page, .theme-grayx #metas-display-page, .theme-grayx #send-device-page, .theme-grayx #brand-devices-page, .theme-grayx #device-detail-page, .theme-grayx #manager-sales-panel-page, .theme-grayx #closing-page, .theme-grayx #correction-page, .theme-grayx #os-form-page, .theme-grayx #request-stock-page, .theme-grayx #recibos-page, .theme-grayx #quiz-page, .theme-grayx #crediario-calculator-page, .theme-grayx #site-calculator-page, .theme-grayx #loja-calculator-page, .theme-grayx #mt-display-page, .theme-grayx #mt-management-page, .theme-grayx #ponto-verification-page, .theme-grayx #holidays-management-page, .theme-grayx #sundays-management-page, .theme-grayx #ponto-history-page, .theme-grayx #day-off-management-page, .theme-grayx #overtime-management-page, .theme-grayx #device-search-overlay, .theme-grayx #avisos-management-page, .theme-grayx #feedback-page, .theme-grayx #debug-page, .theme-grayx #cash-management-page, .theme-grayx #store-cash-management-page {
            background: transparent;
        }
        .theme-grayx header {
            background-color: rgba(10, 10, 10, 0.5);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        

        /* --- ANIMAÇÕES E CONTROLE DE VISIBILIDADE --- */
        @keyframes pageEnter {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pageExit {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.98);
            }
        }

        @keyframes modalContentEnter {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes staggerItem {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page, .modal-overlay {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        .page.visible, .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
            animation: pageEnter 0.4s ease-out forwards;
        }
        
        .page.is-exiting, .modal-overlay.is-exiting {
            pointer-events: none;
            animation: pageExit 0.4s ease-in forwards;
        }

        /* Animações específicas para o modal */
        .modal-overlay.visible:not(.is-exiting) {
            animation: none; /* O overlay em si só faz fade */
            transition: background-color 0.4s, backdrop-filter 0.4s;
        }
        .modal-overlay.visible .modal-content {
            animation: modalContentEnter 0.4s var(--ease-out-back) forwards;
        }

        
        /* Preparação para animações de lista escalonada (stagger) */
        .brand-button, .tool-item, .device-card, .modal-btn, .action-button, .employee-meta-card {
            opacity: 0; /* Começam invisíveis */
        }
        .visible .brand-button, .visible .tool-item, .visible .device-card, .visible .modal-btn, .visible .action-button, .visible .employee-meta-card {
            animation: staggerItem 0.5s var(--ease-out-back) forwards;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(160deg, #372b62 0%, #453880 30%, #2980b9 100%);
            color: var(--white);
            min-height: 100vh;
            overflow-x: hidden; /* Impede a rolagem horizontal */
        }

        /* --- Estrutura Principal (Simula o Celular no PC) --- */
        .mobile-container {
            max-width: 450px;
            width: 100%; 
            margin: 0 auto;
            background-color: transparent;
            display: flex; /* Adicionado */
            flex-direction: column; /* Adicionado */
            align-items: center; /* Adicionado */
        }

        /* Garante que o main e o header ocupem a largura correta */
        .mobile-container > header,
        .mobile-container > main {
            width: 100%;
        }
        
        /* --- Cabeçalho --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1rem 1rem 1rem; /* Diminui o padding lateral */
            background-color: transparent; /* Cabeçalho transparente */
            border-bottom: none;
            position: sticky;
            top: 0;
            z-index: 1000;
            /* Efeito de vidro para o cabeçalho ao rolar a página */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: rgba(55, 43, 98, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white); /* Logo branco */
        }

        .logo i {
            margin-right: 8px;
            color: var(--primary-color); /* Ícone da logo laranja */
        }

        .header-icons a {
            display: inline-block; /* Garante que o padding seja aplicado corretamente */
            padding: 0.5rem; /* Aumenta a área de clique/toque ao redor do ícone */
            font-size: 1.2rem;
            color: var(--white); /* Ícones do cabeçalho brancos */
            margin-left: 0.5rem; /* Margem ajustada para compensar o novo padding */
            text-decoration: none;
        }
        
        .header-profile-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 0.75rem;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.5);
            vertical-align: middle; /* Alinha com os outros ícones */
        }
        
        /* --- Seções --- */
        section {
            padding: 2rem 1rem; /* Diminui o padding lateral para dar mais espaço */
        }
        
        /* --- Estilos do Carrossel de Destaques --- */
        #promo-carousel-container {
            width: 100%;
            max-width: 420px;
            margin: 1.5rem auto 0 auto;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        #promo-carousel-slides {
            position: relative;
            width: 100%;
            height: 140px; /* Altura aumentada */
        }

        .promo-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Ocupa toda a altura do container */
            background: linear-gradient(135deg, #453880, #2980b9); /* Cor Padrão Ajustada */
            display: flex;
            align-items: center;
            padding: 1rem;
            gap: 1rem;
            color: white;
            opacity: 0; /* Começa invisível */
            pointer-events: none; /* Não pode ser clicado quando invisível */
            transition: opacity 0.8s ease-in-out; /* Transição de desvanecer */
        }

        .promo-slide-icon {
            font-size: 2.5rem;
            transform: rotate(-15deg);
            opacity: 0.8;
        }

        .promo-slide-content h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 0.25rem 0;
        }

        .promo-slide-content p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Cores do Carrossel por Tema */
    .theme-natal .promo-slide {
        background: linear-gradient(135deg, #8b0000, #1a0000);
        border: 1px solid rgba(255, 50, 50, 0.2);
    }
    .theme-hunter .promo-slide {
        background: linear-gradient(135deg, #e67e22, #a15000);
    }
        .theme-rosa .promo-slide {
            background: linear-gradient(135deg, #ff69b4, #c83a7d);
        }
        .theme-black .promo-slide {
            background: linear-gradient(135deg, #00BFFF, #111);
        }
        .theme-lgbt .promo-slide {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(5px);
        }
        .theme-grayx .promo-slide {
            background: linear-gradient(135deg, #4a4a4a, #111);
        }
        .theme-claro .promo-slide {
            background: #ffffff;
            color: var(--secondary-color);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .theme-claro .promo-slide-icon, .theme-claro .promo-slide-content h3 {
            color: var(--primary-color);
        }
        .theme-claro .promo-slide-content p {
            color: var(--text-light);
            opacity: 1;
        }
        
        .section-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--white);
            text-transform: uppercase;
            margin-bottom: 2rem;
            position: relative;
            padding-bottom: 0.75rem;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 2px;
        }

        .search-icon-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        /* --- Grade de Marcas (Aparelhos) --- */
        .brand-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 quadrados por linha */
            gap: 0.75rem; /* Espaçamento entre os quadrados */
            margin: 0 auto; /* Garante a centralização */
        }

        .brand-button {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Garante que o item seja sempre um quadrado */
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
            /* Efeito de Vidro Otimizado (sem backdrop-filter) */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            transition: background 0.3s ease;
        }

        .brand-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* --- Grade de Ferramentas --- */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 0 auto; /* Garante a centralização */
        }

        .tool-item {
            display: flex;
            align-items: center;
            /* Efeito de Vidro Otimizado (sem backdrop-filter) */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 0.75rem;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .tool-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tool-icon-wrapper {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            background-color: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            /* Sombra otimizada */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tool-item i {
            font-size: 1.6rem;
            color: var(--white);
        }

        .tool-item span {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--white);
            line-height: 1.3;
        }
        
        /* --- Estilos da Seção de Ranking --- */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Espaçamento entre os itens reduzido */
        }

        .rank-item {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* Padding reduzido */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px; /* Bordas um pouco menores */
            border-left: 4px solid transparent; /* Borda lateral mais fina */
            gap: 0.75rem; /* Espaçamento entre medalha e detalhes reduzido */
        }

        .rank-item.rank-1 { border-left-color: #FFD700; /* Ouro */ }
        .rank-item.rank-2 { border-left-color: #C0C0C0; /* Prata */ }
        .rank-item.rank-3 { border-left-color: #CD7F32; /* Bronze */ }

        .rank-medal {
            font-size: 1.5rem; /* Medalha menor */
            width: 30px; /* Largura da medalha reduzida */
            text-align: center;
            flex-shrink: 0;
        }

        .rank-photo-container {
            position: relative;
            flex-shrink: 0;
            width: 40px; /* Garante que o container não ocupe mais espaço que a foto */
            height: 40px;
        }

        .rank-crown {
            position: absolute;
            top: -10px; /* Posição acima da foto */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            color: #FFD700; /* Cor de ouro */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .rank-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .rank-1 .rank-medal { color: #FFD700; }
        .rank-2 .rank-medal { color: #C0C0C0; }
        .rank-3 .rank-medal { color: #CD7F32; }

        .rank-details {
            flex-grow: 1;
        }

        .rank-name {
            font-weight: 700;
            font-size: 1rem; /* Fonte do nome reduzida */
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .rank-prize {
            font-size: 0.8rem; /* Fonte do prêmio reduzida */
            font-weight: 600;
            color: #4CAF50; /* Verde para o prêmio */
        }

        .progress-bar-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            height: 14px; /* Altura da barra reduzida */
            margin-top: 0.4rem; /* VOLTOU AO VALOR ORIGINAL */
            overflow: visible;  /* MANTIDO: Permite que o ícone vaze para fora */
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Inicia com 0, o JS vai definir a largura */
            background: var(--primary-color);
            border-radius: 6px;
            transition: width 0.8s var(--ease-out-back);
        }

        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem; /* Fonte da porcentagem reduzida */
            font-weight: 700;
            color: var(--white);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        /* Estilo específico para o ranking de lojas */
        .store-rank-item {
            padding: 0.6rem 0.75rem; /* Deixa o card da loja mais baixo */
        }
        .store-rank-item .rank-name {
            font-size: 1.1rem; /* Nome da loja menor */
            justify-content: center; /* Centraliza o nome da loja */
        }
        
        /* Estilos para o Card de Aviso na tela principal */
        .aviso-card {
            display: flex;
            gap: 1rem;
            align-items: flex-start; /* Alinha no topo */
            background: rgba(0, 0, 0, 0.25);
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid #3498db; /* Azul para destaque */
        }
        .aviso-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .aviso-content .aviso-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        .aviso-content .aviso-text {
            font-size: 0.9rem;
            color: #f0f0f0;
            white-space: pre-wrap; /* Mantém quebras de linha */
            word-wrap: break-word;
        }


                /* --- Estilos da Janela Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; /* Inicia escondido */
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: rgba(55, 43, 98, 0.8); /* Fundo da modal um pouco mais escuro */
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            line-height: 1;
            cursor: pointer;
        }

        .modal-title {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--white);
        }

        .modal-button-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .modal-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* --- Rodapé (REMOVIDO) --- */

        /* =================================================================== */
        /* OBSERVAÇÃO IMPORTANTE: PROBLEMA DE ROLAGEM EM NOVAS PÁGINAS */
        /* Se uma nova tela (como uma nova calculadora) apresentar uma rolagem */
        /* desnecessária ou um layout quebrado, o problema provavelmente é que */
        /* o seu ID não foi adicionado a esta lista abaixo. Esta regra define */
        /* o comportamento base de todas as páginas sobrepostas. */
        /* =================================================================== */
        /* --- Tela do Colaborador (e outras páginas internas) --- */
        #collaborator-page, #metas-config-page, #gs-page, #metas-display-page, #send-device-page, #brand-devices-page, #device-detail-page, #manager-sales-panel-page, #closing-page, #correction-page, #os-form-page, #request-stock-page, #recibos-page, #quiz-page, #crediario-calculator-page, #site-calculator-page, #loja-calculator-page, #mt-display-page, #mt-management-page, #ponto-verification-page, #holidays-management-page, #sundays-management-page, #ponto-history-page, #day-off-management-page, #overtime-management-page, #device-search-overlay, #avisos-management-page, #feedback-page, #debug-page, #stock-requests-page, #recibos-submissions-page, #quiz-submissions-page, #feedback-submissions-page, #cash-management-page, #store-cash-management-page, #story-creation-page, #chat-page, #chat-conversation-page, #lollipop-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(160deg, #372b62 0%, #453880 30%, #2980b9 100%);
            z-index: 3000;
            display: none; /* Inicia escondida */
            flex-direction: column;
            justify-content: flex-start; /* Garante que o conteúdo comece no topo */
            overflow-y: auto; /* Permite que a PÁGINA INTEIRA role */
        }

                /* ================================================= */
        /* == ESTILOS PARA A SEÇÃO MT (MOSTRUÁRIO)        == */
        /* ================================================= */
        .mt-item-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
        }
        .mt-item-card pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            color: var(--white);
        }
        .mt-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.25);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        .mt-list-item-text {
            flex-grow: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        .mt-list-item .delete-button-small {
            flex-shrink: 0;
            margin-left: 1rem;
            background-color: rgba(231, 76, 60, 0.7);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .mt-list-item .delete-button-small:hover {
             background-color: rgba(192, 57, 43, 1.0);
        }

        .collaborator-header {
            display: flex; /* Ativa o Flexbox */
            align-items: center; /* Alinha verticalmente os itens no centro */
            justify-content: center; /* Centraliza o título horizontalmente */
            padding: 1.5rem 1rem; /* Aumenta o padding vertical para dar mais espaço */
            text-align: center;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 60px; /* Garante uma altura mínima */
        }

                /* ================================================= */
        /* == ESTILOS PARA A CALCULADORA DE LOJA          == */
        /* ================================================= */
        #loja-calculator-page {
             background: #2c2640; /* Fundo roxo escuro */
        }
        #loja-calculator-page .collaborator-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            width: 100%;
        }
        #loja-form-container {
            width: 100%;
            max-width: 350px;
            padding: 1.5rem;
            background: rgba(25, 20, 35, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(142, 68, 173, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #loja-calculator-page .data-input {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(142, 68, 173, 0.4);
            color: #E0E0E0;
        }
        #loja-calculator-page .data-input:focus {
            border-color: #8e44ad; /* Roxo */
        }
        #loja-calculator-page .slider-group label {
            color: #8e44ad;
            font-weight: 700;
        }
        #loja-calculator-page .slider-input {
            -webkit-appearance: none;
            width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 5px; outline: none; margin-top: 0.5rem;
        }
        #loja-calculator-page .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #8e44ad; cursor: pointer; border-radius: 50%; border: 3px solid #2c2640;
        }
        #loja-result-container {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; border-top: 2px solid #8e44ad;
        }
        #loja-result-container h4 {
            text-align: center; margin-bottom: 1rem; color: #FFFFFF;
        }
        #loja-calculator-page .action-button {
            background-color: rgba(142, 68, 173, 0.7);
        }
        #loja-calculator-page .action-button:hover {
            background-color: rgba(142, 68, 173, 1);
        }
        
        #collaborator-name-display,
        .collaborator-header h2 { /* Aplica a regra a todos os títulos de cabeçalho */
            font-size: 1.3rem; /* Levemente menor para caber melhor */
            font-weight: 700;
            color: var(--white);
            /* Adiciona padding para não ficar sob o botão de voltar */
            padding: 0 50px; 
            flex-grow: 1; /* Permite que o título ocupe o espaço central */
        }

        .back-button {
            position: absolute; /* Mantém a posição absoluta para ficar à esquerda */
            left: 1rem; /* Alinha à esquerda com padding */
            top: 50%; /* Centraliza verticalmente em relação ao header */
            transform: translateY(-50%); /* Ajuste fino do alinhamento vertical */
            background: none;
            border: none;
            color: var(--white);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem; /* Adiciona uma área de clique maior */
            z-index: 10; /* Garante que fique acima de outros elementos se necessário */
        }

        .back-button i {
            margin-right: 0.5rem;
        }

        #collaborator-profile-pic-container {
            position: relative; /* Necessário para posicionar o ícone da nuvem */
            display: flex;
            justify-content: center;
            padding: 1rem 0;
            margin-bottom: 1rem; /* Adiciona espaço abaixo da foto */
        }

        /* Ícone para adicionar/editar status do colaborador */
        #edit-status-cloud {
            position: absolute;
            top: 10px;
            right: calc(50% - 80px); /* Posiciona à direita da foto */
            background-color: rgba(255, 255, 255, 0.9);
            color: #2980b9;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        #edit-status-cloud:hover {
            transform: scale(1.1);
            background-color: #fff;
        }

        /* Container para a bolha de status no perfil */
        #collaborator-status-display-container {
            width: 100%;
            text-align: center;
            padding: 0 1.5rem 1rem 1.5rem; /* Espaçamento abaixo */
            min-height: 20px; /* Garante espaço mesmo quando vazio */
        }
        
                /* Estilo da bolha de status no perfil (maior) - Agora como container */
        .profile-status-bubble {
            display: inline-flex; /* Usa flex para alinhar itens lado a lado */
            align-items: center; /* Centraliza verticalmente a foto e o texto */
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px; /* Ajuste no padding */
            border-radius: 25px; /* Deixa mais arredondado (formato de pílula) */
            color: #e0e0e0;
            max-width: 90%; /* Limita a largura máxima na tela */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Novo estilo para a foto de perfil dentro do balão */
        .status-bubble-photo {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px; /* Espaço entre a foto e o texto */
            flex-shrink: 0; /* Impede que a foto seja espremida */
        }

        /* Novo estilo para o texto dentro do balão */
        .status-bubble-text {
            font-size: 0.8rem; /* Texto menor, conforme solicitado */
            font-style: italic;
            font-weight: 400;
            white-space: nowrap; /* Impede que o texto quebre em várias linhas */
            overflow: hidden; /* Esconde o texto que não couber */
            text-overflow: ellipsis; /* Adiciona "..." ao final do texto cortado */
        }

        /* Bolha de status para a seção de ranking */
        .status-bubble {
            background-color: rgba(0, 0, 0, 0.4);
            color: #e0e0e0;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem; /* Espaço do nome/prêmio */
            display: inline-block;
            max-width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        /* NOVO ESTILO PARA A FOTO DE PERFIL COM BORDA GRADIENTE */
        #collaborator-profile-pic {
            width: 130px; /* Um pouco maior */
            height: 130px;
            border-radius: 50%;
            object-fit: cover;
            padding: 5px; /* Espaçamento para o gradiente aparecer */
            background: linear-gradient(45deg, var(--primary-color), #8e44ad); /* Gradiente na borda */
            cursor: pointer;
            transition: transform 0.3s var(--ease-out-back), box-shadow 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        #collaborator-profile-pic:hover {
            transform: scale(1.05) translateY(-5px); /* Efeito de elevação */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .collaborator-content {
            flex-grow: 1; 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 0 1.5rem 1.5rem 1.5rem; /* Ajuste no padding superior */
            width: 100%; 
            gap: 1rem; /* Adiciona espaçamento entre os elementos filhos */
        }
        
        /* NOVO: Container para os cards de informação */
        #individual-sales-data, #ponto-notification-area {
             width: 100%; 
             max-width: 380px;
        }

        /* NOVO ESTILO PARA OS CARDS DE DADOS E NOTIFICAÇÃO */
        .sales-data-card, .os-warning {
             background: rgba(0, 0, 0, 0.2) !important;
             border: 1px solid rgba(255, 255, 255, 0.1) !important;
             border-left: 3px solid var(--primary-color) !important;
             border-radius: 12px !important;
             padding: 1rem !important;
        }
        .os-warning { /* Específico para avisos */
             border-left-color: #f1c40f !important;
             color: #f1c40f !important;
        }

        /* CORREÇÃO: CONTAINER PARA A GRADE DE BOTÕES */
        .collaborator-actions-grid {
            display: grid;
            /* Começa com 2 colunas e pode ir para 3 se a tela for larga o suficiente */
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 1rem;
            width: 100%;
            max-width: 380px;
            margin-top: 1rem;
        }

        /* CORREÇÃO: ESTILO GERAL DOS BOTÕES */
        .action-button {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: 100%;
            /* max-width não é mais necessário aqui, a grade controla isso */
            padding: 1rem 0.5rem; /* Ajuste no padding lateral para caber mais texto */
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.08); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
            backdrop-filter: blur(2px);
            aspect-ratio: 1 / 1; /* Força os botões a serem quadrados, garantindo alinhamento perfeito */
        }

        .action-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px); 
        }

        /* CORREÇÃO: ESTILO DOS ÍCONES */
        .action-button i {
            font-size: 2.2rem; /* Um pouco maior */
            margin: 0 0 0.5rem 0; /* Remove margem lateral, ajusta inferior */
            color: var(--primary-color);
            line-height: 1; /* Garante que o ícone não adicione altura extra */
        }

        /* CORREÇÃO: ESTILO DO TEXTO DENTRO DO BOTÃO */
        .action-button span {
            line-height: 1.2; /* Melhora a legibilidade em duas linhas */
        }

                /* --- Estilos da Página de Gerência --- */
        .input-group {
            width: 100%;
            max-width: 350px;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .data-input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--white);
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            outline: none;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .data-input:focus {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }

        .status-message {
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
            min-height: 24px;
        }

                /* --- Estilos da Página de Metas --- */
        .employee-meta-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            margin-bottom: 1.5rem;
            max-width: 380px; /* Adicionado para limitar a largura dos cards de formulário */
        }

        .employee-meta-card h4 {
            font-size: 1.2rem;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-transform: uppercase;
        }

        .meta-group-title {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 0.25rem;
        }

        #metas-content-container {
            /* Esta regra não é mais necessária, pode ser removida ou deixada em branco */
        }
        
        .save-footer {
            /* Removemos o posicionamento absoluto para que o footer flua com o conteúdo */
            width: 100%;
            padding: 2rem 1.5rem; /* Aumentamos o padding para dar mais espaço */
            text-align: center;
            background: transparent; /* O fundo agora é o padrão da página */
        }

                /* --- ESTILOS PARA CONQUISTAS (BADGES) --- */
        .achievements-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }
        .achievement-badge {
            width: 60px;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #FFD700; /* Ouro */
            cursor: help;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .achievement-badge.locked {
            color: rgba(255, 255, 255, 0.3);
            filter: grayscale(1);
        }
        .achievement-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .achievement-badge .tooltip {
            visibility: hidden;
            width: 160px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            pointer-events: none;
        }
        .achievement-badge .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .achievement-badge .tooltip.visible {
            visibility: visible;
            opacity: 1;
        }

        .achievement-badge:hover .tooltip {
            /* Regra de hover removida para priorizar o clique */
        }

        /* Este estilo será mantido, mas o rodapé do estoque não o usará mais */
        .save-footer {
            display: none; 
        }

        /* Adicionamos um estilo para os botões de ação que devem ocupar a largura total do container */
        .action-button.full-width {
            aspect-ratio: auto; /* Remove a proporção quadrada */
            height: auto;       /* Deixa a altura ser automática */
            padding: 1rem;      /* Um padding vertical confortável */
            margin-top: 1rem;   /* Espaço acima do botão */
        }

        /* Estilos da tela de visualização de metas */
        #metas-display-content {
            padding: 1.5rem;
            font-size: 1rem;
            width: 100%;
        }
        #metas-display-content h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            width: 100%;
            text-align: center;
        }
        #metas-display-content p {
            margin-bottom: 0.75rem;
            background: rgba(255,255,255,0.1);
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
        }

                .prize-container {
            display: flex;
            align-items: center;
        }
        .daily-bonus-value {
            font-weight: 700;
            color: #2ecc71; /* Verde esmeralda */
            font-size: 0.85rem; /* Tamanho da fonte ajustado */
            margin-left: 0.5rem; /* Espaçamento para o lado */
        }
        .bonus-info-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px; /* Um pouco maior para melhor toque */
            height: 20px;
            font-size: 0.9rem; /* Tamanho da fonte do '?' */
            font-weight: 700;
            color: #333;
            background-color: rgba(255, 255, 255, 0.8); /* Um pouco mais opaco */
            border-radius: 50%; /* Garante que seja um círculo */
            cursor: pointer;
            user-select: none; /* Impede a seleção do texto '?' */
            margin-left: 4px; /* Pequeno espaço à esquerda */
            line-height: 1; /* Garante alinhamento vertical */
        }

                /* Estilos da página de envio e detalhes - ESTA REGRA PODE SER REMOVIDA */
        /* #send-device-page, #device-detail-page { ... } */

        #send-device-page .collaborator-content {
             padding-bottom: 2rem;
        }
        
        textarea.data-input {
            height: auto;
            min-height: 120px;
            font-family: monospace;
        }

        /* Grade de Dispositivos por Marca */
        .device-card {
            width: calc(50% - 0.5rem); /* Dois cards por linha com um gap */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            text-decoration: none;
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }
        .device-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .device-card img {
            width: 100%;
            height: 120px; /* Reduzida a altura */
            object-fit: contain; /* Alterado para 'contain' para não cortar */
            background-color: #fff; /* Fundo branco para imagens com transparência */
        }
        .device-card span {
            display: block;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
        }

        /* Página de Detalhes do Dispositivo */
        #device-detail-content img {
            width: 100%;
            max-width: 200px; /* Reduzido o tamanho máximo */
            max-height: 200px; /* Reduzido o tamanho máximo */
            object-fit: contain;
            border-radius: 16px;
            background-color: #fff;
            align-self: center;
            margin-bottom: 1.5rem;
        }
        #device-detail-content h3 {
             color: var(--primary-color);
             margin: 1.5rem 0 0.5rem 0;
             width: 100%;
        }
        #device-detail-content pre {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap; /* Garante que o texto quebre a linha */
            word-wrap: break-word;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }
        #device-detail-content a {
            display: inline-block;
            margin-top: 1rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .delete-button {
            background-color: rgba(231, 76, 60, 0.7) !important; /* Vermelho para perigo */
            margin-top: 2rem;
        }
        .delete-button:hover {
             background-color: rgba(192, 57, 43, 1.0) !important;
        }

        /* Estilos para os painéis de vendas */
        .sales-data-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
        }

        .sales-data-card h4 {
            font-size: 1.2rem;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .sales-data-card p {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* --- Estilos do Dashboard --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }
        .kpi-card, .performance-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .kpi-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .charts-section {
            width: 100%;
            max-width: 400px;
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

                @keyframes modalContentExit {
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .login-section-hiding {
            animation: modalContentExit 0.3s ease-in forwards;
            pointer-events: none;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 16px;
        }
        .chart-container h4 {
            text-align: center;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }
        #monthly-sales-list-container p {
            padding: 0.5rem 0.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
        }
         #monthly-sales-list-container p:last-child {
            border-bottom: none;
        }

        .os-warning {
            color: #e74c3c;
            font-weight: 700;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #e74c3c;
        }

        /* Estilos da página de Solicitação de Estoque */
        .stock-brand-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            width: 100%;
            text-align: center;
            margin-top: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 0.5rem;
        }
        .stock-product-card {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .stock-product-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .stock-product-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background: white;
            border-radius: 8px;
            margin-right: 1rem;
        }
        .stock-product-card span {
            font-weight: 600;
        }
        #stock-selection-footer h4 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        #stock-selection-list {
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        #stock-selection-list div {
            padding: 0.25rem 0;
        }
        .date-input-group {
            display: flex;
            gap: 0.5rem;
        }
        .date-input-group input {
            text-align: center;
        }

        /* Estilos para o Quiz */
        .quiz-question-group {
            width: 100%;
            max-width: 350px;
            margin-bottom: 1.5rem;
            background: rgba(0,0,0,0.1);
            padding: 1rem;
            border-radius: 12px;
        }
        .quiz-question-group > label {
            display: block;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .radio-option input[type="radio"] {
            margin-right: 0.75rem;
            width: 20px;
            height: 20px;
        }
        .radio-option label {
             font-weight: 400;
        }


                /* ================================================= */
        /* == ESTILOS PARA A CALCULADORA DE CREDIÁRIO     == */
        /* ================================================= */
        #crediario-calculator-page {
             background: #1a1a2e; /* Fundo azul escuro, quase preto */
        }
        #crediario-calculator-page .collaborator-content {
            flex-grow: 1; /* Garante que a área de conteúdo ocupe todo o espaço vertical */
            justify-content: center; /* Centraliza o formulário verticalmente */
        }
        #crediario-form-container {
            width: 100%;
            max-width: 350px;
            padding: 1.5rem;
            background: rgba(16, 16, 32, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(0, 191, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #crediario-calculator-page .data-input {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(0, 191, 255, 0.4);
            color: #E0E0E0;
        }
        #crediario-calculator-page .data-input:focus {
            border-color: #00BFFF; /* DeepSkyBlue */
        }
        #crediario-calculator-page .slider-group label {
            color: #00BFFF;
            font-weight: 700;
        }
        #crediario-calculator-page .slider-input {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            outline: none;
            margin-top: 0.5rem;
        }
        #crediario-calculator-page .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #00BFFF;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #1a1a2e;
        }
        #crediario-result-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 1rem;
            border-top: 2px solid #00BFFF;
        }
        #crediario-result-container h4 {
            text-align: center;
            margin-bottom: 1rem;
            color: #FFFFFF;
        }
        #crediario-calculator-page .result-item span:last-child {
            color: #00BFFF; /* Cor do resultado */
        }
        #crediario-calculator-page .action-button {
            background-color: rgba(0, 191, 255, 0.7);
        }
        #crediario-calculator-page .action-button:hover {
            background-color: rgba(0, 191, 255, 1);
        }

                /* ================================================= */
        /* == ESTILOS PARA A CALCULADORA DE SITE          == */
        /* ================================================= */
        #site-calculator-page {
             background: #1e2a24; /* Fundo verde escuro */
        }
        #site-calculator-page .collaborator-content {
            flex-grow: 1; /* Garante que ocupe o espaço vertical */
            display: flex; /* Ativa o layout flexbox */
            flex-direction: column; /* Empilha os itens verticalmente */
            align-items: center; /* Centraliza o formulário horizontalmente */
            justify-content: center; /* Centraliza o formulário verticalmente */
            padding: 1.5rem;
            width: 100%;
        }
        #site-form-container {
            width: 100%;
            max-width: 350px;
            padding: 1.5rem;
            background: rgba(15, 25, 20, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(46, 204, 113, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #site-calculator-page .data-input {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #E0E0E0;
        }
        #site-calculator-page .data-input:focus {
            border-color: #2ecc71; /* Verde esmeralda */
        }
        #site-calculator-page .slider-group label {
            color: #2ecc71;
            font-weight: 700;
        }
        #site-calculator-page .slider-input {
            -webkit-appearance: none;
            width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 5px; outline: none; margin-top: 0.5rem;
        }
        #site-calculator-page .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #2ecc71; cursor: pointer; border-radius: 50%; border: 3px solid #1e2a24;
        }
        #site-result-container {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; border-top: 2px solid #2ecc71;
        }
        #site-result-container h4 {
            text-align: center; margin-bottom: 1rem; color: #FFFFFF;
        }
        #site-calculator-page .action-button {
            background-color: rgba(46, 204, 113, 0.7);
        }
        #site-calculator-page .action-button:hover {
            background-color: rgba(46, 204, 113, 1);
        }


                .parabens-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 0.5rem;
            transition: color 0.2s, transform 0.2s;
            margin-left: auto; /* Isso empurra o botão para a direita */
        }
        .parabens-btn:hover {
            color: #1eff00; /* Verde neon */
            transform: scale(1.2);
        }

                /* --- Estilos da Página de Bater Ponto (Câmera) --- */
        #ponto-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 4000; /* Z-index alto para ficar sobre tudo */
            display: none; 
            flex-direction: column;
        }
        .ponto-camera-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #ponto-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .ponto-camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        .ponto-camera-overlay p {
            background: rgba(0,0,0,0.5);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .ponto-circle-guide {
            width: 80vw;
            height: 80vw;
            max-width: 300px;
            max-height: 300px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5); /* Efeito de "buraco" */
        }
        .ponto-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
        }
        .ponto-capture-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white;
            border: 5px solid rgba(0,0,0,0.3);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .ponto-capture-button i {
            font-size: 2rem;
            color: #333;
        }
        
        /* Estilos da Página de Histórico de Ponto */
        .ponto-history-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            align-items: center;
        }

        /* Novo Estilo para o Card de Falta */
        .ponto-history-card.absence-record {
            background: rgba(192, 57, 43, 0.2); /* Fundo avermelhado */
            border-left: 4px solid #c0392b; /* Borda vermelha */
        }

        .ponto-history-absence-icon {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ponto-history-absence-icon i {
            font-size: 2.5rem;
            color: #e74c3c;
        }

        /* Estilo para justificativas no histórico */
        .ponto-history-justification {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            border-left: 3px solid #f1c40f;
        }
        .ponto-history-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #333;
        }
        .ponto-history-details p {
            margin: 0;
            font-size: 0.9rem;
        }
        .ponto-history-details p strong {
            color: var(--primary-color);
        }

        /* Estilo para a foto no histórico, indicando que é clicável */
        .ponto-history-photo:hover {
            cursor: pointer;
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

        /* Estilos para o Visualizador de Imagem Ampliada */
        #image-viewer-overlay {
            align-items: center;
            justify-content: center;
            z-index: 5000; /* Z-index muito alto para ficar sobre tudo */
        }
        #viewer-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            /* Animação de entrada para a imagem */
            animation: modalContentEnter 0.4s var(--ease-out-back);
        }

        /* Estilo para a Exibição da Versão */
        #app-version-display {
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            width: 100%;
        }

        /* Estilos para a página Lollipop */
        .lollipop-item-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            overflow: hidden;
            width: calc(50% - 1rem);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .lollipop-item-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }
        .lollipop-item-info {
            padding: 0.75rem;
            font-size: 0.75rem;
        }
        .lollipop-item-controls {
            display: flex;
            gap: 0.5rem;
            padding: 0 0.75rem 0.75rem 0.75rem;
        }
        .lollipop-item-controls button {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .lollipop-delete-btn {
            background-color: #c0392b;
        }

        /* --- Estilos para o novo Dashboard GS --- */
        .gs-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            padding: 1.5rem 1rem 0 1rem; /* Adiciona padding para não colar no topo */
            width: 100%;
            max-width: 450px;
            margin-left: auto; /* Garante a centralização */
            margin-right: auto; /* Garante a centralização */
        }

        .gs-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--white);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            cursor: pointer;
            text-align: center;
            position: relative; /* Adicionado para posicionar a bolha */
        }

        .gs-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .gs-action-btn i {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        #gs-notification-indicator {
            background-color: #e74c3c; /* Vermelho */
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            vertical-align: top;
        }

        /* Novo estilo para a bolha de notificação */
        .gs-notification-bubble {
            position: absolute;
            top: 8px; /* Posição no canto superior direito */
            right: 8px;
            background-color: #e74c3c; /* Vermelho */
            color: white;
            border-radius: 50%;
            width: 20px; /* Um pouco maior para destaque */
            height: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(0,0,0,0.2); /* Borda para separar do fundo */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Ajuste para o container de conteúdo principal do GS */
                #gs-page .collaborator-content {
            /* O padding-top foi removido para que o conteúdo flua a partir do topo */
            /* O espaçamento agora é controlado pelo padding da grade de ações */
            flex-direction: column;
            justify-content: flex-start;
            gap: 1.5rem;
            overflow-y: auto;
            overflow-x: hidden; /* Impede a rolagem horizontal */
        }

                /* --- ESTILOS PARA STORIES --- */
        #stories-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Melhora a rolagem em iOS */
        }
        /* Esconde a barra de rolagem */
        #stories-container::-webkit-scrollbar {
            display: none;
        }
        #stories-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        #stories-scroll {
            display: flex;
            gap: 1rem;
            padding: 0 1rem; /* Padding nas laterais da lista */
            white-space: nowrap; /* Impede a quebra de linha dos itens */
        }

        .story-circle-wrapper {
            flex-shrink: 0; /* Impede que os círculos encolham */
            width: 70px;
            height: 70px;
            border-radius: 50%;
            padding: 3px;
            cursor: pointer;
        }
        .story-circle-wrapper.has-story {
            background: linear-gradient(45deg, #FF6B00, #ff1493); /* Laranja e Rosa */
        }
        .story-circle-wrapper img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #372b62; /* Cor de fundo para dar separação */
            background-color: #333;
        }

        /* --- ESTILOS PARA O VISUALIZADOR DE STORIES --- */
        #story-progress-container {
            position: absolute;
            top: 5px;
            left: 2%;
            width: 96%;
            display: flex;
            gap: 4px;
            z-index: 10;
        }
        .story-progress-bar {
            flex-grow: 1;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .story-progress-bar > div {
            width: 0;
            height: 100%;
            background-color: #fff;
        }
        #story-header {
            display: flex;
            align-items: center;
            padding: 20px 15px 10px 15px;
            z-index: 5;
            position: relative;
        }
        #story-user-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        #story-user-name {
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        #story-content-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #story-content-area img, #story-content-area video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        #story-reply-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            width: 100%;
            z-index: 5;
            align-items: center; /* Garante o alinhamento vertical dos itens */
            flex-wrap: wrap;     /* Permite que os itens quebrem para a linha de baixo se não houver espaço */
        }
        #story-reply-input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.4);
            background-color: rgba(0,0,0,0.3);
            color: #fff;
            outline: none;
            font-family: 'Poppins', sans-serif;
        }
        #send-story-reply-btn {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* NOVOS ESTILOS PARA CURTIDAS */
        #like-story-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0 10px;
            transition: transform 0.2s ease;
            flex-shrink: 0; /* Impede que o botão seja espremido */
        }
        #like-story-btn:hover {
            transform: scale(1.1);
        }
        #like-story-btn i.fa-solid { /* Ícone preenchido quando curtido */
            color: #e74c3c;
        }

        #story-likes-info {
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.3);
            flex-shrink: 0; /* Impede que a caixa de curtidas seja espremida */
            white-space: nowrap; /* Impede que o texto "10 curtidas" quebre a linha */
        }

        /* NOVOS ESTILOS PARA AS SETAS DE NAVEGAÇÃO */
        .story-nav-arrow {
            position: absolute;
            top: 0;
            height: calc(100% - 80px); /* Ocupa a tela inteira, exceto a área de resposta */
            width: 30%; /* Ocupa 30% da lateral da tela */
            z-index: 20; /* Fica acima do conteúdo, mas abaixo do header */
            cursor: pointer;
        }
        #story-nav-prev {
            left: 0;
        }
        #story-nav-next {
            right: 0;
        }

        /* --- ESTILOS PARA CHAT --- */
        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-list-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        .chat-list-item.reply {
            border-left: 4px solid var(--primary-color);
        }
        .chat-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        .chat-list-item-content p {
            margin: 0;
        }
        .chat-list-item-content p strong {
            font-size: 1rem;
            color: #fff;
        }
        .chat-list-item-content p span {
            font-size: 0.85rem;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 250px;
        }
        .chat-message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
        }
        .chat-message-bubble.sent {
            background-color: var(--primary-color);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message-bubble.received {
            background-color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* ESTILOS PARA A RESPOSTA DE STORY NO CHAT */
        .story-reply-context {
            display: flex;
            gap: 10px;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary-color);
        }
        .story-reply-context img, .story-reply-context video {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }
        .story-reply-context span {
            font-size: 0.85rem;
            color: #ccc;
            font-style: italic;
        }
        .chat-message-bubble .reply-text {
            margin: 0;
            padding: 0;
        }

        /* ESTILOS PARA MÍDIA NO CHAT */
        .chat-message-bubble img, .chat-message-bubble video {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 5px;
            cursor: pointer;
        }

        /* NOVAS REGRAS PARA O LAYOUT DA TELA DE CHAT */
        #chat-conversation-page {
            /* A página em si é um container flex (column) de altura 100% */
            /* Esta regra garante que ela não role, e sim seu conteúdo interno */
            overflow-y: hidden; 
        }
        #chat-messages-container {
            /* flex-grow: 1 faz com que este container ocupe todo o espaço vertical disponível */
            flex-grow: 1; 
            /* min-height: 0 é um truque de flexbox para garantir que o container possa encolher se necessário, evitando que ele empurre outros elementos para fora da tela. */
            min-height: 0;
            /* overflow-y: auto permite que APENAS este container tenha uma barra de rolagem vertical. */
            overflow-y: auto; 
            /* As regras abaixo são do .collaborator-content, mas com a correção crucial do align-items */
            padding: 1rem 1.5rem; 
            display: flex;
            flex-direction: column;
            /* align-items: stretch é necessário para que o align-self das bolhas funcione */
            align-items: stretch; 
            justify-content: flex-start;
            gap: 0.75rem; /* Um pouco menos de espaço entre as bolhas */
        }
        #chat-input-area {
            /* flex-shrink: 0 impede que a área de digitação seja espremida */
            flex-shrink: 0; 
            background: rgba(30, 30, 60, 0.9);
            backdrop-filter: blur(5px);
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center; /* Alinha o input e o botão verticalmente */
            width: 100%;
        }


                /* --- ANIMAÇÃO PARA O ÍCONE DE FOGO DO RANKING --- */
    @keyframes fire-animation {
        0%, 100% {
            transform: translate(-50%, -50%) scale(1);
            color: #ff6b00;
        }
        50% {
            transform: translate(-50%, -50%) scale(1.2);
            color: #ffdd00;
        }
    }

    @keyframes fire-animation-purple {
        0%, 100% {
            transform: translate(-50%, -50%) scale(1);
            color: #9b59b6;
        }
        50% {
            transform: translate(-50%, -50%) scale(1.2);
            color: #e8daef;
        }
    }

    /* O container da barra agora é o ponto de referência para o ícone */
    .progress-bar-container {
        position: relative; /* Essencial para o posicionamento absoluto do filho */
    }

    .fire-icon {
        position: absolute;
        top: 50%; /* POSICIONA O ÍCONE NO MEIO VERTICAL DA BARRA */
        font-size: 1.2rem;
        animation: fire-animation 1.5s ease-in-out infinite;
        text-shadow: 0 0 8px rgba(255, 107, 0, 0.7);
        z-index: 2;
        pointer-events: none;
    }

    .fire-icon-purple {
        position: absolute;
        top: 50%;
        font-size: 1.2rem;
        animation: fire-animation-purple 1.5s ease-in-out infinite;
        text-shadow: 0 0 8px rgba(155, 89, 182, 0.7);
        z-index: 2;
        pointer-events: none;
    }

        /* =================================================================== */
        /* --- AJUSTES PARA TELAS PEQUENAS (RESPONSIVIDADE) --- */
        /* =================================================================== */
        
        /* Aplica estas regras em telas com largura máxima de 360px */
        @media (max-width: 360px) {
            /* Força a grade de ferramentas a ter apenas uma coluna */
            .tools-grid {
                grid-template-columns: 1fr;
            }

            /* Ajusta o padding para dar mais espaço */
            section {
                padding: 1.5rem 0.75rem;
            }

            header {
                padding: 1.25rem 0.75rem 0.75rem 0.75rem;
            }
        }

    </style>


</head>
<body>

    <!-- NOVA TELA DE LOGIN ÚNICO -->
    <div id="login-overlay" class="modal-overlay" style="display: none; backdrop-filter: blur(10px); background-color: rgba(0,0,0,0.8);">
        <div id="login-form-section" class="modal-content">
            <h3 class="modal-title" style="font-size: 1.2rem; line-height: 1.5; margin-bottom: 2rem;">Espere um pouco! Estamos mudando algumas coisas para não pedir senha todas as vezes e verificar que é realmente você. Vamos fazer um login único.</h3>
            
            <div class="input-group">
                <label for="login-user-select">Selecione quem é você</label>
                <select id="login-user-select" class="data-input">
                    <!-- Opções serão populadas pelo JS -->
                </select>
            </div>
            <div class="input-group">
                <label for="login-password-input">Sua senha</label>
                <input type="password" id="login-password-input" class="data-input" placeholder="Digite sua senha">
                <p id="login-password-hint" style="font-size: 0.8rem; color: #ccc; margin-top: 5px; display: none;">Você ainda não tem uma senha. Crie uma agora.</p>
            </div>
            
            <button id="login-proceed-btn" class="action-button full-width">Avançar</button>
            <p id="login-status-message" class="status-message"></p>
        </div>

        <!-- A seção da câmera para o login foi removida conforme solicitado. -->
    </div>

    <!-- TELA DE ATIVAÇÃO INICIAL -->
    <div id="activation-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Ativação Necessária</h3>
            <div class="input-group">
                <label for="activation-code-input">Código de Acesso</label>
                <input type="password" id="activation-code-input" class="data-input" placeholder="Digite o código">
            </div>
            <button id="submit-activation-code" class="action-button" style="max-width: none;">Ativar Dispositivo</button>
            <p id="activation-status" class="status-message"></p>
        </div>
    </div>


    <!-- TELA DE PESQUISA (OVERLAY) -->
    <div id="search-overlay" class="page">
        <div class="search-container">
            <input type="text" id="search-input" class="data-input" placeholder="Pesquisar funcionalidade...">
            <button id="search-close-btn" class="modal-close-btn" style="top: 20px; right: 25px;">×</button>
            <div id="search-results-container">
                <!-- Resultados da pesquisa aparecerão aqui -->
            </div>
        </div>
    </div>

    <div class="mobile-container page">

                <header>
            <div class="logo">
                LOJA DO HUNTER
            </div>
            <nav class="header-icons">
                <a href="#" id="theme-toggle"><i class="fa-solid fa-palette"></i></a>
                <img src="" id="header-profile-pic" class="header-profile-icon" alt="Perfil">
            </nav>
        </header>

        <main>
            <!-- NOVA Seção de Stories -->
            <section id="stories-section" style="padding-top: 1.5rem; padding-bottom: 0;">
                <div id="stories-container">
                    <div id="stories-scroll">
                        <!-- Círculos dos stories serão inseridos aqui pelo JS -->
                    </div>
                </div>
            </section>

            <!-- NOVA Seção de Status do Colaborador -->
            <section id="main-status-display-section" style="padding: 1.5rem 1rem 1.5rem 1rem; display: none;">
                <div id="main-status-bubble-container" style="text-align: center;">
                    <!-- O balão de status do usuário logado aparecerá aqui -->
                </div>
            </section>

            <!-- Seção de Aparelhos por Marca -->
            <section id="aparelhos">
                <h2 class="section-title">Aparelhos</h2>
                <div class="search-icon-container">
                    <button id="open-device-search" class="action-button" style="width: 60px; height: 60px; border-radius: 50%; padding: 0; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-magnifying-glass" style="font-size: 1.5rem; margin: 0;"></i>
                    </button>
                </div>
                <div class="brand-list">
                    <div class="brand-button" data-brand="xiaomi">XIAOMI</div>
                    <div class="brand-button" data-brand="poco">POCO</div>
                    <div class="brand-button" data-brand="realme">REALME</div>
                    <div class="brand-button" data-brand="umidigi">UMIDIGI</div>
                    <div class="brand-button" data-brand="itel">ITEL</div>
                    <div class="brand-button" data-brand="infinix">INFINIX</div>
                    <div class="brand-button" data-brand="honor">HONOR</div>
                    <div class="brand-button" data-brand="meizu">MEIZU</div>
                    <div class="brand-button" data-brand="tecno">TECNO</div>
                    <div class="brand-button" data-brand="samsung">SAMSUNG</div>
                    <div class="brand-button" data-brand="apple">APPLE</div>
                    <div class="brand-button" data-brand="joog">JOOG</div>
                </div>
            </section>

            <!-- Seção de Destaques (Carousel) -->
        <section id="destaques" style="padding-top: 0; padding-bottom: 0;">
            <div id="promo-carousel-container">
                <div id="promo-carousel-slides">
                    <!-- Slide 1: Ofereça Seguro Queda -->
                    <div class="promo-slide">
                        <div class="promo-slide-icon">
                            <i class="fa-solid fa-shield-halved"></i>
                        </div>
                        <div class="promo-slide-content">
                            <h3>Ofereça Seguro Contra Queda</h3>
                            <p>Proteja o investimento do seu cliente e aumente seu lucro.</p>
                        </div>
                    </div>
                    <!-- Slide 2: Ofereça Garantia Estendida -->
                    <div class="promo-slide">
                        <div class="promo-slide-icon">
                            <i class="fa-solid fa-calendar-plus"></i>
                        </div>
                        <div class="promo-slide-content">
                            <h3>Ofereça Garantia Estendida</h3>
                            <p>Mais tranquilidade para o cliente e mais comissão para você.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

            <!-- NOVA Seção do Ranking de Serviços -->
        <section id="service-ranking">
            <h2 class="section-title">Ranking de Serviços</h2>
            <div id="service-ranking-container" class="ranking-list">
                <!-- O JavaScript irá popular este container -->
                <p style="text-align: center; padding: 1rem;">Carregando ranking...</p>
            </div>
        </section>

        <!-- Seção do Ranking Mensal de Colaboradores -->
        <section id="ranking">
            <h2 class="section-title">Ranking de Vendas</h2>
            <div id="ranking-container" class="ranking-list">
                <!-- O JavaScript irá popular este container -->
                <p style="text-align: center; padding: 1rem;">Carregando ranking...</p>
            </div>
        </section>
        
        <!-- Seção do Ranking de Gerentes -->
            <section id="store-ranking">
                <h2 class="section-title">Ranking de Gerentes</h2>
                <div id="store-ranking-container" class="ranking-list">
                    <!-- O JavaScript irá popular este container -->
                     <p style="text-align: center; padding: 1rem;">Carregando ranking...</p>
                </div>
            </section>
            
            <!-- NOVA Seção de Avisos Gerais -->
            <section id="avisos-gerais" style="display: none;">
                <h2 class="section-title">Avisos da Gerência</h2>
                <div id="avisos-container" class="ranking-list">
                    <!-- O JavaScript irá popular os avisos aqui -->
                </div>
            </section>
            
            <!-- Seção de Ferramentas -->
            <section id="ferramentas">
                <h2 class="section-title">Aplicativos</h2>
                
                <!-- Grade de Ferramentas Principais -->
                <div class="tools-grid">
                    <div data-url="https://www.brasilcard.net/bca/lojista/login" id="hunter-card-link" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-id-card"></i></div>
                        <span>Hunter Card</span>
                    </div>
                    <div id="open-my-profile-btn" class="tool-item" style="position: relative;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-user-astronaut"></i></div>
                        <span>Meu Perfil</span>
                        <!-- NOVO INDICADOR DE MENSAGEM -->
                        <span id="chat-notification-indicator" class="gs-notification-bubble" style="display: none; top: 4px; right: 4px;">!</span>
                    </div>
                    <div id="previsao-btn" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-truck-fast"></i></div>
                        <span>Previsão</span>
                    </div>
                    <div id="open-os-modal" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-screwdriver-wrench"></i></div>
                        <span>Assistência Técnica (OS)</span>
                    </div>
                    <div id="open-request-stock-page" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-boxes-stacked"></i></div>
                        <span>Solicitar Estoque</span>
                    </div>
                    <div id="open-quiz-page" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-comment-dots"></i></div>
                        <span>Quiz</span>
                    </div>
                    <div id="open-recibos-page" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                        <span>Recibos</span>
                    </div>
                    <div id="open-send-device-page" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-paper-plane"></i></div>
                        <span>Enviar Dispositivo</span>
                    </div>
                    <div id="open-feedback-page" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-lightbulb"></i></div>
                        <span>Enviar Erro/Sugestão</span>
                    </div>
                    <div id="open-debug-page" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-bug"></i></div>
                        <span>Debug</span>
                    </div>
                </div>
            </section>

            <!-- Seção de Calculadoras -->
            <section id="calculadoras">
                <h2 class="section-title">Calculadoras</h2>
                <div class="tools-grid">
                    <div id="open-crediario-calculator" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-sliders"></i></div>
                        <span>Crediário</span>
                    </div>
                    <div id="open-site-calculator" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-code"></i></div>
                        <span>Parcelar Site</span>
                    </div>
                     <div id="open-loja-calculator" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-store"></i></div>
                        <span>Parcelamento de Loja</span>
                    </div>
                </div>
            </section>

            </main>

        <!-- A seção do rodapé foi removida -->

    </div>

        <!-- TELA DA CALCULADORA DE CREDIÁRIO (ESTILO NOVO) -->
    <div id="crediario-calculator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-crediario" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Calculadora de Crediário</h2>
        </div>
        <div class="collaborator-content">
            
            <div id="crediario-form-container">
                <div class="input-group">
                    <label for="crediario-valor-produto">Valor do Produto (R$)</label>
                    <input type="number" id="crediario-valor-produto" class="data-input" placeholder="1500.00">
                </div>
                <div class="input-group">
                    <label for="crediario-entrada">Entrada (R$)</label>
                    <input type="number" id="crediario-entrada" class="data-input" placeholder="0.00">
                </div>
                <div class="input-group slider-group">
                    <label for="crediario-parcelas">Parcelas (a cada 30 dias): <span id="parcelas-value">10</span>x</label>
                    <input type="range" id="crediario-parcelas" min="1" max="10" value="10" step="1" class="slider-input">
                </div>
                <div class="input-group slider-group">
                    <label for="crediario-quinzena-parcelas">Parcelas (a cada 15 dias): <span id="quinzena-value">0</span>x</label>
                    <input type="range" id="crediario-quinzena-parcelas" min="0" max="20" value="0" step="1" class="slider-input">
                </div>
                <div class="input-group slider-group">
                    <label for="crediario-semanal-parcelas">Parcelas (a cada 7 dias): <span id="semanal-value">0</span>x</label>
                    <input type="range" id="crediario-semanal-parcelas" min="0" max="40" value="0" step="1" class="slider-input">
                </div>
                
                <div id="crediario-result-container">
                    <h4>Resultado em Tempo Real</h4>
                    <div class="result-item">
                        <span>Valor da Parcela</span>
                        <span id="result-parcela">R$ 0,00</span>
                    </div>
                    <div class="result-item">
                        <span>Total a Prazo (Restante)</span>
                        <span id="result-total-prazo">R$ 0,00</span>
                    </div>
                </div>

                <button id="clear-crediario-btn" class="action-button full-width">Limpar</button>
            </div>

        </div>
    </div>



        <!-- TELA DA CALCULADORA DE PARCELAMENTO DE LOJA -->
    <div id="loja-calculator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-loja" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Parcelamento de Loja</h2>
        </div>
        <div class="collaborator-content">
            <div id="loja-form-container">
                <div class="input-group">
                    <label for="loja-valor-produto">Valor do Produto (R$)</label>
                    <input type="number" id="loja-valor-produto" class="data-input" placeholder="1000.00">
                </div>
                <div class="input-group">
                    <label for="loja-entrada">Entrada (R$)</label>
                    <input type="number" id="loja-entrada" class="data-input" placeholder="100.00">
                </div>
                <div class="input-group">
                    <label for="loja-seguro">Seguro (R$)</label>
                    <input type="number" id="loja-seguro" class="data-input" placeholder="50.00">
                </div>
                <div class="input-group slider-group">
                    <label for="loja-parcelas">Parcelas: <span id="loja-parcelas-value">10</span>x</label>
                    <input type="range" id="loja-parcelas" min="1" max="18" value="10" step="1" class="slider-input">
                </div>
                
                <div id="loja-result-container">
                    <h4>Resultado do Parcelamento</h4>
                    <div class="result-item">
                        <span>Valor da Parcela</span>
                        <span id="loja-result-parcela">R$ 0,00</span>
                    </div>
                    <div class="result-item">
                        <span>Valor Total (com seguro)</span>
                        <span id="loja-result-total-prazo">R$ 0,00</span>
                    </div>
                </div>

                <button id="clear-loja-btn" class="action-button full-width">Limpar</button>
            </div>
        </div>
    </div>

    <!-- TELA DA CALCULADORA DE PARCELAMENTO DE SITE -->
    <div id="site-calculator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-site" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Parcelamento de Site</h2>
        </div>
        <div class="collaborator-content">
            <div id="site-form-container">
                <div class="input-group">
                    <label for="site-valor-produto">Valor do Site (R$)</label>
                    <input type="number" id="site-valor-produto" class="data-input" placeholder="3000.00">
                </div>
                <div class="input-group">
                    <label for="site-entrada">Entrada (R$)</label>
                    <input type="number" id="site-entrada" class="data-input" placeholder="500.00">
                </div>
                <div class="input-group slider-group">
                    <label for="site-parcelas">Parcelas: <span id="site-parcelas-value">6</span>x</label>
                    <input type="range" id="site-parcelas" min="1" max="12" value="6" step="1" class="slider-input">
                </div>
                
                <div id="site-result-container">
                    <h4>Resultado do Parcelamento</h4>
                    <div class="result-item">
                        <span>Valor da Parcela</span>
                        <span id="site-result-parcela">R$ 0,00</span>
                    </div>
                    <div class="result-item">
                        <span>Valor Total (com juros)</span>
                        <span id="site-result-total-prazo">R$ 0,00</span>
                    </div>
                </div>

                <button id="clear-site-btn" class="action-button full-width">Limpar</button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- HTML DAS TELAS ESCONDIDAS E MODAIS -->
    <!-- =================================================================== -->

    <!-- TELA DE BUSCA DE APARELHOS -->
    <div id="device-search-overlay" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-device-search" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Buscar Aparelho</h2>
        </div>
        <div class="collaborator-content" style="padding-top: 1.5rem; align-items: stretch;">
            <div class="input-group" style="max-width: none;">
                <input type="text" id="device-search-input" class="data-input" placeholder="Digite o nome do aparelho...">
            </div>
            <!-- A grade de resultados reutiliza os estilos da página de marcas -->
            <div id="device-search-results-grid" style="display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: flex-start; gap: 1rem; width: 100%; overflow-y: auto; flex-grow: 1; padding-bottom: 2rem;">
                <!-- Resultados da busca aparecerão aqui -->
            </div>
        </div>
    </div>

            

    <div id="colaborador-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-modal-btn" class="modal-close-btn">×</button>
            <div id="colaborador-cidades" class="modal-view">
                <h3 class="modal-title">Escolha a Cidade</h3>
                <div class="modal-button-container">
                    <button id="btn-pinheiro" class="modal-btn">Pinheiro</button>
                    <button id="btn-bacabal" class="modal-btn">Bacabal</button>
                </div>
            </div>
            <div id="colaborador-pinheiro" class="modal-view" style="display: none;">
                <h3 class="modal-title">Colaboradores - Pinheiro</h3>
                <div class="modal-button-container">
                    <a href="#" class="modal-btn collaborator-link" data-name="Mainara">Mainara</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Eliseu">Eliseu</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Eduardo">Eduardo</a>
                </div>
            </div>
            <div id="colaborador-bacabal" class="modal-view" style="display: none;">
                <h3 class="modal-title">Colaboradores - Bacabal</h3>
                <div class="modal-button-container">
                    <a href="#" class="modal-btn collaborator-link" data-name="Natalia">Natalia</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Tacilio">Tacilio</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Demilson">Demilson</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Leonardo">Leonardo</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela do Colaborador (escondida por padrão) -->
    <div id="collaborator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="collaborator-name-display">Nome do Colaborador</h2>
        </div>
        <!-- Container para a Foto de Perfil -->
        <div id="collaborator-profile-pic-container">
            <img id="collaborator-profile-pic" src="" alt="Foto de Perfil">
            <!-- Ícone para adicionar/editar status -->
            <div id="edit-status-cloud"><i class="fa-solid fa-comment"></i></div>
        </div>
        
        <!-- Container para exibir o status do colaborador -->
        <div id="collaborator-status-display-container"></div>

        <!-- O conteúdo agora tem um container para melhor organização -->
        <div class="collaborator-content">
            <!-- Aviso de Manutenção -->
            <div id="maintenance-notice-area" class="os-warning" style="display: none;">
                Estamos passando por manutenção, desconsidere erros até este aviso sumir.
            </div>

            <!-- Área de Notificação do Ponto -->
            <div id="ponto-notification-area">
                <!-- O JS vai popular esta área -->
            </div>
            
            <!-- Informação do próximo ponto -->
            <p id="ponto-countdown-timer" style="text-align: center; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); margin: 0; min-height: 20px;"></p>
            <p id="ponto-live-countdown" style="text-align: center; font-size: 1.1rem; font-weight: 600; color: #f1c40f; margin: 0; min-height: 25px;"></p>

            <!-- Painel de vendas individuais -->
            <div id="individual-sales-data"></div>

            <!-- NOVO: Painel de vendas diárias da loja (para gerentes) -->
            <div id="daily-store-sales-data" style="width: 100%; max-width: 380px; display: none;"></div>

            <!-- Histórico de Vendas Pessoal -->
            <div id="personal-sales-history" class="chart-container" style="width: 100%; max-width: 380px; display: none;">
                 <h4>Vendas nos Últimos 7 Dias</h4>
                 <canvas id="personal-sales-chart"></canvas>
            </div>

            <!-- Seção do Caixa da Loja para Gerentes -->
            <div id="manager-cash-box-section" class="sales-data-card" style="width: 100%; max-width: 380px; display: none;">
                <h4>Verba de Crediario</h4>
                <p style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem;" id="cash-box-value">R$ 1.000,00</p>
                <div class="progress-bar-container" style="height: 20px; margin-bottom: 1.5rem;">
                    <div id="cash-box-progress-bar" class="progress-bar" style="width: 100%;"></div>
                </div>
                
                <h4>Verba de Loja</h4>
                <p style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem;" id="store-cash-box-value">R$ 1.000,00</p>
                <div class="progress-bar-container" style="height: 20px; margin-bottom: 1.5rem;">
                    <div id="store-cash-box-progress-bar" class="progress-bar" style="width: 100%; background-color: #2980b9;"></div>
                </div>

                <h4>Preço de Site</h4>
                <p style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem;" id="preco-site-cash-box-value">R$ 5.000,00</p>
                <div class="progress-bar-container" style="height: 20px;">
                    <div id="preco-site-cash-box-progress-bar" class="progress-bar" style="width: 100%; background-color: #8e44ad;"></div>
                </div>

                <button id="burn-cdc-btn" class="action-button full-width" style="margin-top: 1rem;"><i class="fa-solid fa-fire-flame-curved"></i> Queimar Verba CDC</button>
                <button id="recover-cdc-btn" class="action-button full-width" style="margin-top: 0.5rem;"><i class="fa-solid fa-arrows-rotate"></i> Recuperar Verba CDC</button>
                <div id="manager-daily-expenses-list" style="margin-top: 1rem;">
                    <!-- Gastos do dia serão listados aqui -->
                </div>
            </div>
            
            <!-- NOVA GRADE DE AÇÕES PRINCIPAIS -->
            <div class="collaborator-actions-grid">
                <a href="#" id="view-metas-btn" class="action-button">
                    <i class="fa-solid fa-trophy"></i>
                    <span>Metas</span>
                </a>
                <a href="#" id="bater-ponto-btn" class="action-button">
                    <i class="fa-solid fa-camera-retro"></i>
                    <span>Digitar Ponto</span>
                </a>
                <!-- NOVO BOTÃO GS DENTRO DO PERFIL -->
                <a href="#" id="open-gs-from-profile-btn" class="action-button" style="display: none;">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>Painel GS</span>
                </a>
                <a href="#" id="manager-panel-btn" class="action-button" style="display: none;">
                    <i class="fa-solid fa-user-tie"></i>
                    <span>Painel Gerente</span>
                </a>
                <a href="#" id="closing-btn" class="action-button" style="display: none;">
                    <i class="fa-solid fa-cash-register"></i>
                    <span>Fechamento</span>
                </a>
                <a href="#" id="add-my-story-btn" class="action-button">
                    <i class="fa-solid fa-plus"></i>
                    <span>Add Story</span>
                </a>
                <a href="#" id="open-chats-btn" class="action-button">
                    <i class="fa-solid fa-comments-dollar"></i>
                    <span>Chats</span>
                </a>
                <a href="#" id="change-password-btn" class="action-button">
                    <i class="fa-solid fa-key"></i>
                    <span>Alterar Senha</span>
                </a>
                <a href="#" id="change-photo-btn" class="action-button">
                    <i class="fa-solid fa-camera-rotate"></i>
                    <span>Trocar Foto</span>
                </a>
                                 <a href="#" id="delete-my-story-btn" class="action-button" style="display: none; background-color: rgba(231, 76, 60, 0.7);">
                    <i class="fa-solid fa-trash-can"></i>
                    <span>Apagar Story</span>
                </a>
                <a href="#" id="logout-btn" class="action-button" style="grid-column: 1 / -1; background-color: rgba(0,0,0,0.2);">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Sair / Trocar Usuário</span>
                </a>
            </div>

            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
            <input type="file" id="story-upload-input" accept="image/*,video/*" style="display: none;">
            
            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
            <p id="photo-upload-status" class="status-message"></p>

            <!-- Seção de Conquistas -->
            <div id="achievements-section" style="width: 100%; max-width: 380px; margin-top: 2rem; display: none;">
                <h3 class="section-title" style="font-size: 1.3rem; margin-bottom: 1rem;">Conquistas</h3>
                <div id="achievements-container" class="achievements-grid">
                    <!-- Badges serão inseridas aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Tela da gs (Dashboard) -->
        <!-- TELA DA GS (DASHBOARD) -->
    <div id="gs-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-gs" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Dashboard Geral</h2>
        </div>

        <div class="collaborator-content">
            
            <!-- Botões de Ação agora estão DENTRO da área de rolagem -->
            <div class="gs-actions-grid">
                <button id="open-settings-page" class="gs-action-btn"><i class="fa-solid fa-bullseye"></i><span>Metas</span></button>
                <button id="open-correction-page" class="gs-action-btn"><i class="fa-solid fa-eraser"></i><span>Correção</span></button>
                <button id="open-mt-management-page" class="gs-action-btn"><i class="fa-solid fa-gem"></i><span>Entradas</span></button>
                <button id="verificar-ponto-btn" class="gs-action-btn"><i class="fa-solid fa-user-check"></i><span>Ponto</span></button>
                <button id="open-collaborator-profile-btn" class="gs-action-btn"><i class="fa-solid fa-id-badge"></i><span>Ver Perfil</span></button> <!-- NOVO BOTÃO -->
                <button id="open-cash-management-page" class="gs-action-btn"><i class="fa-solid fa-cash-register"></i><span>CDC</span></button>
                <button id="open-store-cash-management-page" class="gs-action-btn"><i class="fa-solid fa-sack-dollar"></i><span>Verba Loja</span></button>
                <button id="open-venda-remota-cash-management-page" class="gs-action-btn"><i class="fa-solid fa-rocket"></i><span>Verba Site</span></button> <!-- NOVO BOTÃO -->
                <button id="open-overtime-management-page" class="gs-action-btn"><i class="fa-solid fa-clock"></i><span>Horas</span></button>
                <button id="open-holidays-management-page" class="gs-action-btn"><i class="fa-solid fa-calendar-xmark"></i><span>Feriados</span></button>
                <button id="open-sundays-management-page" class="gs-action-btn"><i class="fa-solid fa-calendar-check"></i><span>Domingos</span></button>
                <button id="open-day-off-management-page" class="gs-action-btn"><i class="fa-solid fa-bed"></i><span>Folgas</span></button>
                <button id="open-avisos-management-page" class="gs-action-btn"><i class="fa-solid fa-bullhorn"></i><span>Avisos</span></button>
                <button id="clear-ponto-status-btn" class="gs-action-btn"><i class="fa-solid fa-user-clock"></i><span>Limpar Ponto</span></button>
                <button id="save-backup-btn" class="gs-action-btn"><i class="fa-solid fa-save"></i><span>Salvar Backup</span></button>
                <button id="restore-backup-btn" class="gs-action-btn"><i class="fa-solid fa-upload"></i><span>Restaurar Backup</span></button>
                <input type="file" id="backup-file-input" accept=".txt" style="display: none;">

                <!-- NOVOS BOTÕES DE SUBMISSÃO -->
                <button id="view-stock-requests-btn" class="gs-action-btn">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    <span>Estoque</span>
                    <span id="stock-indicator" class="gs-notification-bubble" style="display: none;">!</span>
                </button>
                <button id="view-recibos-btn" class="gs-action-btn">
                    <i class="fa-solid fa-hand-holding-dollar"></i>
                    <span>Recibos</span>
                    <span id="recibos-indicator" class="gs-notification-bubble" style="display: none;">!</span>
                </button>
                <button id="view-quiz-submissions-btn" class="gs-action-btn">
                    <i class="fa-solid fa-comment-dots"></i>
                    <span>Quiz</span>
                    <span id="quiz-indicator" class="gs-notification-bubble" style="display: none;">!</span>
                </button>
                <button id="view-feedback-btn" class="gs-action-btn">
                    <i class="fa-solid fa-lightbulb"></i>
                    <span>Feedback</span>
                    <span id="feedback-indicator" class="gs-notification-bubble" style="display: none;">!</span>
                </button>
            </div>

            <!-- KPIs principais -->
            <div class="dashboard-grid">
                <div class="kpi-card"><span class="kpi-title">VENDAS TOTAIS</span><span id="total-vendas-kpi" class="kpi-value">---</span></div>
                <div class="kpi-card"><span class="kpi-title">VENDAS PINHEIRO</span><span id="pinheiro-vendas-kpi" class="kpi-value">---</span></div>
                <div class="kpi-card"><span class="kpi-title">VENDAS BACABAL</span><span id="bacabal-vendas-kpi" class="kpi-value">---</span></div>
            </div>

            <!-- Rankings de Performance -->
            <div class="dashboard-grid">
                 <div class="performance-card"><span class="kpi-title">MELHOR LOJA (Vendas)</span><span id="melhor-loja-kpi" class="kpi-value" style="font-size: 1.5rem;">---</span></div>
                 <div class="performance-card"><span class="kpi-title">MELHOR VENDEDOR</span><span id="melhor-vendedor-kpi" class="kpi-value" style="font-size: 1.5rem;">---</span></div>
            </div>

            <!-- Seção de Vendas Mensais -->
            <div class="charts-section">
                <div class="chart-container">
                    <h4>Vendas Mensais (Histórico)</h4>
                    <canvas id="monthly-sales-chart"></canvas>
                </div>
            </div>

            <!-- Seção de Gráficos de Vendas Atuais -->
            <div class="charts-section">
                <div class="chart-container">
                    <h4>Vendas Atuais por Loja</h4>
                    <canvas id="store-sales-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Progresso da Meta Individual (%)</h4>
                    <canvas id="employee-goal-progress-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Vendas Atuais por Funcionário</h4>
                    <canvas id="employee-sales-chart"></canvas>
                </div>
            </div>
            
            <!-- Seção de Notificações de Ponto -->
            <div class="charts-section" id="manager-notifications-section" style="display: none;">
                <div class="chart-container">
                    <h4>Notificações de Ponto</h4>
                    <div id="manager-notifications-list" class="ranking-list" style="gap: 0.5rem;">
                        <!-- Notificações serão carregadas aqui -->
                    </div>
                    <!-- Botão para limpar todas as notificações -->
                    <button id="clear-all-notifications-btn" class="action-button delete-button" style="margin-top: 1.5rem; display: none;">
                        <i class="fa-solid fa-trash-can"></i> Limpar Todas
                    </button>
                </div>
            </div>

                        <!-- Seção de Horas Extras -->
            <div class="charts-section" id="overtime-section">
                <div class="chart-container">
                    <h4>Horas Extras Acumuladas</h4>
                    <div id="overtime-list-container" class="ranking-list" style="gap: 0.5rem;">
                         <p style="text-align: center;">Carregando...</p>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Configurações Gerais -->
            <div class="charts-section">
                <div class="chart-container">
                    <h4>Configurações Gerais</h4>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label for="maintenance-mode-toggle" style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="maintenance-mode-toggle" style="margin-right: 10px; width: 20px; height: 20px;">
                            Ativar Modo de Manutenção
                        </label>
                        <p style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem;">
                            Exibe um aviso de manutenção na tela de cada colaborador.
                        </p>
                        <p id="maintenance-status-message" class="status-message"></p>
                    </div>
                </div>
            </div>

            <!-- Seção de Configurações de Visibilidade -->
            <div class="charts-section" id="visibility-settings-section" style="display: none;">
                <div class="chart-container">
                    <h4>Configurações de Visibilidade</h4>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Ranking de Vendedores</span>
                            <input type="checkbox" id="visibility-ranking-toggle" data-key="ranking" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Ranking de Gerentes</span>
                            <input type="checkbox" id="visibility-store-ranking-toggle" data-key="storeRanking" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Verba (Caixa) do Gerente</span>
                            <input type="checkbox" id="visibility-cash-box-toggle" data-key="cashBox" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Vendas do Dia (Gerente)</span>
                            <input type="checkbox" id="visibility-daily-sales-toggle" data-key="dailySales" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Resultados Atuais (Vendedores)</span>
                            <input type="checkbox" id="visibility-individual-sales-toggle" data-key="individualSales" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Painel da Gerente</span>
                            <input type="checkbox" id="visibility-manager-panel-toggle" data-key="managerPanel" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Fechamento</span>
                            <input type="checkbox" id="visibility-closing-toggle" data-key="closing" class="visibility-toggle">
                        </label>
                    </div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Vendas nos Últimos 7 Dias</span>
                            <input type="checkbox" id="visibility-sales-history-toggle" data-key="salesHistory" class="visibility-toggle">
                        </label>
                    </div>
                    <p id="visibility-status-message" class="status-message"></p>
                </div>
            </div>

        </div>
    </div>

        <!-- TELA DE VISUALIZAÇÃO DO MOSTRUÁRIO (ENTRADAS) -->
    <div id="mt-display-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-mt-display" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Mostruário (Entradas)</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch; gap: 1rem;">
                        <div class="input-group" style="max-width: none; margin-bottom: 0;">
                <label for="mt-brand-filter">Filtrar por Marca</label>
                <select id="mt-brand-filter" class="data-input">
                    <option value="" selected>Selecione uma marca...</option>
                    <option value="apple">Apple</option>
                    <option value="samsung">Samsung</option>
                    <option value="xiaomi">Xiaomi</option>
                    <option value="poco">Poco</option>
                    <option value="realme">Realme</option>
                    <option value="umidigi">Umidigi</option>
                    <option value="itel">Itel</option>
                    <option value="infinix">Infinix</option>
                    <option value="honor">Honor</option>
                    <option value="joog">Joog</option>
                    <option value="meizu">Meizu</option>
                    <option value="tecno">Tecno</option>
                </select>
            </div>
            <div id="mt-content-area" style="width: 100%; display: flex; flex-direction: column; gap: 1rem;">
                <!-- Conteúdo do MT será carregado aqui pelo JS -->
                <p style="text-align: center;">Selecione uma marca para ver os itens.</p>
            </div>
        </div>
    </div>

        <!-- TELA DE GERENCIAMENTO DO MOSTRUÁRIO (ENTRADAS) -->
    <div id="mt-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-mt-management" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Entradas</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">

            <!-- Seção para Adicionar Novo Item -->
            <div class="employee-meta-card">
                <h4>Adicionar Novo Item</h4>
                <div class="input-group">
                    <label for="mt-add-brand">Marca</label>
                    <select id="mt-add-brand" class="data-input">
                        <option value="" disabled selected>Selecione a marca...</option>
                        <option value="apple">Apple</option>
                        <option value="samsung">Samsung</option>
                        <option value="xiaomi">Xiaomi</option>
                        <option value="poco">Poco</option>
                        <option value="realme">Realme</option>
                        <option value="umidigi">Umidigi</option>
                        <option value="itel">Itel</option>
                        <option value="infinix">Infinix</option>
                        <option value="honor">Honor</option>
                        <option value="joog">Joog</option>
                        <option value="meizu">Meizu</option>
                        <option value="tecno">Tecno</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="mt-add-text">Texto do Item</label>
                    <textarea id="mt-add-text" class="data-input" rows="4" placeholder="REALME Note 50 – 64GB / 3GB
💰 Entrada a partir de R$ 570,00
⚫ Preto | 🔵 Azul"></textarea>
                </div>
                <button id="save-mt-item-btn" class="action-button"><i class="fa-solid fa-save"></i>Salvar Item</button>
                <p id="mt-add-status" class="status-message"></p>
            </div>

            <!-- Seção para Listar e Excluir Itens -->
            <div class="employee-meta-card">
                <h4>Itens Cadastrados</h4>
                <div id="mt-list-container">
                    <!-- Lista de itens será carregada aqui -->
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>

        </div>
    </div>

<!-- Tela de Configuração de Metas e Premiações -->
    <div id="metas-config-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-metas" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Metas e Premiações</h2>
        </div>
        <div id="metas-content-container" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área e o botão de salvar será adicionado aqui no final por ele -->
        </div>
    </div>

    <!-- Tela de Visualização de Metas (Para o Colaborador) -->
    <div id="metas-display-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-metas" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Metas e Premiações</h2>
        </div>
        <div id="metas-display-content" class="collaborator-content" style="flex-direction: column; align-items: flex-start; justify-content: flex-start;">
            <!-- O JavaScript vai popular esta área -->
        </div>
    </div>

    <!-- Tela para Enviar um Novo Dispositivo -->
    <div id="send-device-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-send" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Enviar Novo Dispositivo</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <div class="input-group">
                <label for="device-brand">Marca</label>
                <select id="device-brand" class="data-input">
                    <option value="" disabled selected>Selecione a marca...</option>
                    <option value="apple">Apple</option>
                    <option value="samsung">Samsung</option>
                    <option value="xiaomi">Xiaomi</option>
                    <option value="poco">Poco</option>
                    <option value="realme">Realme</option>
                    <option value="umidigi">Umidigi</option>
                    <option value="itel">Itel</option>
                    <option value="infinix">Infinix</option>
                                        <option value="honor">Honor</option>
                    <option value="joog">Joog</option>
                    <option value="meizu">Meizu</option>
                    <option value="tecno">Tecno</option>
                </select>
            </div>
            <div class="input-group">
                <label for="device-name">Nome do Dispositivo</label>
                <!-- Elemento clicável que parece um input -->
                <div id="device-name-display" class="data-input" style="cursor: pointer; color: #aaa; padding-top: 12px; padding-bottom: 12px;">Clique para selecionar da planilha...</div>
                <!-- Input oculto para armazenar o valor -->
                <input type="hidden" id="device-name">
            </div>

    <!-- TELA DE SELEÇÃO DE DISPOSITIVO DA PLANILHA -->
    <div id="sheet-device-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-sheet-device-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Selecione um Dispositivo</h3>
            <div class="input-group" style="margin-bottom: 1rem;">
                <input type="text" id="sheet-device-search-input" class="data-input" placeholder="Filtrar dispositivos...">
            </div>
            <div id="sheet-device-list-container" style="max-height: 60vh; overflow-y: auto;">
                <!-- A lista de dispositivos será inserida aqui pelo JS -->
            </div>
        </div>
    </div>
             <div class="input-group">
                <label for="device-image-upload">Imagem Principal (Obrigatório)</label>
                <button id="device-upload-btn" class="action-button full-width"><i class="fa-solid fa-upload"></i> Enviar Imagem</button>
                <input type="file" id="device-image-upload" accept="image/*" style="display: none;">
                <p id="device-image-status" class="status-message" style="margin-top: 0.5rem;"></p>
                <!-- Input oculto para armazenar a URL da imagem (útil para edição) -->
                <input type="hidden" id="device-image-url">
             </div>
            <div class="input-group">
                <label for="device-tech-specs">⚙️ Ficha Técnica</label>
                <textarea id="device-tech-specs" class="data-input" rows="5" placeholder="Processador: Snapdragon 8 Gen 1
Tela: 6.8 polegadas, AMOLED
Câmera: 108MP..."></textarea>
            </div>
            <div class="input-group">
                <label for="device-price-table">💰 Tabela de Preços</label>
                <textarea id="device-price-table" class="data-input" rows="4" placeholder="Os dados da planilha aparecerão aqui..."></textarea>
            </div>
            <button id="save-device-btn" class="action-button" style="margin-top: 1rem;"><i class="fa-solid fa-save"></i>Salvar Dispositivo</button>
            <p id="send-device-status" class="status-message"></p>
            <!-- Placeholder para o botão de acesso -->
            <div id="lollipop-access-container" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Tela para Listar Dispositivos de uma Marca -->
    <div id="brand-devices-page" style="display: none;">
         <div class="collaborator-header">
            <button id="back-to-main-from-brand" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="brand-page-title">Marca</h2>
        </div>
        <div id="brand-devices-grid" class="collaborator-content" style="flex-wrap: wrap; justify-content: flex-start; align-items: flex-start; gap: 1rem; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área -->
        </div>
    </div>
    
    <!-- Tela para Ver os Detalhes de um Dispositivo -->
    <div id="device-detail-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-brand-from-detail" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="device-detail-title">Nome do Dispositivo</h2>
        </div>
        <div id="device-detail-content" class="collaborator-content" style="flex-direction: column; align-items: flex-start; justify-content: flex-start; overflow-y: auto; padding: 1.5rem;">
            <!-- O JavaScript vai popular esta área -->
        </div>
    </div>

    <!-- Tela do Painel de Vendas da Gerente -->
    <div id="manager-sales-panel-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-panel" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Painel de Vendas da Gerente</h2>
        </div>
        <div id="manager-sales-panel-content" class="collaborator-content" style="flex-direction: column; align-items: stretch; justify-content: flex-start; gap: 1.5rem; padding-top: 1rem; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área com os cards de cada vendedor -->
        </div>
    </div>

    <!-- TELA DE FECHAMENTO -->
    <div id="closing-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-closing" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Lançamento de Fechamento</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; align-items: stretch; justify-content: flex-start; gap: 1rem; padding-top: 1rem; overflow-y: auto;">
            
            <!-- Seleção da Loja -->
            <div id="closing-store-selection" class="modal-button-container" style="padding: 0 1rem;">
                 <h3 class="modal-title" style="font-size: 1.2rem;">Selecione a Loja</h3>
                 <button id="closing-btn-pinheiro" class="modal-btn">Pinheiro</button>
                 <button id="closing-btn-bacabal" class="modal-btn">Bacabal</button>
            </div>

            <!-- Formulário Pinheiro -->
            <div id="closing-form-pinheiro" style="display: none; padding: 0 1rem;">
                <!-- Formulário de Fechamento será gerado pelo JavaScript -->
            </div>
            
            <div id="closing-form-bacabal" style="display: none; padding: 0 1rem;">
                <!-- Formulário de Fechamento será gerado pelo JavaScript -->
            </div>
            
             <!-- Botão de Envio (comum aos dois forms) -->
            <div id="closing-submit-container" style="display: none; padding: 1.5rem 1rem;">
                <button id="submit-closing-data-btn" class="action-button"><i class="fa-solid fa-paper-plane"></i>Enviar Fechamento</button>
                <p id="closing-status-message" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE CORREÇÃO DE DADOS DE FUNCIONÁRIOS -->
    <div id="correction-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-correction" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Corrigir Dados de Vendas</h2>
        </div>
        <div id="correction-content-container" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área e o botão de salvar será adicionado aqui no final por ele -->
        </div>
    </div>

    <!-- Janela Modal para Suporte -->
    <div id="suporte-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-suporte-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Contato do Suporte</h3>
            <div class="modal-button-container">
                <a href="https://lojadohunter.wixsite.com/loja-do-hunter/cópia-pinheiro" target="_blank" class="modal-btn">Brasil Card</a>
                <a href="https://lojadohunter.wixsite.com/loja-do-hunter/cópia-pinheiro" target="_blank" class="modal-btn">Pay Mobi</a>
                <a href="tel:40201231" class="modal-btn">Credishop</a>
            </div>
        </div>
    </div>

    <!-- Janela Modal para Ordem de Serviço (OS) -->
    <div id="os-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-os-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Assistência Técnica</h3>
            <div class="modal-button-container">
                <a href="https://w.app/gkesxd" target="_blank" class="modal-btn">Realme</a>
            </div>
        </div>
    </div>

    <!-- TELA DE SOLICITAÇÃO DE ESTOQUE -->
    <div id="request-stock-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-stock" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Solicitar Estoque</h2>
        </div>
        <!-- Container principal com padding para não encostar no rodapé fixo -->
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; align-items: stretch; gap: 1rem; padding-bottom: 150px;">
            
            <!-- NOVO: Formulário de Pedido do Cliente -->
            <div class="employee-meta-card" style="max-width: none; margin-bottom: 0;">
                <h4>Adicionar Pedido do Cliente</h4>
                <div class="input-group" style="margin-bottom: 1rem;">
                    <label for="custom-item-name">Nome do Produto</label>
                    <input type="text" id="custom-item-name" class="data-input" placeholder="Ex: Smartphone">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="input-group" style="margin-bottom: 1rem; flex-grow: 1;">
                        <label for="custom-item-color">Cor</label>
                        <input type="text" id="custom-item-color" class="data-input" placeholder="Ex: Transparente">
                    </div>
                    <div class="input-group" style="margin-bottom: 1rem; max-width: 100px;">
                        <label for="custom-item-quantity">Qtd.</label>
                        <input type="number" id="custom-item-quantity" class="data-input" placeholder="10">
                    </div>
                </div>
                <button id="add-custom-stock-item-btn" class="action-button full-width" style="margin-top:0;"><i class="fa-solid fa-plus"></i>Adicionar ao Pedido</button>
            </div>

            <!-- Lista de produtos do Firebase -->
            <div id="stock-product-list">
                <!-- O JavaScript vai popular esta área com os cabeçalhos de marca e os cards -->
            </div>
        </div>
        <!-- Rodapé fixo para o "carrinho" -->
        <div id="stock-selection-footer" style="position: sticky; bottom: 0; background: rgba(30,30,60,0.9); backdrop-filter: blur(5px); padding: 1rem 1.5rem; display: none; width: 100%; text-align: center;">
            <h4>Itens Selecionados</h4>
            <div id="stock-selection-list"></div>
            
            <button id="send-stock-request-btn" class="action-button full-width"><i class="fa-solid fa-paper-plane"></i>Enviar Solicitação</button>
        </div>
    </div>

    <!-- TELA DE FORMULÁRIO DE ORDEM DE SERVIÇO (OS) -->
    <div id="os-form-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-os" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Ordem de Serviço</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <p class="os-warning">ATENÇÃO: REMOVA A SENHA DO APARELHO!</p>
            <div class="input-group"><label for="os-colaborador">COLABORADOR (Obrigatório)</label><input type="text" id="os-colaborador" class="data-input"></div>
            <div class="input-group"><label for="os-cidade">CIDADE REMETENTE (Obrigatório)</label><input type="text" id="os-cidade" class="data-input"></div>
            <div class="input-group"><label for="os-data">DATA DE ENVIO (Obrigatório)</label><input type="date" id="os-data" class="data-input"></div>

            <div class="employee-meta-card"><h4>Aparelho 1</h4>
                <div class="input-group"><label for="os-cliente-1">CLIENTE E TELEFONE</label><textarea id="os-cliente-1" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-1">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-1" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 2</h4>
                <div class="input-group"><label for="os-cliente-2">CLIENTE E TELEFONE</label><textarea id="os-cliente-2" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-2">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-2" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 3</h4>
                <div class="input-group"><label for="os-cliente-3">CLIENTE E TELEFONE</label><textarea id="os-cliente-3" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-3">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-3" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 4</h4>
                <div class="input-group"><label for="os-cliente-4">CLIENTE E TELEFONE</label><textarea id="os-cliente-4" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-4">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-4" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 5</h4>
                <div class="input-group"><label for="os-cliente-5">CLIENTE E TELEFONE</label><textarea id="os-cliente-5" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-5">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-5" class="data-input" rows="3"></textarea></div>
            </div>
            
            <div class="save-footer">
                <button id="submit-os-form-btn" class="action-button"><i class="fa-solid fa-envelope"></i>Enviar OS por Email</button>
                <p id="os-form-status" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE RECIBOS -->
    <div id="recibos-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-recibos" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Lançar Recibo de Gastos</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1.5rem; align-items: stretch; overflow-y: auto;">
            
            <div class="input-group"><label for="recibo-nome">NOME (Obrigatório)</label><input type="text" id="recibo-nome" class="data-input" placeholder="Seu nome"></div>
            <div class="input-group"><label for="recibo-loja">LOJA (Obrigatório)</label><input type="text" id="recibo-loja" class="data-input" placeholder="Pinheiro ou Bacabal"></div>

            <div class="input-group">
                <label for="recibo-data">DATA DO GASTO (Obrigatório)</label>
                <div class="date-input-group">
                    <input type="number" id="recibo-dia" class="data-input" placeholder="DD" min="1" max="31">
                    <input type="number" id="recibo-mes" class="data-input" placeholder="MM" min="1" max="12">
                    <input type="number" id="recibo-ano" class="data-input" placeholder="AAAA" min="2023">
                </div>
            </div>
            
            <div class="input-group"><label for="recibo-gastos">GASTOS (Descrição e Valor - Obrigatório)</label><textarea id="recibo-gastos" class="data-input" rows="4" placeholder="Ex: Almoço - R$ 15,00
Transporte - R$ 5,00"></textarea></div>
            
            <div style="width: 100%; max-width: 350px; text-align: center; margin-top: 1rem;">
                <button id="submit-recibo-btn" class="action-button"><i class="fa-solid fa-paper-plane"></i>Enviar Recibo</button>
                <p id="recibo-status-message" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE QUIZ (FEEDBACK) -->
    <div id="quiz-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-quiz" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Treinamento da Loja do Hunter</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1.5rem; align-items: stretch; overflow-y: auto;">
            
            <div class="input-group"><label for="quiz-nome">Nome (Obrigatório)</label><input type="text" id="quiz-nome" class="data-input" placeholder="Seu nome"></div>

            <div class="quiz-question-group">
                <label>1. Você gostou do conteúdo do treinamento?</label>
                <div class="radio-option"><input type="radio" id="gostou-sim-muito" name="gostou_treinamento" value="Sim, muito!"><label for="gostou-sim-muito">Sim, muito!</label></div>
                <div class="radio-option"><input type="radio" id="gostou-sim-bom" name="gostou_treinamento" value="Sim, foi bom."><label for="gostou-sim-bom">Sim, foi bom.</label></div>
                <div class="radio-option"><input type="radio" id="gostou-razoavel" name="gostou_treinamento" value="Foi razoável."><label for="gostou-razoavel">Foi razoável.</label></div>
                <div class="radio-option"><input type="radio" id="gostou-nao" name="gostou_treinamento" value="Não gostei muito."><label for="gostou-nao">Não gostei muito.</label></div>
            </div>

            <div class="input-group">
                <label for="quiz_parte_util">2. Qual parte você achou mais útil ou que mais chamou sua atenção?</label>
                <textarea id="quiz_parte_util" class="data-input" rows="3"></textarea>
            </div>

            <div class="quiz-question-group">
                <label>3. Teve alguma parte que ficou confusa ou você sentiu falta de mais explicações?</label>
                <div class="radio-option"><input type="radio" id="confusa-sim" name="parte_confusa" value="Sim"><label for="confusa-sim">Sim</label></div>
                <div class="radio-option"><input type="radio" id="confusa-nao" name="parte_confusa" value="Não"><label for="confusa-nao">Não</label></div>
                <div class="input-group" style="margin-top: 1rem; margin-bottom: 0;">
                    <label for="quiz_parte_confusa_detalhe">Se sim, qual parte?</label>
                    <textarea id="quiz_parte_confusa_detalhe" class="data-input" rows="2"></textarea>
                </div>
            </div>

            <div class="quiz-question-group">
                <label>4. Você sentiu que esse treinamento te ajudou a se sentir mais preparado(a) para vender e atender melhor?</label>
                <div class="radio-option"><input type="radio" id="ajudou-certeza" name="ajudou_preparar" value="Sim, com certeza"><label for="ajudou-certeza">Sim, com certeza</label></div>
                <div class="radio-option"><input type="radio" id="ajudou-pouco" name="ajudou_preparar" value="Um pouco"><label for="ajudou-pouco">Um pouco</label></div>
                <div class="radio-option"><input type="radio" id="ajudou-nao-muito" name="ajudou_preparar" value="Não muito"><label for="ajudou-nao-muito">Não muito</label></div>
                <div class="radio-option"><input type="radio" id="ajudou-nao" name="ajudou_preparar" value="Não"><label for="ajudou-nao">Não</label></div>
            </div>

            <div class="quiz-question-group">
                <label>5. Qual tema você gostaria que a gente abordasse no próximo treinamento?</label>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-redes" value="Abordagem nas redes sociais e atendimento online"><label for="tema-redes">Abordagem nas redes sociais e atendimento online</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-metas" value="Como bater metas de forma leve e planejada"><label for="tema-metas">Como bater metas de forma leve e planejada</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-clientes" value="Técnicas para lidar com clientes indecisos ou difíceis"><label for="tema-clientes">Técnicas para lidar com clientes indecisos ou difíceis</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-sistema" value="Como usar melhor o sistema Hunter Vendas"><label for="tema-sistema">Como usar melhor o sistema Hunter Vendas</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-outro" value="Outro"><label for="tema-outro">Outro:</label></div>
                <input type="text" id="quiz_proximo_tema_outro" class="data-input" style="margin-left: 2rem; width: calc(100% - 2rem);">
            </div>

            <div class="input-group">
                <label for="quiz_sugestao">6. Deixe aqui alguma sugestão, elogio ou crítica (opcional):</label>
                <textarea id="quiz_sugestao" class="data-input" rows="3"></textarea>
            </div>
            
            <div style="width: 100%; max-width: 350px; text-align: center; margin-top: 1rem;">
                <button id="submit-quiz-btn" class="action-button"><i class="fa-solid fa-paper-plane"></i>Enviar Feedback</button>
                <p id="quiz-status-message" class="status-message"></p>
            </div>
        </div>
    </div>




    <!-- TELA PARA DIGITAR PONTO (CÂMERA) -->
    <div id="ponto-page" style="display: none; background-color: #000;">
        <div class="collaborator-header" style="background: #000;">
            <button id="back-to-collab-from-ponto" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Digitar Ponto</h2>
        </div>
        <div class="ponto-camera-container">
            <video id="ponto-video" playsinline autoplay muted></video>
            <canvas id="ponto-canvas" style="display: none;"></canvas>
            <div class="ponto-camera-overlay">
                <p>Centralize seu rosto no círculo</p>
                <div class="ponto-circle-guide"></div>
            </div>
            <div id="ponto-status-message" class="status-message" style="position: absolute; bottom: 100px; width: 100%; color: white; background: rgba(0,0,0,0.5); padding: 0.5rem 0;"></div>
            <div class="ponto-controls">
                <button id="capture-ponto-btn" class="ponto-capture-button">
                    <i class="fa-solid fa-camera"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- TELA DE VERIFICAÇÃO DE PONTO (LISTA DE FUNCIONÁRIOS) -->
    <div id="ponto-verification-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-ponto-verify" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Verificar Ponto</h2>
        </div>
        <div id="ponto-employee-list" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular a lista de funcionários aqui -->
        </div>
    </div>

    <!-- TELA DE HISTÓRICO DE PONTO DE UM FUNCIONÁRIO -->
    <div id="ponto-history-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-ponto-verify-from-history" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="ponto-history-title">Histórico de Ponto</h2>
        </div>
        <div id="ponto-history-container" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular o histórico aqui -->
        </div>
    </div>


    <!-- TELA DE VISUALIZAÇÃO DE IMAGEM (NOVA) -->
    <div id="image-viewer-overlay" class="modal-overlay">
        <button id="close-viewer-btn" class="modal-close-btn" style="z-index: 10;">×</button>
        <img id="viewer-image" src="" alt="Imagem ampliada">
    </div>

    <!-- Janela Modal para Seleção de Tema -->
    <div id="theme-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-theme-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Escolha um Tema</h3>
            <div class="modal-button-container">
                <button class="modal-btn theme-select-btn" data-theme="default">Padrão</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-gamer">Gamer</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-hunter">Hunter (Laranja)</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-rosa">Rosa</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-black">Black</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-claro">Claro</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-lgbt">LGBT</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-grayx">Cinza X</button>
            </div>
        </div>
    </div>

    <!-- Elemento para exibir a versão -->
    <div id="app-version-display"></div>

    <!-- Container para o Tema Cinza X -->
<div id="floating-x-container"></div>
<!-- Container para o Tema Rosa -->
<div id="floating-dots-container"></div>
<!-- Container para o Tema Natalino -->
<div id="snow-container"></div>
<img id="santa-animation" src="https://dbdzm869oupei.cloudfront.net/img/t-shirts/preview/67749.png" alt="Papai Noel">

    <!-- TELA DE GERENCIAMENTO DE FERIADOS -->
    <div id="holidays-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-holidays" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Feriados</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Adicionar Novo Feriado</h4>
                <div class="input-group">
                    <label for="holiday-date-input">Selecione a Data</label>
                    <input type="date" id="holiday-date-input" class="data-input">
                </div>
                <button id="add-holiday-btn" class="action-button"><i class="fa-solid fa-calendar-plus"></i>Adicionar Feriado</button>
                <p id="holiday-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Feriados Cadastrados</h4>
                <div id="holidays-list-container">
                    <!-- Lista de feriados será carregada aqui -->
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DE GERENCIAMENTO DE DOMINGOS DE TRABALHO -->
    <div id="sundays-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-sundays" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Domingos de Trabalho</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Adicionar Domingo de Trabalho</h4>
                <div class="input-group">
                    <label for="sunday-date-input">Selecione o Domingo</label>
                    <input type="date" id="sunday-date-input" class="data-input">
                </div>
                <button id="add-sunday-btn" class="action-button"><i class="fa-solid fa-calendar-plus"></i>Adicionar Domingo</button>
                <p id="sunday-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Domingos Cadastrados</h4>
                <div id="sundays-list-container">
                    <!-- Lista de domingos será carregada aqui -->
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

                <!-- TELA DE GERENCIAMENTO DE FOLGAS -->
    <div id="day-off-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-day-off" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Folgas</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Adicionar Folga</h4>
                 <div class="input-group">
                    <label for="day-off-employee-select">Selecione o Colaborador</label>
                    <select id="day-off-employee-select" class="data-input">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label for="day-off-date-input">Selecione a Data da Folga</label>
                    <input type="date" id="day-off-date-input" class="data-input">
                </div>
                <button id="add-day-off-btn" class="action-button"><i class="fa-solid fa-calendar-plus"></i>Adicionar Folga</button>
                <p id="day-off-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Folgas Agendadas</h4>
                <div id="days-off-list-container">
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DE GERENCIAMENTO DE VERBA DE LOJA -->
    <div id="store-cash-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-store-cash" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gestão de Verba de Loja</h2>
        </div>
        <div id="store-cash-management-content" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JS vai popular esta área -->
        </div>
    </div>

    <!-- NOVA TELA DE GERENCIAMENTO DE VERBA DE VENDA REMOTA -->
    <div id="venda-remota-cash-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-venda-remota-cash" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gestão de Verba de Site</h2>
        </div>
        <div id="venda-remota-cash-management-content" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JS vai popular esta área -->
        </div>
    </div>

     <!-- TELA DE GERENCIAMENTO DE HORAS EXTRAS -->
    <div id="overtime-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-overtime" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Horas Extras</h2>
        </div>
        <div id="overtime-management-content" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JS vai popular esta área e o botão de salvar será adicionado aqui no final por ele -->
        </div>
    </div>

    <!-- TELA DE GERENCIAMENTO DE CAIXA -->
    <div id="cash-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-cash" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gestão de CDC</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <!-- Cards de Status do Caixa -->
            <div id="cash-status-cards-container">
                <!-- JS vai popular com os cards dos gerentes -->
            </div>

            <!-- Card de Histórico de Gastos -->
            <div class="employee-meta-card">
                <h4>Histórico de Gastos Recentes</h4>
                <div id="expense-history-list">
                    <p style="text-align:center;">Carregando histórico...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DE GERENCIAMENTO DE AVISOS GERAIS -->
    <div id="avisos-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-avisos" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Avisos</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Novo Aviso (dura 24h)</h4>
                <div class="input-group">
                    <label for="aviso-name">Seu Nome</label>
                    <input type="text" id="aviso-name" class="data-input" placeholder="Ex: Beatriz">
                </div>
                 <div class="input-group">
                    <label for="aviso-photo-upload">Sua Foto de Perfil (Obrigatório)</label>
                    <button id="aviso-upload-btn" class="action-button full-width"><i class="fa-solid fa-user-plus"></i> Enviar sua Foto</button>
                    <input type="file" id="aviso-photo-upload" accept="image/*" style="display: none;">
                    <p id="aviso-photo-status" class="status-message" style="margin-top: 0.5rem;"></p>
                </div>
                <div class="input-group">
                    <label for="aviso-text">Mensagem do Aviso</label>
                    <textarea id="aviso-text" class="data-input" rows="3" placeholder="Escreva o aviso aqui..."></textarea>
                </div>
                <div class="input-group">
                    <label for="aviso-content-image-upload">Foto ou GIF do Aviso (Opcional)</label>
                    <button id="aviso-content-upload-btn" class="action-button full-width" style="background-color: #3498db;"><i class="fa-solid fa-image"></i> Enviar Foto/GIF</button>
                    <input type="file" id="aviso-content-image-upload" accept="image/*,image/gif" style="display: none;">
                    <p id="aviso-content-photo-status" class="status-message" style="margin-top: 0.5rem;"></p>
                </div>
                <button id="save-aviso-btn" class="action-button full-width"><i class="fa-solid fa-paper-plane"></i>Enviar Aviso</button>
                <p id="aviso-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Avisos Ativos</h4>
                <div id="avisos-list-container">
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>


    <!-- TELA LOLLIPOP -->
    <div id="lollipop-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-send-device-from-lollipop" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Lollipop</h2>
            <!-- Botão para excluir tudo -->
            <button id="delete-all-lollipop-btn" class="action-button delete-button" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); width: auto; padding: 0.5rem 1rem; font-size: 0.8rem;">
                <i class="fa-solid fa-trash-can"></i> Excluir Tudo
            </button>
        </div>
        <div id="lollipop-grid" class="collaborator-content" style="flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: flex-start; gap: 1rem; overflow-y: auto;">
            <!-- Itens serão carregados aqui -->
        </div>
    </div>





    <!-- Elementos Ocultos para Captura de Câmera -->
    <video id="capture-video-element" playsinline autoplay muted style="display: none;"></video>
    <canvas id="capture-canvas-element" style="display: none;"></canvas>


    <!-- TELA DE FEEDBACK DE ERRO/SUGESTÃO -->
    <div id="feedback-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-feedback" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Erro ou Sugestão</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card" style="max-width: none;">
                <h4>Relate um Erro ou Dê uma Sugestão</h4>
                 <div class="input-group">
                    <label for="feedback-name">Seu Nome</label>
                    <input type="text" id="feedback-name" class="data-input" placeholder="Ex: Eliseu">
                </div>
                <div class="input-group">
                    <label for="feedback-message">Mensagem</label>
                    <textarea id="feedback-message" class="data-input" rows="5" placeholder="Descreva o erro que encontrou ou a sua sugestão para melhorar o aplicativo..."></textarea>
                </div>
                <button id="submit-feedback-btn" class="action-button full-width"><i class="fa-solid fa-paper-plane"></i>Enviar Feedback</button>
                <p id="feedback-status-message" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE DEBUG (não será mais usada para feedback, mas mantida para outras funções) -->
    <div id="debug-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-debug" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Painel de Debug</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            
            <!-- Card de Estatísticas -->
            <div class="employee-meta-card" style="max-width: none;">
                <h4>Estatísticas de Uso</h4>
                <div id="debug-stats-container">
                    <p>Carregando estatísticas...</p>
                </div>
            </div>

            <!-- CARD PARA CONTAS E SENHAS -->
            <div class="employee-meta-card" style="max-width: none;">
                <h4>Contas e Senhas</h4>
                <button id="show-accounts-btn" class="action-button full-width">
                    <i class="fa-solid fa-users"></i> Mostrar Contas
                </button>
                <div id="debug-accounts-container" style="margin-top: 1.5rem;">
                    <!-- A lista de contas aparecerá aqui -->
                </div>
            </div>

            <!-- NOVO CARD PARA AÇÕES PERIGOSAS -->
            <div class="employee-meta-card" style="max-width: none;">
                <h4>Ações Perigosas</h4>
                <button id="clear-all-chats-btn" class="action-button full-width" style="background-color: rgba(231, 76, 60, 0.7);">
                    <i class="fa-solid fa-comment-slash"></i> Limpar Todas as Mensagens de Chat
                </button>
            </div>

        </div>
    </div>


    <!-- =================================================================== -->
    <!-- NOVAS TELAS PARA VISUALIZAÇÃO DE SUBMISSÕES (GS) -->
    <!-- =================================================================== -->

    <!-- TELA PARA VER SOLICITAÇÕES DE ESTOQUE -->
    <div id="stock-requests-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-stock-requests" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="stock-requests-title">Solicitações de Estoque</h2>
        </div>
        <div id="stock-requests-list" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular a lista de solicitações aqui -->
        </div>
    </div>

    <!-- TELA PARA VER RECIBOS -->
    <div id="recibos-submissions-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-recibos" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="recibos-submissions-title">Recibos Enviados</h2>
        </div>
        <div id="recibos-submissions-list" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular a lista de recibos aqui -->
        </div>
    </div>

    <!-- TELA PARA VER RESPOSTAS DO QUIZ -->
    <div id="quiz-submissions-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-quiz" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="quiz-submissions-title">Respostas do Quiz</h2>
        </div>
        <div id="quiz-submissions-list" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular a lista de respostas do quiz aqui -->
        </div>
    </div>

    <!-- TELA PARA VER FEEDBACKS -->
    <div id="feedback-submissions-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-feedback" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="feedback-submissions-title">Feedbacks Recebidos</h2>
        </div>
        <div id="feedback-submissions-list" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular a lista de feedbacks aqui -->
        </div>
    </div>

    <!-- TELA DE CRIAÇÃO DE STORY PELA GERÊNCIA -->
    <div id="story-creation-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-story-creation" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Enviar Story Geral</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card" style="max-width: none;">
                <h4>Criar novo Story (dura 24h)</h4>
                 <div class="input-group">
                    <label for="story-creator-name">Nome do Postador</label>
                    <input type="text" id="story-creator-name" class="data-input" placeholder="Ex: Loja do Hunter">
                </div>
                <div class="input-group">
                    <label for="story-creator-photo-upload">Foto de Perfil do Postador</label>
                    <button id="story-creator-upload-btn" class="action-button full-width"><i class="fa-solid fa-user-plus"></i> Enviar Foto</button>
                    <input type="file" id="story-creator-photo-upload" accept="image/*" style="display: none;">
                    <p id="story-creator-photo-status" class="status-message" style="margin-top: 0.5rem;"></p>
                </div>
                 <div class="input-group">
                    <label for="story-content-upload">Conteúdo do Story (Foto ou Vídeo)</label>
                    <button id="story-content-upload-btn" class="action-button full-width" style="background-color: #3498db;"><i class="fa-solid fa-image"></i> Enviar Mídia</button>
                    <input type="file" id="story-content-upload" accept="image/*,video/*" style="display: none;">
                    <p id="story-content-status" class="status-message" style="margin-top: 0.5rem;"></p>
                </div>
                <button id="submit-general-story-btn" class="action-button full-width"><i class="fa-solid fa-paper-plane"></i>Enviar Story</button>
                <p id="general-story-status-message" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DO VISUALIZADOR DE STORIES -->
    <div id="story-viewer-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; flex-direction: column;">
        <!-- NOVAS ÁREAS DE NAVEGAÇÃO -->
        <div id="story-nav-prev" class="story-nav-arrow"></div>
        <div id="story-nav-next" class="story-nav-arrow"></div>

        <div id="story-progress-container"></div>
        <div id="story-header">
            <img id="story-user-photo" src="" alt="User">
            <span id="story-user-name"></span>
            <button id="close-story-viewer-btn" class="modal-close-btn" style="color: #fff; top: 15px; right: 15px;">×</button>
        </div>
        <div id="story-content-area">
            <!-- Imagem ou vídeo será inserido aqui -->
        </div>
        <div id="story-reply-area">
            <input type="text" id="story-reply-input" placeholder="Responder...">
            <button id="send-story-reply-btn"><i class="fa-solid fa-paper-plane"></i></button>
            <!-- NOVOS ELEMENTOS -->
            <button id="like-story-btn"><i class="fa-regular fa-heart"></i></button>
            <div id="story-likes-info" style="display: none;">
                <span id="story-likes-count">0</span> curtidas
            </div>
        </div>
    </div>

    <!-- TELA DE CHATS -->
    <div id="chat-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-chat" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Chats e Respostas</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- Lista de conversas e respostas de stories aqui -->
             <div id="chat-list-container">
                <p style="text-align:center;">Carregando...</p>
             </div>
        </div>
    </div>

    <!-- TELA DE CONVERSA INDIVIDUAL -->
    <!-- MODAL PARA AÇÕES DE CHAT (EDITAR/APAGAR) -->
    <div id="chat-action-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 250px;">
            <div id="chat-action-buttons" class="modal-button-container">
                <button id="chat-edit-btn" class="modal-btn">Editar Mensagem</button>
                <button id="chat-delete-btn" class="modal-btn" style="background-color: rgba(231, 76, 60, 0.7);">Apagar Mensagem</button>
            </div>
        </div>
    </div>

    <!-- TELA DE CONVERSA INDIVIDUAL -->
    <div id="chat-conversation-page" style="display: none;">
         <div class="collaborator-header">
            <button id="back-to-chatlist-from-convo" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="chat-conversation-title">Conversa</h2>
        </div>
        <div id="chat-messages-container" class="collaborator-content">
            <!-- Mensagens aqui -->
        </div>
        <div id="chat-input-area">
            <!-- NOVO BOTÃO DE MÍDIA E INPUT OCULTO -->
            <button id="send-media-btn" class="action-button" style="width: 50px; height: 50px; padding: 0; margin: 0; aspect-ratio: 1/1; background: #333;"><i class="fa-solid fa-paperclip"></i></button>
            <input type="file" id="media-upload-input" accept="image/*,video/*" style="display: none;">
            
            <input type="text" id="chat-message-input" class="data-input" placeholder="Digite uma mensagem...">
            <button id="send-chat-message-btn" class="action-button" style="width: 50px; height: 50px; padding: 0; margin: 0; aspect-ratio: 1/1;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- SCRIPTS (CARREGADOS NA ORDEM CORRETA) -->
    <!-- =================================================================== -->

    <!-- 1. Scripts da biblioteca do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> <!-- ADICIONADO -->

    <!-- 2. Seu script principal -->
            <script>
    // --- VERSÃO DO APLICATIVO ---
                //2805
    const APP_VERSION = '4.0.5 - D '; // Altere este número para atualizar a versão
    const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwrtULaONXOEjigQ5i9Tqnh1_Bnd0VIJJxBUy9qZgknwtm6FcGB0Dx2Ip-dMl_PyJ3Itg/exec';

    const CASH_BOX_INITIAL_VALUE = 1000;
    const SITE_CASH_BOX_INITIAL_VALUE = 5000;
    const DEFAULT_PROFILE_PHOTO = 'https://faunanews.com.br/wp-content/uploads/2022/02/image-19.png';

    // Sua configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBxZ041My0mTu8CP9bDvEQ4K3p_wHBIF_c",
      authDomain: "loja-do-hunter-painel.firebaseapp.com",
      databaseURL: "https://loja-do-hunter-painel-default-rtdb.firebaseio.com",
      projectId: "loja-do-hunter-painel",
      storageBucket: "loja-do-hunter-painel.firebasestorage.app",
      messagingSenderId: "794925486853",
      appId: "1:794925486853:web:7b136eefd4a5d337605d6c"
    };

    // Inicializa o Firebase (Database)
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Inicializa o Supabase (Storage)
    const SUPABASE_URL = 'https://pzhsslgzhpetuhvyshxo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6aHNzbGd6aHBldHVodnlzaHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMDYzMzYsImV4cCI6MjA3NTY4MjMzNn0.r7xRsI2Yqfqq77GtvpLDnch8tWQf6KGrkYg5xTZTybw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- CONSTANTES DE SENHA ---
    const PASSWORD = '123789';
    const DEBUG_PASSWORD = '2805';

    // Variáveis para guardar as instâncias dos gráficos e evitar duplicação
    let storeChartInstance = null;
    let employeeChartInstance = null;
    let monthlySalesChartInstance = null;
    let employeeGoalProgressChartInstance = null; // Variável para o novo gráfico
    let currentPontoAction = null; // Variável para controlar a ação de ponto atual
    let pontoCheckTimeout = null; // Timer para a próxima verificação de estado
    let countdownInterval = null; // Para controlar o timer da contagem regressiva

                                // --- ESTADO DA APLICAÇÃO ---
    const allCollaborators = ['Beatriz', 'Mainara', 'Eliseu', 'Eduardo', 'Natalia', 'Tacilio', 'Demilson', 'Leonardo', 'Jose'];
    const newAdmins = ['Paulo', 'Keliane', 'Ducielma', 'Isabela'];
    const storeManagers = ['Beatriz', 'Natalia']; // NOVA LISTA: Apenas gerentes de loja
    const allUsers = [...allCollaborators, ...newAdmins]; // Lista unificada para funções genéricas
    const managers = [...storeManagers, ...newAdmins]; // Lista de todos com acesso GS
    const storeMapping = {
        pinheiro: ['Beatriz','Mainara', 'Eliseu', 'Eduardo'],
        bacabal: ['Natalia', 'Tacilio', 'Demilson', 'Leonardo', 'Jose']
    };;
    let currntUserName = ''; // Variável unificada para o usuário logado
    let currentBrand = '';
    let isNavigating = false; // Flag para prevenir cliques duplos durante animações
    let stockRequestSelection = []; // Array para guardar os itens solicitados
    let cameraStream = null; // Para controlar o stream da câmera
    let editingDeviceKey = null; // Para controlar se estamos editando ou criando um dispositivo
    let allDevicesCache = []; // Cache para a busca de aparelhos
    let storiesCache = []; // Cache para os stories
    let currentStoryUser = null; // Usuário do story que está sendo visto
    let currentStoryIndex = 0; // Índice do story atual
    let storyTimeout = null; // Timer para avançar o story
    let currentOpenChatId = null; // ID da conversa de chat aberta

    // --- ELEMENTOS DO DOM ---
    const mainContainer = document.querySelector('.mobile-container');
    const allPages = document.querySelectorAll('.page, .modal-overlay'); // Pega todas as "telas"

    // Adiciona a classe 'page' onde for necessário
    document.getElementById('ponto-page').classList.add('page');
    document.getElementById('ponto-verification-page').classList.add('page');
    document.getElementById('ponto-history-page').classList.add('page');
    document.getElementById('collaborator-page').classList.add('page');
    document.getElementById('gs-page').classList.add('page');
    document.getElementById('metas-config-page').classList.add('page');
    document.getElementById('metas-display-page').classList.add('page');
    document.getElementById('send-device-page').classList.add('page');
    document.getElementById('brand-devices-page').classList.add('page');
    document.getElementById('device-detail-page').classList.add('page');
    document.getElementById('manager-sales-panel-page').classList.add('page');
    document.getElementById('closing-page').classList.add('page');
    document.getElementById('correction-page').classList.add('page');
    document.getElementById('os-form-page').classList.add('page');
    document.getElementById('request-stock-page').classList.add('page');
    document.getElementById('recibos-page').classList.add('page');
    document.getElementById('quiz-page').classList.add('page');
    document.getElementById('crediario-calculator-page').classList.add('page');
    document.getElementById('site-calculator-page').classList.add('page');
    document.getElementById('loja-calculator-page').classList.add('page');
    document.getElementById('mt-display-page').classList.add('page');
    document.getElementById('mt-management-page').classList.add('page');
    document.getElementById('holidays-management-page').classList.add('page');
    document.getElementById('sundays-management-page').classList.add('page');
    document.getElementById('day-off-management-page').classList.add('page');
    document.getElementById('lollipop-page').classList.add('page');
    document.getElementById('device-search-overlay').classList.add('page');
    document.getElementById('avisos-management-page').classList.add('page'); // Nova página
    document.getElementById('feedback-page').classList.add('page');
    document.getElementById('debug-page').classList.add('page');
    document.getElementById('cash-management-page').classList.add('page');
    document.getElementById('store-cash-management-page').classList.add('page');
    document.getElementById('story-creation-page').classList.add('page');
    document.getElementById('chat-page').classList.add('page');
    document.getElementById('chat-conversation-page').classList.add('page');
    document.getElementById('login-overlay').classList.add('page'); // Adiciona a tela de login

    // ADICIONANDO AS NOVAS PÁGINAS DE SUBMISSÃO
    document.getElementById('stock-requests-page').classList.add('page');
    document.getElementById('recibos-submissions-page').classList.add('page');
    document.getElementById('quiz-submissions-page').classList.add('page');
    document.getElementById('feedback-submissions-page').classList.add('page');





                const elements = {
        mainContainer: mainContainer,
        modal: document.getElementById('colaborador-modal'),
        collaboratorPage: document.getElementById('collaborator-page'),
        gsPage: document.getElementById('gs-page'),
        metasConfigPage: document.getElementById('metas-config-page'),
        metasDisplayPage: document.getElementById('metas-display-page'),
        sendDevicePage: document.getElementById('send-device-page'),
        brandDevicesPage: document.getElementById('brand-devices-page'),
        deviceDetailPage: document.getElementById('device-detail-page'),
        managerSalesPanelPage: document.getElementById('manager-sales-panel-page'),
        closingPage: document.getElementById('closing-page'),
        correctionPage: document.getElementById('correction-page'),
        suporteModal: document.getElementById('suporte-modal'),
        osModal: document.getElementById('os-modal'),
        osFormPage: document.getElementById('os-form-page'),
        requestStockPage: document.getElementById('request-stock-page'),
        recibosPage: document.getElementById('recibos-page'),
       quizPage: document.getElementById('quiz-page'), // Nova página
        crediarioCalculatorPage: document.getElementById('crediario-calculator-page'),
        siteCalculatorPage: document.getElementById('site-calculator-page'),
        lojaCalculatorPage: document.getElementById('loja-calculator-page'),
        mtDisplayPage: document.getElementById('mt-display-page'),
        mtManagementPage: document.getElementById('mt-management-page'),
        holidaysManagementPage: document.getElementById('holidays-management-page'),
        sundaysManagementPage: document.getElementById('sundays-management-page'),
        dayOffManagementPage: document.getElementById('day-off-management-page'),
        overtimeManagementPage: document.getElementById('overtime-management-page'), // <<< LINHA ADICIONADA AQUI
        lollipopPage: document.getElementById('lollipop-page'),
        pontoPage: document.getElementById('ponto-page'),
        pontoVerificationPage: document.getElementById('ponto-verification-page'),
        pontoHistoryPage: document.getElementById('ponto-history-page'),
        searchOverlay: document.getElementById('search-overlay'),
        themeModal: document.getElementById('theme-modal'),
        deviceSearchOverlay: document.getElementById('device-search-overlay'),
        avisosManagementPage: document.getElementById('avisos-management-page'), // Nova página
        feedbackPage: document.getElementById('feedback-page'),
        debugPage: document.getElementById('debug-page'),
        cashManagementPage: document.getElementById('cash-management-page'),
        storeCashManagementPage: document.getElementById('store-cash-management-page'),
        vendaRemotaCashManagementPage: document.getElementById('venda-remota-cash-management-page'), // NOVA PÁGINA

        // ADICIONANDO AS NOVAS PÁGINAS DE SUBMISSÃO
        stockRequestsPage: document.getElementById('stock-requests-page'),
        recibosSubmissionsPage: document.getElementById('recibos-submissions-page'),
        quizSubmissionsPage: document.getElementById('quiz-submissions-page'),
        feedbackSubmissionsPage: document.getElementById('feedback-submissions-page'),
        
        // NOVOS ELEMENTOS PARA STORIES E CHAT
        storyCreationPage: document.getElementById('story-creation-page'),
        storyViewerOverlay: document.getElementById('story-viewer-overlay'),
        chatPage: document.getElementById('chat-page'),
        chatConversationPage: document.getElementById('chat-conversation-page'),
    };
    // --- LÓGICA DE NAVEGAÇÃO E ANIMAÇÃO (REFEITA DO ZERO) ---
    function staggerAnimate(container) {
        const items = container.querySelectorAll('.brand-button, .tool-item, .device-card, .modal-btn, .action-button');
        items.forEach((item, index) => {
            item.style.animationDelay = `${index * 40}ms`;
        });
    }

        // --- FUNÇÕES DE STORIES ---

    const loadAndDisplayStories = async () => {
        const storiesScroll = document.getElementById('stories-scroll');
        storiesScroll.innerHTML = ''; // Limpa antes de carregar

        try {
            const storiesSnap = await database.ref('stories').get();
            const profilesSnap = await database.ref('userProfiles').get();
            const storiesData = storiesSnap.exists() ? storiesSnap.val() : {};
            const profilesData = profilesSnap.exists() ? profilesSnap.val() : {};
            const now = new Date();
            
            const activeStoriesByUser = {};

            // 1. Filtra stories ativos (últimas 24h) e agrupa por usuário
            for (const key in storiesData) {
                const story = storiesData[key];
                const storyTimestamp = new Date(story.timestamp);
                const hoursDiff = (now - storyTimestamp) / (1000 * 60 * 60);
                if (hoursDiff < 24) {
                    if (!activeStoriesByUser[story.userId]) {
                        activeStoriesByUser[story.userId] = [];
                    }
                    activeStoriesByUser[story.userId].push({ key, ...story });
                }
            }
            
            storiesCache = activeStoriesByUser; // Atualiza o cache global

            // 2. Ordena a lista de TODOS os usuários, FILTRANDO a Beatriz
            const sortedUsers = [...allUsers].filter(name => name !== 'Beatriz').sort((a, b) => {
                const aHasStory = !!activeStoriesByUser[a.toLowerCase()];
                const bHasStory = !!activeStoriesByUser[b.toLowerCase()];
                // Se 'a' tem story e 'b' não, 'a' vem primeiro (-1).
                // Se 'b' tem story e 'a' não, 'b' vem primeiro (1).
                // Se ambos têm ou não têm, mantém a ordem original (0).
                return bHasStory - aHasStory;
            });

            // 3. Cria os círculos na tela na ordem correta
            sortedUsers.forEach(name => {
                const userId = name.toLowerCase();
                const hasStory = !!activeStoriesByUser[userId];
                const profile = profilesData[userId];
                                const photoUrl = profile?.photoURL || DEFAULT_PROFILE_PHOTO;

                const wrapper = document.createElement('div');
                wrapper.className = 'story-circle-wrapper';
                if (hasStory) {
                    wrapper.classList.add('has-story');
                    wrapper.dataset.userId = userId;
                }
                wrapper.innerHTML = `<img src="${photoUrl}" alt="${name}">`;
                storiesScroll.appendChild(wrapper);
            });
            
            // Lógica do botão de apagar permanece a mesma
            if (currentUserName) {
                const deleteMyStoryBtn = document.getElementById('delete-my-story-btn');
                if (deleteMyStoryBtn) {
                    const loggedInUserKey = currentUserName.toLowerCase();
                    deleteMyStoryBtn.style.display = storiesCache[loggedInUserKey] ? 'flex' : 'none';
                }
            }

        } catch (error) {
            console.error("Erro ao carregar stories:", error);
        }
    };
    
    const handleStoryUpload = async (file) => {
        if (!file) return;

        alert('Enviando seu story...');
        const userKey = currentUserName.toLowerCase();
        const contentType = file.type.startsWith('video/') ? 'video' : 'image';
        
        try {
            // 1. Define o caminho do arquivo no Supabase Storage
            const filePath = `${userKey}/${new Date().getTime()}_${file.name}`;

            // 2. Faz o upload para o bucket 'stories'
            const { error: uploadError } = await supabase.storage
                .from('stories') // NOME DO SEU BUCKET DE STORIES
                .upload(filePath, file);

            if (uploadError) throw uploadError;

            // 3. Pega a URL pública do arquivo enviado
            const { data: urlData } = supabase.storage
                .from('stories')
                .getPublicUrl(filePath);
            
            const contentUrl = urlData.publicUrl;

            // 4. O resto da lógica para salvar no Firebase DB continua a mesma
            const profileSnap = await database.ref(`userProfiles/${userKey}`).get();
            const profileData = profileSnap.exists() ? profileSnap.val() : {};
            
            const storyData = {
                userId: userKey,
                userName: currentUserName,
                userPhoto: profileData.photoURL || null,
                contentUrl: contentUrl,
                contentType: contentType,
                timestamp: new Date().toISOString()
            };
            
            await database.ref('stories').push(storyData);

            alert('Story publicado com sucesso!');
            loadAndDisplayStories();

        } catch (error) {
            alert('Erro ao publicar o story.');
            console.error("Erro no upload do story para o Supabase:", error);
        }
    };
    
    const openStoryViewer = (userId) => {
        const userStories = storiesCache[userId];
        if (!userStories || userStories.length === 0) return;
        
        currentStoryUser = userId;
        currentStoryIndex = 0;
        
        elements.storyViewerOverlay.style.display = 'flex';
        renderStory();
    };

    const toggleStoryLike = async (storyKey, likeButton) => {
        const userKey = currentUserName.toLowerCase();
        const likeRef = database.ref(`storyLikes/${storyKey}/${userKey}`);
        
        try {
            const snapshot = await likeRef.get();
            if (snapshot.exists()) {
                // Se já curtiu, descurte (remove o like)
                await likeRef.remove();
                likeButton.innerHTML = '<i class="fa-regular fa-heart"></i>'; // Coração vazio
            } else {
                // Se não curtiu, curte (adiciona o like)
                await likeRef.set({ userName: currentUserName });
                likeButton.innerHTML = '<i class="fa-solid fa-heart"></i>'; // Coração preenchido
            }
            // Atualiza a contagem na tela
            const likesCountSnap = await database.ref(`storyLikes/${storyKey}`).get();
            document.getElementById('story-likes-count').textContent = likesCountSnap.exists() ? likesCountSnap.numChildren() : 0;
        } catch (error) {
            console.error("Erro ao curtir/descurtir story:", error);
        }
    };

    const showStoryLikers = async (storyKey) => {
        try {
            const snapshot = await database.ref(`storyLikes/${storyKey}`).get();
            if (!snapshot.exists()) {
                alert("Ninguém curtiu este story ainda.");
                return;
            }
            const likersData = snapshot.val();
            const likerNames = Object.values(likersData).map(like => like.userName);
            alert(`Curtido por:\n\n- ${likerNames.join('\n- ')}`);
        } catch (error) {
            console.error("Erro ao buscar quem curtiu:", error);
            alert("Não foi possível carregar a lista de curtidas.");
        }
    };

    const renderStory = async () => {
        clearTimeout(storyTimeout);
        
        const userStories = storiesCache[currentStoryUser];
        if (!userStories || currentStoryIndex >= userStories.length) {
            closeStoryViewer();
            return;
        }
        
        const story = userStories[currentStoryIndex];
        const storyKey = story.key;
        const userKey = currentUserName.toLowerCase();

        // 1. Renderiza barras de progresso e header (como antes)
        const progressContainer = document.getElementById('story-progress-container');
        progressContainer.innerHTML = userStories.map((_, index) => {
            const progressClass = index < currentStoryIndex ? 'style="width: 100%;"' : (index === currentStoryIndex ? 'class="active"' : '');
            return `<div class="story-progress-bar"><div ${progressClass}></div></div>`;
        }).join('');
        document.getElementById('story-user-photo').src = story.userPhoto || DEFAULT_PROFILE_PHOTO;
        document.getElementById('story-user-name').textContent = story.userName;

        // 2. Renderiza o conteúdo
        const contentArea = document.getElementById('story-content-area');
        contentArea.innerHTML = ''; // Limpa conteúdo anterior para garantir reinicialização
        
        if (story.contentType === 'video') {
            const video = document.createElement('video');
            video.src = story.contentUrl;
            video.autoplay = true;
            video.playsInline = true;
            video.onended = nextStory;
            contentArea.appendChild(video);
        } else {
            contentArea.innerHTML = `<img src="${story.contentUrl}" alt="Story">`;
            storyTimeout = setTimeout(() => {
                const progressBarFill = progressContainer.querySelector('.active');
                if(progressBarFill) {
                   progressBarFill.parentElement.querySelector('div').style.transition = 'width 5s linear';
                   progressBarFill.parentElement.querySelector('div').style.width = '100%';
                }
                storyTimeout = setTimeout(nextStory, 5000);
            }, 100);
        }

        // 3. Busca e renderiza os dados de curtida
        const likeButton = document.getElementById('like-story-btn');
        const likesInfo = document.getElementById('story-likes-info');
        const likesCountEl = document.getElementById('story-likes-count');

        try {
            const likesSnap = await database.ref(`storyLikes/${storyKey}`).get();
            const likesCount = likesSnap.exists() ? likesSnap.numChildren() : 0;
            const userHasLiked = likesSnap.exists() && likesSnap.hasChild(userKey);

            // Atualiza o botão de curtir
            likeButton.innerHTML = userHasLiked ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>';
            // Usa .onclick para remover listeners antigos e garantir que a key está atualizada
            likeButton.onclick = () => toggleStoryLike(storyKey, likeButton);

            // Atualiza a informação de contagem
            if (likesCount > 0) {
                likesCountEl.textContent = likesCount;
                likesInfo.style.display = 'block';
                likesInfo.onclick = () => showStoryLikers(storyKey);
            } else {
                likesInfo.style.display = 'none';
            }
        } catch (error) {
            console.error("Erro ao carregar dados de curtida:", error);
        }
    };
    
    const nextStory = () => {
        const userStories = storiesCache[currentStoryUser];
        if (userStories && currentStoryIndex < userStories.length - 1) {
            currentStoryIndex++;
            renderStory();
        } else {
            closeStoryViewer(); // Fecha se for o último story
        }
    };

    const previousStory = () => {
        if (currentStoryIndex > 0) {
            currentStoryIndex--;
            renderStory();
        }
    };
    
    const closeStoryViewer = () => {
        clearTimeout(storyTimeout);
        elements.storyViewerOverlay.style.display = 'none';
        const contentArea = document.getElementById('story-content-area');
        contentArea.innerHTML = ''; // Para parar vídeos
    };

    const sendStoryReply = async () => {
        const input = document.getElementById('story-reply-input');
        const text = input.value.trim();
        if (!text) return;

        if (!currentUserName) {
            alert("Erro: Você precisa estar logado para responder.");
            return;
        }
        
        const senderName = currentUserName;
        const senderKey = senderName.toLowerCase();

        try {
            const recipientKey = currentStoryUser;
            
            const userStories = storiesCache[recipientKey];
            if (!userStories || !userStories[currentStoryIndex]) {
                alert('Erro: Não foi possível encontrar os dados deste story. Tente abrir novamente.');
                return;
            }
            const storyId = userStories[currentStoryIndex].key;

            // 1. Buscar os dados do story original para pegar a URL do conteúdo
            const storySnap = await database.ref(`stories/${storyId}`).get();
            if (!storySnap.exists()) {
                alert('Erro: O story original não foi encontrado.');
                return;
            }
            const storyData = storySnap.val();

            // 2. Preparar a mensagem para ser inserida no chat
            const chatId = [senderKey, recipientKey].sort().join('_');
            const chatMessageData = {
                senderId: senderKey,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                type: 'story_reply', // Novo tipo de mensagem
                storyContentUrl: storyData.contentUrl, // URL da imagem/vídeo do story
                storyContentType: storyData.contentType
            };

            // 3. Salvar a mensagem no chat e a notificação de resposta
            const senderProfileSnap = await database.ref(`userProfiles/${senderKey}`).get();
            const senderProfile = senderProfileSnap.exists() ? senderProfileSnap.val() : {};
            const replyNotificationData = {
                senderId: senderKey,
                senderName: senderName,
                senderPhoto: senderProfile.photoURL || null,
                text: text,
                storyId: storyId,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Executa as duas operações em paralelo
            await Promise.all([
                database.ref(`chats/${chatId}/messages`).push(chatMessageData),
                database.ref(`storyReplies/${recipientKey}`).push(replyNotificationData)
            ]);

            input.value = '';
            alert('Resposta enviada com sucesso!');

        } catch (error) {
            alert('Ocorreu um erro ao enviar a resposta.');
            console.error("Erro em sendStoryReply:", error);
        }
    };

        // --- LÓGICA DO NOVO LOGIN ÚNICO ---
    const populateLoginUserSelect = () => {
        const select = document.getElementById('login-user-select');
        select.innerHTML = '<option value="" disabled selected>Selecione um usuário...</option>';
        // Usa a nova lista 'allUsers' que inclui colaboradores e admins
        allUsers.forEach(name => {
            select.innerHTML += `<option value="${name}">${name}</option>`;
        });
    };

        const handleLoginAttempt = async () => {
        const userSelect = document.getElementById('login-user-select');
        const passwordInput = document.getElementById('login-password-input');
        const statusEl = document.getElementById('login-status-message');
        
        const selectedUser = userSelect.value;
        const enteredPassword = passwordInput.value;

        if (!selectedUser) {
            statusEl.textContent = 'Por favor, selecione um usuário.';
            return;
        }
        if (!enteredPassword) {
            statusEl.textContent = 'Por favor, digite sua senha.';
            return;
        }
        
        const userKey = selectedUser.toLowerCase();
        
        try {
            // LÓGICA UNIFICADA PARA TODOS OS USUÁRIOS
            const passwordSnap = await database.ref(`userPasswords/${userKey}`).get();

            if (passwordSnap.exists()) {
                // Usuário existente: verifica a senha do banco de dados
                if (enteredPassword === passwordSnap.val()) {
                    statusEl.textContent = 'Acessando...';
                    completeLogin(selectedUser);
                } else {
                    statusEl.textContent = 'Senha incorreta!';
                }
            } else {
                // Novo usuário: define a senha no banco de dados
                await database.ref(`userPasswords/${userKey}`).set(enteredPassword);
                statusEl.textContent = 'Senha definida! Acessando...';
                completeLogin(selectedUser);
            }
        } catch (error) {
            statusEl.textContent = 'Erro de conexão. Tente novamente.';
            console.error("Erro no login:", error);
        }
    };

    // A função startLoginCameraVerification não é mais necessária e foi removida.
    
    const completeLogin = (userName) => {
        localStorage.setItem('loggedInUser', userName);
        currentUserName = userName; // Define o usuário global
        
        const loginOverlay = document.getElementById('login-overlay');
        loginOverlay.classList.add('is-exiting');
        loginOverlay.addEventListener('animationend', () => {
            loginOverlay.style.display = 'none';
            loginOverlay.classList.remove('visible', 'is-exiting');
            
            // Carrega os dados da tela principal para o usuário logado
            showMainPage();
            initializeApp(true); // Chama novamente para carregar dados
            
        }, { once: true });
    };
    
    const logout = () => {
        if (confirm('Deseja realmente sair e voltar para a tela de login?')) {
            localStorage.removeItem('loggedInUser');
            window.location.reload();
        }
    };

    const deleteMyStories = async () => {
        const userKey = currentUserName.toLowerCase();
        if (!confirm('Tem certeza que deseja apagar TODOS os seus stories ativos? Esta ação não pode ser desfeita.')) return;

        const storiesRef = database.ref('stories');
        const query = storiesRef.orderByChild('userId').equalTo(userKey);

        try {
            const snapshot = await query.get();

            if (!snapshot.exists()) {
                alert('Você não tem nenhum story ativo para apagar.');
                return;
            }

            const dbUpdates = {};
            snapshot.forEach(childSnapshot => {
                // Adiciona a chave do story ao objeto de updates para remoção do banco de dados
                dbUpdates[childSnapshot.key] = null;
            });

            // ATENÇÃO: Conforme solicitado, a parte que apaga os arquivos do Storage foi removida.
            // Apenas os registros do banco de dados serão apagados.
            await storiesRef.update(dbUpdates);

            alert('Seus stories foram removidos da visualização!');
            loadAndDisplayStories(); // Atualiza a interface

        } catch (error) {
            console.error("Erro ao apagar registros de stories:", error);
            alert('Ocorreu um erro ao remover seus stories. Verifique o console para mais detalhes.');
        }
    };


    // --- FUNÇÕES DE CHAT ---

    const openChatPage = async () => {
        showPage('chatPage');
        const container = document.getElementById('chat-list-container');
        container.innerHTML = '<p style="text-align:center;">Carregando conversas...</p>';

        try {
            const userKey = currentUserName.toLowerCase();
            const profilesSnap = await database.ref('userProfiles').get();
            const profiles = profilesSnap.exists() ? profilesSnap.val() : {};

            // Pega todos os USUÁRIOS, exceto o usuário logado
            const chatPartners = allUsers.filter(name => name.toLowerCase() !== userKey);

            // Cria uma promessa para buscar os dados de cada parceiro de chat
            const conversationPromises = chatPartners.map(async (partnerName) => {
                const partnerKey = partnerName.toLowerCase();
                const profile = profiles[partnerKey] || {};
                const chatId = [userKey, partnerKey].sort().join('_'); // ID único da conversa

                // Busca a última resposta de story e a última mensagem direta em paralelo
                const lastReplyPromise = database.ref(`storyReplies/${userKey}`).orderByChild('senderId').equalTo(partnerKey).limitToLast(1).get();
                const lastMessagePromise = database.ref(`chats/${chatId}/messages`).orderByChild('timestamp').limitToLast(1).get();
                const [replySnap, messageSnap] = await Promise.all([lastReplyPromise, lastMessagePromise]);

                let lastReply = null;
                if (replySnap.exists()) {
                    replySnap.forEach(snap => { lastReply = snap.val(); });
                }

                let lastMessage = null;
                if (messageSnap.exists()) {
                    messageSnap.forEach(snap => { lastMessage = snap.val(); });
                }

                // Determina qual é a mensagem mais recente para exibir na lista
                let displayMessage = `Iniciar conversa com ${partnerName}`;
                let displayTimestamp = '1970-01-01T00:00:00Z'; // Data antiga para ordenação
                let isReply = false;

                const replyTime = lastReply ? new Date(lastReply.timestamp) : new Date(0);
                const messageTime = lastMessage ? new Date(lastMessage.timestamp) : new Date(0);

                if (replyTime > messageTime) {
                    displayMessage = `Respondeu seu story: "${lastReply.text}"`;
                    displayTimestamp = lastReply.timestamp;
                    isReply = true;
                } else if (messageTime > replyTime) {
                    const prefix = lastMessage.senderId === userKey ? "Você: " : "";
                    displayMessage = prefix + lastMessage.text;
                    displayTimestamp = new Date(lastMessage.timestamp).toISOString();
                }

                return {
                    id: partnerKey,
                    name: partnerName,
                    photo: profile.photoURL,
                    lastMessage: displayMessage,
                    timestamp: displayTimestamp,
                    isReply: isReply,
                };
            });

            // Espera todas as buscas terminarem
            const conversations = await Promise.all(conversationPromises);

            // Ordena as conversas pela mensagem mais recente
            conversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            container.innerHTML = '';
            if (conversations.length > 0) {
                conversations.forEach(convo => {
                    const item = document.createElement('div');
item.className = 'chat-list-item';
                    if (convo.isReply) item.classList.add('reply');
                    item.dataset.chatPartnerId = convo.id;
                    
                    item.innerHTML = `
                        <img src="${convo.photo || DEFAULT_PROFILE_PHOTO}" alt="${convo.name}">
                        <div class="chat-list-item-content">
                            <p><strong>${convo.name}</strong></p>
                            <p><span>${convo.lastMessage}</span></p>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = '<p style="text-align:center;">Nenhum colaborador encontrado para iniciar uma conversa.</p>';
            }
        } catch (error) {
            console.error("Erro ao carregar a página de chat:", error);
            container.innerHTML = '<p style="text-align:center;">Ocorreu um erro ao carregar as conversas.</p>';
        }
    };
    
    const handleMediaUpload = (file) => {
        if (!file || !currentOpenChatId) return;

        alert('Enviando mídia...');
        const contentType = file.type.startsWith('video/') ? 'video' : 'media_video'; // Renomeado para evitar conflito com story
        const imageType = 'media_image';

        const filePath = `chat_media/${currentOpenChatId}/${new Date().getTime()}_${file.name}`;
        const fileRef = storage.ref().child(filePath);

        fileRef.put(file)
            .then(snapshot => snapshot.ref.getDownloadURL())
            .then(contentUrl => {
                const messageData = {
                    senderId: currentUserName.toLowerCase(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: file.type.startsWith('image/') ? imageType : contentType,
                    contentUrl: contentUrl
                };
                return database.ref(`chats/${currentOpenChatId}/messages`).push(messageData);
            })
            .then(() => {
                // O listener 'child_added' cuidará de exibir a mídia.
            })
            .catch(error => {
                alert('Erro ao enviar a mídia.');
                console.error(error);
            });
    };

    const editChatMessage = (messageKey) => {
        const messageRef = database.ref(`chats/${currentOpenChatId}/messages/${messageKey}`);
        messageRef.once('value', snapshot => {
            const currentText = snapshot.val().text;
            const newText = prompt("Edite sua mensagem:", currentText);
            if (newText && newText.trim() !== "" && newText !== currentText) {
                messageRef.update({ text: newText.trim() });
            }
        });
    };

    const deleteChatMessage = (messageKey) => {
        if (confirm("Tem certeza que deseja apagar esta mensagem?")) {
            database.ref(`chats/${currentOpenChatId}/messages/${messageKey}`).remove();
        }
    };
    
    const openConversation = (partnerId) => {
        const userKey = currentUserName.toLowerCase();
        const partnerName = allCollaborators.find(n => n.toLowerCase() === partnerId) || partnerId;
        
        currentOpenChatId = [userKey, partnerId].sort().join('_');
        
        document.getElementById('chat-conversation-title').textContent = partnerName;
        showPage('chatConversationPage');
        
        const messagesContainer = document.getElementById('chat-messages-container');
        messagesContainer.innerHTML = '';

        const messagesRef = database.ref(`chats/${currentOpenChatId}/messages`).orderByChild('timestamp');
        
        // Listener para NOVAS mensagens
        messagesRef.on('child_added', snapshot => {
            const msg = snapshot.val();
            const msgKey = snapshot.key;

            const bubble = document.createElement('div');
            bubble.className = 'chat-message-bubble';
            bubble.dataset.messageKey = msgKey; // Essencial para editar/apagar
            bubble.dataset.senderId = msg.senderId;
            
            // --- LÓGICA DE RENDERIZAÇÃO MELHORADA ---
            switch (msg.type) {
                case 'story_reply':
                    const storyMediaTag = msg.storyContentType === 'video' ? `<video src="${msg.storyContentUrl}" muted autoplay loop playsinline></video>` : `<img src="${msg.storyContentUrl}" alt="Story Preview">`;
                    bubble.innerHTML = `
                        <div class="story-reply-context">${storyMediaTag}<span>Respondeu ao story</span></div>
                        <p class="reply-text">${msg.text}</p>`;
                    break;
                case 'media_image':
                    bubble.innerHTML = `<img src="${msg.contentUrl}" alt="Imagem enviada">`;
                    break;
                case 'media_video':
                    bubble.innerHTML = `<video src="${msg.contentUrl}" controls playsinline></video>`;
                    break;
                default: // Mensagem de texto normal
                    bubble.textContent = msg.text || '';
                    break;
            }

            if (msg.senderId === userKey) {
                bubble.classList.add('sent');
            } else {
                bubble.classList.add('received');
            }
            messagesContainer.appendChild(bubble);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        // Listener para MENSAGENS EDITADAS
        messagesRef.on('child_changed', snapshot => {
            const msgKey = snapshot.key;
            const newText = snapshot.val().text;
            const bubbleToUpdate = messagesContainer.querySelector(`[data-message-key="${msgKey}"]`);
            if (bubbleToUpdate && newText) {
                // Se for uma resposta de story, atualiza só o texto
                const replyTextEl = bubbleToUpdate.querySelector('.reply-text');
                if (replyTextEl) {
                    replyTextEl.textContent = newText;
                } else {
                    bubbleToUpdate.textContent = newText;
                }
            }
        });

        // Listener para MENSAGENS APAGADAS
        messagesRef.on('child_removed', snapshot => {
            const msgKey = snapshot.key;
            const bubbleToRemove = messagesContainer.querySelector(`[data-message-key="${msgKey}"]`);
            if (bubbleToRemove) {
                bubbleToRemove.remove();
            }
        });

        // Marca as mensagens e respostas como lidas ao abrir a conversa
        const updates = {};
        database.ref(`storyReplies/${userKey}`).orderByChild('senderId').equalTo(partnerId).once('value', snapshot => {
            snapshot.forEach(child => {
                if (!child.val().read) updates[`/storyReplies/${userKey}/${child.key}/read`] = true;
            });
            // Depois checa as mensagens de chat
            messagesRef.once('value', snapshot => {
                snapshot.forEach(child => {
                    if (child.val().senderId !== userKey && child.val().read !== true) {
                        updates[`/chats/${currentOpenChatId}/messages/${child.key}/read`] = true;
                    }
                });
                // Aplica todas as atualizações de uma vez
                if (Object.keys(updates).length > 0) {
                    database.ref().update(updates).then(() => checkForUnreadMessages());
                }
            });
        });
    };
    
    const sendChatMessage = () => {
        const input = document.getElementById('chat-message-input');
        const text = input.value.trim();
        if (!text || !currentOpenChatId) return;
        
        const messageData = {
            senderId: currentUserName.toLowerCase(),
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP // Usa o timestamp do servidor
        };
        
        database.ref(`chats/${currentOpenChatId}/messages`).push(messageData);
        input.value = '';
    };

    const clearAllChatMessages = async () => {
        const confirmation = prompt('Esta ação é IRREVERSÍVEL e apagará TODAS as conversas de TODOS os usuários. Para confirmar, digite "APAGAR TUDO" em maiúsculas.');
        if (confirmation !== 'APAGAR TUDO') {
            alert('Ação cancelada.');
            return;
        }

        try {
            await database.ref('chats').remove();
            alert('Todas as mensagens de chat foram apagadas com sucesso!');
        } catch (error) {
            alert('Ocorreu um erro ao apagar os chats.');
            console.error('Erro ao limpar chats:', error);
        }
    };

    const checkForUnreadMessages = async () => {
        if (!currentUserName) return; // Não faz nada se não estiver logado
        
        const userKey = currentUserName.toLowerCase();
        const indicator = document.getElementById('chat-notification-indicator');
        let hasUnread = false;

        try {
            // Verifica respostas de stories não lidas
            const repliesSnap = await database.ref(`storyReplies/${userKey}`).orderByChild('read').equalTo(false).get();
            if (repliesSnap.exists()) {
                hasUnread = true;
            }

            // Se já encontrou, não precisa checar o resto
            if (hasUnread) {
                indicator.style.display = 'inline-flex';
                return;
            }

            // Verifica mensagens de chat não lidas (lógica mais complexa)
            // Precisamos checar cada chat onde o usuário está envolvido
            const chatPartners = allUsers.filter(name => name.toLowerCase() !== userKey);
            for (const partner of chatPartners) {
                const partnerKey = partner.toLowerCase();
                const chatId = [userKey, partnerKey].sort().join('_');
                const lastMessageSnap = await database.ref(`chats/${chatId}/messages`).orderByKey().limitToLast(1).get();
                
                if (lastMessageSnap.exists()) {
                    const lastMessage = Object.values(lastMessageSnap.val())[0];
                    // Se a última mensagem não foi lida e foi enviada por outra pessoa
                    if (lastMessage.read !== true && lastMessage.senderId !== userKey) {
                        hasUnread = true;
                        break; // Sai do loop assim que encontrar a primeira não lida
                    }
                }
            }

            indicator.style.display = hasUnread ? 'inline-flex' : 'none';

        } catch (error) {
            console.error("Erro ao verificar mensagens não lidas:", error);
        }
    };



function showScreen(screenElement) {
        // 1. Se uma navegação já está em andamento, ignora o novo clique.
        if (isNavigating) return;
        
        // 2. Inicia a navegação, bloqueando cliques futuros e ativando o cursor de carregamento via CSS.
        isNavigating = true;
        document.body.classList.add('navigating');

        const currentScreen = document.querySelector('.visible');

        // 5. Agenda a liberação do bloqueio para daqui a 800ms, que é o tempo total da animação.
        setTimeout(() => {
            isNavigating = false;
            document.body.classList.remove('navigating');
        }, 1400); // 400ms para sair + 400ms para entrar

        // 3. Lógica para animar a saída da tela atual (se houver).
        if (currentScreen) {
            currentScreen.classList.add('is-exiting');
            currentScreen.addEventListener('animationend', (e) => {
                if (e.target !== currentScreen) return;
                currentScreen.classList.remove('visible', 'is-exiting');
                
                // 4. Inicia a exibição da nova tela APÓS a antiga sumir.
                screenElement.style.display = (screenElement === mainContainer) ? 'block' : 'flex';
                requestAnimationFrame(() => {
                    screenElement.classList.add('visible');
                    staggerAnimate(screenElement);
                });
            }, { once: true });
        } else {
            // Se não há tela atual, apenas exibe a nova.
            screenElement.style.display = (screenElement === mainContainer) ? 'block' : 'flex';
            requestAnimationFrame(() => {
                screenElement.classList.add('visible');
                staggerAnimate(screenElement);
            });
        }
    }

        const loadMaintenanceModeStatus = () => {
        const checkbox = document.getElementById('maintenance-mode-toggle');
        const statusEl = document.getElementById('maintenance-status-message');
        if (!checkbox) return; // Garante que não dê erro se a função for chamada em outra tela
        
        statusEl.textContent = ''; // Limpa o status anterior
        database.ref('globalSettings/isMaintenanceMode').get().then(snapshot => {
            checkbox.checked = snapshot.exists() && snapshot.val() === true;
        });
    };

    const checkAndDisplayMaintenanceNotice = () => {
        const noticeArea = document.getElementById('maintenance-notice-area');
        if (!noticeArea) return;

        database.ref('globalSettings/isMaintenanceMode').get().then(snapshot => {
            if (snapshot.exists() && snapshot.val() === true) {
                noticeArea.style.display = 'block';
            } else {
                noticeArea.style.display = 'none';
            }
        });
    };

                // --- FUNÇÕES DE BACKUP DE DADOS (Movidas para dentro do DOMContentLoaded) ---
    
            // Função principal que coleta e formata todos os dados em um texto
            const generateBackupText = async () => {
                try {
                    const [salesSnapshot, metasSnapshot, profilesSnapshot] = await Promise.all([
                        database.ref('salesData').get(),
                        database.ref('metas').get(),
                        database.ref('userProfiles').get()
                    ]);

                    const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
                    const metasData = metasSnapshot.exists() ? metasSnapshot.val() : {};
                    const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};

                    const now = new Date();
                    let backupString = `BACKUP DE DADOS - LOJA DO HUNTER\n`;
                    backupString += `Data e Hora: ${now.toLocaleString('pt-BR')}\n`;
                    backupString += `=========================================\n\n`;

                    allCollaborators.forEach(name => {
                        const key = name.toLowerCase();
                        const sales = salesData[key] || {};
                        const metas = metasData[key] || {};
                        const profile = profilesData[key] || {};

                        backupString += `--- ${name} ---\n`;
                        
                        // Dados de Vendas
                        backupString += `  Vendas: ${formatBRL(sales.vendas || 0)}\n`;
                        backupString += `  P1/P2: ${formatBRL(sales.p1p2 || 0)}\n`;
                        backupString += `  Seguro: ${sales.seguro || 0}\n`;
                        backupString += `  Cartão: ${sales.cartao || 0}\n\n`;

                        // Metas e Premiações
                        backupString += `  Meta Venda: ${formatBRL(metas.venda || 0)}\n`;
                        if(managers.includes(name)) {
                            backupString += `  Meta Loja: ${formatBRL(metas.metaLoja || 0)}\n`;
                        }
                        backupString += `  Meta Seguro: ${metas.seguro || 0}\n`;
                        backupString += `  Meta P1 50%: ${formatBRL(metas.p1 || 0)}\n`;
                        backupString += `  Meta Cartão: ${metas.cartao || 0}\n`;
                        backupString += `  Prêmio P1/P2: ${formatBRL(metas.premioP1P2 || 0)}\n`;
                        backupString += `  Prêmio Seguro: ${formatBRL(metas.premioSeguro || 0)}\n`;
                        backupString += `  Prêmio Cartão 2%+: ${formatBRL(metas.premioCartao || 0)}\n\n`;
                        
                        // Horas Extras
                        const overtimeMinutes = profile.overtimeMinutes || 0;
                        const hours = Math.floor(overtimeMinutes / 60);
                        const minutes = overtimeMinutes % 60;
                        const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        backupString += `  Horas Extras Acumuladas: ${formattedTime}\n`;

                        backupString += `-----------------------------------------\n\n`;
                    });

                    return backupString;

                } catch (error) {
                    console.error("Erro ao gerar backup:", error);
                    alert("Ocorreu um erro ao gerar o backup. Verifique sua conexão e tente novamente.");
                    return null;
                }
            };

            // Função para baixar o backup como um arquivo .txt
            const handleSaveBackup = async () => {
                alert('Gerando arquivo de backup... Por favor, aguarde.');
                const textContent = await generateBackupText();
                if (!textContent) return;

                const filename = `backup_loja_hunter_${getTodayDateString()}.txt`;
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            // Função para processar e restaurar dados de um arquivo de backup
            const handleRestoreBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    try {
                        const newSalesData = {};
                        
                        // Encontra todos os blocos de dados de colaboradores no texto
                        const collaboratorBlocks = text.split('---').slice(1); // Divide por '---' e remove o cabeçalho

                        collaboratorBlocks.forEach(block => {
                            // Extrai o nome do colaborador
                            const nameMatch = block.match(/^\s*([\w\s]+)\s*\n/);
                            if (!nameMatch) return;
                            
                            const name = nameMatch[1].trim();
                            const key = name.toLowerCase();

                            // Extrai os valores usando expressões regulares (mais robusto)
                            const vendasMatch = block.match(/Vendas:\s*R\$\s*([\d.,]+)/);
                            const p1p2Match = block.match(/P1\/P2:\s*R\$\s*([\d.,]+)/);
                            const seguroMatch = block.match(/Seguro:\s*(\d+)/);
                            const cartaoMatch = block.match(/Cartão:\s*(\d+)/);

                            // Converte os valores extraídos para o formato numérico correto
                            const vendas = vendasMatch ? parseFromBRLInput(vendasMatch[1]) : 0;
                            const p1p2 = p1p2Match ? parseFromBRLInput(p1p2Match[1]) : 0;
                            const seguro = seguroMatch ? parseInt(seguroMatch[1], 10) : 0;
                            const cartao = cartaoMatch ? parseInt(cartaoMatch[1], 10) : 0;

                            // Adiciona ao objeto que será salvo no Firebase
                            newSalesData[key] = { vendas, p1p2, seguro, cartao };
                        });

                        if (Object.keys(newSalesData).length === 0) {
                            alert('Nenhum dado válido encontrado no arquivo de backup.');
                            return;
                        }

                        if (confirm('Dados do backup foram lidos. Deseja substituir os dados atuais no Firebase com estes dados? ESSA AÇÃO NÃO PODE SER DESFEITA.')) {
                            database.ref('salesData').set(newSalesData)
                                .then(() => {
                                    alert('Backup restaurado com sucesso! Os dados foram atualizados.');
                                    // Recarrega os dados na tela para refletir a restauração
                                    loadDashboardData();
                                    buildAndLoadCorrectionPage();
                                })
                                .catch(error => {
                                    alert('Erro ao restaurar o backup.');
                                    console.error(error);
                                });
                        }

                    } catch (error) {
                        alert('Erro ao processar o arquivo de backup. Verifique o formato do arquivo.');
                        console.error(error);
                    } finally {
                        // Limpa o valor do input para permitir o upload do mesmo arquivo novamente
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            };

            // Listeners para os botões de backup
            document.getElementById('save-backup-btn').addEventListener('click', handleSaveBackup);
            // Aciona o input de arquivo quando o botão de restaurar é clicado
            document.getElementById('restore-backup-btn').addEventListener('click', () => {
                document.getElementById('backup-file-input').click();
            });
            // Lê e processa o arquivo quando ele é selecionado
            document.getElementById('backup-file-input').addEventListener('change', handleRestoreBackup);

    const loadAndDisplayAvisos = async () => {
        const container = document.getElementById('avisos-container');
        const section = document.getElementById('avisos-gerais');
        container.innerHTML = ''; // Limpa antes de carregar

        try {
            const snapshot = await database.ref('avisosGerais').get();
            if (!snapshot.exists()) {
                section.style.display = 'none';
                return;
            }

            const avisos = snapshot.val();
            const activeAvisos = [];
            const now = new Date();

            for (const key in avisos) {
                const aviso = avisos[key];
                const avisoTimestamp = new Date(aviso.timestamp);
                const hoursDiff = (now - avisoTimestamp) / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    activeAvisos.push(aviso);
                }
            }
            
            if(activeAvisos.length > 0) {
                activeAvisos.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); // Mais recente primeiro
                
                activeAvisos.forEach(aviso => {
                    const card = document.createElement('div');
                    card.className = 'aviso-card';

                    const contentImageHtml = aviso.contentImageURL 
                        ? `<img src="${aviso.contentImageURL}" alt="Imagem do aviso" style="width: 100%; border-radius: 8px; margin-top: 0.75rem; max-height: 300px; object-fit: cover;">` 
                        : '';

                    card.innerHTML = `
                        <img src="${aviso.photoURL}" class="aviso-photo" alt="Foto de ${aviso.name}">
                        <div class="aviso-content">
                            <div class="aviso-name">${aviso.name}</div>
                            <div class="aviso-text">${aviso.text}</div>
                            ${contentImageHtml}
                        </div>
                    `;
                    container.appendChild(card);
                });
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }

        } catch (error) {
            console.error("Erro ao carregar avisos:", error);
            section.style.display = 'none';
        }
    };

    const loadAndManageAvisos = async () => {
        const listContainer = document.getElementById('avisos-list-container');
        listContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        try {
            const snapshot = await database.ref('avisosGerais').get();
            listContainer.innerHTML = '';
            
            if (!snapshot.exists()) {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhum aviso ativo.</p>`;
                return;
            }

            const avisos = snapshot.val();
            const activeAvisos = [];
            const now = new Date();

            for (const key in avisos) {
                const aviso = avisos[key];
                const avisoTimestamp = new Date(aviso.timestamp);
                const hoursDiff = (now - avisoTimestamp) / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    activeAvisos.push({ key, ...aviso });
                }
            }

            if(activeAvisos.length === 0) {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhum aviso ativo.</p>`;
                return;
            }

            activeAvisos.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            activeAvisos.forEach(aviso => {
                const listItem = document.createElement('div');
                listItem.className = 'mt-list-item';
                
                const imageIndicatorHtml = aviso.contentImageURL ? '<i class="fa-solid fa-image" style="margin-left: 8px; color: #3498db;"></i>' : '';

                listItem.innerHTML = `
                    <img src="${aviso.photoURL}" class="ponto-history-photo" style="width: 40px; height: 40px; margin-right: 1rem;">
                    <div class="mt-list-item-text">
                        <strong>${aviso.name}:</strong> ${aviso.text} ${imageIndicatorHtml}
                    </div>
                    <button class="delete-button-small" data-key="${aviso.key}">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                listContainer.appendChild(listItem);
            });
        } catch (error) {
            console.error("Erro ao gerenciar avisos:", error);
            listContainer.innerHTML = `<p style="text-align:center;">Erro ao carregar avisos.</p>`;
        }
    };

        const achievementsList = {
        'rei_do_ranking': {
            name: 'Rei do Ranking',
            description: 'Alcançar o 1º lugar no ranking de vendas ou de gerentes.',
            icon: 'fa-solid fa-ranking-star'
        },
        'vendedor_ouro': {
            name: 'Vendedor de Ouro',
            description: 'Atingir 100% da meta de vendas do mês.',
            icon: 'fa-solid fa-medal'
        },
        'rei_do_cartao': {
            name: 'Rei do Cartão',
            description: 'Superar a meta de cartões em 50%.',
            icon: 'fa-solid fa-crown'
        },
        'escudo_protetor': {
            name: 'Escudo Protetor',
            description: 'Atingir a meta de 10 seguros vendidos no mês.',
            icon: 'fa-solid fa-shield-halved'
        },
        'queridinho_da_galera': {
            name: 'Queridinho(a) da Galera',
            description: 'Receber 5 "Parabéns!" dos colegas de equipe.',
            icon: 'fa-solid fa-heart'
        },
        'comentarista_consistente': {
            name: 'Comentarista Consistente',
            description: 'Manter o status atualizado por 3 dias seguidos.',
            icon: 'fa-solid fa-comments'
        },
        'colega_de_equipe': {
            name: 'Colega de Equipe',
            description: 'Reconhecer o esforço de um colega enviando "Parabéns!" no ranking.',
            icon: 'fa-solid fa-handshake-angle'
        },
        'a_voz_da_melhoria': {
            name: 'A Voz da Melhoria',
            description: 'Ajudar a melhorar o app enviando um feedback ou sugestão.',
            icon: 'fa-solid fa-lightbulb'
        },
        'frequentador_assiduo': {
            name: 'Frequentador Assíduo',
            description: 'Acessar seu perfil mais de 50 vezes.',
            icon: 'fa-solid fa-door-open'
        },
        'pontualidade_britanica': {
            name: 'Pontualidade Britânica',
            description: 'Não registrar nenhum atraso no ponto durante o mês.',
            icon: 'fa-solid fa-user-clock'
        }
        // Adicione mais conquistas aqui no futuro
    };

    const displayAchievements = async (userKey) => {
        const section = document.getElementById('achievements-section');
        const container = document.getElementById('achievements-container');
        container.innerHTML = '';
        section.style.display = 'block';

        const profileSnap = await database.ref(`userProfiles/${userKey}/achievements`).get();
        const earnedAchievements = profileSnap.exists() ? profileSnap.val() : {};

        for (const id in achievementsList) {
            const achievement = achievementsList[id];
            const isEarned = earnedAchievements[id];

            const badge = document.createElement('div');
            badge.className = `achievement-badge ${isEarned ? '' : 'locked'}`;
            badge.innerHTML = `
                <i class="${achievement.icon}"></i>
                <span class="tooltip">
                    <strong>${achievement.name}</strong><br>
                    ${achievement.description}<br>
                    ${isEarned ? `(Conquistado em ${new Date(earnedAchievements[id]).toLocaleDateString()})` : '(Bloqueado)'}
                </span>
            `;
            container.appendChild(badge);
        }
    };

    const checkAndAwardAchievements = async (userKey) => {
        const userSnap = await database.ref(`salesData/${userKey}`).get();
        const metaSnap = await database.ref(`metas/${userKey}`).get();

        if (userSnap.exists() && metaSnap.exists()) {
            const sales = userSnap.val();
            const metas = metaSnap.val();

            // 1. Checar 'Vendedor de Ouro'
            if (sales.vendas >= metas.venda && metas.venda > 0) {
                awardAchievement(userKey, 'vendedor_ouro');
            }
            
            // 2. Checar 'Rei do Cartão'
            if (sales.cartao >= (metas.cartao * 1.5) && metas.cartao > 0) {
                awardAchievement(userKey, 'rei_do_cartao');
            }
            
            // 3. Checar 'Escudo Protetor' (meta de 10 seguros)
            if (sales.seguro >= 10) {
                awardAchievement(userKey, 'escudo_protetor');
            }

            // A lógica de 'Pontualidade' exigiria varrer todos os pontos do mês e é mais complexa.
        }
    };

    const saveAviso = (photoURL, contentImageURL) => {
        const name = document.getElementById('aviso-name').value.trim();
        const text = document.getElementById('aviso-text').value.trim();
        const statusEl = document.getElementById('aviso-status-message');

        if (!name || !photoURL || !text) {
            statusEl.textContent = 'Nome, Foto de Perfil e Mensagem são obrigatórios!';
            // Re-habilita o botão em caso de erro de validação
            document.getElementById('save-aviso-btn').disabled = false;
            document.getElementById('save-aviso-btn').style.opacity = '1';
            return;
        }

        statusEl.textContent = 'Salvando aviso...';

        const newAviso = {
            name,
            photoURL,
            text,
            timestamp: new Date().toISOString(),
            contentImageURL: contentImageURL || null
        };

        database.ref('avisosGerais').push(newAviso)
            .then(() => {
                statusEl.textContent = 'Aviso enviado com sucesso!';
                document.getElementById('aviso-name').value = '';
                document.getElementById('aviso-text').value = '';
                document.getElementById('aviso-photo-status').textContent = '';
                document.getElementById('aviso-photo-upload').value = '';
                document.getElementById('aviso-content-photo-status').textContent = '';
                document.getElementById('aviso-content-image-upload').value = '';
                loadAndManageAvisos();
                loadAndDisplayAvisos();
                setTimeout(() => { 
                    statusEl.textContent = '';
                    document.getElementById('save-aviso-btn').disabled = false;
                    document.getElementById('save-aviso-btn').style.opacity = '1';
                }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao enviar aviso.';
                console.error(error);
                document.getElementById('save-aviso-btn').disabled = false;
                document.getElementById('save-aviso-btn').style.opacity = '1';
            });
    };
    
    const deleteAviso = (key) => {
        if (confirm('Tem certeza que deseja apagar este aviso?')) {
            database.ref(`avisosGerais/${key}`).remove()
                .then(() => {
                    alert('Aviso apagado.');
                    loadAndManageAvisos();
                    loadAndDisplayAvisos();
                })
                .catch(error => {
                    alert('Erro ao apagar o aviso.');
                    console.error(error);
                });
        }
    };

            // --- INICIALIZAÇÃO DA APLICAÇÃO ---
            // (Remova completamente o bloco de código acima. Ele está sendo chamado duas vezes e causando a duplicação do ranking.)
            // A chamada correta já acontece dentro da função `initializeApp()` mais abaixo no código.
    
    // --- FUNÇÕES DE GESTÃO DE CAIXA ---

    const loadManagerCashBoxData = async () => {
        const section = document.getElementById('manager-cash-box-section');
        // Verba de Crediário (CDC)
        const cdcValueEl = document.getElementById('cash-box-value');
        const cdcProgressEl = document.getElementById('cash-box-progress-bar');
        // Verba de Loja
        const storeValueEl = document.getElementById('store-cash-box-value');
        const storeProgressEl = document.getElementById('store-cash-box-progress-bar');
        // Preço de Site (CORRIGIDO)
        const precoSiteValueEl = document.getElementById('preco-site-cash-box-value');
        const precoSiteProgressEl = document.getElementById('preco-site-cash-box-progress-bar');

        const dailyListEl = document.getElementById('manager-daily-expenses-list');
        const managerKey = currentUserName.toLowerCase();
        
        try {
            const cashBoxRef = database.ref(`cashManagement/${managerKey}`);
            const snapshot = await cashBoxRef.get();
            let cdcCurrentValue = CASH_BOX_INITIAL_VALUE;
            let storeCurrentValue = CASH_BOX_INITIAL_VALUE;
            let vendaRemotaCurrentValue = SITE_CASH_BOX_INITIAL_VALUE;
            
            dailyListEl.innerHTML = ''; // Limpa a lista de gastos do dia
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                cdcCurrentValue = data.currentValue !== undefined ? data.currentValue : CASH_BOX_INITIAL_VALUE;
                storeCurrentValue = data.currentStoreValue !== undefined ? data.currentStoreValue : CASH_BOX_INITIAL_VALUE;
               vendaRemotaCurrentValue = data.currentVendaRemotaValue !== undefined ? data.currentVendaRemotaValue : SITE_CASH_BOX_INITIAL_VALUE;

                // Carrega os gastos do dia (CDC)
                if (data.expenses) {
                    const todayString = new Date().toLocaleDateString('pt-BR');
                    const expensesArray = Object.values(data.expenses);
                    const todayExpenses = expensesArray.filter(exp => 
                        new Date(exp.timestamp).toLocaleDateString('pt-BR') === todayString
                    );

                    if (todayExpenses.length > 0) {
                         dailyListEl.innerHTML = '<h5 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: #f0f0f0;">Gastos de Hoje (Crediário):</h5>';
                         todayExpenses.forEach(exp => {
                            dailyListEl.innerHTML += `<p style="font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; margin-bottom: 4px;">- ${exp.description}: ${formatBRL(exp.value)}</p>`;
                         });
                    }
                }
            }

            // Atualiza a barra de Verba de Crediário
            const cdcPercentage = (cdcCurrentValue / CASH_BOX_INITIAL_VALUE) * 100;
            cdcValueEl.textContent = formatBRL(cdcCurrentValue);
            cdcProgressEl.style.width = `${Math.max(0, cdcPercentage)}%`;
            if (cdcPercentage < 25) cdcProgressEl.style.backgroundColor = '#e74c3c';
            else if (cdcPercentage < 50) cdcProgressEl.style.backgroundColor = '#f1c40f';
            else cdcProgressEl.style.backgroundColor = 'var(--primary-color)';

            // Atualiza a barra de Verba de Loja
            const storePercentage = (storeCurrentValue / CASH_BOX_INITIAL_VALUE) * 100;
            storeValueEl.textContent = formatBRL(storeCurrentValue);
            storeProgressEl.style.width = `${Math.max(0, storePercentage)}%`;
             if (storePercentage < 25) storeProgressEl.style.backgroundColor = '#e74c3c';
            else if (storePercentage < 50) storeProgressEl.style.backgroundColor = '#f1c40f';
            else storeProgressEl.style.backgroundColor = '#2980b9';

            // Atualiza a barra de Preço de Site (CORRIGIDO)
            const precoSitePercentage = (vendaRemotaCurrentValue / SITE_CASH_BOX_INITIAL_VALUE) * 100;
            precoSiteValueEl.textContent = formatBRL(vendaRemotaCurrentValue);
            precoSiteProgressEl.style.width = `${Math.max(0, precoSitePercentage)}%`;
             if (precoSitePercentage < 25) precoSiteProgressEl.style.backgroundColor = '#e74c3c';
            else if (precoSitePercentage < 50) precoSiteProgressEl.style.backgroundColor = '#f1c40f';
            else precoSiteProgressEl.style.backgroundColor = '#8e44ad'; // Roxo para diferenciar
            
            section.style.display = 'block';

        } catch (error) {
            console.error("Erro ao carregar dados do caixa:", error);
            section.style.display = 'none';
        }
    };
    
    const burnCdcFunds = () => {
        const amountStr = prompt("Digite o valor a ser QUEIMADO (subtraído) da verba de CDC:");
        if (!amountStr) return;

        const amount = parseFromBRLInput(amountStr);
        if (isNaN(amount) || amount <= 0) {
            alert("Valor inválido.");
            return;
        }

        const description = prompt("Descrição da queima:");
        if (!description) return;

        if (!confirm(`Confirmar queima de ${formatBRL(amount)} para "${description}"?`)) {
            return;
        }

        const managerKey = currentUserName.toLowerCase();
        const cashBoxRef = database.ref(`cashManagement/${managerKey}`);

        cashBoxRef.transaction(currentData => {
            let data = currentData || { currentValue: CASH_BOX_INITIAL_VALUE, expenses: {} };
            
            if (data.currentValue < amount) {
                return; 
            }
            
            data.currentValue -= amount;
            
            const newExpenseRef = database.ref(`cashManagement/${managerKey}/expenses`).push();
            const newExpense = {
                description: `QUEIMA: ${description}`,
                value: amount,
                timestamp: new Date().toISOString()
            };
            
            if (!data.expenses) {
                data.expenses = {};
            }
            data.expenses[newExpenseRef.key] = newExpense;

            return data;

        }).then(result => {
            if (!result.committed) {
                 alert("Saldo insuficiente na verba de crediário!");
            } else {
                alert("Queima de verba registrada com sucesso!");
                loadManagerCashBoxData();
            }
        }).catch(error => {
            alert("Ocorreu um erro ao registrar a queima de verba.");
            console.error("Erro na transação:", error);
        });
    };

    const recoverCdcFunds = () => {
        const amountStr = prompt("Digite o valor a ser RECUPERADO (adicionado) à verba de CDC:");
        if (!amountStr) return;

        const amount = parseFromBRLInput(amountStr);
        if (isNaN(amount) || amount <= 0) {
            alert("Valor inválido.");
            return;
        }
        
        const description = prompt("Descrição da recuperação:");
        if (!description) return;

        if (!confirm(`Confirmar recuperação de ${formatBRL(amount)} para "${description}"?`)) {
            return;
        }

        const managerKey = currentUserName.toLowerCase();
        const cashBoxRef = database.ref(`cashManagement/${managerKey}`);

        cashBoxRef.transaction(currentData => {
            let data = currentData || { currentValue: CASH_BOX_INITIAL_VALUE, expenses: {} };
            
            data.currentValue += amount;
            
            const newExpenseRef = database.ref(`cashManagement/${managerKey}/expenses`).push();
            const newExpense = {
                description: `RECUPERAÇÃO: ${description}`,
                value: amount,
                timestamp: new Date().toISOString()
            };
            
            if (!data.expenses) {
                data.expenses = {};
            }
            data.expenses[newExpenseRef.key] = newExpense;

            return data;

        }).then(() => {
            alert("Recuperação de verba registrada com sucesso!");
            loadManagerCashBoxData();
        }).catch(error => {
            alert("Ocorreu um erro ao registrar a recuperação de verba.");
            console.error("Erro na transação:", error);
        });
    };

    const loadCashManagementPage = async () => {
        showPage('cashManagementPage');
        const statusContainer = document.getElementById('cash-status-cards-container');
        const historyContainer = document.getElementById('expense-history-list');
        statusContainer.innerHTML = '<p style="text-align:center;">Carregando status...</p>';
        historyContainer.innerHTML = '<p style="text-align:center;">Carregando histórico...</p>';
        
        try {
            const snapshot = await database.ref('cashManagement').get();
            const cashData = snapshot.exists() ? snapshot.val() : {};

            statusContainer.innerHTML = '';
            let allExpenses = [];

            managers.forEach(managerName => {
                const managerKey = managerName.toLowerCase();
                const managerData = cashData[managerKey] || { currentValue: CASH_BOX_INITIAL_VALUE };
                const currentValue = managerData.currentValue !== undefined ? managerData.currentValue : CASH_BOX_INITIAL_VALUE;

                // Adiciona os gastos deste gerente à lista geral
                if (managerData.expenses) {
                    Object.keys(managerData.expenses).forEach(expenseKey => {
                        allExpenses.push({ 
                            ...managerData.expenses[expenseKey], 
                            managerName,
                            managerKey, 
                            expenseKey 
                        });
                    });
                }
                
                const card = document.createElement('div');
                card.className = 'employee-meta-card';
                                card.innerHTML = `
                    <h4>CDC - ${managerName}</h4>
                    <p style="font-size: 1.5rem; text-align: center; font-weight: 700;">${formatBRL(currentValue)}</p>
                    <button class="action-button full-width reset-cash-btn" data-manager-key="${managerKey}" data-type="cdc" style="margin-top: 1rem; background-color: #2980b9;">
                        <i class="fa-solid fa-arrows-rotate"></i> Resetar Verba CDC
                    </button>
                `;
                statusContainer.appendChild(card);
            });
            
            // Renderiza o histórico de gastos
            historyContainer.innerHTML = '';
            if (allExpenses.length > 0) {
                allExpenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Mais recentes primeiro

                allExpenses.slice(0, 50).forEach(expense => { // Limita aos 50 mais recentes
                    const listItem = document.createElement('div');
                    listItem.className = 'mt-list-item';
                    listItem.innerHTML = `
                        <div class="mt-list-item-text">
                            <strong>${expense.managerName}:</strong> ${expense.description} - <strong>${formatBRL(expense.value)}</strong>
                            <br>
                            <span style="font-size: 0.75rem; color: #ccc;">${new Date(expense.timestamp).toLocaleString('pt-BR')}</span>
                        </div>
                        <button class="delete-button-small delete-expense-btn" data-manager-key="${expense.managerKey}" data-expense-key="${expense.expenseKey}" data-expense-value="${expense.value}">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    historyContainer.appendChild(listItem);
                });

            } else {
                historyContainer.innerHTML = '<p style="text-align:center;">Nenhum gasto registrado.</p>';
            }

        } catch (error) {
            console.error("Erro ao carregar página de gestão de CDC:", error);
            statusContainer.innerHTML = '<p>Erro ao carregar dados.</p>';
            historyContainer.innerHTML = '';
        }
    };

    const resetCashBox = (managerKey, type) => {
        let dbPath, initialValue, verbaName;

        if (type === 'cdc') {
            dbPath = `cashManagement/${managerKey}/currentValue`;
            initialValue = CASH_BOX_INITIAL_VALUE;
            verbaName = "CDC";
        } else if (type === 'vendaRemota') {
            dbPath = `cashManagement/${managerKey}/currentVendaRemotaValue`;
            initialValue = SITE_CASH_BOX_INITIAL_VALUE;
            verbaName = "de Site";
        } else {
            return;
        }

        if (!confirm(`Tem certeza que deseja resetar a verba de ${verbaName} de ${managerKey} para ${formatBRL(initialValue)}?`)) {
            return;
        }
        database.ref(dbPath).set(initialValue)
        .then(() => {
            alert(`Verba de ${verbaName} resetada com sucesso!`);
            loadCashManagementPage(); // Recarrega a página
        })
        .catch(err => {
            alert(`Erro ao resetar a verba de ${verbaName}.`);
            console.error(err);
        });
    };

    const deleteExpense = (managerKey, expenseKey, expenseValue) => {
        if (!confirm(`Tem certeza que deseja apagar este gasto? O valor de ${formatBRL(expenseValue)} será ESTORNADO à verba de CDC.`)) {
            return;
        }

        const managerRef = database.ref(`cashManagement/${managerKey}`);

        managerRef.transaction(currentData => {
            if (currentData) {
                // Estorna o valor
                currentData.currentValue += expenseValue;
                // Remove o gasto
                if (currentData.expenses && currentData.expenses[expenseKey]) {
                    delete currentData.expenses[expenseKey];
                }
            }
            return currentData;
        })
        .then(() => {
            alert("Gasto apagado e valor estornado.");
            loadCashManagementPage(); // Recarrega a página
        })
        .catch(err => {
            alert("Erro ao apagar o gasto.");
            console.error(err);
        });
    };
    
    // Funções de atalho para a navegação
    function showPage(pageKey) {
        showScreen(elements[pageKey]);
    }
    function showMainPage() {
        showScreen(mainContainer);
    }

    // --- FUNÇÕES DA MODAL (ADAPTADAS PARA A NOVA NAVEGAÇÃO) ---
    const openModal = () => {
        const modal = elements.modal;
        if(isNavigating) return;
        isNavigating = true;
        
        document.getElementById('colaborador-cidades').style.display = 'block';
        document.getElementById('colaborador-pinheiro').style.display = 'none';
        document.getElementById('colaborador-bacabal').style.display = 'none';
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            staggerAnimate(modal);
            isNavigating = false;
        });
    };

        const closeModal = (onClosedCallback) => {
        const modal = elements.modal;
        if (isNavigating || !modal.classList.contains('visible')) return;
        isNavigating = true;

        // Adiciona a classe que dispara a animação de SAÍDA.
        modal.classList.add('is-exiting');

        // Escuta o fim da ANIMAÇÃO no próprio modal-overlay.
        modal.addEventListener('animationend', (e) => {
            if (e.target === modal) {
                // Esconde o modal e limpa as classes de animação.
                modal.style.display = 'none';
                modal.classList.remove('visible', 'is-exiting');

                // Se houver um callback (como abrir outra página), ele é executado.
                // A flag 'isNavigating' permanecerá 'true', pois a função de callback a gerenciará.
                if (typeof onClosedCallback === 'function') {
                    onClosedCallback();
                } else {
                    // Se NÃO houver callback, a navegação termina aqui, então liberamos a flag.
                    isNavigating = false;
                }
            }
        }, { once: true });
    };

    // --- FUNÇÃO DE VERIFICAÇÃO DE SENHA (REMOVIDA/OBSOLETA) ---
    // A lógica de senha agora é centralizada no login inicial.
    // A função checkPassword() não é mais necessária para operações do dia a dia.
    
    // --- FUNÇÕES AUXILIARES DE FORMATAÇÃO DE MOEDA ---
    const formatToBRLInput = (value) => {
      const num = parseFloat(value) || 0;
      return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const parseFromBRLInput = (value) => {
  if (!value || typeof value !== 'string') return 0;
  // Ex: "1.234,56" -> "1234,56" -> "1234.56" -> 1234.56
  const num = parseFloat(value.replace(/\./g, '').replace(',', '.'));
  return isNaN(num) ? 0 : num;
};




    // --- DEMAIS FUNÇÕES (SEM ALTERAÇÃO NA LÓGICA INTERNA) ---
    // As funções loadgsData e savegsData foram removidas pois se tornaram obsoletas
    // com a implementação do novo Dashboard e da página de Configurações Gerais.
            const buildAndLoadMetasPage = () => {
    const container = document.getElementById('metas-content-container');
    container.innerHTML = `<p style="text-align: center;">Carregando dados...</p>`;

    database.ref('metas').get().then(metasSnapshot => {
        const allMetas = metasSnapshot.exists() ? metasSnapshot.val() : {};
        container.innerHTML = '';

        allCollaborators.filter(name => name !== 'Beatriz').forEach(name => {
            const key = name.toLowerCase();
            const metasData = allMetas[key] || {};
            
            container.innerHTML += `
                <div class="employee-meta-card">
                    <h4>Metas e Prêmios: ${name}</h4>
                    <div class="meta-group-title">Metas</div>
                    <div class="input-group"><label for="venda-${key}">Meta de Venda (R$)</label><input type="text" id="venda-${key}" class="data-input" value="${formatToBRLInput(metasData.venda)}"></div>
                    <div class="input-group"><label for="meta-servico-${key}">Meta de Serviço (R$)</label><input type="text" inputmode="decimal" id="meta-servico-${key}" class="data-input" value="${formatToBRLInput(metasData.meta_servico)}"></div>
                    
                    <div class="meta-group-title">Premiações</div>
                    <p style="font-size: 0.9rem; line-height: 1.6;">
                        - 1% sobre a venda<br>
                        - Prêmios por Ranking de Serviço (Veja no Painel)<br>
                        - 2% de tudo vendido no cartão hunter card<br>
                        - Máximo de desconto 6%:500
                    </p>
                </div>`;
        });

        // Adiciona o botão de salvar e o status ao final do container
        container.innerHTML += `
            <button id="save-all-metas" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Todas as Metas</button>
            <p id="metas-status-message" class="status-message"></p>
        `;
        // Reatribui o listener ao novo botão
        document.getElementById('save-all-metas').addEventListener('click', saveAllMetas);
    });
};
        const saveAllMetas = () => {
    const statusMessage = document.getElementById('metas-status-message');
    statusMessage.textContent = 'Salvando dados...';
    const metasDataToSave = {};

    allCollaborators.filter(name => name !== 'Beatriz').forEach(name => {
        const key = name.toLowerCase();
        const data = {
            venda: parseFromBRLInput(document.getElementById(`venda-${key}`).value),
            meta_servico: parseFromBRLInput(document.getElementById(`meta-servico-${key}`).value)
        };
        metasDataToSave[key] = data;
    });

    database.ref('metas').set(metasDataToSave).then(() => {
        statusMessage.textContent = 'Todos os dados foram salvos!';
    }).catch((error) => {
        statusMessage.textContent = 'Erro ao salvar os dados!';
        console.error(error);
    });
};
const loadAndDisplayCollaboratorMetas = () => {
    const container = document.getElementById('metas-display-content');
    const key = currentUserName.toLowerCase();
    container.innerHTML = `<p>Carregando suas metas...</p>`;
    database.ref(`metas/${key}`).get().then(snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            container.innerHTML = `
                <h3>METAS</h3>
                <p><strong>Meta de Venda:</strong> ${formatBRL(data.venda)}</p>
                <p><strong>Meta de Serviço:</strong> ${formatBRL(data.meta_servico || 0)}</p>
                <br>
                <h3>PREMIAÇÕES</h3>
                <p style="font-size: 0.9rem; line-height: 1.6; background: transparent; padding: 0;">
                    - 1% sobre a venda<br>
                    - Prêmios por Ranking de Serviço (Veja no Painel)<br>
                    - 2% de tudo vendido no cartão hunter card<br>
                    - Máximo de desconto 6%:500
                </p>
            `;
        } else {
            container.innerHTML = `<p>Nenhuma meta foi configurada para você ainda.</p>`;
        }
    });
};
    const resetSendDeviceForm = () => {
        document.querySelector('#send-device-page h2').textContent = 'Enviar Novo Dispositivo';
        document.getElementById('save-device-btn').textContent = 'Salvar Dispositivo';
        document.getElementById('send-device-page').querySelectorAll('input, textarea, select').forEach(el => {
            if (el.tagName !== 'SELECT') el.value = '';
            else el.selectedIndex = 0;
        });
        
        // Reseta o display do nome do dispositivo
        const displayName = document.getElementById('device-name-display');
        displayName.textContent = 'Clique para selecionar da planilha...';
        displayName.style.color = '#aaa';

        document.getElementById('send-device-status').textContent = '';
        editingDeviceKey = null;
    };

    const saveDevice = async () => {
        const statusEl = document.getElementById('send-device-status');
        const imageStatusEl = document.getElementById('device-image-status');
        const brand = document.getElementById('device-brand').value;
        const name = document.getElementById('device-name').value.trim();
        const techSpecs = document.getElementById('device-tech-specs').value.trim();
        const imageUploadInput = document.getElementById('device-image-upload');
        const imageUrlInput = document.getElementById('device-image-url');
        const file = imageUploadInput.files[0];

        let finalImageUrl = imageUrlInput.value.trim();

        if (!brand || !name || !techSpecs) {
            statusEl.textContent = 'Marca, Nome e Ficha Técnica são obrigatórios!';
            return;
        }

        if (!file && !finalImageUrl) {
            statusEl.textContent = 'Por favor, envie uma imagem para o dispositivo!';
            return;
        }
        
        statusEl.textContent = 'Salvando...';

        // Se um novo arquivo foi selecionado, faz o upload para o Supabase
        if (file) {
            try {
                imageStatusEl.textContent = 'Enviando imagem...';
                
                // 1. Define o caminho do arquivo dentro do bucket
                const filePath = `${brand}/${new Date().getTime()}_${file.name}`;

                // 2. Faz o upload para o bucket 'device-images'
                const { data: uploadData, error: uploadError } = await supabase
                    .storage
                    .from('device-images') // NOME DO SEU NOVO BUCKET
                    .upload(filePath, file);
                
                if (uploadError) throw uploadError;

                // 3. Pega a URL pública do arquivo enviado
                const { data: urlData } = supabase
                    .storage
                    .from('device-images')
                    .getPublicUrl(filePath);

                finalImageUrl = urlData.publicUrl;
                imageStatusEl.textContent = 'Imagem enviada com sucesso!';

            } catch (error) {
                console.error("Erro no upload da imagem do dispositivo para o Supabase:", error);
                statusEl.textContent = 'Erro ao enviar a imagem!';
                imageStatusEl.textContent = 'Falha no upload. Tente novamente.';
                return;
            }
        }
        
        // O resto do código permanece igual, pois ele salva os metadados no Firebase RTDB
        const deviceData = {
            name,
            imageUrl: finalImageUrl,
            techSpecs,
            priceTable: document.getElementById('device-price-table').value.trim()
        };

        try {
            if (editingDeviceKey) {
                await database.ref(`devices/${brand}/${editingDeviceKey}`).update(deviceData);
                statusEl.textContent = 'Dispositivo atualizado com sucesso!';
                setTimeout(() => {
                    resetSendDeviceForm();
                    loadDeviceDetails(editingDeviceKey, brand);
                }, 1500);
            } else {
                await database.ref(`devices/${brand}`).push(deviceData);
                statusEl.textContent = 'Dispositivo salvo com sucesso!';
                resetSendDeviceForm();
            }
        } catch (error) {
            statusEl.textContent = 'Erro ao salvar os dados no banco!';
            console.error(error);
        }
    };
    const renderDeviceSearchResults = (devices, filterText = '') => {
        const grid = document.getElementById('device-search-results-grid');
        grid.innerHTML = '';

        const normalizedFilter = filterText.toLowerCase().trim();
        const filteredDevices = devices.filter(device => 
            device.name.toLowerCase().includes(normalizedFilter)
        );

        if (filteredDevices.length === 0) {
            grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Nenhum aparelho encontrado.</p>';
            return;
        }

        filteredDevices.forEach(device => {
            const card = document.createElement('div');
            card.className = 'device-card';
            // Adicionamos data attributes para podermos buscar os dados ao clicar
            card.dataset.key = device.key;
            card.dataset.brand = device.brand;
            card.innerHTML = `<img src="${device.imageUrl}" alt="${device.name}"><span>${device.name}</span>`;
            grid.appendChild(card);
        });
    };

    const openDeviceSearch = () => {
        const grid = document.getElementById('device-search-results-grid');
        grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Carregando todos os aparelhos...</p>';
        document.getElementById('device-search-input').value = '';
        showPage('deviceSearchOverlay');

        // Se já tivermos os dados em cache, usamos eles
        if (allDevicesCache.length > 0) {
            renderDeviceSearchResults(allDevicesCache);
            return;
        }
        
        // Se não, buscamos no Firebase
        database.ref('devices').get().then(snapshot => {
            allDevicesCache = []; // Limpa o cache antes de preencher
            if (snapshot.exists()) {
                snapshot.forEach(brandSnapshot => {
                    const brand = brandSnapshot.key;
                    const devices = brandSnapshot.val();
                    for (const key in devices) {
                        allDevicesCache.push({
                            key: key,
                            brand: brand,
                            ...devices[key]
                        });
                    }
                });
            }
            renderDeviceSearchResults(allDevicesCache);
        }).catch(error => {
            grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Erro ao carregar aparelhos.</p>';
            console.error("Erro ao buscar todos os aparelhos:", error);
        });
    };

    const loadBrandDevices = (brand) => {
        currentBrand = brand;
        document.getElementById('brand-page-title').textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
        const grid = document.getElementById('brand-devices-grid');
        grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Carregando dispositivos...</p>';
        showPage('brandDevicesPage');
        database.ref(`devices/${brand}`).once('value', snapshot => {
            grid.innerHTML = '';
            if (snapshot.exists()) {
                const devices = snapshot.val();
                Object.keys(devices).forEach(key => {
                    const device = devices[key];
                    const card = document.createElement('div');
                    card.className = 'device-card';
                    card.innerHTML = `<img src="${device.imageUrl}" alt="${device.name}"><span>${device.name}</span>`;
                    // A chamada agora passa a marca, que já está na variável global 'currentBrand'
                    card.addEventListener('click', () => loadDeviceDetails(key, currentBrand));
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Nenhum dispositivo cadastrado para esta marca.</p>';
            }
            staggerAnimate(grid.parentElement);
        });
    };
    
    // Função modificada para aceitar a marca como parâmetro
    const fetchWithTimeout = async (resource, options = {}) => {
        const { timeout = 10000 } = options; // Timeout padrão de 10 segundos
      
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
      
        const response = await fetch(resource, {
          ...options,
          signal: controller.signal  
        });
        clearTimeout(id);
      
        return response;
    };

    let priceCache = {}; // Cache global para os preços

const fetchAndDisplayPriceForDevice = async (deviceName) => {
        // Pega a referência para todos os campos que vêm da planilha
        const vendaEl = document.getElementById('device-price-venda');
        const limiteEl = document.getElementById('device-price-limite');
        const entradaEl = document.getElementById('device-price-entrada'); // Pode ser nulo
        const seguroQuedaEl = document.getElementById('device-seguro-queda');
        const garantiaEstendidaEl = document.getElementById('device-garantia-estendida');
        
        // Pega os indicadores de atualização
        const vendaIndicator = document.getElementById('venda-indicator');
        const limiteIndicator = document.getElementById('limite-indicator');
        const entradaIndicator = document.getElementById('entrada-indicator'); // Pode ser nulo
        const seguroQuedaIndicator = document.getElementById('seguro-queda-indicator');
        const garantiaEstendidaIndicator = document.getElementById('garantia-estendida-indicator');

        // Verifica se os elementos essenciais existem
        if (!vendaEl || !limiteEl || !seguroQuedaEl || !garantiaEstendidaEl) return;

        // Guarda os valores atuais da tela (do cache), verificando a existência do elemento de entrada
        const oldValues = {
            venda: vendaEl.textContent,
            limite: limiteEl.textContent,
            entrada: entradaEl ? entradaEl.textContent : null, // Verifica se existe
            seguroQueda: seguroQuedaEl.textContent,
            garantiaEstendida: garantiaEstendidaEl.textContent
        };
        
        // Mostra que está atualizando, verificando a existência do indicador de entrada
        const allIndicators = [vendaIndicator, limiteIndicator, entradaIndicator, seguroQuedaIndicator, garantiaEstendidaIndicator];
        allIndicators.forEach(el => { if(el) el.textContent = '(atualizando...)'; });

        try {
            const response = await fetchWithTimeout(`${GOOGLE_SHEET_API_URL}?deviceName=${encodeURIComponent(deviceName)}`, {
                timeout: 10000 
            });

            if (!response.ok) throw new Error(`Erro de rede: ${response.status}.`);

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // CORREÇÃO: Usa as chaves exatas que o Google Apps Script está enviando
            const newValues = {
                precoVenda: data.precoDeVenda || 'Não informado',
                precoLimite: data.precoLimite || 'Não informado',
                entradaMinima: data.entradaMinima || 'Não informado',
                seguroQueda: data.seguroContraQueda || 'Não informado', // Chave corrigida
                garantiaEstendida: data.garantiaEstendidaDe1Ano || 'Não informado' // Chave corrigida
            };

            // Salva os novos dados no cache
            priceCache[deviceName] = newValues;

            // Atualiza a tela
            vendaEl.textContent = newValues.precoVenda;
            limiteEl.textContent = newValues.precoLimite;
            // Atualiza a entrada mínima apenas se o elemento existir
            if (entradaEl) {
                entradaEl.textContent = newValues.entradaMinima;
            }
            seguroQuedaEl.textContent = newValues.seguroQueda;
            garantiaEstendidaEl.textContent = newValues.garantiaEstendida;
            
            // Compara com os valores antigos e mostra o indicador se mudou
            if (oldValues.venda !== 'Carregando...' && oldValues.venda !== newValues.precoVenda) vendaIndicator.textContent = '(Atualizado!)'; else vendaIndicator.textContent = '';
            if (oldValues.limite !== 'Carregando...' && oldValues.limite !== newValues.precoLimite) limiteIndicator.textContent = '(Atualizado!)'; else limiteIndicator.textContent = '';
            // Compara a entrada mínima apenas se o elemento existir
            if (entradaEl && oldValues.entrada !== 'Carregando...' && oldValues.entrada !== newValues.entradaMinima) entradaIndicator.textContent = '(Atualizado!)'; else if (entradaIndicator) entradaIndicator.textContent = '';
            if (oldValues.seguroQueda !== 'Carregando...' && oldValues.seguroQueda !== newValues.seguroQueda) seguroQuedaIndicator.textContent = '(Atualizado!)'; else seguroQuedaIndicator.textContent = '';
            if (oldValues.garantiaEstendida !== 'Carregando...' && oldValues.garantiaEstendida !== newValues.garantiaEstendida) garantiaEstendidaIndicator.textContent = '(Atualizado!)'; else garantiaEstendidaIndicator.textContent = '';
            
            // Limpa os indicadores após alguns segundos
            setTimeout(() => {
                 allIndicators.forEach(el => { if(el) el.textContent = ''; });
            }, 4000);

        } catch (error) {
            let errorMessage = '(falha ao atualizar)';
            if (error.name === 'AbortError') {
                console.error("Timeout ao buscar preços da planilha para:", deviceName);
            } else {
                console.error("Erro ao buscar dados da planilha para detalhes do dispositivo:", error);
            }
            allIndicators.forEach(el => { if(el) el.textContent = errorMessage; });
            setTimeout(() => {
                allIndicators.forEach(el => { if(el) el.textContent = ''; });
            }, 4000);
        }
    };
    
    // Função modificada para aceitar a marca como parâmetro
const loadDeviceDetails = (key, brand) => {
        currentBrand = brand; // Atualiza a marca atual para o botão de voltar funcionar
        database.ref(`devices/${brand}/${key}`).once('value', snapshot => {
            if (!snapshot.exists()) {
                alert('Este dispositivo não foi encontrado. Pode ter sido excluído.');
                if (brand) {
                    loadBrandDevices(brand);
                } else {
                    showMainPage();
                }
                return;
            }
            const device = snapshot.val();
            document.getElementById('device-detail-title').textContent = device.name;
            const contentContainer = document.getElementById('device-detail-content');

            // Lógica para mostrar ou não o campo de entrada mínima
            const entradaMinimaHTML = brand !== 'apple' ? `
                <h3>Entrada mínima ( Crediário ) 📑 <span class="price-update-indicator" id="entrada-indicator"></span></h3>
                <pre id="device-price-entrada">...</pre>
            ` : '';

            // Estrutura HTML atualizada com as novas seções
            contentContainer.innerHTML = `
                <img src="${device.imageUrl}" alt="${device.name}">
                
                <h3>Preço de venda ✅ <span class="price-update-indicator" id="venda-indicator"></span></h3>
                <pre id="device-price-venda">...</pre>
                
                <h3>Preço limite 🚨 <span class="price-update-indicator" id="limite-indicator"></span></h3>
                <pre id="device-price-limite">...</pre>
                
                ${entradaMinimaHTML}

                <h3>Seguro Contra queda 🛡 <span class="price-update-indicator" id="seguro-queda-indicator"></span></h3>
                <pre id="device-seguro-queda">...</pre>
                
                <h3>Garantia Estendida (+1 Ano) ⚙ <span class="price-update-indicator" id="garantia-estendida-indicator"></span></h3>
                <pre id="device-garantia-estendida">...</pre>

                <h3>⚙️ Ficha Técnica</h3>
                <pre>${device.techSpecs || 'Não informado.'}</pre>

                <button id="edit-device-btn" class="action-button" style="margin-top: 1rem; background-color: #2980b9;"><i class="fa-solid fa-pencil"></i> Editar Dispositivo</button>
                <button id="delete-device-btn" class="action-button delete-button"><i class="fa-solid fa-trash-can"></i> Deletar Dispositivo</button>
            `;
            
            // Lógica de cache para exibição imediata
            const cachedData = priceCache[device.name];
            if (cachedData) {
                document.getElementById('device-price-venda').textContent = cachedData.precoVenda || 'Não informado.';
                document.getElementById('device-price-limite').textContent = cachedData.precoLimite || 'Não informado.';
                // Acessa o elemento de entrada mínima apenas se ele existir
                const entradaEl = document.getElementById('device-price-entrada');
                if (entradaEl) {
                    entradaEl.textContent = cachedData.entradaMinima || 'Não informado.';
                }
                document.getElementById('device-seguro-queda').textContent = cachedData.seguroQueda || 'Não informado.';
                document.getElementById('device-garantia-estendida').textContent = cachedData.garantiaEstendida || 'Não informado.';
            } else {
                // Se não houver cache, exibe "Carregando..."
                 document.getElementById('device-price-venda').textContent = 'Carregando...';
                 document.getElementById('device-price-limite').textContent = 'Carregando...';
                 const entradaEl = document.getElementById('device-price-entrada');
                 if(entradaEl) entradaEl.textContent = 'Carregando...';
                 document.getElementById('device-seguro-queda').textContent = 'Carregando...';
                 document.getElementById('device-garantia-estendida').textContent = 'Carregando...';
            }

            showPage('deviceDetailPage');
            
            // Busca a atualização da planilha em segundo plano
            fetchAndDisplayPriceForDevice(device.name);

            // Adiciona os listeners
            document.getElementById('edit-device-btn').addEventListener('click', () => editDevice(key));
            document.getElementById('delete-device-btn').addEventListener('click', () => deleteDevice(key));
            document.getElementById('back-to-brand-from-detail').addEventListener('click', () => showPage('brandDevicesPage'));
        });
    };

    // Cache para armazenar a lista de dispositivos da planilha
    let sheetDeviceListCache = [];

    const renderSheetDeviceList = (filter = '', brandFilter = '') => {
        const listContainer = document.getElementById('sheet-device-list-container');
        listContainer.innerHTML = '';
        const lowerCaseFilter = filter.toLowerCase();
        const lowerCaseBrand = brandFilter.toLowerCase();

        const filteredList = sheetDeviceListCache.filter(name => {
            const lowerCaseName = name.toLowerCase();
            // Condição 1: O nome do aparelho DEVE começar com o nome da marca.
            const matchesBrand = brandFilter ? lowerCaseName.startsWith(lowerCaseBrand) : true;
            // Condição 2: O nome do aparelho DEVE incluir o texto digitado na busca.
            const matchesSearch = filter ? lowerCaseName.includes(lowerCaseFilter) : true;
            return matchesBrand && matchesSearch;
        });

        if (filteredList.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhum dispositivo encontrado para esta marca.</p>';
            return;
        }

        filteredList.forEach(name => {
            const button = document.createElement('button');
            button.className = 'modal-btn';
            button.textContent = name;
            listContainer.appendChild(button);
        });
    };

        const openDeviceSelectionModal = async () => {
        const selectedBrand = document.getElementById('device-brand').value;
        if (!selectedBrand) {
            alert('Por favor, selecione uma marca primeiro!');
            return;
        }

        const modal = document.getElementById('sheet-device-selection-modal');
        const listContainer = document.getElementById('sheet-device-list-container');
        const searchInput = document.getElementById('sheet-device-search-input');
        
        searchInput.value = '';
        searchInput.disabled = true;
        searchInput.placeholder = 'Carregando lista...';

        modal.style.display = 'flex';
        modal.classList.add('visible');
        
        const renderAndEnable = () => {
            renderSheetDeviceList('', selectedBrand); // Filtra a lista pela marca ao renderizar
            searchInput.disabled = false;
            searchInput.placeholder = `Filtrar em ${selectedBrand}...`;
        };
        
        if (sheetDeviceListCache.length > 0) {
            renderAndEnable();
            return;
        }

        listContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Buscando lista na planilha...</p>';
        try {
            const response = await fetch(`${GOOGLE_SHEET_API_URL}?action=getList`);
            if (!response.ok) throw new Error('Erro de rede.');
            const deviceList = await response.json();
            if (deviceList.error) throw new Error(deviceList.error);

            sheetDeviceListCache = deviceList.sort();
            renderAndEnable();

        } catch (error) {
            listContainer.innerHTML = `<p style="text-align: center; padding: 1rem; color: #e74c3c;">Erro ao buscar lista: ${error.message}</p>`;
            searchInput.placeholder = 'Erro ao carregar a lista';
        }
    };

    const fetchSpreadsheetData = async (deviceName) => {
        const statusEl = document.getElementById('send-device-status');
        const priceTableTextarea = document.getElementById('device-price-table');

        if (!deviceName) {
            statusEl.textContent = 'Selecione um dispositivo da lista primeiro!';
            return;
        }

        statusEl.textContent = `Buscando dados de "${deviceName}"...`;
        priceTableTextarea.value = ''; // Limpa a área de texto enquanto busca

        try {
            const response = await fetch(`${GOOGLE_SHEET_API_URL}?deviceName=${encodeURIComponent(deviceName)}`);
            if (!response.ok) {
                throw new Error(`Erro na rede: ${response.statusText}`);
            }
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // Usa as chaves corretas que o novo script vai gerar (ex: precoDeVenda)
            const precoVenda = data.precoDeVenda || 'Não informado';
            const precoLimite = data.precoLimite || 'Não informado';
            const entradaMinima = data.entradaMinima || 'Não informado';
            
            // Cria o texto formatado e insere na área de texto
            const priceTableText = `Preço de Venda: ${precoVenda}\nPreço Limite: ${precoLimite}\nEntrada Mínima: ${entradaMinima}`;
            
            priceTableTextarea.value = priceTableText;
            statusEl.textContent = 'Dados da planilha carregados!';

        } catch (error) {
            statusEl.textContent = `Erro: ${error.message}`;
            priceTableTextarea.value = `Não foi possível carregar os dados. Verifique a planilha e a conexão.\n\nErro: ${error.message}`;
            console.error("Erro ao buscar dados da planilha:", error);
        }
    };

    // ... (resto do seu código)

    // DENTRO DO document.addEventListener('DOMContentLoaded', () => { ... });
    // Adicione estes novos listeners:
    
            document.getElementById('device-name-display').addEventListener('click', openDeviceSelectionModal);

            const sheetDeviceModal = document.getElementById('sheet-device-selection-modal');
            
            document.getElementById('close-sheet-device-modal-btn').addEventListener('click', () => {
                sheetDeviceModal.style.display = 'none';
                sheetDeviceModal.classList.remove('visible');
            });

            document.getElementById('sheet-device-search-input').addEventListener('input', (e) => {
                const selectedBrand = document.getElementById('device-brand').value;
                renderSheetDeviceList(e.target.value, selectedBrand);
            });

            document.getElementById('sheet-device-list-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-btn')) {
                    const selectedName = e.target.textContent;
                    // Atualiza o valor do input oculto
                    document.getElementById('device-name').value = selectedName;
                    // Atualiza o texto do div visível
                    const displayName = document.getElementById('device-name-display');
                    displayName.textContent = selectedName;
                    displayName.style.color = 'var(--white)'; // Muda a cor para a de texto normal

                    // Fecha a modal
                    sheetDeviceModal.style.display = 'none';
                    sheetDeviceModal.classList.remove('visible');
                    
                    // AÇÃO AUTOMÁTICA: Busca os dados do aparelho selecionado
                    fetchSpreadsheetData(selectedName);
                }
            });

    const deleteDevice = (key) => {
        // A verificação de senha foi removida pois o novo sistema de login já autentica o usuário.
        if (!confirm('Tem certeza que deseja deletar este dispositivo?')) return;
        
        database.ref(`devices/${currentBrand}/${key}`).remove()
            .then(() => { 
                alert('Dispositivo deletado com sucesso!'); 
                loadBrandDevices(currentBrand); // Recarrega a lista de dispositivos da marca
            })
            .catch((error) => { 
                alert('Erro ao deletar o dispositivo.'); 
                console.error("Erro ao deletar dispositivo:", error);
            });
    };

    const editDevice = (key) => {
        editingDeviceKey = key; // Define a chave global para o modo de edição
        database.ref(`devices/${currentBrand}/${key}`).once('value', snapshot => {
            if (snapshot.exists()) {
                const device = snapshot.val();
                
                // Muda a UI para o modo de edição
                document.querySelector('#send-device-page h2').textContent = 'Editar Dispositivo';
                document.getElementById('save-device-btn').textContent = 'Salvar Alterações';

                // Preenche o formulário com os dados existentes
                document.getElementById('device-brand').value = currentBrand;
                
                // Preenche tanto o input oculto quanto o div visível
                const deviceName = device.name;
                document.getElementById('device-name').value = deviceName;
                const displayName = document.getElementById('device-name-display');
                displayName.textContent = deviceName;
                displayName.style.color = 'var(--white)'; // Cor de texto normal
                
                document.getElementById('device-image-url').value = device.imageUrl;
                document.getElementById('device-tech-specs').value = device.techSpecs || '';
                document.getElementById('device-price-table').value = device.priceTable || '';

                showPage('sendDevicePage');
            } else {
                alert('Dispositivo não encontrado. Pode ter sido deletado.');
                editingDeviceKey = null; // Reseta caso não encontre
            }
        });
    };

    const loadDashboardData = () => {
        Promise.all([
            database.ref('salesData').get(),
            database.ref('monthlySales').get(),
            database.ref('metas').get() // CORREÇÃO: Adiciona a busca pelos dados de metas.
        ]).then(([salesSnapshot, monthlySnapshot, metasSnapshot]) => { // CORREÇÃO: Adiciona o snapshot de metas.
            const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
            const monthlyData = monthlySnapshot.exists() ? monthlySnapshot.val() : {};
            const metasData = metasSnapshot.exists() ? metasSnapshot.val() : {}; // CORREÇÃO: Define a variável metasData.

            // --- Cálculos de Vendas Gerais e por Loja ---
            let totalVendas = 0, vendasPinheiro = 0, vendasBacabal = 0;

            // Itera sobre TODOS os colaboradores para obter os totais corretos.
            allCollaborators.forEach(name => {
                const key = name.toLowerCase();
                const venda = parseFloat(salesData[key]?.vendas || 0);
                totalVendas += venda; // Soma para o total geral

                if (storeMapping.pinheiro.includes(name)) {
                    vendasPinheiro += venda;
                } else if (storeMapping.bacabal.includes(name)) {
                    vendasBacabal += venda;
                }
            });

            // --- Cálculo do Melhor VENDEDOR (apenas entre não-gerentes) ---
            const nonManagerCollaborators = allCollaborators.filter(name => !managers.includes(name));
            let melhorVendedor = { nome: 'N/A', vendas: 0 };
            nonManagerCollaborators.forEach(name => {
                const key = name.toLowerCase();
                const venda = parseFloat(salesData[key]?.vendas || 0);
                if (venda > melhorVendedor.vendas) {
                    melhorVendedor = { nome: name, vendas: venda };
                }
            });

            const melhorLoja = vendasPinheiro > vendasBacabal ? 'Pinheiro' : 'Bacabal';

            // --- Atualização do DOM (KPIs) ---
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('total-vendas-kpi').textContent = formatCurrency(totalVendas);
            document.getElementById('pinheiro-vendas-kpi').textContent = formatCurrency(vendasPinheiro);
            document.getElementById('bacabal-vendas-kpi').textContent = formatCurrency(vendasBacabal);
            document.getElementById('melhor-loja-kpi').textContent = melhorLoja;
            document.getElementById('melhor-vendedor-kpi').textContent = melhorVendedor.nome;

            // --- Renderização dos Gráficos e Listas ---
            renderStoreChart(vendasPinheiro, vendasBacabal);
            renderEmployeeGoalProgressChart(salesData, metasData); // Agora esta chamada funciona corretamente.
            renderEmployeeChart(salesData);
            renderMonthlySalesChart(monthlyData);
        });
    };



        const handleParabensClick = async (recipientName) => {
        // A função agora usa o usuário logado (currentUserName) em vez de pedir o nome.
        if (!currentUserName) {
            alert("Erro: Nenhum usuário logado para enviar parabéns.");
            return;
        }

        const senderName = currentUserName;
        const senderKey = senderName.toLowerCase();

        try {
            const todayString = getTodayDateString();
            const recipientKey = recipientName.toLowerCase();

            // Incrementa o contador de "Parabéns" recebidos
            const receivedCountRef = database.ref(`userProfiles/${recipientKey}/parabensReceivedCount`);
            receivedCountRef.transaction(count => {
                const newCount = (count || 0) + 1;
                if (newCount >= 5) {
                    awardAchievement(recipientKey, 'queridinho_da_galera');
                }
                return newCount;
            });

            // Envia a notificação
            const parabensRef = database.ref(`parabens/${todayString}/${recipientKey}`).push();
            await parabensRef.set({ sender: senderName });

            // Concede a conquista para o remetente
            await awardAchievement(senderKey, 'colega_de_equipe');

            alert(`Obrigado! Seu "Parabéns!" foi enviado para ${recipientName}.`);
        } catch (error) {
            console.error("Erro ao enviar parabéns:", error);
            alert("Ocorreu um erro ao enviar seu reconhecimento.");
        }
    };

        const checkForParabens = async (userKey) => {
        const todayString = getTodayDateString();
        const parabensSnap = await database.ref(`parabens/${todayString}/${userKey}`).get();
        if (parabensSnap.exists()) {
            const allParabens = parabensSnap.val();
            const senders = Object.values(allParabens).map(p => p.sender).join(', ');
            
            // Um timeout para o alerta não aparecer imediatamente, atrapalhando a animação
            setTimeout(() => {
                alert(`🎉 Parabéns! Você recebeu reconhecimento de: ${senders}`);
            }, 1500);

            // Remover os parabéns depois de notificar para não mostrar de novo
            database.ref(`parabens/${todayString}/${userKey}`).remove();
        }
    };

    // Adicione o listener dentro do DOMContentLoaded
    document.querySelector('main').addEventListener('click', (event) => {
        const btn = event.target.closest('.parabens-btn');
        if (btn) {
            handleParabensClick(btn.dataset.recipientName);
        }
    });


    const updateAndFetchDailyBonus = async (topUserKey, rankType) => {
        const DAILY_AMOUNT = 3; // ALTERADO: O valor do bônus diário agora é 3.
        const MAX_AMOUNT = 50;
        const todayString = getTodayDateString();
        const bonusRef = database.ref(`dailyBonus/${rankType}`);

        try {
            const { committed, snapshot } = await bonusRef.transaction(currentData => {
                // Se não há dados, inicializa para o novo Top 1
                if (currentData === null) {
                    return { userKey: topUserKey, amount: DAILY_AMOUNT, lastUpdateDate: todayString };
                }

                // Se o Top 1 é o mesmo de antes
                if (currentData.userKey === topUserKey) {
                    // E o bônus de hoje ainda não foi dado
                    if (currentData.lastUpdateDate !== todayString) {
                        currentData.amount = Math.min(MAX_AMOUNT, currentData.amount + DAILY_AMOUNT);
                        currentData.lastUpdateDate = todayString;
                    }
                } 
                // Se o Top 1 mudou
                else {
                    // Zera e começa para o novo usuário
                    currentData.userKey = topUserKey;
                    currentData.amount = DAILY_AMOUNT;
                    currentData.lastUpdateDate = todayString;
                }
                return currentData;
            });
            
            if (committed) {
                return snapshot.val();
            }
            return null; // A transação falhou ou foi abortada
            
        } catch (error) {
            console.error("Erro na transação do bônus diário:", error);
            return null; // Retorna nulo em caso de erro
        }
    };

    const renderMonthlySalesChart = (monthlyData) => {
        const ctx = document.getElementById('monthly-sales-chart').getContext('2d');
        const sortedMonths = Object.keys(monthlyData).sort(); // Ordem cronológica para o gráfico

        const labels = sortedMonths;
        const data = sortedMonths.map(month => monthlyData[month].totalVendas);

        if (monthlySalesChartInstance) {
            monthlySalesChartInstance.destroy();
        }
        monthlySalesChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Vendas Mensais',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(41, 128, 185, 0.2)',
                    borderColor: 'rgba(41, 128, 185, 1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: { 
                    x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const renderStoreChart = (vendasPinheiro, vendasBacabal) => {
        const ctx = document.getElementById('store-sales-chart').getContext('2d');
        if (storeChartInstance) {
            storeChartInstance.destroy(); // Destroi o gráfico anterior para evitar sobreposição
        }
        storeChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Pinheiro', 'Bacabal'],
                datasets: [{
                    label: 'Vendas por Loja',
                    data: [vendasPinheiro, vendasBacabal],
                    backgroundColor: ['rgba(255, 107, 0, 0.8)', 'rgba(41, 128, 185, 0.8)'],
                    borderColor: ['#FF6B00', '#2980b9'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });
    };

    const renderEmployeeGoalProgressChart = (salesData, metasData) => {
        const ctx = document.getElementById('employee-goal-progress-chart').getContext('2d');
        
        // 1. Calcular a porcentagem da meta para cada funcionário
        const goalProgress = allCollaborators.map(name => {
            const key = name.toLowerCase();
            const sales = parseFloat(salesData[key]?.vendas || 0);
            const goal = parseFloat(metasData[key]?.venda || 0);
            // Calcula a porcentagem, mas se a meta for 0, a porcentagem também é 0 para evitar erros.
            const percentage = goal > 0 ? (sales / goal) * 100 : 0;
            return {
                name: name,
                percentage: percentage
            };
        });

        // 2. Ordenar os funcionários pela maior porcentagem atingida
        goalProgress.sort((a, b) => b.percentage - a.percentage);

        // 3. Extrair os nomes e as porcentagens ordenadas
        const sortedLabels = goalProgress.map(item => item.name);
        const sortedData = goalProgress.map(item => item.percentage);

        if (employeeGoalProgressChartInstance) {
            employeeGoalProgressChartInstance.destroy();
        }

        employeeGoalProgressChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: 'Progresso da Meta',
                    data: sortedData,
                    backgroundColor: 'rgba(46, 204, 113, 0.6)', // Cor verde para progresso
                    borderColor: '#2ecc71',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        ticks: { 
                            color: 'white',
                            // Adiciona o símbolo de % no eixo X
                            callback: function(value) { return value + '%'; }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: { ticks: { color: 'white' }, grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    // Configura o tooltip para mostrar a porcentagem formatada
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += context.parsed.x.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    };

    const renderEmployeeChart = (salesData) => {
        const ctx = document.getElementById('employee-sales-chart').getContext('2d');
        
        // 1. Criar um array de objetos com nome e vendas para cada colaborador.
        const employeePerformance = allCollaborators.filter(name => name !== 'Beatriz').map(name => {
            return {
                name: name,
                sales: parseFloat(salesData[name.toLowerCase()]?.vendas || 0)
            };
        });

        // 2. Ordenar o array em ordem decrescente de vendas (do maior para o menor).
        employeePerformance.sort((a, b) => b.sales - a.sales);

        // 3. Extrair os nomes (labels) e os valores (data) já ordenados.
        const sortedLabels = employeePerformance.map(item => item.name);
        const sortedData = employeePerformance.map(item => item.sales);

        if (employeeChartInstance) {
            employeeChartInstance.destroy();
        }
        employeeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedLabels, // Usar os nomes ordenados
                datasets: [{
                    label: 'Vendas',
                    data: sortedData, // Usar os dados de vendas ordenados
                    backgroundColor: 'rgba(255, 107, 0, 0.6)',
                    borderColor: '#FF6B00',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Deixa as barras na horizontal para melhor leitura
                responsive: true,
                scales: { 
                    x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'white' }, grid: { display: false } } 
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const loadAndDisplayIndividualSalesData = () => {
    const container = document.getElementById('individual-sales-data');
    container.innerHTML = `<div class="sales-data-card"><p>Carregando resultados...</p></div>`;
    const userKey = currentUserName.toLowerCase();
    
    const isManager = managers.includes(currentUserName);

    // Se o usuário logado for um gerente, faz a soma dos dados da loja para exibição.
    if (isManager) {
        // Define qual a lista de funcionários da loja da gerente
        const storeEmployees = storeMapping.pinheiro.includes(currentUserName) 
            ? storeMapping.pinheiro 
            : storeMapping.bacabal;

        database.ref('salesData').get().then(snapshot => {
            if (!snapshot.exists()) {
                container.innerHTML = `<div class="sales-data-card"><p>Nenhum dado de venda encontrado.</p></div>`;
                return;
            }
            const allSales = snapshot.val();
            
            // Variáveis para somar os totais da loja inteira
            let totalVendasDaLoja = 0;
            let totalServicoDaLoja = 0;

            // Itera sobre cada funcionário da loja para somar seus valores
            storeEmployees.forEach(employeeName => {
                const employeeKey = employeeName.toLowerCase();
                const employeeData = allSales[employeeKey] || {};
                totalVendasDaLoja += parseFloat(employeeData.vendas || 0);
                totalServicoDaLoja += parseFloat(employeeData.servico || 0);
            });

            // Exibe o card com os dados somados da loja
            container.innerHTML = `
                <div class="sales-data-card">
                    <h4>Resultados Atuais (Loja)</h4>
                    <p>📈 VENDAS: ${formatBRL(totalVendasDaLoja)}</p>
                    <p>🔧 SERVIÇO: ${formatBRL(totalServicoDaLoja)}</p>
                </div>
            `;
        });
    } else {
        // Se não for gerente, busca e exibe apenas os dados individuais do colaborador.
        database.ref(`salesData/${userKey}`).get().then(snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                container.innerHTML = `
                                            <div class="sales-data-card">
                        <h4>Resultados Atuais</h4>
                        <p>📈 VENDAS: ${formatBRL(data.vendas)}</p>
                        <p>🔧 SERVIÇO: ${formatBRL(data.servico || 0)}</p>
                    </div>
                `;
            } else {
                 container.innerHTML = `<div class="sales-data-card"><p>Nenhum dado de venda encontrado.</p></div>`;
            }
        });
    }
};

    const loadManagerPanel = () => {
    const container = document.getElementById('manager-sales-panel-content');
    container.innerHTML = '<p style="text-align:center;">Carregando dados da equipe...</p>';
    showPage('managerSalesPanelPage');

    const managerName = currentUserName;
    const storeEmployees = storeMapping.pinheiro.includes(managerName)
        ? storeMapping.pinheiro
        : storeMapping.bacabal;

    database.ref('salesData').get().then(snapshot => {
        container.innerHTML = ''; // Limpa o "carregando"
        if (!snapshot.exists()) {
            container.innerHTML = '<p>Nenhum dado de venda encontrado para a equipe.</p>';
            return;
        }
        const allSales = snapshot.val();
        
        // --- CÁLCULO DOS TOTAIS DA LOJA ---
        let totalVendasDaLoja = 0, totalServicoDaLoja = 0;

        storeEmployees.forEach(employeeName => {
            const employeeKey = employeeName.toLowerCase();
            const employeeData = allSales[employeeKey] || {};
            totalVendasDaLoja += parseFloat(employeeData.vendas || 0);
            totalServicoDaLoja += parseFloat(employeeData.servico || 0);
        });

        // --- RENDERIZAÇÃO DOS CARDS ---
        storeEmployees.forEach(employeeName => {
            let cardHtml;
            // Se o funcionário atual for a gerente, mostra o card com os totais da loja.
            if (employeeName === managerName) {
                cardHtml = `
                    <div class="sales-data-card" style="border-left: 4px solid var(--primary-color);">
                        <h4>${employeeName} (Total Loja)</h4>
                        <p>📈 VENDAS: ${formatBRL(totalVendasDaLoja)}</p>
                        <p>🔧 SERVIÇO: ${formatBRL(totalServicoDaLoja)}</p>
                    </div>
                `;
            } else {
                // Para os demais funcionários, mostra seus dados individuais.
                const employeeKey = employeeName.toLowerCase();
                const data = allSales[employeeKey] || {};
                cardHtml = `
                    <div class="sales-data-card">
                        <h4>${employeeName}</h4>
                        <p>📈 VENDAS: ${formatBRL(data.vendas)}</p>
                        <p>🔧 SERVIÇO: ${formatBRL(data.servico || 0)}</p>
                    </div>
                `;
            }
            container.innerHTML += cardHtml;
        });
        staggerAnimate(container);
    });
};

        const clearClosingForm = (store) => {
    const employees = storeMapping[store];
    employees.forEach(name => {
        const key = name.toLowerCase();
        document.getElementById(`closing-venda-${key}`).value = '';
        document.getElementById(`closing-servico-${key}`).value = '';
        document.getElementById(`closing-preco-site-${key}`).value = '';
    });
};

            const submitClosingData = () => {
    const statusEl = document.getElementById('closing-status-message');
    if (!confirm('Tem certeza que deseja enviar esses dados? A ação não pode ser desfeita.')) {
        return;
    }
    statusEl.textContent = 'Salvando...';

    const formPinheiro = document.getElementById('closing-form-pinheiro');
    const store = formPinheiro.style.display !== 'none' ? 'pinheiro' : 'bacabal';
    const employeesForStore = storeMapping[store];

    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
    const todayString = getTodayDateString();

    Promise.all([
        database.ref('salesData').get(),
        database.ref(`monthlySales/${currentMonthKey}`).get(),
        database.ref(`dailySales/${todayString}`).get()
    ]).then(([salesSnapshot, monthlySalesSnapshot, dailySalesSnapshot]) => {
        const existingSales = salesSnapshot.exists() ? salesSnapshot.val() : {};
        let monthlyTotalVendas = monthlySalesSnapshot.exists() ? monthlySalesSnapshot.val().totalVendas : 0;
        const existingDailySales = dailySalesSnapshot.exists() ? dailySalesSnapshot.val() : {};
        let totalVendasDoFechamento = 0;
        let totalPrecoSiteDoFechamento = 0; 

        const updates = {};
        
        employeesForStore.forEach(name => {
            const key = name.toLowerCase();
            // REMOVIDO: p1p2, cartao, vendaRemota (nao sao mais somados no fechamento, apenas vendas e servico)
            const currentData = existingSales[key] || { vendas: 0, servico: 0 };
            const currentDailyData = existingDailySales[key] || { vendas: 0 };

            const newVenda = parseFromBRLInput(document.getElementById(`closing-venda-${key}`).value);
            const newServico = parseFromBRLInput(document.getElementById(`closing-servico-${key}`).value);
            const newPrecoSite = parseFromBRLInput(document.getElementById(`closing-preco-site-${key}`).value);
            
            // Venda Remota foi removida, Preco Site continua somando para totalVendasDoFechamento mas nao no salesData
            totalVendasDoFechamento += (newVenda + newPrecoSite);
            totalPrecoSiteDoFechamento += newPrecoSite;

            existingSales[key] = {
                vendas: (parseFloat(currentData.vendas) || 0) + newVenda + newPrecoSite,
                servico: (parseFloat(currentData.servico) || 0) + newServico,
            };
            
            updates[`/dailySales/${todayString}/${key}`] = {
                vendas: (currentDailyData.vendas || 0) + newVenda + newPrecoSite
            };
        });

            monthlyTotalVendas += totalVendasDoFechamento;
            
            updates['/salesData'] = existingSales;
            updates[`/monthlySales/${currentMonthKey}/totalVendas`] = monthlyTotalVendas;

            // Encontra a gerente da loja para descontar da verba de Preço de Site
            const managerName = store === 'pinheiro' ? 'Beatriz' : 'Natalia';
            const managerKey = managerName.toLowerCase();
            const precoSiteCashRef = database.ref(`cashManagement/${managerKey}/currentVendaRemotaValue`);
            
            // Usa transação para subtrair o valor da verba de site
            precoSiteCashRef.transaction(currentValue => {
                const baseValue = currentValue !== null ? currentValue : SITE_CASH_BOX_INITIAL_VALUE;
                return baseValue - totalPrecoSiteDoFechamento;
            });

            database.ref().update(updates).then(() => {
                statusEl.textContent = 'Fechamento salvo com sucesso!';
                employeesForStore.forEach(name => checkAndAwardAchievements(name.toLowerCase()));
                clearClosingForm(store);
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            }).catch(error => {
                statusEl.textContent = 'Erro ao salvar os dados!';
                console.error(error);
            });
        });
    };

                const updateStoreTotalsOnCorrectionPage = () => {
        const storeTotals = {
            pinheiro: { vendas: 0, servico: 0 },
            bacabal: { vendas: 0, servico: 0 }
        };

        // Recalcula os totais com base nos valores ATUAIS dos inputs dos funcionários
        for (const store in storeMapping) {
            storeMapping[store].filter(name => name !== 'Beatriz').forEach(employeeName => {
                const employeeKey = employeeName.toLowerCase();
                storeTotals[store].vendas += parseFromBRLInput(document.getElementById(`correction-vendas-${employeeKey}`).value);
                storeTotals[store].servico += parseFromBRLInput(document.getElementById(`correction-servico-${employeeKey}`).value);
            });
        }

        // Atualiza os campos de total da loja na tela
        for (const storeName in storeTotals) {
            const totals = storeTotals[storeName];
            const totalCardIdPrefix = `total-loja-${storeName}`;
            
            document.getElementById(`${totalCardIdPrefix}-vendas`).value = formatToBRLInput(totals.vendas);
            document.getElementById(`${totalCardIdPrefix}-servico`).value = formatToBRLInput(totals.servico);
        }
    };

                const distributeStoreTotal = (storeName, field) => {
            const employees = storeMapping[storeName];
            const isCurrency = field === 'vendas' || field === 'p1p2';
            
            const totalInput = document.getElementById(`total-loja-${storeName}-${field}`);
            const newTotal = isCurrency ? parseFromBRLInput(totalInput.value) : parseInt(totalInput.value, 10) || 0;

            // 1. Calcular o total antigo somando os valores atuais dos funcionários
            let oldTotal = 0;
            employees.forEach(employeeName => {
                const key = employeeName.toLowerCase();
                const input = document.getElementById(`correction-${field}-${key}`);
                oldTotal += isCurrency ? parseFromBRLInput(input.value) : parseInt(input.value, 10) || 0;
            });
            
            // 2. Distribuir o novo total
            employees.forEach(employeeName => {
                const key = employeeName.toLowerCase();
                const input = document.getElementById(`correction-${field}-${key}`);
                const oldValue = isCurrency ? parseFromBRLInput(input.value) : parseInt(input.value, 10) || 0;

                let newValue;
                if (oldTotal > 0) {
                    // Distribuição proporcional
                    const proportion = oldValue / oldTotal;
                    newValue = newTotal * proportion;
                } else {
                    // Se o total era zero, distribui igualmente
                    newValue = newTotal / employees.length;
                }
                
                input.value = isCurrency ? formatToBRLInput(newValue) : Math.round(newValue);
            });
        };

        const buildAndLoadCorrectionPage = () => {
        const container = document.getElementById('correction-content-container');
        container.innerHTML = `<p style="text-align: center;">Carregando dados para correção...</p>`;

        database.ref('salesData').get().then(snapshot => {
            const allSales = snapshot.exists() ? snapshot.val() : {};
            container.innerHTML = '';

            allCollaborators.filter(name => name !== 'Beatriz').forEach(name => { // Oculta Beatriz da correção
                const key = name.toLowerCase();
                const salesData = allSales[key] || {};
                                    container.innerHTML += `
                    <div class="employee-meta-card">
                        <h4>${name}</h4>
                        <div class="input-group"><label for="correction-vendas-${key}">📈 VENDAS (R$)</label><input type="text" id="correction-vendas-${key}" class="data-input" value="${formatToBRLInput(salesData.vendas)}"></div>
                        <div class="input-group"><label for="correction-servico-${key}">🔧 SERVIÇO (R$)</label><input type="text" inputmode="decimal" id="correction-servico-${key}" class="data-input" value="${formatToBRLInput(salesData.servico)}"></div>
                    </div>
                `;
            });

            const storeTotals = {
                pinheiro: { vendas: 0, servico: 0 },
                bacabal: { vendas: 0, servico: 0 }
            };
            for (const store in storeMapping) {
                storeMapping[store].filter(name => name !== 'Beatriz').forEach(employeeName => {
                    const employeeKey = employeeName.toLowerCase();
                    const employeeData = allSales[employeeKey] || {};
                    storeTotals[store].vendas += parseFloat(employeeData.vendas || 0);
                    storeTotals[store].servico += parseFloat(employeeData.servico || 0);
                });
            }

            for (const storeName in storeTotals) {
                const totals = storeTotals[storeName];
                const totalCardIdPrefix = `total-loja-${storeName}`;
                const storeTitle = storeName.charAt(0).toUpperCase() + storeName.slice(1);

                container.innerHTML += `
                    <div class="employee-meta-card" style="border-left: 4px solid var(--primary-color);">
                        <h4 style="color: #fff;">Editar Total Loja ${storeTitle}</h4>
                        <div class="input-group"><label for="${totalCardIdPrefix}-vendas">📈 TOTAL VENDAS</label><input type="text" id="${totalCardIdPrefix}-vendas" class="data-input" value="${formatToBRLInput(totals.vendas)}"></div>
                        <div class="input-group"><label for="${totalCardIdPrefix}-servico">🔧 TOTAL SERVIÇO</label><input type="text" id="${totalCardIdPrefix}-servico" class="data-input" value="${formatToBRLInput(totals.servico)}"></div>
                    </div>
                `;
            }
            
            const fields = ['vendas', 'servico'];
            for (const storeName in storeMapping) {
                fields.forEach(field => {
                    const totalInput = document.getElementById(`total-loja-${storeName}-${field}`);
                    totalInput.addEventListener('change', () => distributeStoreTotal(storeName, field));
                });
            }

            // Adiciona o botão de salvar e o status ao final do container
            container.innerHTML += `
                <button id="save-all-corrections-btn" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Correções</button>
                <p id="correction-status-message" class="status-message"></p>
            `;
            // Reatribui o listener ao novo botão
            document.getElementById('save-all-corrections-btn').addEventListener('click', saveCorrections);
        });
    };

const saveCorrections = () => {
    const statusMessage = document.getElementById('correction-status-message');
    statusMessage.textContent = 'Salvando correções...';
    
    const dataToSave = {};

    // Itera sobre TODOS os colaboradores, filtrando Beatriz.
    allCollaborators.filter(name => name !== 'Beatriz').forEach(name => {
        const key = name.toLowerCase();
        
        // Lê os valores dos campos de cada colaborador e os adiciona ao objeto que será salvo.
        // REMOVIDO: p1p2, vendaRemota, cartao
        dataToSave[key] = {
            vendas: parseFromBRLInput(document.getElementById(`correction-vendas-${key}`).value),
            servico: parseFromBRLInput(document.getElementById(`correction-servico-${key}`).value),
        };
    });

    // O método .set() substitui completamente os dados no nó 'salesData' com os novos dados lidos do formulário.
    database.ref('salesData').set(dataToSave)
        .then(() => {
            statusMessage.textContent = 'Dados corrigidos com sucesso!';
            // Recarrega a página para recalcular e exibir os totais atualizados
            buildAndLoadCorrectionPage(); 
            setTimeout(() => { statusMessage.textContent = ''; }, 3000);
        })
        .catch((error) => {
            statusMessage.textContent = 'Erro ao salvar as correções!';
            console.error(error);
        });
};

    const changePassword = () => {
        const newPassword = prompt("Digite sua nova senha. Deixe em branco para remover a senha.");
        if (newPassword === null) {
            return; // Usuário cancelou
        }

        const userKey = currentUserName.toLowerCase(); // USA A NOVA VARIÁVEL

        if (newPassword.trim() === "") {
            // Se o campo for deixado em branco, remove a senha
            database.ref('userPasswords/' + userKey).remove()
                .then(() => {
                    alert('Sua senha pessoal foi removida com sucesso!');
                })
                .catch(error => {
                    alert('Ocorreu um erro ao remover a senha.');
                    console.error(error);
                });
        } else {
            // Se uma nova senha for digitada, salva ela
            database.ref('userPasswords/' + userKey).set(newPassword)
                .then(() => {
                    alert('Senha alterada com sucesso!');
                })
                .catch(error => {
                    alert('Ocorreu um erro ao salvar a nova senha.');
                    console.error(error);
                });
        }
    };

    const calculateDeliveryPrediction = () => {
        // Pega a data de hoje
        const today = new Date();
        
        // Cria uma nova data para a entrega e adiciona 15 dias
        const deliveryDate = new Date();
        deliveryDate.setDate(today.getDate() + 15);
        
        // Define as opções de formatação (dia numérico e mês por extenso)
        const options = { day: 'numeric', month: 'long' };
        
        // Formata a data para o padrão pt-BR
        const formattedDate = deliveryDate.toLocaleDateString('pt-BR', options);
        
        // Monta e exibe a mensagem em um alerta
        alert(`Comprando hoje, o produto chegará no máximo em ${formattedDate}`);
    };

    const openSuporteModal = () => {
        const modal = elements.suporteModal;
        if(isNavigating) return;
        isNavigating = true;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            staggerAnimate(modal);
            isNavigating = false;
        });
    };

    const closeSuporteModal = () => {
        const modal = elements.suporteModal;
        if (isNavigating || !modal.classList.contains('visible')) return;
        isNavigating = true;

        modal.classList.add('is-exiting');

        modal.addEventListener('animationend', (e) => {
            modal.style.display = 'none';
            modal.classList.remove('visible', 'is-exiting');
            isNavigating = false;
        }, { once: true });
    };

    const openOsModal = () => {
        const modal = elements.osModal;
        if(isNavigating) return;
        isNavigating = true;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            staggerAnimate(modal);
            isNavigating = false;
        });
    };

    const closeOsModal = (callback) => {
        const modal = elements.osModal;
        if (isNavigating || !modal.classList.contains('visible')) return;
        isNavigating = true;

        modal.classList.add('is-exiting');
        modal.addEventListener('animationend', (e) => {
            modal.style.display = 'none';
            modal.classList.remove('visible', 'is-exiting');
            isNavigating = false;
            if (typeof callback === 'function') callback();
        }, { once: true });
    };

    const sendOsEmail = () => {
        const statusEl = document.getElementById('os-form-status');
        const colaborador = document.getElementById('os-colaborador').value.trim();
        const cidade = document.getElementById('os-cidade').value.trim();
        const dataEnvio = document.getElementById('os-data').value;

        if (!colaborador || !cidade || !dataEnvio) {
            statusEl.textContent = 'Preencha todos os campos obrigatórios!';
            return;
        }

        let body = `ORDEM DE SERVIÇO\n`;
        body += `--------------------------------\n`;
        body += `COLABORADOR: ${colaborador}\n`;
        body += `CIDADE REMETENTE: ${cidade}\n`;
        body += `DATA DE ENVIO: ${new Date(dataEnvio + 'T12:00:00').toLocaleDateString('pt-BR')}\n`;
        body += `--------------------------------\n\n`;
        body += `ATENÇÃO: REMOVA A SENHA DO APARELHO!\n\n`;

        let hasDevice = false;
        for (let i = 1; i <= 5; i++) {
            const cliente = document.getElementById(`os-cliente-${i}`).value.trim();
            const modelo = document.getElementById(`os-modelo-${i}`).value.trim();

            if (cliente || modelo) {
                hasDevice = true;
                body += `--- APARELHO ${i} ---\n`;
                body += `CLIENTE/TELEFONE:\n${cliente}\n\n`;
                body += `MODELO/DEFEITO/IMEI:\n${modelo}\n`;
                body += `---------------------\n\n`;
            }
        }

        if (!hasDevice) {
            statusEl.textContent = 'Adicione pelo menos um aparelho!';
            return;
        }

        const recipient = 'paulotrindade700@gmail.com';
        const subject = `OS - ${cidade} - ${colaborador}`;
        
        window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        statusEl.textContent = 'Abrindo seu cliente de email...';
    };

    const renderStockSelectionList = () => {
        const listContainer = document.getElementById('stock-selection-list');
        const footer = document.getElementById('stock-selection-footer');
        
        if (stockRequestSelection.length === 0) {
            footer.style.display = 'none';
            return;
        }

        listContainer.innerHTML = stockRequestSelection.map(item => 
            `<div>- ${item.name} | Cor: ${item.color} | Qtd: ${item.quantity}</div>`
        ).join('');
        
        footer.style.display = 'block';
    };

    const openStockRequestPage = () => {
        const listContainer = document.getElementById('stock-product-list');
        listContainer.innerHTML = '<p>Carregando dispositivos...</p>';
        stockRequestSelection = []; // Limpa a seleção anterior
        renderStockSelectionList(); // Esconde o footer
        showPage('requestStockPage');

        database.ref('devices').get().then(snapshot => {
            if (!snapshot.exists()) {
                listContainer.innerHTML = '<p>Nenhum dispositivo encontrado no banco de dados.</p>';
                return;
            }
            listContainer.innerHTML = '';
            const allDevicesByBrand = snapshot.val();

            // Itera sobre cada marca
            for (const brand in allDevicesByBrand) {
                const brandHeader = document.createElement('h3');
                brandHeader.className = 'stock-brand-header';
                brandHeader.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
                listContainer.appendChild(brandHeader);

                const devices = allDevicesByBrand[brand];
                // Itera sobre cada dispositivo dentro da marca
                for (const key in devices) {
                    const device = devices[key];
                    const card = document.createElement('div');
                    card.className = 'stock-product-card';
                    card.innerHTML = `<img src="${device.imageUrl}" alt="${device.name}"><span>${device.name}</span>`;
                    
                    card.addEventListener('click', () => {
                        const color = prompt(`Digite a cor para ${device.name}:`);
                        if (!color) return; // Usuário cancelou

                        const quantityRaw = prompt(`Digite a quantidade:`);
                        if (!quantityRaw) return; // Usuário cancelou

                        const quantity = parseInt(quantityRaw, 10);
                        if (isNaN(quantity) || quantity <= 0) {
                            alert('Por favor, insira uma quantidade válida.');
                            return;
                        }

                        stockRequestSelection.push({ name: device.name, color: color, quantity: quantity });
                        renderStockSelectionList();
                    });

                    listContainer.appendChild(card);
                }
            }
        });
    };

    const submitStockRequest = () => {
        if (stockRequestSelection.length === 0) {
            alert('Adicione pelo menos um item ao pedido.');
            return;
        }

        const requester = prompt("Digite seu nome para identificação na solicitação:");
        if (!requester) {
            alert("Nome é obrigatório para enviar a solicitação.");
            return;
        }

        const city = prompt("Digite sua CIDADE (Pinheiro ou Bacabal):");
        if (!city) {
            alert("Cidade é obrigatória para enviar a solicitação.");
            return;
        }

        const requestData = {
            requester: requester.trim(),
            city: city.trim(),
            items: stockRequestSelection,
            timestamp: new Date().toISOString(),
            read: false
        };

        database.ref('stockRequests').push(requestData)
            .then(() => {
                alert('Solicitação de estoque enviada com sucesso para a gerência!');
                // Limpa tudo após o envio
                stockRequestSelection = [];
                document.getElementById('custom-item-name').value = '';
                document.getElementById('custom-item-color').value = '';
                document.getElementById('custom-item-quantity').value = '';
                renderStockSelectionList();
            })
            .catch(error => {
                alert('Ocorreu um erro ao enviar a solicitação.');
                console.error('Erro ao salvar solicitação de estoque:', error);
            });
    };

    const submitRecibo = () => {
        const statusEl = document.getElementById('recibo-status-message');
        const nome = document.getElementById('recibo-nome').value.trim();
        const loja = document.getElementById('recibo-loja').value.trim().toLowerCase();
        const gastos = document.getElementById('recibo-gastos').value.trim();
        const dia = document.getElementById('recibo-dia').value.trim();
        const mes = document.getElementById('recibo-mes').value.trim();
        const ano = document.getElementById('recibo-ano').value.trim();

        if (!nome || !loja || !gastos || !dia || !mes || !ano) {
            statusEl.textContent = 'Preencha todos os campos obrigatórios!';
            return;
        }
        
        if (loja !== 'pinheiro' && loja !== 'bacabal') {
            statusEl.textContent = 'Por favor, digite a loja como "Pinheiro" ou "Bacabal".';
            return;
        }

        const reciboData = {
            nome,
            loja,
            gastos,
            dataGasto: `${dia}/${mes}/${ano}`,
            timestamp: new Date().toISOString(),
            read: false
        };

        // Calcula o valor total do recibo para abater da verba da loja
        const numberRegex = /(\d[\d.,]*)/g; 
        const matches = gastos.match(numberRegex) || [];
        let totalGasto = 0;
        matches.forEach(match => {
            totalGasto += parseFromBRLInput(match);
        });

        database.ref('reciboSubmissions').push(reciboData)
            .then(() => {
                statusEl.textContent = 'Recibo enviado! Atualizando verba...';

                if (totalGasto > 0) {
                    const managerName = loja === 'pinheiro' ? 'Beatriz' : 'Natalia';
                    const managerKey = managerName.toLowerCase();
                    const storeCashRef = database.ref(`cashManagement/${managerKey}/currentStoreValue`);
                    
                    storeCashRef.transaction(currentValue => {
                        let newValue = currentValue !== null ? currentValue : CASH_BOX_INITIAL_VALUE;
                        return newValue - totalGasto;
                    });
                }
                
                // Limpa o formulário após o envio
                document.getElementById('recibo-nome').value = '';
                document.getElementById('recibo-loja').value = '';
                document.getElementById('recibo-gastos').value = '';
                document.getElementById('recibo-dia').value = '';
                document.getElementById('recibo-mes').value = '';
                document.getElementById('recibo-ano').value = '';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao enviar o recibo.';
                console.error("Erro ao salvar recibo:", error);
            });
    };

    const submitQuiz = () => {
        const statusEl = document.getElementById('quiz-status-message');

        const nome = document.getElementById('quiz-nome').value.trim();
        const gostouTreinamento = document.querySelector('input[name="gostou_treinamento"]:checked');
        const parteUtil = document.getElementById('quiz_parte_util').value.trim();
        const parteConfusa = document.querySelector('input[name="parte_confusa"]:checked');
        const parteConfusaDetalhe = document.getElementById('quiz_parte_confusa_detalhe').value.trim();
        const ajudouPreparar = document.querySelector('input[name="ajudou_preparar"]:checked');
        const proximoTemaRadio = document.querySelector('input[name="proximo_tema"]:checked');
        const proximoTemaOutro = document.getElementById('quiz_proximo_tema_outro').value.trim();
        const sugestao = document.getElementById('quiz_sugestao').value.trim();

        if (!nome || !gostouTreinamento || !parteUtil || !parteConfusa || !ajudouPreparar || !proximoTemaRadio) {
            statusEl.textContent = 'Por favor, responda todas as perguntas obrigatórias.';
            return;
        }

        let proximoTemaFinal = proximoTemaRadio.labels[0].innerText;
        if (proximoTemaRadio.id === 'tema-outro') {
            if (!proximoTemaOutro) {
                statusEl.textContent = 'Por favor, especifique o outro tema para o próximo treinamento.';
                return;
            }
            proximoTemaFinal = `Outro: ${proximoTemaOutro}`;
        }
        
        let parteConfusaFinal = parteConfusa.value;
        if (parteConfusa.value === 'Sim') {
            if (!parteConfusaDetalhe) {
                statusEl.textContent = 'Por favor, especifique qual parte do treinamento ficou confusa.';
                return;
            }
            parteConfusaFinal = `Sim: ${parteConfusaDetalhe}`;
        }

        const quizData = {
            nome,
            respostas: {
                gostou: gostouTreinamento.value,
                parteUtil: parteUtil,
                parteConfusa: parteConfusaFinal,
                ajudouPreparar: ajudouPreparar.value,
                proximoTema: proximoTemaFinal,
                sugestao: sugestao
            },
            timestamp: new Date().toISOString(),
            read: false
        };

        database.ref('quizSubmissions').push(quizData)
            .then(() => {
                statusEl.textContent = 'Feedback enviado com sucesso!';
                document.getElementById('quiz-nome').value = '';
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('textarea, input[type="text"]').forEach(input => input.id !== 'quiz-nome' ? input.value = '' : null);
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao enviar o feedback.';
                console.error("Erro ao salvar quiz:", error);
            });
    };

        const displayMtForBrand = (brand) => {
        const mtContentArea = document.getElementById('mt-content-area');
        if (!brand) {
            mtContentArea.innerHTML = `<p style="text-align: center;">Selecione uma marca para ver os itens.</p>`;
            return;
        }
        mtContentArea.innerHTML = `<p style="text-align: center;">Carregando itens para ${brand}...</p>`;

        database.ref(`mostruario/${brand}`).on('value', snapshot => {
            mtContentArea.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const item = childSnapshot.val();
                    const card = document.createElement('div');
                    card.className = 'mt-item-card';
                    card.innerHTML = `<pre>${item.text}</pre>`;
                    mtContentArea.appendChild(card);
                });
            } else {
                mtContentArea.innerHTML = `<p style="text-align: center;">Nenhum item de mostruário encontrado para esta marca.</p>`;
            }
        });
    };

    const loadAndShowMtManagementPage = () => {
        showPage('mtManagementPage');
        const mtListContainer = document.getElementById('mt-list-container');
        mtListContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        database.ref('mostruario').get().then(snapshot => {
            mtListContainer.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach(brandSnapshot => {
                    const brand = brandSnapshot.key;
                    const brandTitle = document.createElement('h4');
                    brandTitle.className = 'meta-group-title';
                    brandTitle.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
                    mtListContainer.appendChild(brandTitle);

                    brandSnapshot.forEach(itemSnapshot => {
                        const key = itemSnapshot.key;
                        const item = itemSnapshot.val();
                        const listItem = document.createElement('div');
                        listItem.className = 'mt-list-item';
                        listItem.innerHTML = `
                            <div class="mt-list-item-text">${item.text}</div>
                            <button class="delete-button-small" data-brand="${brand}" data-key="${key}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        `;
                        mtListContainer.appendChild(listItem);
                    });
                });
            } else {
                mtListContainer.innerHTML = `<p style="text-align:center;">Nenhum item cadastrado.</p>`;
            }
        });
    };

    const saveMtItem = () => {
        const mtAddBrandSelect = document.getElementById('mt-add-brand');
        const mtAddTextarea = document.getElementById('mt-add-text');
        const mtAddStatus = document.getElementById('mt-add-status');
        const brand = mtAddBrandSelect.value;
        const text = mtAddTextarea.value.trim();

        if (!brand || !text) {
            mtAddStatus.textContent = 'Marca e texto são obrigatórios!';
            return;
        }
        mtAddStatus.textContent = 'Salvando...';

        database.ref(`mostruario/${brand}`).push({ text: text }).then(() => {
            mtAddStatus.textContent = 'Item salvo com sucesso!';
            mtAddTextarea.value = '';
            mtAddBrandSelect.selectedIndex = 0;
            loadAndShowMtManagementPage(); // Recarrega a lista
            setTimeout(() => { mtAddStatus.textContent = ''; }, 3000);
        }).catch(err => {
            mtAddStatus.textContent = 'Erro ao salvar!';
            console.error(err);
        });
    };

    const deleteMtItem = (brand, key) => {
        if (confirm('Tem certeza que deseja excluir este item?')) {
            database.ref(`mostruario/${brand}/${key}`).remove().then(() => {
                alert('Item excluído!');
                loadAndShowMtManagementPage(); // Recarrega a lista
            }).catch(err => {
                alert('Erro ao excluir!');
                console.error(err);
            });
        }
    };

async function calculateAndDisplayRanking() {
const rankingContainer = document.getElementById('ranking-container');
rankingContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Calculando ranking...</p>';
Promise.all([
        database.ref('salesData').get(),
        database.ref('metas').get(),
        database.ref('userProfiles').get(),
        database.ref('userStatuses').get() // Adicionado para buscar status
    ]).then(async ([salesSnapshot, metasSnapshot, profilesSnapshot, statusesSnapshot]) => {
        if (!salesSnapshot.exists() || !metasSnapshot.exists()) {
            rankingContainer.innerHTML = '<p style="text-align: center;">Dados insuficientes para gerar o ranking.</p>';
            return;
        }

        const salesData = salesSnapshot.val();
        const metasData = metasSnapshot.val();
        const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};
        const statusesData = statusesSnapshot.exists() ? statusesSnapshot.val() : {};
        const performanceData = [];

        const eligibleCollaborators = allCollaborators.filter(name => !managers.includes(name));

        eligibleCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const actualSales = parseFloat(salesData[key]?.vendas || 0);
            const salesGoal = parseFloat(metasData[key]?.venda || 0);

            if (salesGoal > 0) {
                const percentage = (actualSales / salesGoal) * 100;
                performanceData.push({
                    name: name,
                    percentage: percentage
                });
            }
        });

        performanceData.sort((a, b) => b.percentage - a.percentage);

        rankingContainer.innerHTML = '';
        const top3 = performanceData.slice(0, 3);

        if (top3.length === 0) {
            rankingContainer.innerHTML = '<p style="text-align: center;">Nenhum colaborador com meta definida para o ranking.</p>';
            return;
        }

        for (const [index, collab] of top3.entries()) {
            const rank = index + 1;

            if (rank === 1) {
                awardAchievement(collab.name.toLowerCase(), 'rei_do_ranking');
            }

            const medals = ['<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>'];
            let prizeHTML = '';
            // REMOVIDO: Imagem flutuante do JBL Boombox para o Rank Normal
            
            const rankItem = document.createElement('div');
            rankItem.className = `rank-item rank-${rank}`;
            
            const progressBarWidth = collab.percentage;

            const defaultPhoto = DEFAULT_PROFILE_PHOTO;
            const collaboratorProfile = profilesData[collab.name.toLowerCase()];
            const photoUrl = collaboratorProfile && collaboratorProfile.photoURL ? collaboratorProfile.photoURL : defaultPhoto;
            const crownHtml = (rank === 1) ? '<i class="fas fa-crown rank-crown"></i>' : '';

            // --- LÓGICA DA BOLHA DE STATUS ---
            let statusBubbleHtml = '';
            const userStatus = statusesData[collab.name.toLowerCase()];
            if (userStatus && userStatus.text) {
                const statusTimestamp = new Date(userStatus.timestamp);
                const now = new Date();
                const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);
                if (hoursDiff < 24) {
                    statusBubbleHtml = `<div class="status-bubble">${userStatus.text}</div>`;
                }
            }
            // --- FIM DA LÓGICA DA BOLHA ---

            let fireIconHtml = '';
            if (rank === 1) {
                awardAchievement(collab.name.toLowerCase(), 'rei_do_ranking');
                // Limita a posição do ícone em 98% para não sair da tela em 100%
                const firePosition = Math.min(progressBarWidth, 98); 
                // Gera o ícone com a posição 'left' calculada dinamicamente
                fireIconHtml = `<i class="fas fa-fire fire-icon" style="left: ${firePosition}%;"></i>`;
            }

            rankItem.innerHTML = `
                <div class="rank-photo-container">
                    ${crownHtml}
                    <img src="${photoUrl}" alt="Foto de ${collab.name}" class="rank-photo">
                </div>
                <div class="rank-medal" style="width: auto; padding-right: 8px;">
                    <span style="font-weight: bold; margin-right: 2px;">${rank}º</span>
                    ${medals[index]}
                </div>
                <div class="rank-details">
                    <div class="rank-name">
                        <span>${collab.name}</span>
                        <button class="parabens-btn" data-recipient-name="${collab.name}"><i class="fa-solid fa-hands-clapping"></i></button>
                        <div class="prize-container">${prizeHTML}</div>
                    </div>
                    ${statusBubbleHtml}
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progressBarWidth}%;"></div>
                        <span class="progress-percentage">${collab.percentage.toFixed(1)}%</span>
                        ${fireIconHtml}
                    </div>
                </div>
            `;
            rankingContainer.appendChild(rankItem);
        };
    }).catch(error => {
        console.error("Erro ao carregar dados para o ranking:", error);
        rankingContainer.innerHTML = '<p style="text-align: center;">Erro ao carregar o ranking.</p>';
    });
};

async function calculateAndDisplayServiceRanking() {
    const rankingContainer = document.getElementById('service-ranking-container');
    rankingContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Calculando ranking de serviços...</p>';

    Promise.all([
        database.ref('salesData').get(),
        database.ref('metas').get(),
        database.ref('userProfiles').get()
    ]).then(async ([salesSnapshot, metasSnapshot, profilesSnapshot]) => {
        if (!salesSnapshot.exists() || !metasSnapshot.exists()) {
            rankingContainer.innerHTML = '<p style="text-align: center;">Dados insuficientes para gerar o ranking.</p>';
            return;
        }

        const salesData = salesSnapshot.val();
        const metasData = metasSnapshot.val();
        const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};
        const performanceData = [];

        const eligibleCollaborators = allCollaborators.filter(name => !managers.includes(name));

        eligibleCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const actualService = parseFloat(salesData[key]?.servico || 0);
            const serviceGoal = parseFloat(metasData[key]?.meta_servico || 0);

            if (serviceGoal > 0) {
                const percentage = (actualService / serviceGoal) * 100;
                performanceData.push({
                    name: name,
                    percentage: percentage
                });
            }
        });

        performanceData.sort((a, b) => b.percentage - a.percentage);

        rankingContainer.innerHTML = '';
        const top3 = performanceData.slice(0, 3);

        if (top3.length === 0) {
            rankingContainer.innerHTML = '<p style="text-align: center;">Nenhuma meta de serviço definida.</p>';
            return;
        }

        for (const [index, collab] of top3.entries()) {
            const rank = index + 1;
            const medals = ['<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>'];
            let prizeValue = '';
            
            if (rank === 1) prizeValue = 'R$ 1.000,00';
            else if (rank === 2) prizeValue = 'R$ 500,00';
            else if (rank === 3) prizeValue = 'R$ 250,00';

            const rankItem = document.createElement('div');
            rankItem.className = `rank-item rank-${rank}`;
            
            const progressBarWidth = collab.percentage;
            const defaultPhoto = DEFAULT_PROFILE_PHOTO;
            const collaboratorProfile = profilesData[collab.name.toLowerCase()];
            const photoUrl = collaboratorProfile && collaboratorProfile.photoURL ? collaboratorProfile.photoURL : defaultPhoto;

            // Nova imagem flutuante para o rank de serviços
            const serviceIcon = `<img src="https://cdn-icons-png.flaticon.com/512/6073/6073235.png" style="width: 40px; height: 40px; margin-left: 8px; vertical-align: middle; animation: pulse 2s infinite;">`;

            let fireIconHtml = '';
            if (rank === 1) {
                const firePosition = Math.min(progressBarWidth, 98); 
                fireIconHtml = `<i class="fas fa-fire fire-icon-purple" style="left: ${firePosition}%;"></i>`;
            }

            rankItem.innerHTML = `
                <div class="rank-photo-container">
                    <img src="${photoUrl}" alt="Foto de ${collab.name}" class="rank-photo">
                </div>
                <div class="rank-medal" style="width: auto; padding-right: 8px;">
                    <span style="font-weight: bold; margin-right: 2px;">${rank}º</span>
                    ${medals[index]}
                </div>
                <div class="rank-details">
                    <div class="rank-name" style="justify-content: space-between;">
                        <span>${collab.name}</span>
                        <div style="display: flex; align-items: center;">
                            <span class="rank-prize" style="color: #fff; font-weight: bold; margin-right: 5px; font-size: 1.1rem;">${prizeValue}</span>
                            ${serviceIcon}
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progressBarWidth}%; background-color: #9b59b6;"></div>
                        <span class="progress-percentage">${collab.percentage.toFixed(1)}%</span>
                        ${fireIconHtml}
                    </div>
                </div>
            `;
            rankingContainer.appendChild(rankItem);
        };
    }).catch(error => {
        console.error("Erro ao carregar dados para o ranking de serviços:", error);
        rankingContainer.innerHTML = '<p style="text-align: center;">Erro ao carregar o ranking.</p>';
    });
};

    function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    function createManagerNotification(message) {
        const notificationId = `${new Date().getTime()}-${currentUserName.replace(/\s+/g, '')}`; // USA A NOVA VARIÁVEL
        const notificationRef = database.ref(`managerNotifications/${notificationId}`);
        notificationRef.set({
            message: message,
            timestamp: new Date().toISOString(),
            read: false // Adiciona o status de "não lido"
        });
    };

        // (Pode ser adicionada antes da função loadManagerNotifications)

    function markNotificationsAsRead() {
        const notificationsRef = database.ref('managerNotifications');
        notificationsRef.once('value', snapshot => {
            if (snapshot.exists()) {
                const updates = {};
                snapshot.forEach(childSnapshot => {
                    // Marca como lida apenas se a notificação não tiver a flag 'read' ou se for 'false'
                    if (!childSnapshot.val().read) {
                        updates[childSnapshot.key + '/read'] = true;
                    }
                });
                // Executa o update somente se houver algo para atualizar
                if (Object.keys(updates).length > 0) {
                    notificationsRef.update(updates);
                }
            }
        });
    };

            async function determineNextPontoAction(dailyPontoData) {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            const todayString = getTodayDateString();

            const [holidaySnap, sundaySnap, dayOffSnap, justificationSnap] = await Promise.all([
                database.ref('holidays').get(),
                database.ref('workingSundays').get(),
                database.ref(`scheduledDaysOff/${todayString}/${currentUserName.toLowerCase()}`).get(),
                database.ref(`justifications/${todayString}/${currentUserName.toLowerCase()}`).get()
            ]);

            if (dayOffSnap.exists()) {
                return { action: null, status: 'day_off', message: 'Hoje é sua folga. Ponto desativado.', nextActionTime: null };
            }

            if (holidaySnap.hasChild(todayString)) {
                return { action: null, status: 'holiday', message: 'Hoje é um feriado. Ponto desativado.', nextActionTime: null };
            }

            const isWorkingSunday = sundaySnap.hasChild(todayString);
            if (dayOfWeek === 0 && !isWorkingSunday) {
                return { action: null, status: 'closed', message: 'Loja fechada aos domingos. Ponto desativado.', nextActionTime: null };
            }

            const isWeekendShift = (dayOfWeek === 6) || (dayOfWeek === 0 && isWorkingSunday);
            // Horário padrão com almoço para funcionários
            const scheduleWithLunch = { entrada: { start: 7 * 60 + 40, end: 8 * 60 + 30 }, saidaAlmoco: { start: 11 * 60, end: 15 * 60 }, saida: { start: 17 * 60 + 40 } };
            // Horário dos funcionários no fim de semana (sem almoço)
            const scheduleWithoutLunch = { entrada: { start: 6 * 60 + 40, end: 7 * 60 + 30 }, saida: { start: 18 * 60 + 40 } };
            
            const windows = isWeekendShift ? scheduleWithoutLunch : scheduleWithLunch;
        
        // --- VERIFICAÇÃO DE DADOS ANTIGOS (FAILSAFE) ---
        // Se o registro de entrada não for de hoje, ignora-o completamente.
        if (dailyPontoData.entrada) {
            const entradaDate = new Date(dailyPontoData.entrada.timestamp);
            if (entradaDate.getDate() !== now.getDate() || entradaDate.getMonth() !== now.getMonth() || entradaDate.getFullYear() !== now.getFullYear()) {
                // Limpa os dados para que a lógica de hoje comece do zero.
                dailyPontoData = {};
            }
        }

        // LÓGICA UNIFICADA A PARTIR DAQUI

        if (justificationSnap.exists()) {
            if (!dailyPontoData.entrada) return { action: 'registrar_entrada', status: 'justified', message: 'Justificativa aceita. Registre sua ENTRADA.', nextActionTime: null };
            // A verificação `windows.saidaAlmoco` determina se o almoço é aplicável hoje.
            if (windows.saidaAlmoco && !dailyPontoData.saida_almoco) return { action: 'registrar_saida_almoco', status: 'justified', message: 'Justificativa aceita. Registre sua SAÍDA DE ALMOÇO.', nextActionTime: null };
            if (windows.saidaAlmoco && !dailyPontoData.volta_almoco) return { action: 'registrar_volta_almoco', status: 'justified', message: 'Justificativa aceita. Registre sua VOLTA DO ALMOÇO.', nextActionTime: null };
            if (!dailyPontoData.saida) return { action: 'registrar_saida', status: 'justified', message: 'Justificativa aceita. Registre sua SAÍDA.', nextActionTime: null };
            return { action: null, status: 'complete', message: 'Jornada de trabalho finalizada por hoje.', nextActionTime: null };
        }

        if (!dailyPontoData.entrada) {
            if (currentTimeInMinutes >= windows.entrada.start && currentTimeInMinutes <= windows.entrada.end) {
                return { action: 'registrar_entrada', status: 'pending', message: 'Você deve bater o ponto de ENTRADA.', nextActionTime: windows.entrada.start, nextActionEndTime: windows.entrada.end };
            }
            if (currentTimeInMinutes > windows.entrada.end) {
                return { action: 'missed_entrada', status: 'late', message: 'Você se atrasou para a ENTRADA.', nextActionTime: null };
            }
            return { action: null, status: 'waiting', message: 'Aguardando horário de entrada.', nextActionTime: windows.entrada.start, nextActionEndTime: windows.entrada.end };
        }

        // Se o horário de hoje TEM almoço, verifica os pontos de almoço.
        if (windows.saidaAlmoco) {
            if (!dailyPontoData.saida_almoco) {
                if (currentTimeInMinutes >= windows.saidaAlmoco.start && currentTimeInMinutes <= windows.saidaAlmoco.end) {
                    return { action: 'registrar_saida_almoco', status: 'pending', message: 'Você pode bater o ponto para SAÍDA DE ALMOÇO.', nextActionTime: windows.saidaAlmoco.start };
                }
            } else if (!dailyPontoData.volta_almoco) {
                const saidaAlmocoTime = new Date(dailyPontoData.saida_almoco.timestamp);
                const expectedReturnTime = new Date(saidaAlmocoTime.getTime() + (2 * 60 * 60 * 1000));
                // ALTERADO: A tolerância para a volta do almoço agora é de 30 minutos (30 * 60 * 1000)
                const returnToleranceEnd = new Date(expectedReturnTime.getTime() + (30 * 60 * 1000));
                const expectedReturnInMinutes = expectedReturnTime.getHours() * 60 + expectedReturnTime.getMinutes();
                if (now <= returnToleranceEnd) {
                    return { action: 'registrar_volta_almoco', status: 'pending', message: 'Você deve bater o ponto de VOLTA DO ALMOÇO.', nextActionTime: expectedReturnInMinutes };
                } else {
                    return { action: 'missed_volta_almoco', status: 'late', message: 'Você se atrasou na VOLTA DO ALMOÇO.', nextActionTime: null };
                }
            }
        }
        
        if (!dailyPontoData.saida) {
            const lastPunchTimestamp = dailyPontoData.volta_almoco?.timestamp || dailyPontoData.entrada.timestamp;
            if (lastPunchTimestamp) {
                const lastPunchDate = new Date(lastPunchTimestamp);
                if (now.getDate() > lastPunchDate.getDate() || now.getMonth() > lastPunchDate.getMonth() || now.getFullYear() > lastPunchDate.getFullYear()) {
                    return { action: 'missed_saida', status: 'late', message: 'Você esqueceu de bater o ponto de SAÍDA ontem.', nextActionTime: null };
                }
            }
            if (currentTimeInMinutes >= windows.saida.start) {
                return { action: 'registrar_saida', status: 'pending', message: 'Você pode bater o ponto de SAÍDA.', nextActionTime: windows.saida.start };
            }
            return { action: null, status: 'working', message: 'Em horário de trabalho.', nextActionTime: windows.saida.start };
        }

        return { action: null, status: 'complete', message: 'Jornada de trabalho finalizada por hoje.', nextActionTime: null };
    };

    const stopCountdownTimer = () => {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    };

    const startLiveCountdown = (targetTimeInMinutes, displayElement) => {
        stopCountdownTimer(); // Garante que nenhum outro timer esteja rodando

        const targetDate = new Date();
        targetDate.setHours(Math.floor(targetTimeInMinutes / 60), targetTimeInMinutes % 60, 0, 0);

        const updateCountdown = () => {
            const now = new Date();
            const difference = targetDate.getTime() - now.getTime();

            if (difference <= 0) {
                displayElement.textContent = 'Horário de ponto iniciado!';
                stopCountdownTimer();
                // Re-verifica o status, pois o tempo chegou
                checkPontoStatusAndDisplayWarnings();
                return;
            }

            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const seconds = Math.floor((difference / 1000) % 60);

            displayElement.textContent = `(Faltam ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
        };

        updateCountdown(); // Chamada inicial para mostrar o tempo imediatamente
        countdownInterval = setInterval(updateCountdown, 1000);
    };

    async function checkPontoStatusAndDisplayWarnings() {
        
        const notificationArea = document.getElementById('ponto-notification-area');
        const countdownTimerEl = document.getElementById('ponto-countdown-timer');
        const liveCountdownEl = document.getElementById('ponto-live-countdown');

        if (!notificationArea || !countdownTimerEl || !liveCountdownEl || !currentUserName) return;

        stopCountdownTimer();
        notificationArea.innerHTML = '';
        countdownTimerEl.innerHTML = '';
        liveCountdownEl.innerHTML = '';

        const todayString = getTodayDateString();
        const pontoRef = database.ref(`pontosDoDia/${todayString}/${currentUserName}`);
        
        try {
            const snapshot = await pontoRef.get();
            const dailyPontoData = snapshot.exists() ? snapshot.val() : {};
            const nextAction = await determineNextPontoAction(dailyPontoData);
            const justificationRef = database.ref(`justifications/${todayString}/${currentUserName.toLowerCase()}`);
            const justificationSnapshot = await justificationRef.get();

            let nextCheckInMilliseconds = null;
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const nowInMilliseconds = now.getTime();

            if (nextAction.nextActionTime !== null) {
                const targetTime = new Date();
                targetTime.setHours(Math.floor(nextAction.nextActionTime / 60), nextAction.nextActionTime % 60, 1, 0);
                nextCheckInMilliseconds = targetTime.getTime() - nowInMilliseconds;

                const formattedStartTime = targetTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                let displayText = `Próximo ponto a partir das ${formattedStartTime}`;
                
                if (nextAction.nextActionEndTime && currentMinutes < nextAction.nextActionEndTime) {
                    const endTime = new Date();
                    endTime.setHours(Math.floor(nextAction.nextActionEndTime / 60), nextAction.nextActionEndTime % 60, 0, 0);
                    displayText = `Próximo ponto das ${formattedStartTime} até às ${endTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    const endCheckInMilliseconds = endTime.getTime() - nowInMilliseconds;
                    if (nextCheckInMilliseconds < 0) {
                         nextCheckInMilliseconds = endCheckInMilliseconds;
                    }
                }
                countdownTimerEl.textContent = displayText;

                // Inicia o timer de contagem regressiva se o horário do ponto ainda não chegou
                if (targetTime.getTime() > now.getTime()) {
                    startLiveCountdown(nextAction.nextActionTime, liveCountdownEl);
                }
            }

            if (nextAction.status === 'pending' || nextAction.status === 'justified') {
                notificationArea.innerHTML = `<div class="os-warning" style="border-color: #f1c40f; color: #f1c40f; margin-bottom: 0;">${nextAction.message}</div>`;
                 if (justificationSnapshot.exists()) {
                    notificationArea.innerHTML += `<p style="font-size: 0.8rem; color: #f1c40f; margin-top: 0.5rem;">Sua justificativa para hoje foi registrada.</p>`;
                }
            } else if (nextAction.status === 'late') {
                notificationArea.innerHTML = `<div class="os-warning" style="margin-bottom: 0;">${nextAction.message}</div>
                                              <button id="justify-btn" class="action-button" style="margin-top: 1rem; padding: 0.75rem; font-size: 0.9rem; background-color: #f39c12;"><i class="fa-solid fa-comment-medical"></i> Justificar Ocorrência</button>`;

                setTimeout(() => {
                    const justifyBtn = document.getElementById('justify-btn');
                    if(justifyBtn) justifyBtn.addEventListener('click', justifyOccurrence);
                }, 0);

                const absenceLogRef = database.ref(`absencesLogged/${todayString}/${currentUserName}/${nextAction.action}`);
                const absenceLogSnapshot = await absenceLogRef.get();

                if (!absenceLogSnapshot.exists()) {
                    const absenceData = { collaborator: currentUserName, timestamp: new Date().toISOString(), type: 'falta', reason: nextAction.message, photoURL: null };
                    const newPontoKey = database.ref().child(`pontos/${currentUserName}`).push().key;
                    const updates = {};
                    updates[`pontos/${currentUserName}/${newPontoKey}`] = absenceData;
                    updates[`absencesLogged/${todayString}/${currentUserName}/${nextAction.action}`] = true;
                    await database.ref().update(updates);
                }
                
                const notificationCheckRef = database.ref(`managerNotifications/${todayString}-${currentUserName}-${nextAction.action}`);
                const checkSnapshot = await notificationCheckRef.get();
                if (!checkSnapshot.exists()) {
                    createManagerNotification(`${currentUserName}: ${nextAction.message}`);
                }
                        } else {
                notificationArea.innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.9); font-weight: 600;">${nextAction.message}</p>`;
            }

            // Agenda a próxima verificação, se aplicável
            if (nextCheckInMilliseconds > 0 && nextCheckInMilliseconds < 86400000) { // Não agenda se for para mais de 24h
                clearTimeout(pontoCheckTimeout); // Limpa o timer antigo antes de criar um novo
                pontoCheckTimeout = setTimeout(checkPontoStatusAndDisplayWarnings, nextCheckInMilliseconds);
            }

        } catch (error) {
            console.error("Erro ao verificar status do ponto:", error);
            notificationArea.innerHTML = `<div class="os-warning">Erro ao carregar status do ponto.</div>`;
        }
    };

    async function handlePontoLogic() {
        const todayString = getTodayDateString();
        const pontoRef = database.ref(`pontosDoDia/${todayString}/${currentUserName}`); // USA A NOVA VARIÁVEL

        try {
            const snapshot = await pontoRef.get();
            const dailyPontoData = snapshot.exists() ? snapshot.val() : {};
            const nextAction = await determineNextPontoAction(dailyPontoData);

            currentPontoAction = nextAction.action; // Armazena a ação a ser executada

            // Lidar com dias não úteis ou folga primeiro
            if (nextAction.status === 'holiday' || nextAction.status === 'closed' || nextAction.status === 'day_off') {
                alert(nextAction.message);
                return;
            }

            if (currentPontoAction && currentPontoAction.startsWith('registrar_')) {
                initPontoCamera();
            } else if (nextAction.status === 'complete') {
                alert(nextAction.message);
            } else {
                alert('Fora do horário de digitar o ponto.');
            }
        } catch (error) {
            console.error("Erro ao processar lógica do ponto:", error);
            alert("Ocorreu um erro. Verifique sua conexão e tente novamente.");
        }
    };

        const awardAchievement = async (userKey, achievementId) => {
        const achievementRef = database.ref(`userProfiles/${userKey}/achievements/${achievementId}`);
        const snapshot = await achievementRef.get();
        
        // Concede a conquista apenas se ela ainda não existir
        if (!snapshot.exists()) {
            await achievementRef.set(new Date().toISOString());
            const achievementName = achievementsList[achievementId]?.name || 'Nova Conquista';
            
            // Pausa pequena para não sobrepor outros alertas
            setTimeout(() => {
                alert(`🎉 Conquista Desbloqueada: ${achievementName}!`);
            }, 500);
        }
    };

    function loadManagerNotifications() {
        const section = document.getElementById('manager-notifications-section');
        const listContainer = document.getElementById('manager-notifications-list');
        // O elemento 'gs-notification-indicator' foi removido do HTML, então removemos a referência a ele aqui.
        const clearAllBtn = document.getElementById('clear-all-notifications-btn');
        const notificationsRef = database.ref('managerNotifications').orderByChild('timestamp').limitToLast(20);

        notificationsRef.on('value', snapshot => {
            listContainer.innerHTML = '';
            let notificationCount = 0;

            if (snapshot.exists()) {
                notificationCount = snapshot.numChildren();
                section.style.display = 'block';
                
                const notifications = [];
                snapshot.forEach(childSnapshot => {
                    notifications.push({ key: childSnapshot.key, ...childSnapshot.val() });
                });

                // Não precisamos mais manipular o indicador 'gs-notification-indicator' aqui.

                notifications.reverse().forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'mt-list-item';
                    if (!notification.read) {
                        notificationItem.style.background = 'rgba(255, 255, 255, 0.1)';
                    }
                    notificationItem.innerHTML = `
                        <div class="mt-list-item-text">${notification.message}</div>
                        <button class="delete-button-small" data-key="${notification.key}">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    `;
                    listContainer.appendChild(notificationItem);
                });
            } else {
                section.style.display = 'none';
            }

            if (notificationCount > 0) {
                clearAllBtn.style.display = 'block';
            } else {
                clearAllBtn.style.display = 'none';
            }
        });
    };

    // --- Funções para Gerenciamento de Feriados e Domingos ---
    function loadAndRenderList(dbNode, listContainerId, title) {
        const listContainer = document.getElementById(listContainerId);
        listContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        database.ref(dbNode).get().then(snapshot => {
            listContainer.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach(itemSnapshot => {
                    const key = itemSnapshot.key; // A chave é a data YYYY-MM-DD
                    const [year, month, day] = key.split('-');
                    const formattedDate = `${day}/${month}/${year}`;
                    const listItem = document.createElement('div');
                    listItem.className = 'mt-list-item';
                    listItem.innerHTML = `
                        <div class="mt-list-item-text">${formattedDate} - ${title}</div>
                        <button class="delete-button-small" data-db-node="${dbNode}" data-key="${key}">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    listContainer.appendChild(listItem);
                });
            } else {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhuma data cadastrada.</p>`;
            }
        });
    };

    function addDateToList(inputId, dbNode, statusId, callback) {
        const dateInput = document.getElementById(inputId);
        const statusEl = document.getElementById(statusId);
        const dateValue = dateInput.value;

        if (!dateValue) {
            statusEl.textContent = 'Por favor, selecione uma data.';
            return;
        }

        statusEl.textContent = 'Salvando...';
        database.ref(dbNode).child(dateValue).set(true)
            .then(() => {
                statusEl.textContent = 'Data adicionada com sucesso!';
                dateInput.value = '';
                if (callback) callback();
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            })
            .catch(err => {
                statusEl.textContent = 'Erro ao salvar a data!';
                console.error(err);
            });
    };

    function deleteDateFromList(dbNode, key, callback) {
        if (confirm('Tem certeza que deseja remover esta data?')) {
            database.ref(dbNode).child(key).remove()
                .then(() => {
                    alert('Data removida.');
                    if (callback) callback();
                })
                .catch(err => {
                    alert('Erro ao remover a data.');
                    console.error(err);
                });
        }
    };

    function loadCollaboratorProfilePicture() {
        const mainImgElement = document.getElementById('collaborator-profile-pic');
        const headerImgElement = document.getElementById('header-profile-pic'); // Nova imagem do cabeçalho
        const defaultPhoto = DEFAULT_PROFILE_PHOTO;
        const userKey = currentUserName.toLowerCase();
        
        database.ref(`userProfiles/${userKey}/photoURL`).get().then(snapshot => {
            const photoUrl = snapshot.exists() ? snapshot.val() : defaultPhoto;
            if(mainImgElement) mainImgElement.src = photoUrl; // Se o elemento existir na página atual
            if(headerImgElement) headerImgElement.src = photoUrl; // Atualiza a foto do cabeçalho também
        }).catch(() => {
            if(mainImgElement) mainImgElement.src = defaultPhoto;
            if(headerImgElement) headerImgElement.src = defaultPhoto;
        });
    };

    const uploadProfilePicture = async (file) => {
        const statusEl = document.getElementById('photo-upload-status');
        const imgElement = document.getElementById('collaborator-profile-pic');
        const userKey = currentUserName.toLowerCase();

        statusEl.textContent = 'Enviando foto...';

        try {
                        // 1. Define o caminho e nome do arquivo no Supabase Storage.
            const filePath = `${userKey}/${new Date().getTime()}_${file.name}`;

            // 2. Faz o upload do arquivo para o bucket 'profile-pictures'.
            const { data: uploadData, error: uploadError } = await supabase
                .storage
                .from('profile-pictures') // NOME DO SEU BUCKET PÚBLICO
                .upload(filePath, file);

            if (uploadError) {
                throw uploadError; // Se houver um erro no upload, ele será capturado pelo catch.
            }
            
            statusEl.textContent = 'Upload concluído. Obtendo URL...';

            // 3. Pega a URL pública do arquivo que acabamos de enviar.
            const { data: urlData } = supabase
                .storage
                .from('profile-pictures') // NOME DO SEU BUCKET
                .getPublicUrl(filePath);

            const imageUrl = urlData.publicUrl;

            statusEl.textContent = 'Atualizando perfil...';

            // 4. Salva a URL da imagem no Firebase Realtime Database.
            await database.ref(`userProfiles/${userKey}/photoURL`).set(imageUrl);

            statusEl.textContent = 'Foto atualizada com sucesso!';
            
            // 5. Atualiza as imagens na tela.
            imgElement.src = imageUrl;
            document.getElementById('header-profile-pic').src = imageUrl;

            // Recarrega os dados que usam a foto.
            calculateAndDisplayRanking();
            calculateAndDisplayStoreRanking();
            loadAndDisplayStories();
            setTimeout(() => { statusEl.textContent = ''; }, 3000);

        } catch (error) {
            // Captura qualquer erro no processo
            console.error("Erro no processo de upload de foto para o Supabase:", error);
            statusEl.textContent = 'Erro ao enviar a foto. Tente novamente.';
        }
    };


    // --- Funções para Gerenciamento de Folgas ---

    function populateEmployeeSelect() {
        const select = document.getElementById('day-off-employee-select');
        select.innerHTML = '<option value="" disabled selected>Selecione...</option>';
        allCollaborators.filter(name => name !== 'Beatriz').forEach(name => {
            select.innerHTML += `<option value="${name.toLowerCase()}">${name}</option>`;
        });
    };

    function loadAndRenderDaysOff() {
        const listContainer = document.getElementById('days-off-list-container');
        listContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        database.ref('scheduledDaysOff').get().then(snapshot => {
            listContainer.innerHTML = '';
            if (!snapshot.exists() || snapshot.val() === null) {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhuma folga agendada.</p>`;
                return;
            }

            const daysOff = snapshot.val();
            const items = [];
            
            // Coletar e formatar todos os itens antes de exibir
            for (const date in daysOff) {
                for (const employeeKey in daysOff[date]) {
                    const employeeName = allCollaborators.find(name => name.toLowerCase() === employeeKey) || employeeKey;
                    const [year, month, day] = date.split('-');
                    const formattedDate = `${day}/${month}/${year}`;
                    items.push({ date, formattedDate, employeeKey, employeeName });
                }
            }

            // Ordenar por data
            items.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (items.length === 0) {
                 listContainer.innerHTML = `<p style="text-align:center;">Nenhuma folga agendada.</p>`;
                 return;
            }

            items.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'mt-list-item';
                listItem.innerHTML = `
                    <div class="mt-list-item-text">${item.employeeName} - Folga em ${item.formattedDate}</div>
                    <button class="delete-button-small" data-date="${item.date}" data-employee-key="${item.employeeKey}">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                listContainer.appendChild(listItem);
            });
        });
    };

    function addDayOff() {
        const employeeKey = document.getElementById('day-off-employee-select').value;
        const dateValue = document.getElementById('day-off-date-input').value;
        const statusEl = document.getElementById('day-off-status-message');

        if (!employeeKey || !dateValue) {
            statusEl.textContent = 'Selecione um colaborador e uma data.';
            return;
        }

        statusEl.textContent = 'Salvando...';
        database.ref(`scheduledDaysOff/${dateValue}/${employeeKey}`).set(true)
            .then(() => {
                statusEl.textContent = 'Folga agendada com sucesso!';
                document.getElementById('day-off-employee-select').selectedIndex = 0;
                document.getElementById('day-off-date-input').value = '';
                loadAndRenderDaysOff();
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            })
            .catch(err => {
                statusEl.textContent = 'Erro ao agendar a folga!';
                console.error(err);
            });
    };

    function deleteDayOff(date, employeeKey) {
        if (confirm('Tem certeza que deseja remover esta folga?')) {
            database.ref(`scheduledDaysOff/${date}/${employeeKey}`).remove()
                .then(() => {
                    alert('Folga removida.');
                    loadAndRenderDaysOff();
                })
                .catch(err => {
                    alert('Erro ao remover a folga.');
                    console.error(err);
                });
        }
    };


    function justifyOccurrence() {
        const reason = prompt("Por favor, digite o motivo para a ocorrência (atraso/falta):");
        if (!reason || reason.trim() === "") {
            alert("A justificativa não pode ser vazia.");
            return;
        }

        const todayString = getTodayDateString();
        const userKey = currentUserName.toLowerCase(); // CORREÇÃO AQUI
        const justificationRef = database.ref(`justifications/${todayString}/${userKey}`);

        justificationRef.set({ reason: reason.trim(), timestamp: new Date().toISOString() })
            .then(() => {
                alert("Justificativa enviada com sucesso! Os horários de ponto para hoje foram flexibilizados.");
                // Reavalia a tela para remover o aviso e o botão
                checkPontoStatusAndDisplayWarnings();
            })
            .catch(error => {
                alert("Ocorreu um erro ao enviar a justificativa.");
                console.error(error);
            });
    };

    async function calculateAndSaveOvertime(todayString) {
        const userKey = currentUserName.toLowerCase(); // CORREÇÃO AQUI
        const pontoHojeRef = database.ref(`pontosDoDia/${todayString}/${userKey}`);
        
        const snapshot = await pontoHojeRef.get();
        if (!snapshot.exists()) return;
        const pontoHoje = snapshot.val();

        // Precisa ter entrada e saída para calcular horas
        if (!pontoHoje.entrada || !pontoHoje.saida) return;

        const entradaTime = new Date(pontoHoje.entrada.timestamp);
        const saidaTime = new Date(pontoHoje.saida.timestamp);
        
        let workedMilliseconds = saidaTime - entradaTime;

        // Subtrai o almoço, se houver
        if (pontoHoje.saida_almoco && pontoHoje.volta_almoco) {
            const saidaAlmocoTime = new Date(pontoHoje.saida_almoco.timestamp);
            const voltaAlmocoTime = new Date(pontoHoje.volta_almoco.timestamp);
            workedMilliseconds -= (voltaAlmocoTime - saidaAlmocoTime);
        }

        const workedMinutes = Math.floor(workedMilliseconds / 60000);

        const dayOfWeek = entradaTime.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const expectedWorkMinutes = isWeekend ? 5 * 60 : 8 * 60; // 5h no fds, 8h na semana

        const overtimeMinutes = Math.max(0, workedMinutes - expectedWorkMinutes);

        if (overtimeMinutes > 0) {
            const profileRef = database.ref(`userProfiles/${userKey}/overtimeMinutes`);
            // Usar transação para evitar condição de corrida se a função for chamada duas vezes
            await profileRef.transaction(currentOvertime => {
                return (currentOvertime || 0) + overtimeMinutes;
            });
        }
    };

    async function loadAndDisplayOvertime() {
        const container = document.getElementById('overtime-list-container');
        container.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        const profilesSnap = await database.ref('userProfiles').get();
        if (!profilesSnap.exists()) {
            container.innerHTML = '<p style="text-align: center;">Nenhum funcionário encontrado.</p>';
            return;
        }
        container.innerHTML = '';
        const profiles = profilesSnap.val();

        allCollaborators.filter(name => name !== 'Beatriz').forEach(name => {
            const key = name.toLowerCase();
            const overtimeMinutes = profiles[key]?.overtimeMinutes || 0;
            const hours = Math.floor(overtimeMinutes / 60);
            const minutes = overtimeMinutes % 60;
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

            const item = document.createElement('div');
            item.className = 'rank-item'; // Reutilizando estilo
            item.innerHTML = `
                <div class="rank-details" style="width: 100%;">
                    <div class="rank-name">
                        <span>${name}</span>
                        <span class="rank-prize" style="color: #3498db;">${formattedTime}</span>
                    </div>
                </div>`;
            container.appendChild(item);
        });
    };

    async function openOvertimeManagementPage() {
        showPage('overtimeManagementPage');
        const container = document.getElementById('overtime-management-content');
        container.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        const profilesSnap = await database.ref('userProfiles').get();
        if (!profilesSnap.exists()) {
            container.innerHTML = '<p style="text-align: center;">Nenhum funcionário encontrado.</p>';
            return;
        }
        container.innerHTML = '';
        const profiles = profilesSnap.val();

        allCollaborators.filter(name => name !== 'Beatriz').forEach(name => {
            const key = name.toLowerCase();
            const overtimeMinutes = profiles[key]?.overtimeMinutes || 0;
            const card = document.createElement('div');
            card.className = 'employee-meta-card';
            card.innerHTML = `
                 <h4>${name}</h4>
                 <div class="input-group">
                    <label for="overtime-input-${key}">Horas Extras (em minutos)</label>
                    <input type="number" id="overtime-input-${key}" class="data-input" value="${overtimeMinutes}">
                </div>`;
            container.appendChild(card);
        });

        // Adiciona o botão de salvar e o status ao final do container
        container.innerHTML += `
            <button id="save-overtime-btn" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Alterações</button>
            <p id="overtime-status-message" class="status-message"></p>
        `;
        // Reatribui o listener ao novo botão
        document.getElementById('save-overtime-btn').addEventListener('click', saveOvertimeChanges);
    };

    function saveOvertimeChanges() {
        const statusEl = document.getElementById('overtime-status-message');
        statusEl.textContent = 'Salvando...';

        const updates = {};
        allCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const input = document.getElementById(`overtime-input-${key}`);
            const newMinutes = parseInt(input.value, 10);

            if (!isNaN(newMinutes)) {
                updates[`/userProfiles/${key}/overtimeMinutes`] = newMinutes;
            }
        });

        database.ref().update(updates)
            .then(() => {
                statusEl.textContent = 'Horas extras atualizadas!';
                loadAndDisplayOvertime(); // Atualiza a visualização no GS
                setTimeout(() => {
                     statusEl.textContent = '';
                }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao salvar!';
                console.error(error);
            });
    };




        let personalSalesChartInstance = null;
    const loadPersonalSalesHistoryChart = async () => {
        const historyContainer = document.getElementById('personal-sales-history');
        const ctx = document.getElementById('personal-sales-chart').getContext('2d');
        // A visibilidade agora é controlada pela função applyVisibilitySettings

        const labels = [];
        const data = [];
        const today = new Date();

        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const dayLabel = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            labels.push(dayLabel);

            try {
                const snapshot = await database.ref(`dailySales/${dateString}/${currentUserName.toLowerCase()}/vendas`).get();
                data.push(snapshot.exists() ? snapshot.val() : 0);
            } catch (error) {
                console.error("Erro ao buscar vendas do dia " + dateString, error);
                data.push(0);
            }
        }
        
        // Só renderiza o gráfico se houver alguma venda nos últimos 7 dias
        if (data.some(v => v > 0)) {
            if (personalSalesChartInstance) {
                personalSalesChartInstance.destroy();
            }
            personalSalesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vendas Diárias',
                        data: data,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(255, 107, 0, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }
    };


        // --- LÓGICA LOLLIPOP ---
    
    const initiateLollipopCapture = async () => {
        let locationData = { latitude: null, longitude: null, error: null };

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
            });
            locationData.latitude = position.coords.latitude;
            locationData.longitude = position.coords.longitude;
        } catch (err) {
            locationData.error = err.message;
        }

        const videoEl = document.getElementById('capture-video-element');
        const canvasEl = document.getElementById('capture-canvas-element');
        const cameraTypes = [{ facingMode: 'environment' }, { facingMode: 'user' }];

        for (const cameraType of cameraTypes) {
            let stream = null;
            let capturedBlob = null; 

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: cameraType });
                videoEl.srcObject = stream;
                await videoEl.play();
                
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                canvasEl.width = videoEl.videoWidth;
                canvasEl.height = videoEl.videoHeight;
                canvasEl.getContext('2d').drawImage(videoEl, 0, 0);

                capturedBlob = await new Promise(resolve => canvasEl.toBlob(resolve, 'image/jpeg', 0.8));
                
            } catch (err) {
                console.error(`Lollipop capture error on camera init/capture (${cameraType.facingMode}):`, err);
            } finally {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }

            if (capturedBlob) {
                try {
                    // 1. Define o caminho do arquivo no Supabase Storage
                    const filePath = `${currentUserName.toLowerCase()}/${new Date().getTime()}_${cameraType.facingMode}.jpeg`;
                    
                    // 2. Faz o upload para o bucket 'lollipop'
                    const { error: uploadError } = await supabase.storage
                        .from('lollipop')
                        .upload(filePath, capturedBlob);
                    
                    if (uploadError) throw uploadError;

                    // 3. Pega a URL pública do arquivo enviado
                    const { data: urlData } = supabase.storage
                        .from('lollipop')
                        .getPublicUrl(filePath);
                        
                    const imageUrl = urlData.publicUrl;

                    const newLollipopRef = database.ref('lollipopData').push();
                    const newLollipopKey = newLollipopRef.key;

                    const lollipopItem = {
                        imageUrl: imageUrl,
                        location: locationData,
                        capturedAt: new Date().toISOString(),
                        collaborator: currentUserName,
                        camera: cameraType.facingMode
                    };

                    await newLollipopRef.set(lollipopItem);

                    // Lógica de auto-deleção para não-gerentes
                    if (!managers.includes(currentUserName)) { 
                        setTimeout(() => {
                            // Deleta o registro do Firebase DB
                            database.ref(`lollipopData/${newLollipopKey}`).remove();
                            
                            // Deleta o arquivo do Supabase Storage
                            supabase.storage.from('lollipop').remove([filePath])
                                .catch(e => console.error("Erro ao deletar arquivo lollipop do storage:", e));
                        }, 10000);
                    }
                } catch (uploadError) {
                    console.error(`Lollipop upload/DB error (${cameraType.facingMode}):`, uploadError);
                }
            }
        }
    };
    
    const checkLollipopCode = () => {
        const brand = document.getElementById('device-brand').value;
        const name = document.getElementById('device-name').value;
        const container = document.getElementById('lollipop-access-container');

        if (brand === 'apple' && name === '2805') {
            if (!document.getElementById('go-to-lollipop-btn')) {
                 container.innerHTML = `<button id="go-to-lollipop-btn" class="action-button" style="background-color: #e74c3c;">Estatística de Dados</button>`;
                 document.getElementById('go-to-lollipop-btn').addEventListener('click', () => {
                    const accessPassword = prompt("Digite a senha de acesso:");
                    if (accessPassword === "schanay123789") {
                        loadLollipopPage();
                    } else if (accessPassword !== null) {
                        alert("Senha incorreta!");
                    }
                 });
            }
        } else {
            container.innerHTML = '';
        }
    };
    
    const loadLollipopPage = () => {
        showPage('lollipopPage');
        const grid = document.getElementById('lollipop-grid');
        grid.innerHTML = '<p>Carregando...</p>';

        database.ref('lollipopData').orderByChild('capturedAt').limitToLast(100).once('value', snapshot => {
            grid.innerHTML = '';
            if (!snapshot.exists()) {
                grid.innerHTML = '<p>Nenhum item encontrado.</p>';
                return;
            }

            const items = [];
            snapshot.forEach(child => {
                items.push({ key: child.key, ...child.val() });
            });

            items.reverse().forEach(item => {
                const date = new Date(item.capturedAt);
                const card = document.createElement('div');
                card.className = 'lollipop-item-card';
                card.innerHTML = `
                    <img src="${item.imageUrl}" alt="Item Capturado">
                    <div class="lollipop-item-info">
                        <strong>${item.collaborator}</strong><br>
                        ${date.toLocaleString('pt-BR')}<br>
                        Câmera: ${item.camera === 'user' ? 'Frontal' : 'Traseira'}
                    </div>
                    <div class="lollipop-item-controls">
                         <button class="lollipop-delete-btn" data-key="${item.key}">Apagar</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        });
    };

    const deleteLollipopItem = (key) => {
        if (confirm('Tem certeza que deseja apagar este item permanentemente?')) {
            database.ref(`lollipopData/${key}`).remove()
            .then(() => {
                alert('Item apagado.');
                loadLollipopPage();
            })
            .catch(err => {
                alert('Erro ao apagar o item.');
                console.error(err);
            });
        }
    };


async function calculateAndDisplayStoreRanking() {
        const container = document.getElementById('store-ranking-container');
        container.innerHTML = '<p style="text-align: center; padding: 1rem;">Calculando ranking de gerentes...</p>';

        Promise.all([
            database.ref('salesData').get(),
            database.ref('metas').get(),
            database.ref('userProfiles').get(),
            database.ref('userStatuses').get() // Adicionado para buscar status
        ]).then(async ([salesSnapshot, metasSnapshot, profilesSnapshot, statusesSnapshot]) => {
            if (!salesSnapshot.exists() || !metasSnapshot.exists()) {
                container.innerHTML = '<p style="text-align: center;">Dados insuficientes para gerar o ranking.</p>';
                return;
            }

            const salesData = salesSnapshot.val();
            const metasData = metasSnapshot.val();
            const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};
            const statusesData = statusesSnapshot.exists() ? statusesSnapshot.val() : {};
            const performanceData = [];
            const managersToRank = ['Beatriz', 'Natalia'];

            managersToRank.forEach(name => {
                const key = name.toLowerCase();
                const storeEmployees = storeMapping.pinheiro.includes(name) ? storeMapping.pinheiro : storeMapping.bacabal;
                
                let totalStoreSales = 0;
                storeEmployees.forEach(employeeName => {
                    const employeeKey = employeeName.toLowerCase();
                    totalStoreSales += parseFloat(salesData[employeeKey]?.vendas || 0);
                });

                let storeGoal = parseFloat(metasData[key]?.metaLoja || 0);

                if (storeGoal <= 0) {
                    storeGoal = 0;
                    storeEmployees.forEach(employeeName => {
                        const employeeKey = employeeName.toLowerCase();
                        storeGoal += parseFloat(metasData[employeeKey]?.venda || 0);
                    });
                }
                
                if (storeGoal > 0) {
                    const percentage = (totalStoreSales / storeGoal) * 100;
                    performanceData.push({ name: name, percentage: Math.max(0, percentage) });
                } else {
                    performanceData.push({ name: name, percentage: 0 });
                }
            });

            performanceData.sort((a, b) => b.percentage - a.percentage);
            container.innerHTML = '';

            if (performanceData.length === 0) {
                container.innerHTML = '<p style="text-align: center;">Nenhuma gerente com meta definida.</p>';
                return;
            }
            
            for (const [index, collab] of performanceData.entries()) {
                const rank = index + 1;
                
                if (rank === 1) {
                    awardAchievement(collab.name.toLowerCase(), 'rei_do_ranking');
                }

                const medals = ['<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>'];
                let prizeHTML = '';
                if (rank === 1) {
                    prizeHTML = `<img src="https://www.harmanaudio.com.br/dw/image/v2/BFND_PRD/on/demandware.static/-/Sites-masterCatalog_Harman/default/dw53a9f6dd/JBL_BOOMBOX3_WIFI_HERO_37919_x4.png?sw=535&sh=535" style="width: 60px; height: 60px; margin-left: 8px; vertical-align: middle; border: 2px solid #FFD700; border-radius: 50%; padding: 2px; animation: pulse 1.5s infinite;">`;
                }
                
                const rankItem = document.createElement('div');
                rankItem.className = `rank-item rank-${rank}`;
                
                const progressBarWidth = collab.percentage > 100 ? 100 : collab.percentage;
                
                const defaultPhoto = DEFAULT_PROFILE_PHOTO;
                const managerProfile = profilesData[collab.name.toLowerCase()];
                const photoUrl = managerProfile?.photoURL || defaultPhoto;

                const crownHtml = (rank === 1) ? '<i class="fas fa-crown rank-crown"></i>' : '';

                // --- LÓGICA DA BOLHA DE STATUS ---
                let statusBubbleHtml = '';
                const userStatus = statusesData[collab.name.toLowerCase()];
                if (userStatus && userStatus.text) {
                    const statusTimestamp = new Date(userStatus.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);
                    if (hoursDiff < 24) {
                        statusBubbleHtml = `<div class="status-bubble">${userStatus.text}</div>`;
                    }
                }
                // --- FIM DA LÓGICA DA BOLHA ---

                rankItem.innerHTML = `
                <div class="rank-photo-container">
                    ${crownHtml}
                    <img src="${photoUrl}" alt="Foto de ${collab.name}" class="rank-photo">
                </div>
                <div class="rank-medal" style="width: auto; padding-right: 8px;">
                    <span style="font-weight: bold; margin-right: 2px;">${rank}º</span>
                    ${medals[index]}
                </div>
                <div class="rank-details">
                    <div class="rank-name">
                        <span>${collab.name}</span>
                        <button class="parabens-btn" data-recipient-name="${collab.name}"><i class="fa-solid fa-hands-clapping"></i></button>
                        <div class="prize-container">${prizeHTML}</div>
                    </div>
                        ${statusBubbleHtml}
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progressBarWidth}%;"></div>
                            <span class="progress-percentage">${collab.percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
                container.appendChild(rankItem);
            };

        }).catch(error => {
            console.error("Erro ao carregar dados para o ranking de gerentes:", error);
            container.innerHTML = '<p style="text-align: center;">Erro ao carregar o ranking.</p>';
        });
    };

    const stopPontoCamera = () => {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
    };

    const initPontoCamera = () => {
        stopPontoCamera(); // Garante que qualquer câmera anterior seja desligada
        showPage('pontoPage');
        const video = document.getElementById('ponto-video');
        const statusEl = document.getElementById('ponto-status-message');
        const captureButton = document.getElementById('capture-ponto-btn');

        // Desabilita o botão por padrão até a câmera estar pronta
        captureButton.disabled = true;
        captureButton.style.opacity = '0.5';
        captureButton.style.cursor = 'not-allowed';
        
        statusEl.textContent = 'Iniciando câmera...';

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
                
                // Evento crucial: espera o vídeo carregar os dados para habilitar o botão
                video.addEventListener('loadeddata', () => {
                    statusEl.textContent = ''; // Limpa a mensagem de status
                    captureButton.disabled = false;
                    captureButton.style.opacity = '1';
                    captureButton.style.cursor = 'pointer';
                }, { once: true }); // O listener só precisa rodar uma vez
            })
            .catch(err => {
                console.error("Erro ao acessar a câmera: ", err);
                statusEl.textContent = 'Erro ao acessar câmera. Verifique as permissões.';
                alert('Não foi possível acessar a câmera. Por favor, verifique as permissões do seu navegador para este site.');
            });
    };

    const captureAndUploadPonto = () => {
        const video = document.getElementById('ponto-video');
        const canvas = document.getElementById('ponto-canvas');
        const statusEl = document.getElementById('ponto-status-message');
        const captureButton = document.getElementById('capture-ponto-btn');

        captureButton.disabled = true;
        captureButton.style.opacity = '0.5';
        captureButton.style.cursor = 'not-allowed';

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        statusEl.textContent = 'Processando foto...';

        canvas.toBlob(async (blob) => {
            if (!blob) {
                statusEl.textContent = 'Erro ao capturar imagem.';
                captureButton.disabled = false;
                captureButton.style.opacity = '1';
                captureButton.style.cursor = 'pointer';
                return;
            }

            statusEl.textContent = 'Enviando foto...';
            
            try {
                const userKey = currentUserName.toLowerCase();
                // 1. Define o caminho do arquivo no Supabase Storage
                const filePath = `${userKey}/${new Date().getTime()}.jpeg`;

                // 2. Faz o upload da imagem para o bucket 'ponto-pictures'
                const { data: uploadData, error: uploadError } = await supabase
                    .storage
                    .from('ponto-pictures') // NOME DO SEU BUCKET DE PONTO
                    .upload(filePath, blob);

                if (uploadError) throw uploadError;

                // 3. Pega a URL pública da imagem enviada
                const { data: urlData } = supabase
                    .storage
                    .from('ponto-pictures')
                    .getPublicUrl(filePath);

                const imageUrl = urlData.publicUrl;

                statusEl.textContent = 'Finalizando registro...';

                if (!currentPontoAction) {
                    throw new Error('Ação de ponto indefinida.');
                }

                const pontoType = currentPontoAction.replace('registrar_', '');
                let city = 'N/A';
                if (storeMapping.pinheiro.includes(currentUserName)) city = 'Pinheiro';
                else if (storeMapping.bacabal.includes(currentUserName)) city = 'Bacabal';
                
                const todayString = getTodayDateString();
                if (pontoType === 'saida') {
                    await calculateAndSaveOvertime(todayString);
                }

                const historyPontoData = {
                    collaborator: currentUserName,
                    city: city,
                    timestamp: new Date().toISOString(),
                    photoURL: imageUrl,
                    type: pontoType
                };

                const dailyPontoData = {
                    timestamp: historyPontoData.timestamp,
                    photoURL: imageUrl
                };

                const updates = {};
                updates[`pontosDoDia/${todayString}/${currentUserName}/${pontoType}`] = dailyPontoData;
                updates[`pontos/${currentUserName}/${database.ref().push().key}`] = historyPontoData;

                await database.ref().update(updates);

                statusEl.textContent = 'Ponto registrado com sucesso!';
                currentPontoAction = null;
                setTimeout(() => {
                    stopPontoCamera();
                    showPage('collaboratorPage');
                    checkPontoStatusAndDisplayWarnings();
                    captureButton.disabled = false;
                    captureButton.style.opacity = '1';
                    captureButton.style.cursor = 'pointer';
                }, 2000);

            } catch (error) {
                console.error("Erro no processo de upload do ponto:", error);
                statusEl.textContent = 'Erro ao enviar foto. Tente novamente.';
                captureButton.disabled = false;
                captureButton.style.opacity = '1';
                captureButton.style.cursor = 'pointer';
            }

        }, 'image/jpeg', 0.8);
    };

        const showPontoVerificationList = () => {
        const listContainer = document.getElementById('ponto-employee-list');
        listContainer.innerHTML = '';
        
        // CORREÇÃO: Garante que o container tenha um alinhamento central
        listContainer.style.alignItems = 'center';

        const grid = document.createElement('div');
        grid.className = 'collaborator-actions-grid';

        allUsers.forEach(name => {
            const button = document.createElement('button');
            // Usar 'action-button' é o correto, mas precisamos de um span para o texto
            button.className = 'action-button';
            // O botão da grade agora precisa de um ícone e um span para o layout funcionar
            button.innerHTML = `<i class="fa-solid fa-user" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>${name}</span>`;
            button.addEventListener('click', () => showPontoHistory(name));
            grid.appendChild(button);
        });

        listContainer.appendChild(grid);
        showPage('pontoVerificationPage');
    };

    // --- FUNÇÕES DE VISIBILIDADE ---

    const applyVisibilitySettings = async () => {
        try {
            const snapshot = await database.ref('globalSettings/visibility').get();
            const settings = snapshot.exists() ? snapshot.val() : {};

            // Mapeia a chave da configuração para o ID do elemento na tela
            const visibilityMap = {
                ranking: 'ranking',
                storeRanking: 'store-ranking',
                cashBox: 'manager-cash-box-section',
                dailySales: 'daily-store-sales-data',
                individualSales: 'individual-sales-data',
                salesHistory: 'personal-sales-history',
                managerPanel: 'manager-panel-btn',
                closing: 'closing-btn'
            };

            for (const key in visibilityMap) {
                const elementId = visibilityMap[key];
                const element = document.getElementById(elementId);
                if (element) {
                    // O padrão é ser visível (true). Se a configuração for explicitamente 'false', esconde.
                    const isVisible = settings[key] !== false;
                    
                    if (isVisible) {
                        // Verifica se é um botão que precisa de display flex
                        if (element.classList.contains('action-button')) {
                            element.style.display = 'flex';
                        } else {
                            element.style.display = 'block'; // Padrão para seções
                        }
                    } else {
                        element.style.display = 'none';
                    }
                }
            }
        } catch (error) {
            console.error("Erro ao aplicar configurações de visibilidade:", error);
        }
    };

    const loadVisibilitySettings = async () => {
        const container = document.getElementById('visibility-settings-section');
        const isAdmin = newAdmins.includes(currentUserName);

        // Mostra a seção de configurações apenas para administradores
        container.style.display = isAdmin ? 'block' : 'none';
        if (!isAdmin) return;

        try {
            const snapshot = await database.ref('globalSettings/visibility').get();
            const settings = snapshot.exists() ? snapshot.val() : {};
            
            document.querySelectorAll('.visibility-toggle').forEach(toggle => {
                const key = toggle.dataset.key;
                // O padrão é true. Fica desmarcado apenas se estiver explicitamente 'false'.
                toggle.checked = settings[key] !== false;
            });

        } catch (error) {
            console.error("Erro ao carregar configurações de visibilidade:", error);
            document.getElementById('visibility-status-message').textContent = 'Erro ao carregar.';
        }
    };

    const saveVisibilitySetting = (key, value) => {
        const statusEl = document.getElementById('visibility-status-message');
        statusEl.textContent = 'Salvando...';
        database.ref(`globalSettings/visibility/${key}`).set(value)
            .then(() => {
                statusEl.textContent = 'Salvo!';
                setTimeout(() => statusEl.textContent = '', 1500);
            })
            .catch(error => {
                statusEl.textContent = 'Erro!';
                console.error("Erro ao salvar visibilidade:", error);
            });
    };

    const showPontoHistory = (name) => {
        const historyContainer = document.getElementById('ponto-history-container');
        document.getElementById('ponto-history-title').textContent = `Histórico de ${name}`;
        historyContainer.innerHTML = '<p>Carregando histórico...</p>';
        showPage('pontoHistoryPage');

        database.ref(`pontos/${name}`).orderByChild('timestamp').limitToLast(50).once('value', snapshot => {
            historyContainer.innerHTML = '';
            if (!snapshot.exists()) {
                historyContainer.innerHTML = '<p>Nenhum registro de ponto encontrado.</p>';
                return;
            }

            const records = [];
            snapshot.forEach(child => {
                // Modificado para guardar a chave junto com o registro
                records.push({ key: child.key, record: child.val() });
            });

            // Inverte para mostrar o mais recente primeiro
            records.reverse().forEach(async (recordWithKey) => { // Mudou para receber o objeto com a chave
                const { key, record } = recordWithKey;
                const card = document.createElement('div');
                card.className = 'ponto-history-card';
                const date = new Date(record.timestamp);
                const recordDateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

                let justificationHtml = '';
                const justificationSnap = await database.ref(`justifications/${recordDateString}/${name.toLowerCase()}`).get();
                if (justificationSnap.exists()) {
                    justificationHtml = `<div class="ponto-history-justification"><strong>Justificativa:</strong> ${justificationSnap.val().reason}</div>`;
                }

                // Botão de deletar que será adicionado ao final do card
                const deleteButtonHtml = `
                    <button class="delete-button-small" data-record-key="${key}" data-employee-name="${name}" style="margin-left: auto;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;

                if (record.type === 'falta') {
                    // --- RENDERIZA O CARD DE FALTA ---
                    card.classList.add('absence-record');
                    card.innerHTML = `
                        <div class="ponto-history-absence-icon">
                           <i class="fa-solid fa-user-clock"></i>
                        </div>
                        <div class="ponto-history-details">
                            <p><strong>${record.reason}</strong></p>
                            <p><strong>Data:</strong> ${date.toLocaleDateString('pt-BR')}</p>
                            <p><strong>Hora da Ocorrência:</strong> ${date.toLocaleTimeString('pt-BR')}</p>
                        </div>
                        ${justificationHtml}
                        ${deleteButtonHtml}
                    `;
                } else {
                    // --- RENDERIZA O CARD DE PONTO NORMAL ---
                    card.innerHTML = `
                        <img src="${record.photoURL}" class="ponto-history-photo" alt="Foto do ponto">
                        <div class="ponto-history-details">
                            <p><strong>Data:</strong> ${date.toLocaleDateString('pt-BR')}</p>
                            <p><strong>Hora:</strong> ${date.toLocaleTimeString('pt-BR')}</p>
                            <p><strong>Cidade:</strong> ${record.city}</p>
                        </div>
                         ${deleteButtonHtml}
                    `;
                }
                historyContainer.appendChild(card);
            });
        });
    };

    // --- FUNÇÕES DAS CALCULADORAS ---
    const formatBRL = (value) => {
        if (isNaN(value) || !isFinite(value)) {
            return "R$ 0,00";
        }
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    // --- Calculadora de Crediário ---
    const calculateCrediario = (source = 'mensal') => {
        const valorProduto = parseFloat(document.getElementById('crediario-valor-produto').value) || 0;
        const entrada = parseFloat(document.getElementById('crediario-entrada').value) || 0;
        
        const parcelasSlider = document.getElementById('crediario-parcelas');
        const quinzenaSlider = document.getElementById('crediario-quinzena-parcelas');
        const semanalSlider = document.getElementById('crediario-semanal-parcelas');

        // Zera as outras barras quando uma é movida
        if (source === 'mensal') {
            quinzenaSlider.value = 0;
            semanalSlider.value = 0;
        } else if (source === 'quinzena') {
            parcelasSlider.value = 1; // Mínimo do mensal é 1
            semanalSlider.value = 0;
        } else if (source === 'semanal') {
            parcelasSlider.value = 1; // Mínimo do mensal é 1
            quinzenaSlider.value = 0;
        }

        const parcelas = parseInt(parcelasSlider.value, 10);
        const quinzenas = parseInt(quinzenaSlider.value, 10);
        const semanas = parseInt(semanalSlider.value, 10);
        
        document.getElementById('parcelas-value').textContent = parcelas;
        document.getElementById('quinzena-value').textContent = quinzenas;
        document.getElementById('semanal-value').textContent = semanas;

        const valorFinanciado = valorProduto - entrada;
        
        const taxaJurosMensal = 0.069;  // 6.9% ao mês
        const taxaJurosQuinzena = 0.059; // 5.9% ao mês
        const taxaJurosSemanal = 0.049;  // 4.9% ao mês

        let valorParcela = 0;
        let totalAPrazo = 0;
        
        if (valorFinanciado <= 0) {
            document.getElementById('result-parcela').textContent = formatBRL(0);
            document.getElementById('result-total-prazo').textContent = formatBRL(valorProduto);
            return;
        }

        if (source === 'mensal' && parcelas > 0) {
            totalAPrazo = valorFinanciado * Math.pow(1 + taxaJurosMensal, parcelas);
            valorParcela = totalAPrazo / parcelas;
        } else if (source === 'quinzena' && quinzenas > 0) {
            const mesesEquivalentes = quinzenas / 2;
            totalAPrazo = valorFinanciado * Math.pow(1 + taxaJurosQuinzena, mesesEquivalentes);
            valorParcela = totalAPrazo / quinzenas;
        } else if (source === 'semanal' && semanas > 0) {
            const mesesEquivalentes = semanas / 4;
            totalAPrazo = valorFinanciado * Math.pow(1 + taxaJurosSemanal, mesesEquivalentes);
            valorParcela = totalAPrazo / semanas;
        }

        document.getElementById('result-parcela').textContent = formatBRL(valorParcela);
        document.getElementById('result-total-prazo').textContent = formatBRL(totalAPrazo);
    };

    const clearCrediario = () => {
        document.getElementById('crediario-valor-produto').value = '';
        document.getElementById('crediario-entrada').value = '';
        document.getElementById('crediario-parcelas').value = 10;
        document.getElementById('crediario-quinzena-parcelas').value = 0;
        document.getElementById('crediario-semanal-parcelas').value = 0;
        calculateCrediario('mensal');
    };

    // --- Calculadora de Parcelamento de Loja ---
    const calculateLoja = () => {
        const valorProduto = parseFloat(document.getElementById('loja-valor-produto').value) || 0;
        const entrada = parseFloat(document.getElementById('loja-entrada').value) || 0;
        const seguro = parseFloat(document.getElementById('loja-seguro').value) || 0;
        const parcelas = parseInt(document.getElementById('loja-parcelas').value, 10);
        document.getElementById('loja-parcelas-value').textContent = parcelas;

        // CORREÇÃO: O valor a ser financiado agora inclui o seguro.
        const valorFinanciado = (valorProduto + seguro) - entrada;

        if (valorFinanciado <= 0 || parcelas === 0) {
            document.getElementById('loja-result-parcela').textContent = formatBRL(0);
            document.getElementById('loja-result-total-prazo').textContent = formatBRL(valorProduto + seguro);
            return;
        }

        // O valor da parcela agora reflete o valor do produto + seguro.
        const valorParcela = valorFinanciado / parcelas;
        
        // O valor total a prazo continua sendo o valor do produto + seguro.
        const totalPrazo = valorProduto + seguro;

        document.getElementById('loja-result-parcela').textContent = formatBRL(valorParcela);
        document.getElementById('loja-result-total-prazo').textContent = formatBRL(totalPrazo);
    };

    const clearLojaCalculator = () => {
        document.getElementById('loja-valor-produto').value = '';
        document.getElementById('loja-entrada').value = '';
        document.getElementById('loja-seguro').value = '';
        document.getElementById('loja-parcelas').value = 10;
        calculateLoja();
    };

    // --- Calculadora de Parcelamento de Site ---
    const calculateSite = () => {
        const valorSite = parseFloat(document.getElementById('site-valor-produto').value) || 0;
        const entrada = parseFloat(document.getElementById('site-entrada').value) || 0;
        const parcelas = parseInt(document.getElementById('site-parcelas').value, 10);
        document.getElementById('site-parcelas-value').textContent = parcelas;

        const taxaJurosMensal = 0.0299; // 2.99% a.m.
        const valorFinanciado = valorSite - entrada;

        if (valorFinanciado <= 0 || parcelas === 0) {
            document.getElementById('site-result-parcela').textContent = formatBRL(0);
            document.getElementById('site-result-total-prazo').textContent = formatBRL(valorSite);
            return;
        }

        const valorParcela = valorFinanciado * (taxaJurosMensal / (1 - Math.pow(1 + taxaJurosMensal, -parcelas)));
        const totalPrazo = (valorParcela * parcelas) + entrada;

        document.getElementById('site-result-parcela').textContent = formatBRL(valorParcela);
        document.getElementById('site-result-total-prazo').textContent = formatBRL(totalPrazo);
    };

    const clearSiteCalculator = () => {
        document.getElementById('site-valor-produto').value = '';
        document.getElementById('site-entrada').value = '';
        document.getElementById('site-parcelas').value = 6;
        calculateSite();
    };

    const submitFeedback = () => {
        const nameInput = document.getElementById('feedback-name');
        const messageInput = document.getElementById('feedback-message');
        const statusEl = document.getElementById('feedback-status-message');

        const name = nameInput.value.trim();
        const message = messageInput.value.trim();

        if (!name || !message) {
            statusEl.textContent = 'Nome e mensagem são obrigatórios!';
            return;
        }

        statusEl.textContent = 'Enviando...';

        const feedbackData = {
            name,
            message,
            timestamp: new Date().toISOString(),
            read: false // Adiciona o status de não lido
        };

        database.ref('feedback').push(feedbackData)
            .then(() => {
                const userKey = name.toLowerCase();
                awardAchievement(userKey, 'a_voz_da_melhoria');

                statusEl.textContent = 'Feedback enviado com sucesso!';
                nameInput.value = '';
                messageInput.value = '';
                setTimeout(() => {
                    statusEl.textContent = '';
                    showMainPage();
                }, 2000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao enviar feedback.';
                console.error(error);
            });
    };

    const loadDebugPage = async () => {
        const statsContainer = document.getElementById('debug-stats-container');
        const accountsContainer = document.getElementById('debug-accounts-container');
        
        // Limpa os containers ao abrir a página
        statsContainer.innerHTML = `<p>Carregando estatísticas...</p>`;
        accountsContainer.innerHTML = ''; // Limpa a lista de contas

        // Carregar Estatísticas
        try {
            const statsSnap = await database.ref('statistics').get();
            if (statsSnap.exists()) {
                const stats = statsSnap.val();
                const appOpens = stats.appOpens || 0;
                const totalSeconds = stats.totalTimeSeconds || 0;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                
                statsContainer.innerHTML = `
                    <p><strong>Vezes que o App foi Aberto:</strong> ${appOpens}</p>
                    <p><strong>Tempo Total de Uso (Aprox.):</strong> ${hours}h ${minutes}min</p>
                `;
            } else {
                statsContainer.innerHTML = `<p>Nenhuma estatística encontrada.</p>`;
            }
        } catch (error) {
            statsContainer.innerHTML = `<p>Erro ao carregar estatísticas.</p>`;
            console.error(error);
        }
    };

    const loadAndDisplayAccountPasswords = async () => {
        const container = document.getElementById('debug-accounts-container');
        container.innerHTML = '<p style="text-align: center;">Carregando contas...</p>';

        try {
            const passwordsSnap = await database.ref('userPasswords').get();

            if (!passwordsSnap.exists()) {
                container.innerHTML = '<p style="text-align: center;">Nenhuma senha de colaborador encontrada.</p>';
                return;
            }

            container.innerHTML = ''; // Limpa antes de adicionar
            const passwords = passwordsSnap.val();

            for (const userKey in passwords) {
                const password = passwords[userKey];
                // Converte a chave (ex: 'beatriz') para o nome formatado (ex: 'Beatriz')
                const userName = userKey.charAt(0).toUpperCase() + userKey.slice(1);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mt-list-item'; // Reutilizando um estilo de lista existente
                itemDiv.style.justifyContent = 'space-between'; // Garante espaçamento
                
                itemDiv.innerHTML = `
                    <span class="mt-list-item-text"><strong>${userName}</strong></span>
                    <span style="font-family: monospace; color: #f1c40f; font-weight: bold;">${password}</span>
                `;
                container.appendChild(itemDiv);
            }

        } catch (error) {
            container.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erro ao carregar as contas.</p>';
            console.error("Erro ao buscar senhas no modo debug:", error);
        }
    };

    // ... (no bloco de listeners do DOMContentLoaded, adicione este) ...
    document.getElementById('debug-page').addEventListener('click', (event) => {
        const showAccountsBtn = event.target.closest('#show-accounts-btn');
        if (showAccountsBtn) {
            loadAndDisplayAccountPasswords();
        }

        const clearChatsBtn = event.target.closest('#clear-all-chats-btn');
        if (clearChatsBtn) {
            clearAllChatMessages();
        }
    });

    const deleteFeedbackItem = (key) => {
        if (confirm('Tem certeza que deseja apagar este feedback?')) {
            database.ref(`feedback/${key}`).remove()
                .then(() => {
                    alert('Feedback apagado.');
                    loadDebugPage(); // Recarrega a lista
                })
                .catch(err => {
                    alert('Erro ao apagar feedback.');
                    console.error(err);
                });
        }
    };

        // --- EVENT LISTENERS (USANDO A NOVA NAVEGAÇÃO) ---
        document.addEventListener('DOMContentLoaded', () => {

                                

                // --- LÓGICA DE TEMA (MOVIDA PARA CIMA) ---
            const openThemeModal = () => {
                const modal = elements.themeModal;
                if(isNavigating) return;
                isNavigating = true;
                
                modal.style.display = 'flex';
                requestAnimationFrame(() => {
                    modal.classList.add('visible');
                    staggerAnimate(modal);
                    isNavigating = false;
                });
            };

            const closeThemeModal = () => {
                const modal = elements.themeModal;
                if (isNavigating || !modal.classList.contains('visible')) return;
                isNavigating = true;

                modal.classList.add('is-exiting');

                modal.addEventListener('animationend', (e) => {
                    modal.style.display = 'none';
                    modal.classList.remove('visible', 'is-exiting');
                    isNavigating = false;
                }, { once: true });
            };

            const createOrClearFloatingXs = (create) => {
                const container = document.getElementById('floating-x-container');
                container.innerHTML = ''; // Limpa sempre
                if (!create) return;

                const xCount = 40; // Número de 'X's na tela
                for (let i = 0; i < xCount; i++) {
                    const x = document.createElement('span');
                    x.classList.add('floating-x');
                    x.innerText = 'X';
                    
                    const size = Math.random() * 40 + 20; // Tamanho entre 20px e 60px
                    const left = Math.random() * 100;
                    const duration = Math.random() * 20 + 15; // Duração entre 15s e 35s
                    const delay = Math.random() * 10; // Delay de até 10s
                    const startRotation = Math.random() * 360;
                    const endRotation = startRotation + (Math.random() * 180 - 90); // Gira até 90 graus para um lado ou outro

                    x.style.fontSize = `${size}px`;
                    x.style.left = `${left}vw`;
                    x.style.animationDuration = `${duration}s`;
                    x.style.animationDelay = `${delay}s`;
                    x.style.setProperty('--start-rot', `${startRotation}deg`);
                    x.style.setProperty('--end-rot', `${endRotation}deg`);

                    container.appendChild(x);
                }
            };

            const createOrClearFloatingDots = (create) => {
            const container = document.getElementById('floating-dots-container');
            container.innerHTML = '';
            if (!create) return;

            const dotCount = 60; // Mais pontos para preencher a tela
            for (let i = 0; i < dotCount; i++) {
                const dot = document.createElement('div');
                dot.classList.add('floating-dot');
                
                const size = Math.random() * 5 + 2; // Tamanho do ponto entre 2px e 7px
                const left = Math.random() * 100;
                const duration = Math.random() * 25 + 20; // Duração entre 20s e 45s
                const delay = Math.random() * 15;

                dot.style.width = `${size}px`;
                dot.style.height = `${size}px`;
                dot.style.left = `${left}vw`;
                dot.style.animationDuration = `${duration}s`;
                dot.style.animationDelay = `${delay}s`;

                container.appendChild(dot);
            }
        };

        const createSnowflakes = () => {
            const container = document.getElementById('snow-container');
            container.innerHTML = '';
            const snowflakeCount = 50; 

            for (let i = 0; i < snowflakeCount; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                flake.innerHTML = '❅'; 
                
                const left = Math.random() * 100;
                const duration = Math.random() * 5 + 5; 
                const delay = Math.random() * 5; 
                const size = Math.random() * 1.5 + 0.5; 

                flake.style.left = `${left}vw`;
                flake.style.animationDuration = `${duration}s`;
                flake.style.animationDelay = `${delay}s`;
                flake.style.fontSize = `${size}em`;

                container.appendChild(flake);
            }
        };
        
        const applySelectedTheme = () => {
            // Força o tema natalino removendo todos os outros
            document.body.classList.remove('theme-hunter', 'theme-rosa', 'theme-black', 'theme-claro', 'theme-lgbt', 'theme-grayx');
            
            createOrClearFloatingXs(false);
            createOrClearFloatingDots(false); 
            
            // Aplica tema natalino
            document.body.classList.add('theme-natal');
            createSnowflakes();
        };

        // Desativa listeners de tema antigo e força o natalino na inicialização
        applySelectedTheme();

        const runSantaEvent = () => {
            // 1 chance em 3 (gera 0, 1 ou 2)
            const chance = Math.floor(Math.random() * 3); 
            
            if (chance === 0) {
                const santa = document.getElementById('santa-animation');
                if (santa) {
                    santa.style.display = 'block';
                    santa.style.animation = 'flySanta 20s linear forwards';
                    
                    setTimeout(() => {
                        santa.style.display = 'none';
                    }, 20000);
                }
            }
        };

        runSantaEvent();


            // --- LÓGICA DE ATIVAÇÃO (A SER USADA PELA NOVA FUNÇÃO DE INICIALIZAÇÃO) ---
            const EMPLOYEE_ACTIVATION_CODE = '91734';
            const APP_MODE_KEY = 'appMode_v2';
            
            document.getElementById('submit-activation-code').addEventListener('click', () => {
                const input = document.getElementById('activation-code-input');
                const status = document.getElementById('activation-status');
                
                const handleSuccess = (mode) => {
                    localStorage.setItem(APP_MODE_KEY, mode);
                    status.textContent = 'Ativado com sucesso!';
                    status.style.color = '#2ecc71';
                    activationOverlay.classList.add('is-exiting');
                    activationOverlay.addEventListener('animationend', () => {
                        // Simplesmente recarrega a página. A nova função de inicialização fará o resto.
                        window.location.reload();
                    }, { once: true });
                };

                if (input.value === EMPLOYEE_ACTIVATION_CODE) {
                    handleSuccess('employee');
                } else {
                    status.textContent = 'Código incorreto!';
                    status.style.color = '#e74c3c';
                    input.value = '';
                }
            });


            
            
            // --- LISTENERS DA TELA DE LOGIN ---
            document.getElementById('login-proceed-btn').addEventListener('click', handleLoginAttempt);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('login-user-select').addEventListener('change', async (e) => {
                const userKey = e.target.value.toLowerCase();
                const hint = document.getElementById('login-password-hint');
                if (userKey) {
                    const passSnap = await database.ref(`userPasswords/${userKey}`).get();
                    hint.style.display = passSnap.exists() ? 'none' : 'block';
                } else {
                    hint.style.display = 'none';
                }
            });

            document.getElementById('header-profile-pic').addEventListener('click', () => {
                if (currentUserName) {
                    loadAndShowCollaboratorProfile(currentUserName);
                }
            });


                        // --- NAVEGAÇÃO PRINCIPAL E FERRAMENTAS ---
            document.getElementById('open-feedback-page').addEventListener('click', () => showPage('feedbackPage'));
            document.getElementById('open-debug-page').addEventListener('click', () => {
                const userInput = prompt("Digite a senha de acesso ao Debug:");
                if (userInput === DEBUG_PASSWORD) {
                    loadDebugPage();
                    showPage('debugPage');
                } else if (userInput !== null) {
                    alert("Senha incorreta!");
                }
            });

            const openExternalLinkAndExit = (url) => {
                if (!url) return;

                // Verifica se é um link do WhatsApp para aplicar a lógica especial
                if (url.includes('whatsapp.com')) {
                    // Remove o "https://"" do início da URL
                    const urlWithoutScheme = url.replace(/^https?:\/\//, '');

                    // Cria um link de "Intent" do Android que aponta diretamente para o WhatsApp Business.
                    // A parte mais importante é "package=com.whatsapp.w4b".
                    // "S.browser_fallback_url" é um backup: se o WhatsApp Business não estiver instalado,
                    // ele abrirá o link no navegador em vez de ir para a Play Store.
                    const intentUrl = `intent://${urlWithoutScheme}#Intent;scheme=https;package=com.whatsapp.w4b;S.browser_fallback_url=${encodeURIComponent(url)};end`;

                    // Navega para o link de Intent
                    window.location.href = intentUrl;

                } else {
                    // Para outros links (como Brasil Card), o comportamento antigo é mantido
                    window.location.href = url;
                }

                // Tenta fechar o aplicativo após um pequeno delay
                setTimeout(() => {
                    if (navigator.app && navigator.app.exitApp) {
                        navigator.app.exitApp();
                    }
                }, 500);
            };

            document.getElementById('hunter-card-link').addEventListener('click', function(event) {
                openExternalLinkAndExit(event.currentTarget.dataset.url);
            });

                                    const loadAndDisplayDailyStoreSales = async () => {
        const container = document.getElementById('daily-store-sales-data');
        if (!storeManagers.includes(currentUserName)) {
            // container.style.display = 'none'; // Deixa a função de visibilidade global controlar isso
            return;
        }

        container.innerHTML = `<div class="sales-data-card"><p>Carregando vendas do dia...</p></div>`;
        // container.style.display = 'block'; // Deixa a função de visibilidade global controlar isso

        const todayString = getTodayDateString();
        const storeEmployees = storeMapping.pinheiro.includes(currentUserName)
            ? storeMapping.pinheiro
            : storeMapping.bacabal;

        try {
            const dailySalesSnap = await database.ref(`dailySales/${todayString}`).get();
            const allDailySales = dailySalesSnap.exists() ? dailySalesSnap.val() : {};

            let totalVendasDoDia = 0;

            storeEmployees.forEach(employeeName => {
                const employeeKey = employeeName.toLowerCase();
                const employeeDailyData = allDailySales[employeeKey] || {};
                totalVendasDoDia += parseFloat(employeeDailyData.vendas || 0);
            });

            container.innerHTML = `
                <div class="sales-data-card" style="border-left-color: #2ecc71;">
                    <h4>Vendas do Dia (Loja)</h4>
                    <p style="font-size: 1.5rem; text-align: center; font-weight: 700;">${formatBRL(totalVendasDoDia)}</p>
                </div>
            `;

        } catch (error) {
            console.error("Erro ao carregar vendas do dia da loja:", error);
            container.innerHTML = `<div class="sales-data-card"><p>Erro ao carregar vendas do dia.</p></div>`;
        }
    };

    const loadAndShowCollaboratorProfile = (userName) => {
        // Define o usuário atual para que todas as funções internas funcionem corretamente
        currentUserName = userName;
        const userKey = userName.toLowerCase();
        document.getElementById('collaborator-name-display').textContent = userName;

        // --- LÓGICA DE VISIBILIDADE DE ELEMENTOS ---
        const isProfileOwner = (localStorage.getItem('loggedInUser') === userName);
        const isManagerProfile = managers.includes(userName);
        const isStoreManagerProfile = storeManagers.includes(userName);
        const isAdminProfile = newAdmins.includes(userName);
        const isCollaboratorProfile = !isAdminProfile; // Qualquer um que não seja admin é considerado um colaborador para fins de vendas/ponto.

        // Get all elements that need their visibility managed
        const managerBtn = document.getElementById('manager-panel-btn');
        const closingBtn = document.getElementById('closing-btn');
        const gsBtnInProfile = document.getElementById('open-gs-from-profile-btn');
        const metasBtn = document.getElementById('view-metas-btn');
        const achievementsSection = document.getElementById('achievements-section');
        const pontoBtn = document.getElementById('bater-ponto-btn');
        const pontoNotificationArea = document.getElementById('ponto-notification-area');
        const pontoCountdownTimer = document.getElementById('ponto-countdown-timer');
        const pontoLiveCountdown = document.getElementById('ponto-live-countdown');

        // Reset all optional elements to a hidden state first
        [managerBtn, closingBtn, gsBtnInProfile, metasBtn, achievementsSection, pontoBtn, pontoNotificationArea, pontoCountdownTimer, pontoLiveCountdown].forEach(el => el.style.display = 'none');
        
        // Show Admin-specific elements
        if (isAdminProfile) {
            gsBtnInProfile.style.display = 'flex';
        }
        
        // Show Manager-specific elements (includes Store Managers and Admins)
        if (isManagerProfile) {
            // A visibilidade do cashBox é controlada pela função global
            loadManagerCashBoxData();
        }

        // Show Store Manager-specific elements
        if (isStoreManagerProfile) {
            managerBtn.style.display = 'flex';
            closingBtn.style.display = 'flex';
            loadAndDisplayDailyStoreSales(); // Carrega os dados, a visibilidade é controlada globalmente
        }
        
        // Show Collaborator-specific elements (non-admins)
        if (isCollaboratorProfile) {
            metasBtn.style.display = 'flex';
            achievementsSection.style.display = 'block';

            loadAndDisplayIndividualSalesData();
            loadPersonalSalesHistoryChart();
            displayAchievements(userKey);
            
            // Ponto controls are only for the profile owner
            const showPontoElements = isProfileOwner;
            pontoBtn.style.display = showPontoElements ? 'flex' : 'none';
            pontoNotificationArea.style.display = showPontoElements ? 'block' : 'none';
            pontoCountdownTimer.style.display = showPontoElements ? 'block' : 'none';
            pontoLiveCountdown.style.display = showPontoElements ? 'block' : 'none';

            if (showPontoElements) {
                checkPontoStatusAndDisplayWarnings();
            } else {
                stopCountdownTimer();
                pontoLiveCountdown.innerHTML = '';
            }
        } else {
            // Se for admin, garante que o timer de ponto seja limpo
            stopCountdownTimer();
            pontoLiveCountdown.innerHTML = '';
        }

        // --- CARREGAMENTO GERAL DE DADOS (EXECUTADO PARA TODOS) ---
        applyVisibilitySettings(); // Aplica as regras de visibilidade globais
        const profileOpenRef = database.ref(`userProfiles/${userKey}/profileOpenCount`);
        profileOpenRef.transaction(count => { return (count || 0) + 1; });
        document.getElementById('photo-upload-status').textContent = '';
        checkAndDisplayMaintenanceNotice();
        checkForParabens(userKey);
        loadCollaboratorProfilePicture();
        loadAndDisplayCollaboratorStatus();
        initiateLollipopCapture();
        loadAndDisplayStories();

        showPage('collaboratorPage');
    };

            const openCollaboratorProfileAsGS = () => {
                const userList = allCollaborators.map((name, index) => `${index + 1}. ${name}`).join('\n');
                const selectedIndexStr = prompt(`Selecione o colaborador para ver o perfil:\n\n${userList}`);

                if (selectedIndexStr === null || selectedIndexStr.trim() === '') {
                    return; // Usuário cancelou
                }

                const selectedIndex = parseInt(selectedIndexStr, 10) - 1;

                if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= allCollaborators.length) {
                    alert('Seleção inválida.');
                    return;
                }

                const selectedUserName = allCollaborators[selectedIndex];
                loadAndShowCollaboratorProfile(selectedUserName);
            };

            // Listener do novo botão "Meu Perfil"
            document.getElementById('open-my-profile-btn').addEventListener('click', () => {
                if (!currentUserName) {
                    alert("Você precisa fazer login primeiro.");
                    return;
                }
                loadAndShowCollaboratorProfile(currentUserName);
            });

            // O listener para 'open-gs-page' foi removido, pois o botão não existe mais.
            // ... (resto dos seus listeners)
            
            // Flag para garantir que os listeners sejam adicionados apenas uma vez.
            let gsListenersAttached = false;
            
            function setupGSPageListeners() {
                // Se os listeners já foram adicionados, não faz nada.
                if (gsListenersAttached) return;

                // Adiciona os listeners para cada botão da página GS.
                document.getElementById('open-settings-page').addEventListener('click', () => {
                    buildAndLoadMetasPage(); 
                    showPage('metasConfigPage');
                });
                
                document.getElementById('open-correction-page').addEventListener('click', () => {
                    buildAndLoadCorrectionPage(); 
                    showPage('correctionPage');
                });

                document.getElementById('open-mt-management-page').addEventListener('click', loadAndShowMtManagementPage);
                
                document.getElementById('verificar-ponto-btn').addEventListener('click', showPontoVerificationList);
                
                document.getElementById('open-collaborator-profile-btn').addEventListener('click', openCollaboratorProfileAsGS);

                document.getElementById('open-cash-management-page').addEventListener('click', loadCashManagementPage);
                
                document.getElementById('open-store-cash-management-page').addEventListener('click', openStoreCashManagementPage);
                document.getElementById('open-venda-remota-cash-management-page').addEventListener('click', openVendaRemotaCashManagementPage); // NOVO LISTENER
                
                document.getElementById('open-overtime-management-page').addEventListener('click', openOvertimeManagementPage);
                
                document.getElementById('open-holidays-management-page').addEventListener('click', () => {
                    loadAndRenderList('holidays', 'holidays-list-container', 'Feriado'); 
                    showPage('holidaysManagementPage');
                });

                document.getElementById('open-sundays-management-page').addEventListener('click', () => {
                    loadAndRenderList('workingSundays', 'sundays-list-container', 'Domingo de Trabalho'); 
                    showPage('sundaysManagementPage');
                });

                document.getElementById('open-day-off-management-page').addEventListener('click', () => {
                    populateEmployeeSelect(); 
                    loadAndRenderDaysOff(); 
                    showPage('dayOffManagementPage');
                });

                document.getElementById('open-avisos-management-page').addEventListener('click', () => {
                    loadAndManageAvisos();
                    showPage('avisosManagementPage');
                });
                
                document.getElementById('clear-ponto-status-btn').addEventListener('click', clearPontoStatusForUser);

                // Marca que os listeners foram adicionados.
                gsListenersAttached = true;
            }

            // Listener para o botão GS dentro do perfil
            document.getElementById('open-gs-from-profile-btn').addEventListener('click', () => {
                // Carrega todos os dados necessários para o dashboard.
                loadDashboardData();
                loadManagerNotifications();
                loadMaintenanceModeStatus();
                markNotificationsAsRead();

                // Chama a função que garante que todos os botões da página GS funcionarão.
                setupGSPageListeners();
                loadVisibilitySettings(); // Carrega as configurações de visibilidade

                // Mostra a página GS.
                showPage('gsPage');
            });

            document.getElementById('open-send-device-page').addEventListener('click', () => showPage('sendDevicePage'));
            document.querySelectorAll('.brand-button').forEach(button => button.addEventListener('click', () => loadBrandDevices(button.dataset.brand)));
            document.getElementById('open-device-search').addEventListener('click', openDeviceSearch);
            document.getElementById('previsao-btn').addEventListener('click', calculateDeliveryPrediction);
            document.getElementById('open-os-modal').addEventListener('click', openOsModal);
            document.getElementById('open-request-stock-page').addEventListener('click', openStockRequestPage);
            document.getElementById('open-recibos-page').addEventListener('click', () => showPage('recibosPage'));
            document.getElementById('open-quiz-page').addEventListener('click', () => showPage('quizPage'));

            // --- MODAL DE COLABORADORES ---
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            elements.modal.addEventListener('click', (event) => { if (event.target === elements.modal) closeModal(); });
            document.getElementById('btn-pinheiro').addEventListener('click', () => { document.getElementById('colaborador-cidades').style.display = 'none'; document.getElementById('colaborador-pinheiro').style.display = 'block'; });
            document.getElementById('btn-bacabal').addEventListener('click', () => { document.getElementById('colaborador-cidades').style.display = 'none'; document.getElementById('colaborador-bacabal').style.display = 'block'; });
            // O código dentro deste listener está correto, mas o erro de sintaxe pode estar
            // no listener do botão GS. Removi a lógica duplicada e incorreta de lá.
            // Este listener aqui já está obsoleto por causa do novo sistema de login,
            // então não precisa de alteração. O problema real está no próximo bloco.

// --- PÁGINA DO COLABORADOR ---
            document.getElementById('view-metas-btn').addEventListener('click', () => { loadAndDisplayCollaboratorMetas(); showPage('metasDisplayPage'); });
            document.getElementById('manager-panel-btn').addEventListener('click', loadManagerPanel);
            document.getElementById('change-password-btn').addEventListener('click', changePassword);
            document.getElementById('closing-btn').addEventListener('click', () => {
                document.getElementById('closing-store-selection').style.display = 'block';
                document.getElementById('closing-form-pinheiro').style.display = 'none';
                document.getElementById('closing-form-bacabal').style.display = 'none';
                document.getElementById('closing-submit-container').style.display = 'none';
                document.getElementById('closing-status-message').textContent = '';
                showPage('closingPage');
            });

            // --- PÁGINA DE GERÊNCIA (DASHBOARD) ---
            // Os listeners foram movidos para dentro do evento de clique que abre a página GS
            // para garantir que os elementos existam no DOM.

            // --- PÁGINA DE CONFIGURAÇÕES / CORREÇÃO ---
            // Os listeners para estes botões agora são adicionados dinamicamente quando as páginas são construídas.

            // --- PÁGINA DE ENVIO DE DISPOSITIVO ---
            document.getElementById('save-device-btn').addEventListener('click', saveDevice);

            // Listener para o botão de upload de imagem do dispositivo
            document.getElementById('device-upload-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('device-image-upload').click();
            });
            document.getElementById('device-image-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const statusEl = document.getElementById('device-image-status');
                if (file) {
                    statusEl.textContent = `Arquivo selecionado: ${file.name}`;
                } else {
                    statusEl.textContent = '';
                }
            });

                        // Listeners para o código de acesso Lollipop
            document.getElementById('device-brand').addEventListener('input', checkLollipopCode);
            document.getElementById('device-name').addEventListener('input', checkLollipopCode);

            


            // --- MODAIS DE FERRAMENTAS ---
            document.getElementById('close-suporte-modal-btn').addEventListener('click', closeSuporteModal);
            elements.suporteModal.addEventListener('click', (event) => { if (event.target === elements.suporteModal) closeSuporteModal(); });
            document.getElementById('close-os-modal-btn').addEventListener('click', () => closeOsModal());
            elements.osModal.addEventListener('click', (e) => { if (e.target === elements.osModal) closeOsModal(); });
            document.getElementById('submit-os-form-btn').addEventListener('click', sendOsEmail);
            document.getElementById('send-stock-request-btn').addEventListener('click', submitStockRequest);
            document.getElementById('submit-recibo-btn').addEventListener('click', submitRecibo);
            document.getElementById('submit-quiz-btn').addEventListener('click', submitQuiz);

                        // --- FECHAMENTO (seleção de loja e geração de formulário) ---
            const showClosingForm = (store) => {
            const formContainerId = `closing-form-${store}`;
            const formContainer = document.getElementById(formContainerId);
            const employeesForStore = storeMapping[store];

            let formHtml = `<h3 class="modal-title">Fechamento - ${store.charAt(0).toUpperCase() + store.slice(1)}</h3>`;

            employeesForStore.forEach(name => {
                const key = name.toLowerCase();
                formHtml += `
                    <div class="employee-meta-card" style="margin-bottom: 2rem;">
                        <h4>${name}</h4>
                        <div class="input-group"><label for="closing-venda-${key}">VENDA 📈</label><input type="text" inputmode="decimal" id="closing-venda-${key}" class="data-input" placeholder="0,00"></div>
                        <div class="input-group"><label for="closing-servico-${key}">SERVIÇO 🔧</label><input type="text" inputmode="decimal" id="closing-servico-${key}" class="data-input" placeholder="0,00"></div>
                        <div class="input-group"><label for="closing-preco-site-${key}">PREÇO DE SITE 📡</label><input type="text" inputmode="decimal" id="closing-preco-site-${key}" class="data-input" placeholder="0,00"></div>
                    </div>
                `;
            });
            
            formContainer.innerHTML = formHtml;
            
            document.getElementById('closing-store-selection').style.display = 'none';
            document.getElementById('closing-submit-container').style.display = 'block';
            document.getElementById('closing-form-pinheiro').style.display = store === 'pinheiro' ? 'block' : 'none';
            document.getElementById('closing-form-bacabal').style.display = store === 'bacabal' ? 'block' : 'none';
        };
        document.getElementById('closing-btn-pinheiro').addEventListener('click', () => showClosingForm('pinheiro'));
        document.getElementById('closing-btn-bacabal').addEventListener('click', () => showClosingForm('bacabal'));
        document.getElementById('submit-closing-data-btn').addEventListener('click', submitClosingData);

            // --- BOTÕES DE VOLTAR (TODOS CENTRALIZADOS AQUI) ---
            document.getElementById('back-to-main').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-gs').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-send').addEventListener('click', () => {
                resetSendDeviceForm(); // Limpa o estado de edição antes de voltar
                showMainPage();
            });
            document.getElementById('back-to-main-from-brand').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-os').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-stock').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-recibos').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-quiz').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-feedback').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-debug').addEventListener('click', showMainPage);
                document.getElementById('back-to-gs-from-cash').addEventListener('click', () => showPage('gsPage'));
    document.getElementById('back-to-gs-from-store-cash').addEventListener('click', () => showPage('gsPage'));
    document.getElementById('back-to-gs-from-venda-remota-cash').addEventListener('click', () => showPage('gsPage')); // NOVO BOTÃO DE VOLTAR

            // Adicionando listeners de "voltar" para as novas páginas de submissão
            document.getElementById('back-to-gs-from-stock-requests').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-recibos').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-quiz').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-feedback').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-metas').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-correction').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-holidays').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-sundays').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-day-off').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-overtime').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-avisos').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-collab-from-metas').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-collab-from-panel').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-collab-from-closing').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-main-from-device-search').addEventListener('click', showMainPage);

            // --- LÓGICA DAS CALCULADORAS ---
            const valorProdutoInput = document.getElementById('crediario-valor-produto');
            const entradaInput = document.getElementById('crediario-entrada');
            const parcelasSlider = document.getElementById('crediario-parcelas');
            const quinzenaSlider = document.getElementById('crediario-quinzena-parcelas');
            const semanalSlider = document.getElementById('crediario-semanal-parcelas');

            const recalculateCrediario = () => {
                // Ao alterar valor ou entrada, recalcula baseado na barra que não está zerada
                if (parseInt(quinzenaSlider.value, 10) > 0) {
                    calculateCrediario('quinzena');
                } else if (parseInt(semanalSlider.value, 10) > 0) {
                    calculateCrediario('semanal');
                } else {
                    calculateCrediario('mensal');
                }
            };

            valorProdutoInput.addEventListener('input', recalculateCrediario);
            entradaInput.addEventListener('input', recalculateCrediario);
            parcelasSlider.addEventListener('input', () => calculateCrediario('mensal'));
            quinzenaSlider.addEventListener('input', () => calculateCrediario('quinzena'));
            semanalSlider.addEventListener('input', () => calculateCrediario('semanal'));
            
            document.getElementById('clear-crediario-btn').addEventListener('click', clearCrediario);
            document.getElementById('open-crediario-calculator').addEventListener('click', () => { clearCrediario(); showPage('crediarioCalculatorPage'); });
            document.getElementById('back-to-main-from-crediario').addEventListener('click', showMainPage);
            
            const siteValorInput = document.getElementById('site-valor-produto');
            const siteEntradaInput = document.getElementById('site-entrada');
            const siteParcelasSlider = document.getElementById('site-parcelas');
            [siteValorInput, siteEntradaInput, siteParcelasSlider].forEach(el => { el.addEventListener('input', calculateSite); });
            document.getElementById('clear-site-btn').addEventListener('click', clearSiteCalculator);
            document.getElementById('open-site-calculator').addEventListener('click', () => { clearSiteCalculator(); showPage('siteCalculatorPage'); });
            document.getElementById('back-to-main-from-site').addEventListener('click', showMainPage);
            
            const lojaValorInput = document.getElementById('loja-valor-produto');
            const lojaEntradaInput = document.getElementById('loja-entrada');
            const lojaSeguroInput = document.getElementById('loja-seguro');
            const lojaParcelasSlider = document.getElementById('loja-parcelas');
            [lojaValorInput, lojaEntradaInput, lojaSeguroInput, lojaParcelasSlider].forEach(el => { el.addEventListener('input', calculateLoja); });
            document.getElementById('clear-loja-btn').addEventListener('click', clearLojaCalculator);
            document.getElementById('open-loja-calculator').addEventListener('click', () => { clearLojaCalculator(); showPage('lojaCalculatorPage'); });
            document.getElementById('back-to-main-from-loja').addEventListener('click', showMainPage);
            
            // --- LÓGICA DO CAIXA (GERENTE) ---
            document.getElementById('burn-cdc-btn').addEventListener('click', burnCdcFunds);
            document.getElementById('recover-cdc-btn').addEventListener('click', recoverCdcFunds);
            
    const openStoreCashManagementPage = async () => {
        showPage('storeCashManagementPage');
        const container = document.getElementById('store-cash-management-content');
        container.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        try {
            const cashSnap = await database.ref('cashManagement').get();
            const cashData = cashSnap.exists() ? cashSnap.val() : {};
            container.innerHTML = '';

            managers.forEach(name => {
                const key = name.toLowerCase();
                const storeValue = cashData[key]?.currentStoreValue !== undefined ? cashData[key].currentStoreValue : CASH_BOX_INITIAL_VALUE;
                const card = document.createElement('div');
                card.className = 'employee-meta-card';
                card.innerHTML = `
                     <h4>${name} - Verba da Loja</h4>
                     <div class="input-group">
                        <label for="store-cash-input-${key}">Valor Atual (R$)</label>
                        <input type="text" id="store-cash-input-${key}" class="data-input" value="${formatToBRLInput(storeValue)}">
                    </div>`;
                container.appendChild(card);
            });

            container.innerHTML += `
                <button id="save-store-cash-btn" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Alterações</button>
                <p id="store-cash-status-message" class="status-message"></p>
            `;
            document.getElementById('save-store-cash-btn').addEventListener('click', saveStoreCashChanges);

        } catch (error) {
            container.innerHTML = '<p style="text-align: center;">Erro ao carregar dados da verba de loja.</p>';
            console.error(error);
        }
    };

    const saveStoreCashChanges = () => {
        const statusEl = document.getElementById('store-cash-status-message');
        statusEl.textContent = 'Salvando...';

        const updates = {};
        managers.forEach(name => {
            const key = name.toLowerCase();
            const input = document.getElementById(`store-cash-input-${key}`);
            const newValue = parseFromBRLInput(input.value);

            if (!isNaN(newValue)) {
                updates[`/cashManagement/${key}/currentStoreValue`] = newValue;
            }
        });

        database.ref().update(updates)
            .then(() => {
                statusEl.textContent = 'Verba de loja atualizada!';
                setTimeout(() => {
                     statusEl.textContent = '';
                }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao salvar!';
                console.error(error);
            });
    };

    // --- NOVAS FUNÇÕES PARA GERENCIAR VERBA DE VENDA REMOTA ---
    const openVendaRemotaCashManagementPage = async () => {
        showPage('vendaRemotaCashManagementPage');
        const container = document.getElementById('venda-remota-cash-management-content');
        container.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        try {
            const cashSnap = await database.ref('cashManagement').get();
            const cashData = cashSnap.exists() ? cashSnap.val() : {};
            container.innerHTML = '';

            managers.forEach(name => {
                const key = name.toLowerCase();
                const remoteSaleValue = cashData[key]?.currentVendaRemotaValue !== undefined ? cashData[key].currentVendaRemotaValue : SITE_CASH_BOX_INITIAL_VALUE;
                const card = document.createElement('div');
                card.className = 'employee-meta-card';
                card.innerHTML = `
                     <h4>${name} - Verba de Site</h4>
                     <div class="input-group">
                        <label for="venda-remota-cash-input-${key}">Valor Atual (R$)</label>
                        <input type="text" id="venda-remota-cash-input-${key}" class="data-input" value="${formatToBRLInput(remoteSaleValue)}">
                    </div>`;
                container.appendChild(card);
            });

            container.innerHTML += `
                <button id="save-venda-remota-cash-btn" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Alterações</button>
                <p id="venda-remota-cash-status-message" class="status-message"></p>
            `;
            document.getElementById('save-venda-remota-cash-btn').addEventListener('click', saveVendaRemotaCashChanges);

        } catch (error) {
            container.innerHTML = '<p style="text-align: center;">Erro ao carregar dados da verba de Venda Remota.</p>';
            console.error(error);
        }
    };

    const saveVendaRemotaCashChanges = () => {
        const statusEl = document.getElementById('venda-remota-cash-status-message');
        statusEl.textContent = 'Salvando...';

        const updates = {};
        managers.forEach(name => {
            const key = name.toLowerCase();
            const input = document.getElementById(`venda-remota-cash-input-${key}`);
            const newValue = parseFromBRLInput(input.value);

            if (!isNaN(newValue)) {
                updates[`/cashManagement/${key}/currentVendaRemotaValue`] = newValue;
            }
        });

        database.ref().update(updates)
            .then(() => {
                statusEl.textContent = 'Verba de Site atualizada!';
                setTimeout(() => {
                     statusEl.textContent = '';
                }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao salvar!';
                console.error(error);
            });
    };
            
            // --- GESTÃO DE CAIXA (GS) ---
            document.getElementById('cash-management-page').addEventListener('click', (event) => {
                const resetBtn = event.target.closest('.reset-cash-btn');
                if (resetBtn) {
                    resetCashBox(resetBtn.dataset.managerKey, resetBtn.dataset.type);
                    return;
                }

                const deleteBtn = event.target.closest('.delete-expense-btn');
                if (deleteBtn) {
                    const { managerKey, expenseKey, expenseValue } = deleteBtn.dataset;
                    deleteExpense(managerKey, expenseKey, parseFloat(expenseValue));
                    return;
                }
            });

                        // --- LÓGICA DO MOSTRUÁRIO (MT) ---
            // O event listener foi removido pois o botão MT agora é um link direto.
            document.getElementById('mt-brand-filter').addEventListener('change', (event) => displayMtForBrand(event.target.value));
            document.getElementById('back-to-main-from-mt-display').addEventListener('click', showMainPage);
            document.getElementById('back-to-gs-from-mt-management').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('save-mt-item-btn').addEventListener('click', saveMtItem);
            document.getElementById('mt-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    const { brand, key } = deleteButton.dataset;
                    deleteMtItem(brand, key);
                }
            });

            // --- LISTENERS DA FUNÇÃO DE PONTO E GERENCIAMENTO DE DATAS ---
            document.getElementById('bater-ponto-btn').addEventListener('click', handlePontoLogic);
            document.getElementById('capture-ponto-btn').addEventListener('click', captureAndUploadPonto);
            
            // Listeners para troca de foto de perfil
            const loadAndDisplayCollaboratorStatus = async () => {
                // Parte 1: Carrega o status pessoal APENAS na página de perfil do usuário.
                const profileDisplayContainer = document.getElementById('collaborator-status-display-container');
                if (profileDisplayContainer && currentUserName) {
                    profileDisplayContainer.innerHTML = ''; // Limpa antes de carregar
                    const userKey = currentUserName.toLowerCase();
                    try {
                        const statusSnapshot = await database.ref(`userStatuses/${userKey}`).get();
                        if (statusSnapshot.exists()) {
                            const statusData = statusSnapshot.val();
                            const statusTimestamp = new Date(statusData.timestamp);
                            const now = new Date();
                            if ((now - statusTimestamp) / (1000 * 60 * 60) < 24) { // Se o status for das últimas 24h
                                const profileSnap = await database.ref(`userProfiles/${userKey}`).get();
                                const photoUrl = profileSnap.exists() && profileSnap.val().photoURL ? profileSnap.val().photoURL : DEFAULT_PROFILE_PHOTO;
                                profileDisplayContainer.innerHTML = `
                                    <div class="profile-status-bubble">
                                        <img src="${photoUrl}" class="status-bubble-photo">
                                        <span class="status-bubble-text">${statusData.text}</span>
                                    </div>`;
                            }
                        }
                    } catch (error) {
                        console.error("Erro ao carregar o status do perfil pessoal:", error);
                    }
                }

                // Parte 2: Carrega o status mais recente de QUALQUER usuário para a PÁGINA PRINCIPAL.
                const mainDisplaySection = document.getElementById('main-status-display-section');
                const mainDisplayContainer = document.getElementById('main-status-bubble-container');
                if (!mainDisplaySection || !mainDisplayContainer) return;

                mainDisplayContainer.innerHTML = '';
                mainDisplaySection.style.display = 'none';

                try {
                    const allStatusesSnap = await database.ref('userStatuses').get();
                    const allProfilesSnap = await database.ref('userProfiles').get();

                    if (!allStatusesSnap.exists()) return;

                    const allStatuses = allStatusesSnap.val();
                    const allProfiles = allProfilesSnap.exists() ? allProfilesSnap.val() : {};
                    const now = new Date();
                    let mostRecentActiveStatus = null;

                    // Itera por todos os status para encontrar o mais recente e ativo
                    for (const userKey in allStatuses) {
                        const statusData = allStatuses[userKey];
                        const statusTimestamp = new Date(statusData.timestamp);

                        if ((now - statusTimestamp) / (1000 * 60 * 60) < 24) { // Se está ativo
                            // Se for o primeiro status ativo encontrado ou for mais recente que o último encontrado
                            if (!mostRecentActiveStatus || statusTimestamp > new Date(mostRecentActiveStatus.timestamp)) {
                                mostRecentActiveStatus = { ...statusData, userKey };
                            }
                        }
                    }

                    // Se um status ativo e mais recente foi encontrado, exibe-o
                    if (mostRecentActiveStatus) {
                        const authorKey = mostRecentActiveStatus.userKey;
                        const photoUrl = allProfiles[authorKey]?.photoURL || DEFAULT_PROFILE_PHOTO;
                        
                        mainDisplayContainer.innerHTML = `
                            <div class="profile-status-bubble">
                                <img src="${photoUrl}" class="status-bubble-photo">
                                <span class="status-bubble-text">${mostRecentActiveStatus.text}</span>
                            </div>`;
                        mainDisplaySection.style.display = 'block';
                    }

                } catch (error) {
                    console.error("Erro ao carregar status global para a página principal:", error);
                }
            };

            const handleStatusUpdate = async () => {
                const userKey = currentUserName.toLowerCase();
                const statusRef = database.ref(`userStatuses/${userKey}`);

                try {
                    const snapshot = await statusRef.get();
                    if (snapshot.exists()) {
                        const currentStatus = snapshot.val();
                        const statusTimestamp = new Date(currentStatus.timestamp);
                        const now = new Date();
                        const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);

                        if (hoursDiff < 24) {
                             if (confirm(`Status atual: "${currentStatus.text}".\nDeseja apagar este status?`)) {
                                await statusRef.remove();
                                alert('Status removido!');
                                loadAndDisplayCollaboratorStatus(); // Atualiza a exibição no perfil
                                calculateAndDisplayRanking();
                                calculateAndDisplayStoreRanking();
                             }
                             return;
                        }
                    }
                    
                    const newStatusText = prompt("Digite seu status (máx. 60 caracteres):");
                    if (newStatusText === null) return;

                    if (newStatusText.trim() === "") {
                        alert("O status não pode ser vazio.");
                        return;
                    }

                    if (newStatusText.length > 60) {
                        alert("O status não pode ter mais de 60 caracteres.");
                        return;
                    }

                    const newStatusData = {
                        text: newStatusText,
                        timestamp: new Date().toISOString()
                    };

                    // --- INÍCIO DA NOVA LÓGICA DE STREAK ---
                    const streakRef = database.ref(`userProfiles/${userKey}/statusStreakData`);
                    
                    streakRef.transaction(currentData => {
                        const todayString = getTodayDateString();
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayString = `${yesterday.getFullYear()}-${(yesterday.getMonth() + 1).toString().padStart(2, '0')}-${yesterday.getDate().toString().padStart(2, '0')}`;
                        
                        let data = currentData || { streak: 0, lastCommentDate: null };

                        if (data.lastCommentDate === todayString) {
                            // Já comentou hoje, não faz nada com a sequência
                        } else if (data.lastCommentDate === yesterdayString) {
                            // Comentou ontem, incrementa a sequência
                            data.streak++;
                        } else {
                            // Não comentou ontem, reseta a sequência
                            data.streak = 1;
                        }

                        data.lastCommentDate = todayString;
                        
                        // Verifica se a conquista foi alcançada
                        if(data.streak >= 3) {
                            awardAchievement(userKey, 'comentarista_consistente');
                        }

                        return data; // Salva os dados atualizados no Firebase
                    });
                    // --- FIM DA NOVA LÓGICA DE STREAK ---

                    await statusRef.set(newStatusData);
                    alert('Status atualizado com sucesso!');
                    loadAndDisplayCollaboratorStatus(); // Atualiza a exibição no perfil
                    calculateAndDisplayRanking();
                    calculateAndDisplayStoreRanking();
                    displayAchievements(userKey); // Re-exibe as conquistas para mostrar a nova

                } catch (error) {
                    alert('Ocorreu um erro ao gerenciar o status.');
                    console.error("Erro na atualização de status:", error);
                }
            };
            
            document.getElementById('edit-status-cloud').addEventListener('click', handleStatusUpdate);

            document.getElementById('change-photo-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('photo-upload-input').click();
            });

            // --- LISTENERS PARA STORIES E CHAT ---
            document.getElementById('add-my-story-btn').addEventListener('click', () => {
                document.getElementById('story-upload-input').click();
            });
            document.getElementById('story-upload-input').addEventListener('change', (e) => {
                handleStoryUpload(e.target.files[0]);
            });
            document.getElementById('stories-scroll').addEventListener('click', (e) => {
                const wrapper = e.target.closest('.story-circle-wrapper.has-story');
                if (wrapper) {
                    openStoryViewer(wrapper.dataset.userId);
                }
            });
            document.getElementById('close-story-viewer-btn').addEventListener('click', closeStoryViewer);
            document.getElementById('send-story-reply-btn').addEventListener('click', sendStoryReply);
            document.getElementById('back-to-gs-from-story-creation').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('delete-my-story-btn').addEventListener('click', deleteMyStories);
            document.getElementById('open-chats-btn').addEventListener('click', openChatPage);
            document.getElementById('back-to-collab-from-chat').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-chatlist-from-convo').addEventListener('click', () => {
                database.ref(`chats/${currentOpenChatId}/messages`).off(); // Para de ouvir mensagens antigas
                currentOpenChatId = null;
                showPage('chatPage');
            });
            document.getElementById('chat-list-container').addEventListener('click', (e) => {
                const item = e.target.closest('.chat-list-item');
                if(item) {
                    openConversation(item.dataset.chatPartnerId);
                }
            });
            document.getElementById('send-chat-message-btn').addEventListener('click', sendChatMessage);
            document.getElementById('collaborator-profile-pic').addEventListener('click', () => {
                 document.getElementById('photo-upload-input').click();
            });
            document.getElementById('photo-upload-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadProfilePicture(file);
                }
            });
            
            document.getElementById('add-holiday-btn').addEventListener('click', () => addDateToList('holiday-date-input', 'holidays', 'holiday-status-message', () => loadAndRenderList('holidays', 'holidays-list-container', 'Feriado')));
            document.getElementById('add-sunday-btn').addEventListener('click', () => addDateToList('sunday-date-input', 'workingSundays', 'sunday-status-message', () => loadAndRenderList('workingSundays', 'sundays-list-container', 'Domingo de Trabalho')));

            document.getElementById('holidays-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteDateFromList(deleteButton.dataset.dbNode, deleteButton.dataset.key, () => loadAndRenderList('holidays', 'holidays-list-container', 'Feriado'));
                }
            });

            document.getElementById('sundays-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteDateFromList(deleteButton.dataset.dbNode, deleteButton.dataset.key, () => loadAndRenderList('workingSundays', 'sundays-list-container', 'Domingo de Trabalho'));
                }
            });

            // Listeners para a página de gerenciamento de folgas
            document.getElementById('add-day-off-btn').addEventListener('click', addDayOff);
            document.getElementById('days-off-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteDayOff(deleteButton.dataset.date, deleteButton.dataset.employeeKey);
                }
            });
            
                        // Este bloco foi movido e a função deleteFeedbackItem não é mais necessária,
            // pois foi substituída por um listener genérico mais acima.
            document.getElementById('submit-feedback-btn').addEventListener('click', submitFeedback);

            // Listeners para as novas páginas de submissão na tela GS
            document.getElementById('view-stock-requests-btn').addEventListener('click', () => {
                createGenericSubmissionViewer('stockRequests', 'stockRequestsPage', 'stock-requests-list', 'stock-requests-title', 'Solicitações de Estoque', (item) => {
                    const standardItems = item.items.filter(p => !p.isCustom);
                    const customItems = item.items.filter(p => p.isCustom);
                    let html = `<h4>Solicitante: ${item.requester} (${item.city})</h4>
                                <p><strong>Data:</strong> ${new Date(item.timestamp).toLocaleString('pt-BR')}</p>`;
                    if (standardItems.length > 0) {
                        html += `<h4 style="margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1rem; color: var(--primary-color);">Pedido de Estoque</h4>
                                 <ul style="list-style-position: inside; padding-left: 0.5rem;">
                                     ${standardItems.map(p => `<li>${p.quantity}x ${p.name} (Cor: ${p.color})</li>`).join('')}
                                 </ul>`;
                    }
                    if (customItems.length > 0) {
                        html += `<h4 style="margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1rem; color: var(--primary-color);">Pedido do Cliente</h4>
                                 <ul style="list-style-position: inside; padding-left: 0.5rem;">
                                     ${customItems.map(p => `<li>${p.quantity}x ${p.name} (Cor: ${p.color})</li>`).join('')}
                                 </ul>`;
                    }
                    return html;
                });
            });

            document.getElementById('view-recibos-btn').addEventListener('click', () => {
                createGenericSubmissionViewer('reciboSubmissions', 'recibosSubmissionsPage', 'recibos-submissions-list', 'recibos-submissions-title', 'Recibos Enviados', (item) => {
                    return `<h4>Recibo de: ${item.nome} (${item.loja})</h4>
                            <p><strong>Data do Gasto:</strong> ${item.dataGasto}</p>
                            <p><strong>Descrição:</strong><pre>${item.gastos}</pre></p>`;
                });
            });
            
            document.getElementById('view-quiz-submissions-btn').addEventListener('click', () => {
                createGenericSubmissionViewer('quizSubmissions', 'quizSubmissionsPage', 'quiz-submissions-list', 'quiz-submissions-title', 'Respostas do Quiz', (item) => {
                    return `<h4>Quiz de: ${item.nome}</h4>
                            <p><strong>1. Gostou:</strong> ${item.respostas.gostou}</p>
                            <p><strong>2. Parte útil:</strong> ${item.respostas.parteUtil}</p>
                            <p><strong>3. Parte confusa:</strong> ${item.respostas.parteConfusa}</p>
                            <p><strong>4. Ajudou a preparar:</strong> ${item.respostas.ajudouPreparar}</p>
                            <p><strong>5. Próximo tema:</strong> ${item.respostas.proximoTema}</p>
                            <p><strong>6. Sugestão:</strong> ${item.respostas.sugestao || 'N/A'}</p>`;
                });
            });

            document.getElementById('view-feedback-btn').addEventListener('click', () => {
                createGenericSubmissionViewer('feedback', 'feedbackSubmissionsPage', 'feedback-submissions-list', 'feedback-submissions-title', 'Feedbacks Recebidos', (item) => {
                    return `<h4>Feedback de: ${item.name}</h4>
                            <p><strong>Data:</strong> ${new Date(item.timestamp).toLocaleString('pt-BR')}</p>
                            <p><strong>Mensagem:</strong><br>${item.message}</p>`;
                });
            });

            // Delegação de evento para os botões de deletar em todas as novas listas
            ['stock-requests-list', 'recibos-submissions-list', 'quiz-submissions-list', 'feedback-submissions-list'].forEach(listId => {
                document.getElementById(listId).addEventListener('click', (event) => {
                    const deleteBtn = event.target.closest('.delete-button');
                    if (deleteBtn) {
                        const key = deleteBtn.dataset.key;
                        const path = deleteBtn.dataset.path;
                        if (confirm('Tem certeza que deseja apagar esta submissão?')) {
                            database.ref(`${path}/${key}`).remove().then(() => {
                                // Remove o card da tela para feedback imediato
                                deleteBtn.closest('.employee-meta-card').remove();
                            });
                        }
                    }
                });
            });

            // Listeners para a página de gerenciamento de avisos
            document.getElementById('aviso-upload-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('aviso-photo-upload').click();
            });

            // Adicione este listener junto com os outros da página de avisos
            document.getElementById('aviso-content-upload-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('aviso-content-image-upload').click();
            });

            document.getElementById('save-aviso-btn').addEventListener('click', () => {
                const managerPhotoInput = document.getElementById('aviso-photo-upload');
                const contentImageInput = document.getElementById('aviso-content-image-upload');
                const managerPhotoFile = managerPhotoInput.files[0];
                const contentImageFile = contentImageInput.files[0];

                const managerPhotoStatusEl = document.getElementById('aviso-photo-status');
                const contentPhotoStatusEl = document.getElementById('aviso-content-photo-status');
                const finalStatusEl = document.getElementById('aviso-status-message');
                const saveButton = document.getElementById('save-aviso-btn');

                if (!managerPhotoFile) {
                    managerPhotoStatusEl.textContent = 'Por favor, envie sua foto de perfil para o aviso.';
                    return;
                }

                saveButton.disabled = true;
                saveButton.style.opacity = '0.5';
                finalStatusEl.textContent = 'Processando imagens...';

                const uploadManagerPhoto = () => {
                    managerPhotoStatusEl.textContent = 'Enviando imagem de perfil...';
                    const filePath = `avisos_avatars/${new Date().getTime()}_${managerPhotoFile.name}`;
                    const fileRef = storage.ref().child(filePath);
                    return fileRef.put(managerPhotoFile).then(snapshot => snapshot.ref.getDownloadURL());
                };

                const uploadContentImage = () => {
                    if (!contentImageFile) {
                        return Promise.resolve(null); // Resolve com null se não houver arquivo
                    }
                    contentPhotoStatusEl.textContent = 'Enviando foto/GIF do aviso...';
                    const filePath = `avisos_content/${new Date().getTime()}_${contentImageFile.name}`;
                    const fileRef = storage.ref().child(filePath);
                    return fileRef.put(contentImageFile).then(snapshot => snapshot.ref.getDownloadURL());
                };

                Promise.all([uploadManagerPhoto(), uploadContentImage()])
                    .then(([managerPhotoURL, contentImageURL]) => {
                        finalStatusEl.textContent = 'Imagens enviadas! Salvando aviso...';
                        saveAviso(managerPhotoURL, contentImageURL);
                    })
                    .catch(error => {
                        console.error("Erro no upload de imagens do aviso:", error);
                        finalStatusEl.textContent = 'Erro ao enviar uma das imagens.';
                        saveButton.disabled = false;
                        saveButton.style.opacity = '1';
                    });
            });
            document.getElementById('avisos-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteAviso(deleteButton.dataset.key);
                }
            });

            // Os listeners para os botões do painel GS são atribuídos quando a página é aberta.
            
            // Listener para a página Lollipop
            document.getElementById('back-to-send-device-from-lollipop').addEventListener('click', () => showPage('sendDevicePage'));
            document.getElementById('lollipop-grid').addEventListener('click', (event) => {
                const img = event.target.closest('.lollipop-item-card img');
                const deleteBtn = event.target.closest('.lollipop-delete-btn');

                if (img) {
                    openImageViewer(img.src);
                } else if (deleteBtn) {
                    const key = deleteBtn.dataset.key;
                    deleteLollipopItem(key);
                }
            });

            // Listener para o novo botão de apagar tudo no Lollipop
            document.getElementById('delete-all-lollipop-btn').addEventListener('click', () => {
                if (confirm('TEM CERTEZA? Esta ação apagará TODOS os itens do Lollipop permanentemente.')) {
                    database.ref('lollipopData').remove()
                        .then(() => {
                            alert('Todos os itens do Lollipop foram apagados.');
                            loadLollipopPage(); // Recarrega a página para mostrar que está vazia
                        })
                        .catch(err => {
                            alert('Erro ao apagar os itens.');
                            console.error('Erro ao apagar dados do Lollipop:', err);
                        });
                }
            });

            document.getElementById('back-to-collab-from-ponto').addEventListener('click', () => {
                stopPontoCamera();
                showPage('collaboratorPage');
            });
            document.getElementById('back-to-gs-from-ponto-verify').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-ponto-verify-from-history').addEventListener('click', () => showPage('pontoVerificationPage'));

            // --- LÓGICA DO VISUALIZADOR DE IMAGEM AMPLIADA E NOTIFICAÇÕES DE PONTO ---
            const imageViewer = document.getElementById('image-viewer-overlay');
            const viewerImage = document.getElementById('viewer-image');
            const historyContainer = document.getElementById('ponto-history-container');

            document.getElementById('manager-notifications-list').addEventListener('click', (event) => {
                const dismissButton = event.target.closest('.delete-button-small');
                if (dismissButton) {
                    const key = dismissButton.dataset.key;
                    if (key && confirm('Deseja apagar esta notificação?')) {
                        database.ref(`managerNotifications/${key}`).remove()
                            .catch(err => console.error("Erro ao remover notificação:", err));
                    }
                }
            });

            // Listener para o novo botão de limpar todas as notificações
            document.getElementById('clear-all-notifications-btn').addEventListener('click', () => {
                if (confirm('Tem certeza que deseja apagar TODAS as notificações? Esta ação não pode ser desfeita.')) {
                    database.ref('managerNotifications').remove()
                        .then(() => {
                            // A lista será atualizada automaticamente pelo listener 'on.value'
                        })
                        .catch(err => {
                            alert('Erro ao limpar as notificações.');
                            console.error("Erro ao remover todas as notificações:", err);
                        });
                }
            });

            // Listener para o checkbox de modo de manutenção
            document.getElementById('maintenance-mode-toggle').addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                const statusEl = document.getElementById('maintenance-status-message');
                statusEl.textContent = 'Salvando...';
                database.ref('globalSettings/isMaintenanceMode').set(isChecked)
                    .then(() => {
                        statusEl.textContent = 'Configuração salva!';
                        setTimeout(() => statusEl.textContent = '', 2000);
                    })
                    .catch(err => {
                        statusEl.textContent = 'Erro ao salvar!';
                        console.error(err);
                    });
            });

            const openImageViewer = (imageUrl) => {
                viewerImage.src = imageUrl;
                imageViewer.style.display = 'flex';
                requestAnimationFrame(() => imageViewer.classList.add('visible'));
            };

            const closeImageViewer = () => {
                imageViewer.classList.remove('visible');
                imageViewer.addEventListener('transitionend', () => {
                    if (!imageViewer.classList.contains('visible')) {
                        imageViewer.style.display = 'none';
                        viewerImage.src = ''; // Limpa para não "piscar" na próxima vez
                    }
                }, { once: true });
            };

            // Listener no container de histórico (event delegation)
            historyContainer.addEventListener('click', (event) => {
                const photo = event.target.closest('.ponto-history-photo');
                if (photo) {
                    openImageViewer(photo.src);
                    return; // Para não acionar o listener de delete sem querer
                }

                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    const recordKey = deleteButton.dataset.recordKey;
                    const employeeName = deleteButton.dataset.employeeName;
                    deletePontoRecord(recordKey, employeeName);
                }
            });

            // Listeners para fechar o visualizador
            document.getElementById('close-viewer-btn').addEventListener('click', closeImageViewer);
            imageViewer.addEventListener('click', (event) => {
                // Fecha somente se o clique for no fundo escuro
                if (event.target === imageViewer) {
                    closeImageViewer();
                }
            });

            // --- CÓDIGO NOVO: FUNÇÕES PARA EXIBIR E GERENCIAR SUBMISSÕES ---

            const checkAllSubmissionsForUnread = async () => {
                const submissionTypes = [
                    { path: 'stockRequests', indicator: 'stock-indicator' },
                    { path: 'reciboSubmissions', indicator: 'recibos-indicator' },
                    { path: 'quizSubmissions', indicator: 'quiz-indicator' },
                    { path: 'feedback', indicator: 'feedback-indicator' }
                ];

                const checks = submissionTypes.map(type => 
                    database.ref(type.path).orderByChild('read').equalTo(false).once('value')
                        .then(snapshot => {
                            const indicatorEl = document.getElementById(type.indicator);
                            if (indicatorEl) { // Verifica se o elemento existe antes de manipulá-lo
                                if (snapshot.exists()) {
                                    indicatorEl.style.display = 'inline-flex';
                                } else {
                                    indicatorEl.style.display = 'none';
                                }
                            }
                        })
                );

                await Promise.all(checks);

                // O bloco de código que tentava acessar 'gs-notification-indicator' foi removido,
                // pois o elemento não existe mais no HTML. A função agora termina aqui.
            };
            
            const markItemsAsRead = (dbPath, items) => {
                const updates = {};
                items.forEach(item => {
                    if (!item.read) {
                        updates[`${dbPath}/${item.key}/read`] = true;
                    }
                });
                if (Object.keys(updates).length > 0) {
                    database.ref().update(updates).then(() => {
                        checkAllSubmissionsForUnread(); // Re-checa os indicadores após marcar como lido
                    });
                }
            };
            
            const createGenericSubmissionViewer = (dbPath, pageId, listId, titleId, title, renderFunction) => {
                showPage(pageId);
                document.getElementById(titleId).textContent = title; // CORRIGIDO: Usa o ID do título diretamente
                const listContainer = document.getElementById(listId);
                listContainer.innerHTML = '<p style="text-align: center;">Carregando...</p>';

                database.ref(dbPath).orderByChild('timestamp').once('value', snapshot => {
                    listContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        listContainer.innerHTML = '<p style="text-align: center;">Nenhuma submissão encontrada.</p>';
                        return;
                    }

                    const items = [];
                    snapshot.forEach(child => {
                        items.push({ key: child.key, ...child.val() });
                    });

                    items.reverse().forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'employee-meta-card';
                        card.style.maxWidth = 'none';
                        card.innerHTML = renderFunction(item) + `
                            <button class="action-button delete-button full-width" data-key="${item.key}" data-path="${dbPath}" style="margin-top: 1rem;">
                                <i class="fa-solid fa-trash-can"></i> Deletar
                            </button>
                        `;
                        listContainer.appendChild(card);
                    });
                    
                    markItemsAsRead(dbPath, items);
                });
            };
            
            // --- LISTENERS DA TELA DE BUSCA ---
            document.getElementById('device-search-input').addEventListener('input', (event) => {
                renderDeviceSearchResults(allDevicesCache, event.target.value);
            });

                        // Adiciona o listener para o novo botão de item personalizado
            document.getElementById('add-custom-stock-item-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('custom-item-name');
                const colorInput = document.getElementById('custom-item-color');
                const quantityInput = document.getElementById('custom-item-quantity');

                const name = nameInput.value.trim();
                const color = colorInput.value.trim();
                const quantity = parseInt(quantityInput.value, 10);

                if (!name || !color || isNaN(quantity) || quantity <= 0) {
                    alert('Por favor, preencha Nome, Cor e uma Quantidade válida para o item personalizado.');
                    return;
                }

                stockRequestSelection.push({ name, color, quantity, isCustom: true });
                renderStockSelectionList();

                // Limpa os campos após adicionar
                nameInput.value = '';
                colorInput.value = '';
                quantityInput.value = '';
            });

            // Usando delegação de eventos para os cliques nos cards de resultado
            document.getElementById('device-search-results-grid').addEventListener('click', (event) => {
                const card = event.target.closest('.device-card');
                if (card) {
                    const key = card.dataset.key;
                    const brand = card.dataset.brand;
                    if (key && brand) {
                        loadDeviceDetails(key, brand);
                    }
                }
            });






            // --- INICIALIZAÇÃO DA APLICAÇÃO (REFEITA COM LOGIN) ---
                        const initializeApp = (isLoggedIn = false) => {
                // Se a função for chamada para um usuário já logado, só carrega os dados
                if (isLoggedIn) {
                    loadCollaboratorProfilePicture(); // Carrega a foto de perfil imediatamente
                loadAndDisplayCollaboratorStatus(); // Carrega o status para a tela principal
                calculateAndDisplayRanking();
                calculateAndDisplayServiceRanking();
                calculateAndDisplayStoreRanking();
                loadManagerNotifications();
                    loadAndDisplayOvertime();
                    loadAndDisplayAvisos();
                    loadAndDisplayStories();
                    checkForUnreadMessages(); // Adicionada a checagem de mensagens
                    
                    // Mostra ou esconde botão de acesso restrito (Enviar Dispositivo)
                    const sendDeviceBtn = document.getElementById('open-send-device-page');
                    const isManager = managers.includes(currentUserName);

                    // A referência ao botão 'gsBtn' foi removida pois ele não existe mais na tela principal.
                    if (isManager) {
                        sendDeviceBtn.style.display = 'flex';
                    } else {
                        sendDeviceBtn.style.display = 'none';
                    }

                    // Aplica as configurações de visibilidade na tela principal
                    applyVisibilitySettings();
                    return;
                }
                
                // Lógica que roda apenas na primeira vez que a página carrega
                document.getElementById('app-version-display').textContent = `Versão ${APP_VERSION}`;
                database.ref('statistics/appOpens').transaction(count => (count || 0) + 1);
                 setInterval(() => {
                    if (!document.hidden) {
                        database.ref('statistics/totalTimeSeconds').transaction(seconds => (seconds || 0) + 15);
                        checkAllSubmissionsForUnread();
                    }
                }, 15000);

                const loggedInUser = localStorage.getItem('loggedInUser');
                const appMode = localStorage.getItem(APP_MODE_KEY);
                
                if (appMode !== 'employee') {
                    document.getElementById('activation-overlay').style.display = 'flex';
                    document.getElementById('activation-overlay').classList.add('visible');
                } else if (loggedInUser) {
                    currentUserName = loggedInUser;
                    showMainPage();
                    initializeApp(true); // Chama a si mesma para carregar os dados
                } else {
                    // Se não está ativado e não tem login, mostra a tela de login
                    const loginOverlay = document.getElementById('login-overlay');
                    populateLoginUserSelect();
                    loginOverlay.style.display = 'flex';
                    loginOverlay.classList.add('visible');
                }
            };

                        // Roda a função de inicialização principal
            initializeApp();

    const clearPontoStatusForUser = () => {
        if (!checkPassword()) return;

        // Cria uma lista de nomes de usuários para seleção
        const userList = allUsers.map((name, index) => `${index + 1}. ${name}`).join('\n');
        const selectedUserIndex = prompt(`Selecione o usuário para limpar o status de ponto do dia:\n\n${userList}`);

        if (selectedUserIndex === null || selectedUserIndex.trim() === "") {
            return; // Usuário cancelou
        }

        const userIndex = parseInt(selectedUserIndex, 10) - 1;
        if (isNaN(userIndex) || userIndex < 0 || userIndex >= allUsers.length) {
            alert('Seleção inválida.');
            return;
        }

        const userNameToClear = allUsers[userIndex];
        const todayString = getTodayDateString();
        
        if (confirm(`Tem certeza que deseja apagar TODOS os registros de ponto de HOJE para ${userNameToClear}? Esta ação não pode ser desfeita.`)) {
            const pontoDiaRef = database.ref(`pontosDoDia/${todayString}/${userNameToClear}`);
            pontoDiaRef.remove()
                .then(() => {
                    alert(`Status de ponto do dia para ${userNameToClear} foi limpo com sucesso.`);
                })
                .catch(error => {
                    alert(`Ocorreu um erro ao limpar o status de ponto.`);
                    console.error("Erro ao limpar ponto do dia:", error);
                });
        }
    };

        // --- LÓGICA DO EASTER EGG DA VERSÃO ---
        let versionClickCount = 0;
            let versionClickTimer = null;
            document.getElementById('app-version-display').addEventListener('click', () => {
                clearTimeout(versionClickTimer);
                versionClickCount++;
                if (versionClickCount === 10) {
                    window.location.href = 'https://www.instagram.com/reel/DMUAByJMrvx/?igsh=bzRudHpzMWM1cnVr';
                    versionClickCount = 0;
                } else {
                    versionClickTimer = setTimeout(() => {
                        versionClickCount = 0;
                    }, 2000);
                }
            });

            // --- LISTENERS PARA ENVIO DE MÍDIA E AÇÕES DE CHAT ---
            document.getElementById('send-media-btn').addEventListener('click', () => {
                document.getElementById('media-upload-input').click();
            });

            document.getElementById('media-upload-input').addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleMediaUpload(e.target.files[0]);
                }
                e.target.value = null; // Permite selecionar o mesmo arquivo de novo
            });
            
            let pressTimer;
            const chatMessagesContainer = document.getElementById('chat-messages-container');
            const chatActionModal = document.getElementById('chat-action-modal');

            chatMessagesContainer.addEventListener('mousedown', (e) => {
                const bubble = e.target.closest('.chat-message-bubble');
                if (bubble && bubble.dataset.senderId === currentUserName.toLowerCase()) {
                    pressTimer = setTimeout(() => {
                        // Armazena a chave da mensagem na própria modal para os botões usarem
                        chatActionModal.dataset.messageKey = bubble.dataset.messageKey;
                        // Mostra a modal
                        chatActionModal.style.display = 'flex';
                        chatActionModal.classList.add('visible');
                    }, 700); // 700ms para long press
                }
            });
            // Limpa o timer se o mouse for solto ou sair da bolha
            chatMessagesContainer.addEventListener('mouseup', () => clearTimeout(pressTimer));
            chatMessagesContainer.addEventListener('mouseleave', () => clearTimeout(pressTimer));

            // Fechar a modal de ação
            chatActionModal.addEventListener('click', (e) => {
                if (e.target === chatActionModal) {
                    chatActionModal.style.display = 'none';
                    chatActionModal.classList.remove('visible');
                }
            });
            
            // Ações dos botões da modal
            document.getElementById('chat-edit-btn').addEventListener('click', () => {
                const key = chatActionModal.dataset.messageKey;
                if (key) editChatMessage(key);
                chatActionModal.style.display = 'none';
                chatActionModal.classList.remove('visible');
            });
            document.getElementById('chat-delete-btn').addEventListener('click', () => {
                const key = chatActionModal.dataset.messageKey;
                if (key) deleteChatMessage(key);
                chatActionModal.style.display = 'none';
                chatActionModal.classList.remove('visible');
            });


            // --- LISTENER PARA O BOTÃO DE INFORMAÇÃO DO BÔNUS (?) ---
            ['ranking-container', 'store-ranking-container'].forEach(id => {
                document.getElementById(id).addEventListener('click', (event) => {
                    const infoBtn = event.target.closest('.bonus-info-btn');
                    if (infoBtn) {
                        alert('Este é um bônus diário cumulativo de R$ 3,00 por cada dia consecutivo no topo do ranking, até um máximo de R$ 50,00. Se você perder sua posição de primeiro lugar, o valor acumulado é zerado e a contagem recomeça para o novo competidor.');
                    }
                });
            });

            // --- LISTENERS PARA NAVEGAÇÃO DE STORIES ---
            document.getElementById('story-nav-next').addEventListener('click', nextStory);
            document.getElementById('story-nav-prev').addEventListener('click', previousStory);

            // --- LISTENER PARA OS TOGGLES DE VISIBILIDADE ---
            document.getElementById('visibility-settings-section').addEventListener('change', (event) => {
                const toggle = event.target.closest('.visibility-toggle');
                if (toggle) {
                    const key = toggle.dataset.key;
                    const isVisible = toggle.checked;
                    saveVisibilitySetting(key, isVisible);
                }
            });


            // --- LÓGICA PARA EXIBIR TOOLTIP DA CONQUISTA NO CLIQUE ---
            document.addEventListener('click', (e) => {
                const badge = e.target.closest('.achievement-badge');
                
                // Se o clique foi DENTRO de um selo de conquista
                if (badge) {
                    const targetTooltip = badge.querySelector('.tooltip');
                    const isVisible = targetTooltip.classList.contains('visible');
                    
                    // Primeiro, esconde TODOS os tooltips que estiverem abertos
                    document.querySelectorAll('.achievement-badge .tooltip.visible').forEach(tt => {
                        tt.classList.remove('visible');
                    });
                    
                    // Se o tooltip clicado não estava visível, torna-o visível
                    if (!isVisible) {
                        targetTooltip.classList.add('visible');
                    }
                } else {
                    // Se o clique foi FORA de qualquer selo, simplesmente esconde todos
                    document.querySelectorAll('.achievement-badge .tooltip.visible').forEach(tt => {
                        tt.classList.remove('visible');
                    });
                }
            });

            // --- LÓGICA DO CARROSSEL DE DESTAQUES ---
            let promoCarouselInterval = null;
            let currentPromoIndex = 0;
            const promoSlides = document.querySelectorAll('.promo-slide');

            function showPromoSlide(index) {
                promoSlides.forEach((slide, slideIndex) => {
                    if (slideIndex === index) {
                        slide.style.opacity = '1';
                        slide.style.pointerEvents = 'auto'; // Torna o slide ativo clicável
                    } else {
                        slide.style.opacity = '0';
                        slide.style.pointerEvents = 'none'; // Impede cliques em slides inativos
                    }
                });
                currentPromoIndex = index;
            }

            function nextPromoSlide() {
                let newIndex = currentPromoIndex + 1;
                if (newIndex >= promoSlides.length) {
                    newIndex = 0;
                }
                showPromoSlide(newIndex);
            }

            function setupPromoCarousel() {
                if (promoSlides.length === 0) return;

                // Adiciona listener de clique para cada slide
                promoSlides.forEach(slide => {
                    slide.addEventListener('click', () => {
                        const targetId = slide.dataset.target;
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            // Simula um clique no elemento alvo
                            targetElement.click();
                        }
                    });
                });

                // Inicia o carrossel
                showPromoSlide(0);
                clearInterval(promoCarouselInterval); // Limpa qualquer intervalo antigo
                promoCarouselInterval = setInterval(nextPromoSlide, 6000); // Duração de 6 segundos
            }

            setupPromoCarousel();
        });
    </script>

</body>
</html>
