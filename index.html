<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOJA DO HUNTER - Celulares e Acessórios</title>
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome - Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    
    <!-- Chart.js - Biblioteca de Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- MODO RÁPIDO (SEM ANIMAÇÕES) --- */
        .fast-mode .modal-content,
        .fast-mode .brand-button, 
        .fast-mode .tool-item, 
        .fast-mode .device-card, 
        .fast-mode .modal-btn, 
        .fast-mode .action-button, 
        .fast-mode .employee-meta-card {
            animation: none !important;
            opacity: 1 !important; /* Garante que os itens fiquem visíveis imediatamente */
        }
        
        /* Remove apenas transições de elementos específicos para não quebrar a lógica de página */
        .fast-mode .brand-button:hover,
        .fast-mode .tool-item:hover,
        .fast-mode .modal-btn:hover,
        .fast-mode .action-button:hover,
        .fast-mode #collaborator-profile-pic:hover,
        .fast-mode .ponto-history-photo:hover,
        .fast-mode .data-input {
            transition: none !important;
        }


        /* CSS Reset e Variáveis de Cor */
        :root {
            --primary-color: #FF6B00; /* Laranja vibrante */
            --secondary-color: #333; /* Cinza escuro para textos */
            --background-color: #f4f4f4; /* Cinza claro para o fundo */
            --card-bg-color: #FFFFFF; /* Branco para os cards */
            --text-light: #666;
            --white: #FFFFFF;
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1); /* Curva para animação com "overshoot" */
        }

        /* ================================================= */
        /* == ESTILOS DOS TEMAS                           == */
        /* ================================================= */

        /* --- TEMA PADRÃO (Nenhuma alteração, já é o base) --- */

        /* --- TEMA HUNTER (LARANJA) --- */
        body.theme-hunter {
            background: linear-gradient(160deg, #612f00 0%, #a15000 30%, #e67e22 100%);
        }
        .theme-hunter header {
            background-color: rgba(161, 80, 0, 0.5);
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        .theme-hunter .modal-content {
            background: rgba(161, 80, 0, 0.8);
        }
        .theme-hunter #collaborator-page, .theme-hunter #gs-page, .theme-hunter #metas-config-page, .theme-hunter #metas-display-page, .theme-hunter #send-device-page, .theme-hunter #brand-devices-page, .theme-hunter #device-detail-page, .theme-hunter #manager-sales-panel-page, .theme-hunter #closing-page, .theme-hunter #correction-page, .theme-hunter #os-form-page, .theme-hunter #request-stock-page, .theme-hunter #recibos-page, .theme-hunter #quiz-page, .theme-hunter #crediario-calculator-page, .theme-hunter #site-calculator-page, .theme-hunter #loja-calculator-page, .theme-hunter #mt-display-page, .theme-hunter #mt-management-page, .theme-hunter #ponto-verification-page, .theme-hunter #holidays-management-page, .theme-hunter #sundays-management-page, .theme-hunter #ponto-history-page, .theme-hunter #day-off-management-page, .theme-hunter #overtime-management-page, .theme-hunter #security-city-selection-page, .theme-hunter #security-profile-page, .theme-hunter #device-search-overlay, .theme-hunter #avisos-management-page {
            background: linear-gradient(160deg, #612f00 0%, #a15000 30%, #e67e22 100%);
        }

        /* --- TEMA ROSA --- */
        body.theme-rosa {
            background: linear-gradient(160deg, #6d1a4f 0%, #c83a7d 30%, #ff69b4 100%);
            --primary-color: #ff1493; /* Deep Pink */
        }
        .theme-rosa header {
            background-color: rgba(200, 58, 125, 0.5);
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        .theme-rosa .modal-content {
            background: rgba(109, 26, 79, 0.8);
        }
        .theme-rosa .logo i { color: #ff1493; }
        .theme-rosa .tool-icon-wrapper { background-color: #ff1493; }
        .theme-rosa #collaborator-profile-pic, .theme-rosa #security-profile-pic { border-color: #ff1493; }
        .theme-rosa .gs-action-btn i { color: #ff1493; }
        .theme-rosa .mt-item-card { border-left-color: #ff1493; }
        .theme-rosa .ponto-history-details p strong { color: #ff1493; }
        .theme-rosa .kpi-value { color: #ff1493; }
        .theme-rosa .stock-brand-header { color: #ff1493; }
        .theme-rosa .progress-bar { background: #ff1493; }
        .theme-rosa .data-input:focus { border-color: #ff1493; }
        .theme-rosa #collaborator-page, .theme-rosa #gs-page, .theme-rosa #metas-config-page, .theme-rosa #metas-display-page, .theme-rosa #send-device-page, .theme-rosa #brand-devices-page, .theme-rosa #device-detail-page, .theme-rosa #manager-sales-panel-page, .theme-rosa #closing-page, .theme-rosa #correction-page, .theme-rosa #os-form-page, .theme-rosa #request-stock-page, .theme-rosa #recibos-page, .theme-rosa #quiz-page, .theme-rosa #crediario-calculator-page, .theme-rosa #site-calculator-page, .theme-rosa #loja-calculator-page, .theme-rosa #mt-display-page, .theme-rosa #mt-management-page, .theme-rosa #ponto-verification-page, .theme-rosa #holidays-management-page, .theme-rosa #sundays-management-page, .theme-rosa #ponto-history-page, .theme-rosa #day-off-management-page, .theme-rosa #overtime-management-page, .theme-rosa #security-city-selection-page, .theme-rosa #security-profile-page, .theme-rosa #device-search-overlay, .theme-rosa #avisos-management-page {
            background: linear-gradient(160deg, #6d1a4f 0%, #c83a7d 30%, #ff69b4 100%);
        }

        /* --- TEMA BLACK --- */
        body.theme-black {
            background: #000;
            --primary-color: #00BFFF; /* DeepSkyBlue como contraste */
        }
        .theme-black header {
            background-color: rgba(10, 10, 10, 0.7);
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }
        .theme-black .brand-button, .theme-black .tool-item, .theme-black .modal-btn, .theme-black .action-button {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .theme-black .modal-content {
            background: rgba(15, 15, 15, 0.85);
        }
        .theme-black .logo i { color: #00BFFF; }
        .theme-black .tool-icon-wrapper { background-color: #00BFFF; }
        .theme-black #collaborator-profile-pic, .theme-black #security-profile-pic { border-color: #00BFFF; }
        .theme-black .gs-action-btn i { color: #00BFFF; }
        .theme-black .mt-item-card { border-left-color: #00BFFF; }
        .theme-black .ponto-history-details p strong { color: #00BFFF; }
        .theme-black .kpi-value { color: #00BFFF; }
        .theme-black .stock-brand-header { color: #00BFFF; }
        .theme-black .progress-bar { background: #00BFFF; }
        .theme-black .data-input:focus { border-color: #00BFFF; }
        .theme-black #collaborator-page, .theme-black #gs-page, .theme-black #metas-config-page, .theme-black #metas-display-page, .theme-black #send-device-page, .theme-black #brand-devices-page, .theme-black #device-detail-page, .theme-black #manager-sales-panel-page, .theme-black #closing-page, .theme-black #correction-page, .theme-black #os-form-page, .theme-black #request-stock-page, .theme-black #recibos-page, .theme-black #quiz-page, .theme-black #crediario-calculator-page, .theme-black #site-calculator-page, .theme-black #loja-calculator-page, .theme-black #mt-display-page, .theme-black #mt-management-page, .theme-black #ponto-verification-page, .theme-black #holidays-management-page, .theme-black #sundays-management-page, .theme-black #ponto-history-page, .theme-black #day-off-management-page, .theme-black #overtime-management-page, .theme-black #security-city-selection-page, .theme-black #security-profile-page, .theme-black #device-search-overlay, .theme-black #avisos-management-page {
            background: #000;
        }

        /* --- TEMA CLARO --- */
        body.theme-claro {
            background: #eef2f3;
            color: var(--secondary-color);
        }
        .theme-claro #collaborator-page, .theme-claro #gs-page, .theme-claro #metas-config-page, .theme-claro #metas-display-page, .theme-claro #send-device-page, .theme-claro #brand-devices-page, .theme-claro #device-detail-page, .theme-claro #manager-sales-panel-page, .theme-claro #closing-page, .theme-claro #correction-page, .theme-claro #os-form-page, .theme-claro #request-stock-page, .theme-claro #recibos-page, .theme-claro #quiz-page, .theme-claro #crediario-calculator-page, .theme-claro #site-calculator-page, .theme-claro #loja-calculator-page, .theme-claro #mt-display-page, .theme-claro #mt-management-page, .theme-claro #ponto-verification-page, .theme-claro #holidays-management-page, .theme-claro #sundays-management-page, .theme-claro #ponto-history-page, .theme-claro #day-off-management-page, .theme-claro #overtime-management-page, .theme-claro #security-city-selection-page, .theme-claro #security-profile-page, .theme-claro #device-search-overlay, .theme-claro #avisos-management-page {
            background: #eef2f3;
            color: var(--secondary-color);
        }
        .theme-claro header {
            background-color: rgba(255, 255, 255, 0.7);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        .theme-claro .logo, .theme-claro .header-icons a {
            color: var(--secondary-color);
        }
        .theme-claro .section-title, .theme-claro .rank-name, .theme-claro .collaborator-header h2, .theme-claro .back-button {
            color: #111;
        }
        .theme-claro .section-title::after {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .theme-claro .brand-button, .theme-claro .tool-item, .theme-claro .modal-btn, .theme-claro .action-button, .theme-claro .gs-action-btn {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: var(--secondary-color);
        }
        .theme-claro .tool-item:hover, .theme-claro .brand-button:hover, .theme-claro .modal-btn:hover, .theme-claro .action-button:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .theme-claro .rank-item, .theme-claro .sales-data-card, .theme-claro .kpi-card, .theme-claro .performance-card, .theme-claro .chart-container, .theme-claro .employee-meta-card, .theme-claro .ponto-history-card {
            background: rgba(255, 255, 255, 0.8);
        }
        .theme-claro .progress-percentage, .theme-claro .ponto-history-details p, .theme-claro .mt-item-card pre, .theme-claro .mt-list-item-text {
            color: #333;
            text-shadow: none;
        }
        .theme-claro .modal-content {
            background: rgba(240, 240, 240, 0.9);
            color: var(--secondary-color);
        }
        .theme-claro .modal-close-btn, .theme-claro .modal-title {
            color: var(--secondary-color);
        }
        .theme-claro .data-input {
            background-color: rgba(0,0,0,0.08);
            border-color: rgba(0,0,0,0.2);
            color: var(--secondary-color);
        }
        .theme-claro .input-group label, .theme-claro .kpi-title, .theme-claro .chart-container h4, .theme-claro .meta-group-title, .theme-claro .ponto-history-justification {
            color: #555;
        }
        .theme-claro #metas-display-content p {
            background: rgba(0,0,0,0.05);
        }
        .theme-claro #monthly-sales-list-container p {
            border-bottom-color: rgba(0,0,0,0.1);
        }
        .theme-claro .fast-mode-toggle i {
            color: var(--secondary-color);
        }
        .theme-claro .fast-mode .fast-mode-toggle i {
            color: var(--primary-color);
        }

        /* --- TEMA LGBT --- */
                body.theme-lgbt {
            background-color: #1a1a1a; /* Cinza bem escuro */
            background-image: url('https://i.redd.it/15vfoi1r0v741.jpg');
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }

        .theme-lgbt header {
            background-color: rgba(0, 0, 0, 0.4);
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }

        .theme-lgbt .modal-content {
            background: rgba(10, 10, 10, 0.5);
        }

        .theme-lgbt #collaborator-page, .theme-lgbt #gs-page, .theme-lgbt #metas-config-page, .theme-lgbt #metas-display-page, .theme-lgbt #send-device-page, .theme-lgbt #brand-devices-page, .theme-lgbt #device-detail-page, .theme-lgbt #manager-sales-panel-page, .theme-lgbt #closing-page, .theme-lgbt #correction-page, .theme-lgbt #os-form-page, .theme-lgbt #request-stock-page, .theme-lgbt #recibos-page, .theme-lgbt #quiz-page, .theme-lgbt #crediario-calculator-page, .theme-lgbt #site-calculator-page, .theme-lgbt #loja-calculator-page, .theme-lgbt #mt-display-page, .theme-lgbt #mt-management-page, .theme-lgbt #ponto-verification-page, .theme-lgbt #holidays-management-page, .theme-lgbt #sundays-management-page, .theme-lgbt #ponto-history-page, .theme-lgbt #day-off-management-page, .theme-lgbt #overtime-management-page, .theme-lgbt #security-city-selection-page, .theme-lgbt #security-profile-page, .theme-lgbt #device-search-overlay, .theme-lgbt #avisos-management-page {
            background: transparent;
        }

        /* --- TEMA CINZA X --- */
        @keyframes floatUp {
            from { transform: translateY(0) rotate(var(--start-rot)); }
            to { transform: translateY(-120vh) rotate(var(--end-rot)); }
        }

        body.theme-grayx {
            background: linear-gradient(160deg, #111 0%, #4a4a4a 60%, #f0f0f0 100%);
        }

        #floating-x-container, #floating-dots-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 0; /* Abaixo do conteúdo principal, mas acima do fundo do body */
            pointer-events: none;
        }
        .floating-x {
            position: absolute;
            top: 110vh; /* Começa fora da tela, embaixo */
            color: rgba(255, 255, 255, 0.06);
            font-weight: 900;
            animation: floatUp linear infinite;
            will-change: transform; /* Otimização para animação */
        }
        
        /* Nova animação apenas para flutuação vertical */
        @keyframes dotFloatUp {
            from { transform: translateY(0); }
            to { transform: translateY(-120vh); }
        }

        /* Novas partículas para o Tema Rosa */
        .floating-dot {
            position: absolute;
            top: 110vh;
            background-color: rgba(255, 255, 255, 0.7); /* CORRIGIDO: Mais visível */
            border-radius: 50%;
            animation: dotFloatUp linear infinite; /* CORRIGIDO: Usando a animação correta */
            will-change: transform;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5); /* Adiciona um brilho suave */
        }

        .theme-grayx header, .theme-grayx main, .theme-rosa header, .theme-rosa main {
            position: relative; /* Garante que fiquem sobre a animação */
            z-index: 1;
        }
        .theme-grayx #collaborator-page, .theme-grayx #gs-page, .theme-grayx #metas-config-page, .theme-grayx #metas-display-page, .theme-grayx #send-device-page, .theme-grayx #brand-devices-page, .theme-grayx #device-detail-page, .theme-grayx #manager-sales-panel-page, .theme-grayx #closing-page, .theme-grayx #correction-page, .theme-grayx #os-form-page, .theme-grayx #request-stock-page, .theme-grayx #recibos-page, .theme-grayx #quiz-page, .theme-grayx #crediario-calculator-page, .theme-grayx #site-calculator-page, .theme-grayx #loja-calculator-page, .theme-grayx #mt-display-page, .theme-grayx #mt-management-page, .theme-grayx #ponto-verification-page, .theme-grayx #holidays-management-page, .theme-grayx #sundays-management-page, .theme-grayx #ponto-history-page, .theme-grayx #day-off-management-page, .theme-grayx #overtime-management-page, .theme-grayx #security-city-selection-page, .theme-grayx #security-profile-page, .theme-grayx #device-search-overlay, .theme-grayx #avisos-management-page {
            background: transparent;
        }
        .theme-grayx header {
            background-color: rgba(10, 10, 10, 0.5);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        

        /* --- ANIMAÇÕES E CONTROLE DE VISIBILIDADE --- */
        @keyframes pageEnter {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pageExit {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.98);
            }
        }

        @keyframes modalContentEnter {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes staggerItem {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page, .modal-overlay {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        .page.visible, .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
            animation: pageEnter 0.4s ease-out forwards;
        }
        
        .page.is-exiting, .modal-overlay.is-exiting {
            pointer-events: none;
            animation: pageExit 0.4s ease-in forwards;
        }

        /* Animações específicas para o modal */
        .modal-overlay.visible:not(.is-exiting) {
            animation: none; /* O overlay em si só faz fade */
            transition: background-color 0.4s, backdrop-filter 0.4s;
        }
        .modal-overlay.visible .modal-content {
            animation: modalContentEnter 0.4s var(--ease-out-back) forwards;
        }

        
        /* Preparação para animações de lista escalonada (stagger) */
        .brand-button, .tool-item, .device-card, .modal-btn, .action-button, .employee-meta-card {
            opacity: 0; /* Começam invisíveis */
        }
        .visible .brand-button, .visible .tool-item, .visible .device-card, .visible .modal-btn, .visible .action-button, .visible .employee-meta-card {
            animation: staggerItem 0.5s var(--ease-out-back) forwards;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(160deg, #372b62 0%, #453880 30%, #2980b9 100%);
            color: var(--white);
            min-height: 100vh;
            overflow-x: hidden; /* Impede a rolagem horizontal */
        }

        /* --- Estrutura Principal (Simula o Celular no PC) --- */
        .mobile-container {
            max-width: 450px;
            width: 100%; 
            margin: 0 auto;
            background-color: transparent;
            display: flex; /* Adicionado */
            flex-direction: column; /* Adicionado */
            align-items: center; /* Adicionado */
        }

        /* Garante que o main e o header ocupem a largura correta */
        .mobile-container > header,
        .mobile-container > main {
            width: 100%;
        }
        
        /* --- Cabeçalho --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1rem 1rem 1rem; /* Diminui o padding lateral */
            background-color: transparent; /* Cabeçalho transparente */
            border-bottom: none;
            position: sticky;
            top: 0;
            z-index: 1000;
            /* Efeito de vidro para o cabeçalho ao rolar a página */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: rgba(55, 43, 98, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white); /* Logo branco */
        }

        .logo i {
            margin-right: 8px;
            color: var(--primary-color); /* Ícone da logo laranja */
        }

        .header-icons a {
            display: inline-block; /* Garante que o padding seja aplicado corretamente */
            padding: 0.5rem; /* Aumenta a área de clique/toque ao redor do ícone */
            font-size: 1.2rem;
            color: var(--white); /* Ícones do cabeçalho brancos */
            margin-left: 0.5rem; /* Margem ajustada para compensar o novo padding */
            text-decoration: none;
        }
        
        /* --- Seções --- */
        section {
            padding: 2rem 1rem; /* Diminui o padding lateral para dar mais espaço */
        }
        
        .section-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--white);
            text-transform: uppercase;
            margin-bottom: 2rem;
            position: relative;
            padding-bottom: 0.75rem;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 2px;
        }

        .search-icon-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        /* --- Grade de Marcas (Aparelhos) --- */
        .brand-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 quadrados por linha */
            gap: 0.75rem; /* Espaçamento entre os quadrados */
        }

        .brand-button {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Garante que o item seja sempre um quadrado */
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
            /* Efeito de Vidro Otimizado (sem backdrop-filter) */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            transition: background 0.3s ease;
        }

        .brand-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* --- Grade de Ferramentas --- */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .tool-item {
            display: flex;
            align-items: center;
            /* Efeito de Vidro Otimizado (sem backdrop-filter) */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 0.75rem;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .tool-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tool-icon-wrapper {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            background-color: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            /* Sombra otimizada */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tool-item i {
            font-size: 1.6rem;
            color: var(--white);
        }

        .tool-item span {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--white);
            line-height: 1.3;
        }
        
        /* --- Estilos da Seção de Ranking --- */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Espaçamento entre os itens reduzido */
        }

        .rank-item {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* Padding reduzido */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px; /* Bordas um pouco menores */
            border-left: 4px solid transparent; /* Borda lateral mais fina */
            gap: 0.75rem; /* Espaçamento entre medalha e detalhes reduzido */
        }

        .rank-item.rank-1 { border-left-color: #FFD700; /* Ouro */ }
        .rank-item.rank-2 { border-left-color: #C0C0C0; /* Prata */ }
        .rank-item.rank-3 { border-left-color: #CD7F32; /* Bronze */ }

        .rank-medal {
            font-size: 1.5rem; /* Medalha menor */
            width: 30px; /* Largura da medalha reduzida */
            text-align: center;
            flex-shrink: 0;
        }

        .rank-photo-container {
            position: relative;
            flex-shrink: 0;
            width: 40px; /* Garante que o container não ocupe mais espaço que a foto */
            height: 40px;
        }

        .rank-crown {
            position: absolute;
            top: -10px; /* Posição acima da foto */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            color: #FFD700; /* Cor de ouro */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .rank-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .rank-1 .rank-medal { color: #FFD700; }
        .rank-2 .rank-medal { color: #C0C0C0; }
        .rank-3 .rank-medal { color: #CD7F32; }

        .rank-details {
            flex-grow: 1;
        }

        .rank-name {
            font-weight: 700;
            font-size: 1rem; /* Fonte do nome reduzida */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank-prize {
            font-size: 0.8rem; /* Fonte do prêmio reduzida */
            font-weight: 600;
            color: #4CAF50; /* Verde para o prêmio */
        }

        .progress-bar-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            height: 14px; /* Altura da barra reduzida */
            margin-top: 0.4rem;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Inicia com 0, o JS vai definir a largura */
            background: var(--primary-color);
            border-radius: 6px;
            transition: width 0.8s var(--ease-out-back);
        }

        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem; /* Fonte da porcentagem reduzida */
            font-weight: 700;
            color: var(--white);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        /* Estilo específico para o ranking de lojas */
        .store-rank-item {
            padding: 0.6rem 0.75rem; /* Deixa o card da loja mais baixo */
        }
        .store-rank-item .rank-name {
            font-size: 1.1rem; /* Nome da loja menor */
            justify-content: center; /* Centraliza o nome da loja */
        }
        
        /* Estilos para o Card de Aviso na tela principal */
        .aviso-card {
            display: flex;
            gap: 1rem;
            align-items: flex-start; /* Alinha no topo */
            background: rgba(0, 0, 0, 0.25);
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid #3498db; /* Azul para destaque */
        }
        .aviso-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .aviso-content .aviso-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        .aviso-content .aviso-text {
            font-size: 0.9rem;
            color: #f0f0f0;
            white-space: pre-wrap; /* Mantém quebras de linha */
            word-wrap: break-word;
        }


                /* --- Estilos da Janela Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; /* Inicia escondido */
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: rgba(55, 43, 98, 0.8); /* Fundo da modal um pouco mais escuro */
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            line-height: 1;
            cursor: pointer;
        }

        .modal-title {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--white);
        }

        .modal-button-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .modal-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* --- Rodapé (REMOVIDO) --- */

        /* =================================================================== */
        /* OBSERVAÇÃO IMPORTANTE: PROBLEMA DE ROLAGEM EM NOVAS PÁGINAS */
        /* Se uma nova tela (como uma nova calculadora) apresentar uma rolagem */
        /* desnecessária ou um layout quebrado, o problema provavelmente é que */
        /* o seu ID não foi adicionado a esta lista abaixo. Esta regra define */
        /* o comportamento base de todas as páginas sobrepostas. */
        /* =================================================================== */
        /* --- Tela do Colaborador (e outras páginas internas) --- */
        #collaborator-page, #metas-config-page, #gs-page, #metas-display-page, #send-device-page, #brand-devices-page, #device-detail-page, #manager-sales-panel-page, #closing-page, #correction-page, #os-form-page, #request-stock-page, #recibos-page, #quiz-page, #crediario-calculator-page, #site-calculator-page, #loja-calculator-page, #mt-display-page, #mt-management-page, #ponto-verification-page, #holidays-management-page, #sundays-management-page, #ponto-history-page, #day-off-management-page, #overtime-management-page, #security-city-selection-page, #security-profile-page, #device-search-overlay, #avisos-management-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(160deg, #372b62 0%, #453880 30%, #2980b9 100%);
            z-index: 3000;
            display: none; /* Inicia escondida */
            flex-direction: column;
            justify-content: flex-start; /* Garante que o conteúdo comece no topo */
            overflow-y: auto; /* Permite que a PÁGINA INTEIRA role */
        }

                /* ================================================= */
        /* == ESTILOS PARA A SEÇÃO MT (MOSTRUÁRIO)        == */
        /* ================================================= */
        .mt-item-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
        }
        .mt-item-card pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            color: var(--white);
        }
        .mt-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.25);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        .mt-list-item-text {
            flex-grow: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        .mt-list-item .delete-button-small {
            flex-shrink: 0;
            margin-left: 1rem;
            background-color: rgba(231, 76, 60, 0.7);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .mt-list-item .delete-button-small:hover {
             background-color: rgba(192, 57, 43, 1.0);
        }

        .collaborator-header {
            display: flex; /* Ativa o Flexbox */
            align-items: center; /* Alinha verticalmente os itens no centro */
            justify-content: center; /* Centraliza o título horizontalmente */
            padding: 1.5rem 1rem; /* Aumenta o padding vertical para dar mais espaço */
            text-align: center;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 60px; /* Garante uma altura mínima */
        }

        #security-city-selection-page .collaborator-header {
            justify-content: space-between;
        }
        #security-city-selection-page .collaborator-header h2 {
            padding: 0;
            flex-grow: 0;
        }

                /* ================================================= */
        /* == ESTILOS PARA A CALCULADORA DE LOJA          == */
        /* ================================================= */
        #loja-calculator-page {
             background: #2c2640; /* Fundo roxo escuro */
        }
        #loja-calculator-page .collaborator-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            width: 100%;
        }
        #loja-form-container {
            width: 100%;
            max-width: 350px;
            padding: 1.5rem;
            background: rgba(25, 20, 35, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(142, 68, 173, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #loja-calculator-page .data-input {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(142, 68, 173, 0.4);
            color: #E0E0E0;
        }
        #loja-calculator-page .data-input:focus {
            border-color: #8e44ad; /* Roxo */
        }
        #loja-calculator-page .slider-group label {
            color: #8e44ad;
            font-weight: 700;
        }
        #loja-calculator-page .slider-input {
            -webkit-appearance: none;
            width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 5px; outline: none; margin-top: 0.5rem;
        }
        #loja-calculator-page .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #8e44ad; cursor: pointer; border-radius: 50%; border: 3px solid #2c2640;
        }
        #loja-result-container {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; border-top: 2px solid #8e44ad;
        }
        #loja-result-container h4 {
            text-align: center; margin-bottom: 1rem; color: #FFFFFF;
        }
        #loja-calculator-page .action-button {
            background-color: rgba(142, 68, 173, 0.7);
        }
        #loja-calculator-page .action-button:hover {
            background-color: rgba(142, 68, 173, 1);
        }
        
        #collaborator-name-display,
        .collaborator-header h2 { /* Aplica a regra a todos os títulos de cabeçalho */
            font-size: 1.3rem; /* Levemente menor para caber melhor */
            font-weight: 700;
            color: var(--white);
            /* Adiciona padding para não ficar sob o botão de voltar */
            padding: 0 50px; 
            flex-grow: 1; /* Permite que o título ocupe o espaço central */
        }

        .back-button {
            position: absolute; /* Mantém a posição absoluta para ficar à esquerda */
            left: 1rem; /* Alinha à esquerda com padding */
            top: 50%; /* Centraliza verticalmente em relação ao header */
            transform: translateY(-50%); /* Ajuste fino do alinhamento vertical */
            background: none;
            border: none;
            color: var(--white);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem; /* Adiciona uma área de clique maior */
            z-index: 10; /* Garante que fique acima de outros elementos se necessário */
        }

        .back-button i {
            margin-right: 0.5rem;
        }

        #collaborator-profile-pic-container, #security-profile-pic-container {
            position: relative; /* Necessário para posicionar o ícone da nuvem */
            display: flex;
            justify-content: center;
            padding: 1rem 0;
            margin-bottom: 1rem; /* Adiciona espaço abaixo da foto */
        }

        /* Ícone para adicionar/editar status do colaborador */
        #edit-status-cloud {
            position: absolute;
            top: 10px;
            right: calc(50% - 80px); /* Posiciona à direita da foto */
            background-color: rgba(255, 255, 255, 0.9);
            color: #2980b9;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        #edit-status-cloud:hover {
            transform: scale(1.1);
            background-color: #fff;
        }

        /* Container para a bolha de status no perfil */
        #collaborator-status-display-container {
            width: 100%;
            text-align: center;
            padding: 0 1.5rem 1rem 1.5rem; /* Espaçamento abaixo */
            min-height: 20px; /* Garante espaço mesmo quando vazio */
        }
        
        /* Estilo da bolha de status no perfil (maior) */
        .profile-status-bubble {
            display: inline-block;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.4rem 0.8rem; /* Padding reduzido */
            border-radius: 16px;
            color: #e0e0e0; /* Cor um pouco mais suave */
            max-width: 100%;
            font-size: 0.9rem; /* Tamanho da fonte reduzido */
            font-style: italic;
            font-weight: 400; /* Peso da fonte normal */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Bolha de status para a seção de ranking */
        .status-bubble {
            background-color: rgba(0, 0, 0, 0.4);
            color: #e0e0e0;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem; /* Espaço do nome/prêmio */
            display: inline-block;
            max-width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        /* NOVO ESTILO PARA A FOTO DE PERFIL COM BORDA GRADIENTE */
        #collaborator-profile-pic, #security-profile-pic {
            width: 130px; /* Um pouco maior */
            height: 130px;
            border-radius: 50%;
            object-fit: cover;
            padding: 5px; /* Espaçamento para o gradiente aparecer */
            background: linear-gradient(45deg, var(--primary-color), #8e44ad); /* Gradiente na borda */
            cursor: pointer;
            transition: transform 0.3s var(--ease-out-back), box-shadow 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        #collaborator-profile-pic:hover, #security-profile-pic:hover {
            transform: scale(1.05) translateY(-5px); /* Efeito de elevação */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .collaborator-content {
            flex-grow: 1; 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 0 1.5rem 1.5rem 1.5rem; /* Ajuste no padding superior */
            width: 100%; 
            gap: 1rem; /* Adiciona espaçamento entre os elementos filhos */
        }
        
        /* NOVO: Container para os cards de informação */
        #individual-sales-data, #ponto-notification-area {
             width: 100%; 
             max-width: 380px;
        }

        /* NOVO ESTILO PARA OS CARDS DE DADOS E NOTIFICAÇÃO */
        .sales-data-card, .os-warning {
             background: rgba(0, 0, 0, 0.2) !important;
             border: 1px solid rgba(255, 255, 255, 0.1) !important;
             border-left: 3px solid var(--primary-color) !important;
             border-radius: 12px !important;
             padding: 1rem !important;
        }
        .os-warning { /* Específico para avisos */
             border-left-color: #f1c40f !important;
             color: #f1c40f !important;
        }

        /* CORREÇÃO: CONTAINER PARA A GRADE DE BOTÕES */
        .collaborator-actions-grid {
            display: grid;
            /* Começa com 2 colunas e pode ir para 3 se a tela for larga o suficiente */
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 1rem;
            width: 100%;
            max-width: 380px;
            margin-top: 1rem;
        }

        /* CORREÇÃO: ESTILO GERAL DOS BOTÕES */
        .action-button {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: 100%;
            /* max-width não é mais necessário aqui, a grade controla isso */
            padding: 1rem 0.5rem; /* Ajuste no padding lateral para caber mais texto */
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--white);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.08); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
            backdrop-filter: blur(2px);
            aspect-ratio: 1 / 1; /* Força os botões a serem quadrados, garantindo alinhamento perfeito */
        }

        .action-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px); 
        }

        /* CORREÇÃO: ESTILO DOS ÍCONES */
        .action-button i {
            font-size: 2.2rem; /* Um pouco maior */
            margin: 0 0 0.5rem 0; /* Remove margem lateral, ajusta inferior */
            color: var(--primary-color);
            line-height: 1; /* Garante que o ícone não adicione altura extra */
        }

        /* CORREÇÃO: ESTILO DO TEXTO DENTRO DO BOTÃO */
        .action-button span {
            line-height: 1.2; /* Melhora a legibilidade em duas linhas */
        }

                /* --- Estilos da Página de Gerência --- */
        .input-group {
            width: 100%;
            max-width: 350px;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .data-input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--white);
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            outline: none;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .data-input:focus {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }

        .status-message {
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
            min-height: 24px;
        }

                /* --- Estilos da Página de Metas --- */
        .employee-meta-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            margin-bottom: 1.5rem;
            max-width: 380px; /* Adicionado para limitar a largura dos cards de formulário */
        }

        .employee-meta-card h4 {
            font-size: 1.2rem;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-transform: uppercase;
        }

        .meta-group-title {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 0.25rem;
        }

        #metas-content-container {
            /* Esta regra não é mais necessária, pode ser removida ou deixada em branco */
        }
        
        .save-footer {
            /* Removemos o posicionamento absoluto para que o footer flua com o conteúdo */
            width: 100%;
            padding: 2rem 1.5rem; /* Aumentamos o padding para dar mais espaço */
            text-align: center;
            background: transparent; /* O fundo agora é o padrão da página */
        }

        /* Este estilo será mantido, mas o rodapé do estoque não o usará mais */
        .save-footer {
            display: none; 
        }

        /* Adicionamos um estilo para os botões de ação que devem ocupar a largura total do container */
        .action-button.full-width {
            aspect-ratio: auto; /* Remove a proporção quadrada */
            height: auto;       /* Deixa a altura ser automática */
            padding: 1rem;      /* Um padding vertical confortável */
            margin-top: 1rem;   /* Espaço acima do botão */
        }

        /* Estilos da tela de visualização de metas */
        #metas-display-content {
            padding: 1.5rem;
            font-size: 1rem;
            width: 100%;
        }
        #metas-display-content h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            width: 100%;
            text-align: center;
        }
        #metas-display-content p {
            margin-bottom: 0.75rem;
            background: rgba(255,255,255,0.1);
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
        }

                /* Estilos da página de envio e detalhes - ESTA REGRA PODE SER REMOVIDA */
        /* #send-device-page, #device-detail-page { ... } */

        #send-device-page .collaborator-content {
             padding-bottom: 2rem;
        }
        
        textarea.data-input {
            height: auto;
            min-height: 120px;
            font-family: monospace;
        }

        /* Grade de Dispositivos por Marca */
        .device-card {
            width: calc(50% - 0.5rem); /* Dois cards por linha com um gap */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            text-decoration: none;
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }
        .device-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .device-card img {
            width: 100%;
            height: 120px; /* Reduzida a altura */
            object-fit: contain; /* Alterado para 'contain' para não cortar */
            background-color: #fff; /* Fundo branco para imagens com transparência */
        }
        .device-card span {
            display: block;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
        }

        /* Página de Detalhes do Dispositivo */
        #device-detail-content img {
            width: 100%;
            max-width: 200px; /* Reduzido o tamanho máximo */
            max-height: 200px; /* Reduzido o tamanho máximo */
            object-fit: contain;
            border-radius: 16px;
            background-color: #fff;
            align-self: center;
            margin-bottom: 1.5rem;
        }
        #device-detail-content h3 {
             color: var(--primary-color);
             margin: 1.5rem 0 0.5rem 0;
             width: 100%;
        }
        #device-detail-content pre {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap; /* Garante que o texto quebre a linha */
            word-wrap: break-word;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }
        #device-detail-content a {
            display: inline-block;
            margin-top: 1rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .delete-button {
            background-color: rgba(231, 76, 60, 0.7) !important; /* Vermelho para perigo */
            margin-top: 2rem;
        }
        .delete-button:hover {
             background-color: rgba(192, 57, 43, 1.0) !important;
        }

        /* Estilos para os painéis de vendas */
        .sales-data-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
        }

        .sales-data-card h4 {
            font-size: 1.2rem;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .sales-data-card p {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* --- Estilos do Dashboard --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }
        .kpi-card, .performance-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .kpi-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .charts-section {
            width: 100%;
            max-width: 400px;
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 16px;
        }
        .chart-container h4 {
            text-align: center;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }
        #monthly-sales-list-container p {
            padding: 0.5rem 0.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
        }
         #monthly-sales-list-container p:last-child {
            border-bottom: none;
        }

        .os-warning {
            color: #e74c3c;
            font-weight: 700;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #e74c3c;
        }

        /* Estilos da página de Solicitação de Estoque */
        .stock-brand-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            width: 100%;
            text-align: center;
            margin-top: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 0.5rem;
        }
        .stock-product-card {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .stock-product-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .stock-product-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background: white;
            border-radius: 8px;
            margin-right: 1rem;
        }
        .stock-product-card span {
            font-weight: 600;
        }
        #stock-selection-footer h4 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        #stock-selection-list {
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        #stock-selection-list div {
            padding: 0.25rem 0;
        }
        .date-input-group {
            display: flex;
            gap: 0.5rem;
        }
        .date-input-group input {
            text-align: center;
        }

        /* Estilos para o Quiz */
        .quiz-question-group {
            width: 100%;
            max-width: 350px;
            margin-bottom: 1.5rem;
            background: rgba(0,0,0,0.1);
            padding: 1rem;
            border-radius: 12px;
        }
        .quiz-question-group > label {
            display: block;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .radio-option input[type="radio"] {
            margin-right: 0.75rem;
            width: 20px;
            height: 20px;
        }
        .radio-option label {
             font-weight: 400;
        }


                /* ================================================= */
        /* == ESTILOS PARA A CALCULADORA DE CREDIÁRIO     == */
        /* ================================================= */
        #crediario-calculator-page {
             background: #1a1a2e; /* Fundo azul escuro, quase preto */
        }
        #crediario-calculator-page .collaborator-content {
            flex-grow: 1; /* Garante que a área de conteúdo ocupe todo o espaço vertical */
            justify-content: center; /* Centraliza o formulário verticalmente */
        }
        #crediario-form-container {
            width: 100%;
            max-width: 350px;
            padding: 1.5rem;
            background: rgba(16, 16, 32, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(0, 191, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #crediario-calculator-page .data-input {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(0, 191, 255, 0.4);
            color: #E0E0E0;
        }
        #crediario-calculator-page .data-input:focus {
            border-color: #00BFFF; /* DeepSkyBlue */
        }
        #crediario-calculator-page .slider-group label {
            color: #00BFFF;
            font-weight: 700;
        }
        #crediario-calculator-page .slider-input {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            outline: none;
            margin-top: 0.5rem;
        }
        #crediario-calculator-page .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #00BFFF;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #1a1a2e;
        }
        #crediario-result-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 1rem;
            border-top: 2px solid #00BFFF;
        }
        #crediario-result-container h4 {
            text-align: center;
            margin-bottom: 1rem;
            color: #FFFFFF;
        }
        #crediario-calculator-page .result-item span:last-child {
            color: #00BFFF; /* Cor do resultado */
        }
        #crediario-calculator-page .action-button {
            background-color: rgba(0, 191, 255, 0.7);
        }
        #crediario-calculator-page .action-button:hover {
            background-color: rgba(0, 191, 255, 1);
        }

                /* ================================================= */
        /* == ESTILOS PARA A CALCULADORA DE SITE          == */
        /* ================================================= */
        #site-calculator-page {
             background: #1e2a24; /* Fundo verde escuro */
        }
        #site-calculator-page .collaborator-content {
            flex-grow: 1; /* Garante que ocupe o espaço vertical */
            display: flex; /* Ativa o layout flexbox */
            flex-direction: column; /* Empilha os itens verticalmente */
            align-items: center; /* Centraliza o formulário horizontalmente */
            justify-content: center; /* Centraliza o formulário verticalmente */
            padding: 1.5rem;
            width: 100%;
        }
        #site-form-container {
            width: 100%;
            max-width: 350px;
            padding: 1.5rem;
            background: rgba(15, 25, 20, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(46, 204, 113, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #site-calculator-page .data-input {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #E0E0E0;
        }
        #site-calculator-page .data-input:focus {
            border-color: #2ecc71; /* Verde esmeralda */
        }
        #site-calculator-page .slider-group label {
            color: #2ecc71;
            font-weight: 700;
        }
        #site-calculator-page .slider-input {
            -webkit-appearance: none;
            width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 5px; outline: none; margin-top: 0.5rem;
        }
        #site-calculator-page .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #2ecc71; cursor: pointer; border-radius: 50%; border: 3px solid #1e2a24;
        }
        #site-result-container {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; border-top: 2px solid #2ecc71;
        }
        #site-result-container h4 {
            text-align: center; margin-bottom: 1rem; color: #FFFFFF;
        }
        #site-calculator-page .action-button {
            background-color: rgba(46, 204, 113, 0.7);
        }
        #site-calculator-page .action-button:hover {
            background-color: rgba(46, 204, 113, 1);
        }

                /* --- Estilos da Página de Bater Ponto (Câmera) --- */
        #ponto-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 4000; /* Z-index alto para ficar sobre tudo */
            display: none; 
            flex-direction: column;
        }
        .ponto-camera-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #ponto-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .ponto-camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        .ponto-camera-overlay p {
            background: rgba(0,0,0,0.5);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .ponto-circle-guide {
            width: 80vw;
            height: 80vw;
            max-width: 300px;
            max-height: 300px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5); /* Efeito de "buraco" */
        }
        .ponto-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
        }
        .ponto-capture-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white;
            border: 5px solid rgba(0,0,0,0.3);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .ponto-capture-button i {
            font-size: 2rem;
            color: #333;
        }
        
        /* Estilos da Página de Histórico de Ponto */
        .ponto-history-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            align-items: center;
        }

        /* Novo Estilo para o Card de Falta */
        .ponto-history-card.absence-record {
            background: rgba(192, 57, 43, 0.2); /* Fundo avermelhado */
            border-left: 4px solid #c0392b; /* Borda vermelha */
        }

        .ponto-history-absence-icon {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ponto-history-absence-icon i {
            font-size: 2.5rem;
            color: #e74c3c;
        }

        /* Estilo para justificativas no histórico */
        .ponto-history-justification {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            border-left: 3px solid #f1c40f;
        }
        .ponto-history-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #333;
        }
        .ponto-history-details p {
            margin: 0;
            font-size: 0.9rem;
        }
        .ponto-history-details p strong {
            color: var(--primary-color);
        }

        /* Estilo para a foto no histórico, indicando que é clicável */
        .ponto-history-photo:hover {
            cursor: pointer;
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

        /* Estilos para o Visualizador de Imagem Ampliada */
        #image-viewer-overlay {
            align-items: center;
            justify-content: center;
            z-index: 5000; /* Z-index muito alto para ficar sobre tudo */
        }
        #viewer-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            /* Animação de entrada para a imagem */
            animation: modalContentEnter 0.4s var(--ease-out-back);
        }

        /* Estilo para a Exibição da Versão */
        #app-version-display {
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            width: 100%;
        }

        /* Estilos para a página Lollipop */
        .lollipop-item-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            overflow: hidden;
            width: calc(50% - 1rem);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .lollipop-item-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }
        .lollipop-item-info {
            padding: 0.75rem;
            font-size: 0.75rem;
        }
        .lollipop-item-controls {
            display: flex;
            gap: 0.5rem;
            padding: 0 0.75rem 0.75rem 0.75rem;
        }
        .lollipop-item-controls button {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .lollipop-delete-btn {
            background-color: #c0392b;
        }

        /* --- Estilos para o novo Dashboard GS --- */
        .gs-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            padding: 1.5rem 1rem 0 1rem; /* Adiciona padding para não colar no topo */
            width: 100%;
            max-width: 450px;
        }

        .gs-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--white);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            cursor: pointer;
            text-align: center;
        }

        .gs-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .gs-action-btn i {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        #gs-notification-indicator {
            background-color: #e74c3c; /* Vermelho */
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            vertical-align: top;
        }

        /* Ajuste para o container de conteúdo principal do GS */
        #gs-page .collaborator-content {
            /* O padding-top foi removido para que o conteúdo flua a partir do topo */
            /* O espaçamento agora é controlado pelo padding da grade de ações */
            flex-direction: column;
            justify-content: flex-start;
            gap: 1.5rem;
            overflow-y: auto;
        }


        /* =================================================================== */
        /* --- AJUSTES PARA TELAS PEQUENAS (RESPONSIVIDADE) --- */
        /* =================================================================== */
        
        /* Aplica estas regras em telas com largura máxima de 360px */
        @media (max-width: 360px) {
            /* Força a grade de ferramentas a ter apenas uma coluna */
            .tools-grid {
                grid-template-columns: 1fr;
            }

            /* Ajusta o padding para dar mais espaço */
            section {
                padding: 1.5rem 0.75rem;
            }

            header {
                padding: 1.25rem 0.75rem 0.75rem 0.75rem;
            }
        }

    </style>


</head>
<body>

    <!-- TELA DE ATIVAÇÃO INICIAL -->
    <div id="activation-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Ativação Necessária</h3>
            <div class="input-group">
                <label for="activation-code-input">Código de Acesso</label>
                <input type="password" id="activation-code-input" class="data-input" placeholder="Digite o código">
            </div>
            <button id="submit-activation-code" class="action-button" style="max-width: none;">Ativar Dispositivo</button>
            <p id="activation-status" class="status-message"></p>
        </div>
    </div>


    <!-- TELA DE PESQUISA (OVERLAY) -->
    <div id="search-overlay" class="page">
        <div class="search-container">
            <input type="text" id="search-input" class="data-input" placeholder="Pesquisar funcionalidade...">
            <button id="search-close-btn" class="modal-close-btn" style="top: 20px; right: 25px;">×</button>
            <div id="search-results-container">
                <!-- Resultados da pesquisa aparecerão aqui -->
            </div>
        </div>
    </div>

    <div class="mobile-container page">

        <header>
            <div class="logo">
                <i class="fa-solid fa-mobile-screen-button"></i>
                LOJA DO HUNTER
            </div>
            <nav class="header-icons">
                <a href="#" id="fast-mode-toggle"><i class="fa-solid fa-person-running"></i></a>
                <a href="#" id="theme-toggle"><i class="fa-solid fa-palette"></i></a>
            </nav>
        </header>

        <main>
            <!-- Seção de Aparelhos por Marca -->
            <section id="aparelhos">
                <h2 class="section-title">Aparelhos</h2>
                <div class="search-icon-container">
                    <button id="open-device-search" class="action-button" style="width: 60px; height: 60px; border-radius: 50%; padding: 0; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-magnifying-glass" style="font-size: 1.5rem; margin: 0;"></i>
                    </button>
                </div>
                <div class="brand-list">
                    <div class="brand-button" data-brand="xiaomi">Xiaomi</div>
                    <div class="brand-button" data-brand="poco">Poco</div>
                    <div class="brand-button" data-brand="realme">Realme</div>
                    <div class="brand-button" data-brand="umidigi">Umidigi</div>
                    <div class="brand-button" data-brand="itel">Itel</div>
                    <div class="brand-button" data-brand="tecno">Tecno</div>
                    <div class="brand-button" data-brand="infinix">Infinix</div>
                    <div class="brand-button" data-brand="honor">Honor</div>
                </div>
            </section>

            <!-- Seção do Ranking Mensal de Colaboradores -->
            <section id="ranking">
                <h2 class="section-title">Ranking do Mês</h2>
                <div id="ranking-container" class="ranking-list">
                    <!-- O JavaScript irá popular este container -->
                    <p style="text-align: center; padding: 1rem;">Carregando ranking...</p>
                </div>
            </section>
            
            <!-- Seção do Ranking de Gerentes -->
            <section id="store-ranking">
                <h2 class="section-title">Ranking de Gerentes</h2>
                <div id="store-ranking-container" class="ranking-list">
                    <!-- O JavaScript irá popular este container -->
                     <p style="text-align: center; padding: 1rem;">Carregando ranking...</p>
                </div>
            </section>
            
            <!-- NOVA Seção de Avisos Gerais -->
            <section id="avisos-gerais" style="display: none;">
                <h2 class="section-title">Avisos da Gerência</h2>
                <div id="avisos-container" class="ranking-list">
                    <!-- O JavaScript irá popular os avisos aqui -->
                </div>
            </section>
            
            <!-- Seção de Ferramentas -->
            <section id="ferramentas">
                <h2 class="section-title">Aplicativos</h2>
                
                <!-- Grade de Ferramentas Principais -->
                <div class="tools-grid">
                    <a href="https://www.brasilcard.net/bca/lojista/login" id="hunter-card-link" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-id-card"></i></div>
                        <span>Hunter Card</span>
                    </a>
                    <div id="open-colaborador-modal" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-users"></i></div>
                        <span>Colaborador</span>
                    </div>
                    <div id="previsao-btn" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-truck-fast"></i></div>
                        <span>Previsão</span>
                    </div>
                    <div id="open-os-modal" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-screwdriver-wrench"></i></div>
                        <span>Assistência Técnica (OS)</span>
                    </div>
                    <div id="open-suporte-modal" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-headset"></i></div>
                        <span>Suporte</span>
                    </div>
                    <div id="open-request-stock-page" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-boxes-stacked"></i></div>
                        <span>Solicitar Estoque</span>
                    </div>
                    <div id="open-quiz-page" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-comment-dots"></i></div>
                        <span>Quiz</span>
                    </div>
                    <div id="open-recibos-page" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                        <span>Recibos</span>
                    </div>
                    <div id="open-gs-page" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-chart-pie"></i></div>
                        <span>GS <span id="gs-notification-indicator" style="display: none;">!</span></span>
                    </div>
                    <div id="open-send-device-page" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-paper-plane"></i></div>
                        <span>Enviar Dispositivo</span>
                    </div>
                </div>
            </section>

            <!-- Seção de Calculadoras -->
            <section id="calculadoras">
                <h2 class="section-title">Calculadoras</h2>
                <div class="tools-grid">
                    <div id="open-crediario-calculator" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-sliders"></i></div>
                        <span>Crediário</span>
                    </div>
                    <div id="open-site-calculator" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-code"></i></div>
                        <span>Parcelar Site</span>
                    </div>
                     <div id="open-loja-calculator" class="tool-item" style="cursor: pointer;">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-store"></i></div>
                        <span>Parcelamento de Loja</span>
                    </div>
                    <div id="open-mt-display-page" class="tool-item">
                        <div class="tool-icon-wrapper"><i class="fa-solid fa-gem"></i></div>
                        <span>MT</span>
                    </div>
                </div>
            </section>

            </main>

        <!-- A seção do rodapé foi removida -->

    </div>

        <!-- TELA DA CALCULADORA DE CREDIÁRIO (ESTILO NOVO) -->
    <div id="crediario-calculator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-crediario" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Calculadora de Crediário</h2>
        </div>
        <div class="collaborator-content">
            
            <div id="crediario-form-container">
                <div class="input-group">
                    <label for="crediario-valor-produto">Valor do Produto (R$)</label>
                    <input type="number" id="crediario-valor-produto" class="data-input" placeholder="1500.00">
                </div>
                <div class="input-group">
                    <label for="crediario-entrada">Entrada (R$)</label>
                    <input type="number" id="crediario-entrada" class="data-input" placeholder="0.00">
                </div>
                <div class="input-group slider-group">
                    <label for="crediario-parcelas">Parcelas: <span id="parcelas-value">12</span>x</label>
                    <input type="range" id="crediario-parcelas" min="1" max="12" value="12" step="1" class="slider-input">
                </div>
                
                <div id="crediario-result-container">
                    <h4>Resultado em Tempo Real</h4>
                    <div class="result-item">
                        <span>Valor da Parcela</span>
                        <span id="result-parcela">R$ 0,00</span>
                    </div>
                    <div class="result-item">
                        <span>Total a Prazo (Restante)</span>
                        <span id="result-total-prazo">R$ 0,00</span>
                    </div>
                </div>

                <button id="clear-crediario-btn" class="action-button full-width">Limpar</button>
            </div>

        </div>
    </div>



        <!-- TELA DA CALCULADORA DE PARCELAMENTO DE LOJA -->
    <div id="loja-calculator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-loja" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Parcelamento de Loja</h2>
        </div>
        <div class="collaborator-content">
            <div id="loja-form-container">
                <div class="input-group">
                    <label for="loja-valor-produto">Valor do Produto (R$)</label>
                    <input type="number" id="loja-valor-produto" class="data-input" placeholder="1000.00">
                </div>
                <div class="input-group">
                    <label for="loja-entrada">Entrada (R$)</label>
                    <input type="number" id="loja-entrada" class="data-input" placeholder="100.00">
                </div>
                <div class="input-group">
                    <label for="loja-seguro">Seguro (R$)</label>
                    <input type="number" id="loja-seguro" class="data-input" placeholder="50.00">
                </div>
                <div class="input-group slider-group">
                    <label for="loja-parcelas">Parcelas: <span id="loja-parcelas-value">10</span>x</label>
                    <input type="range" id="loja-parcelas" min="1" max="18" value="10" step="1" class="slider-input">
                </div>
                
                <div id="loja-result-container">
                    <h4>Resultado do Parcelamento</h4>
                    <div class="result-item">
                        <span>Valor da Parcela</span>
                        <span id="loja-result-parcela">R$ 0,00</span>
                    </div>
                    <div class="result-item">
                        <span>Valor Total (com seguro)</span>
                        <span id="loja-result-total-prazo">R$ 0,00</span>
                    </div>
                </div>

                <button id="clear-loja-btn" class="action-button full-width">Limpar</button>
            </div>
        </div>
    </div>

    <!-- TELA DA CALCULADORA DE PARCELAMENTO DE SITE -->
    <div id="site-calculator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-site" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Parcelamento de Site</h2>
        </div>
        <div class="collaborator-content">
            <div id="site-form-container">
                <div class="input-group">
                    <label for="site-valor-produto">Valor do Site (R$)</label>
                    <input type="number" id="site-valor-produto" class="data-input" placeholder="3000.00">
                </div>
                <div class="input-group">
                    <label for="site-entrada">Entrada (R$)</label>
                    <input type="number" id="site-entrada" class="data-input" placeholder="500.00">
                </div>
                <div class="input-group slider-group">
                    <label for="site-parcelas">Parcelas: <span id="site-parcelas-value">6</span>x</label>
                    <input type="range" id="site-parcelas" min="1" max="12" value="6" step="1" class="slider-input">
                </div>
                
                <div id="site-result-container">
                    <h4>Resultado do Parcelamento</h4>
                    <div class="result-item">
                        <span>Valor da Parcela</span>
                        <span id="site-result-parcela">R$ 0,00</span>
                    </div>
                    <div class="result-item">
                        <span>Valor Total (com juros)</span>
                        <span id="site-result-total-prazo">R$ 0,00</span>
                    </div>
                </div>

                <button id="clear-site-btn" class="action-button full-width">Limpar</button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- HTML DAS TELAS ESCONDIDAS E MODAIS -->
    <!-- =================================================================== -->

    <!-- TELA DE BUSCA DE APARELHOS -->
    <div id="device-search-overlay" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-device-search" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Buscar Aparelho</h2>
        </div>
        <div class="collaborator-content" style="padding-top: 1.5rem; align-items: stretch;">
            <div class="input-group" style="max-width: none;">
                <input type="text" id="device-search-input" class="data-input" placeholder="Digite o nome do aparelho...">
            </div>
            <!-- A grade de resultados reutiliza os estilos da página de marcas -->
            <div id="device-search-results-grid" style="display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: flex-start; gap: 1rem; width: 100%; overflow-y: auto; flex-grow: 1; padding-bottom: 2rem;">
                <!-- Resultados da busca aparecerão aqui -->
            </div>
        </div>
    </div>

            

    <!-- Janela Modal para Colaboradores -->
    <div id="colaborador-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-modal-btn" class="modal-close-btn">×</button>
            <div id="colaborador-cidades" class="modal-view">
                <h3 class="modal-title">Escolha a Cidade</h3>
                <div class="modal-button-container">
                    <button id="btn-pinheiro" class="modal-btn">Pinheiro</button>
                    <button id="btn-bacabal" class="modal-btn">Bacabal</button>
                </div>
            </div>
            <div id="colaborador-pinheiro" class="modal-view" style="display: none;">
                <h3 class="modal-title">Colaboradores - Pinheiro</h3>
                <div class="modal-button-container">
                    <a href="#" class="modal-btn collaborator-link" data-name="Beatriz">Beatriz</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Marcio">Marcio</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Eliseu">Eliseu</a>
                </div>
            </div>
            <div id="colaborador-bacabal" class="modal-view" style="display: none;">
                <h3 class="modal-title">Colaboradores - Bacabal</h3>
                <div class="modal-button-container">
                    <a href="#" class="modal-btn collaborator-link" data-name="Natalia">Natalia</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Tacilio">Tacilio</a>
                    <a href="#" class="modal-btn collaborator-link" data-name="Demilson">Demilson</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela do Colaborador (escondida por padrão) -->
    <div id="collaborator-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="collaborator-name-display">Nome do Colaborador</h2>
        </div>
        <!-- Container para a Foto de Perfil -->
        <div id="collaborator-profile-pic-container">
            <img id="collaborator-profile-pic" src="" alt="Foto de Perfil">
            <!-- Ícone para adicionar/editar status -->
            <div id="edit-status-cloud"><i class="fa-solid fa-comment"></i></div>
        </div>
        
        <!-- Container para exibir o status do colaborador -->
        <div id="collaborator-status-display-container"></div>

        <!-- O conteúdo agora tem um container para melhor organização -->
        <div class="collaborator-content">
            <!-- Aviso de Manutenção -->
            <div id="maintenance-notice-area" class="os-warning" style="display: none;">
                Estamos passando por manutenção, desconsidere erros até este aviso sumir.
            </div>

            <!-- Área de Notificação do Ponto -->
            <div id="ponto-notification-area">
                <!-- O JS vai popular esta área -->
            </div>
            
            <!-- Informação do próximo ponto -->
            <p id="ponto-countdown-timer" style="text-align: center; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); margin: 0; min-height: 20px;"></p>
            <p id="ponto-live-countdown" style="text-align: center; font-size: 1.1rem; font-weight: 600; color: #f1c40f; margin: 0; min-height: 25px;"></p>

            <!-- Painel de vendas individuais -->
            <div id="individual-sales-data"></div>
            
            <!-- NOVA GRADE DE AÇÕES PRINCIPAIS -->
            <div class="collaborator-actions-grid">
                <a href="#" id="view-metas-btn" class="action-button">
                    <i class="fa-solid fa-trophy"></i>
                    <span>Metas</span>
                </a>
                <a href="#" id="bater-ponto-btn" class="action-button">
                    <i class="fa-solid fa-camera-retro"></i>
                    <span>Digitar Ponto</span>
                </a>
                 <a href="#" id="manager-panel-btn" class="action-button" style="display: none;">
                    <i class="fa-solid fa-user-tie"></i>
                    <span>Painel Gerente</span>
                </a>
                <a href="#" id="closing-btn" class="action-button" style="display: none;">
                    <i class="fa-solid fa-cash-register"></i>
                    <span>Fechamento</span>
                </a>
                 <a href="#" id="change-password-btn" class="action-button">
                    <i class="fa-solid fa-key"></i>
                    <span>Alterar Senha</span>
                </a>
                <a href="#" id="change-photo-btn" class="action-button">
                    <i class="fa-solid fa-camera-rotate"></i>
                    <span>Trocar Foto</span>
                </a>
            </div>
            
            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
            <p id="photo-upload-status" class="status-message"></p>
        </div>
    </div>

    <!-- Tela da gs (Dashboard) -->
    <div id="gs-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-gs" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Dashboard Geral</h2>
        </div>

        <div class="collaborator-content">
            
            <!-- Botões de Ação agora estão DENTRO da área de rolagem -->
            <div class="gs-actions-grid">
                <button id="open-settings-page" class="gs-action-btn"><i class="fa-solid fa-bullseye"></i><span>Metas</span></button>
                <button id="open-correction-page" class="gs-action-btn"><i class="fa-solid fa-eraser"></i><span>Correção</span></button>
                <button id="open-mt-management-page" class="gs-action-btn"><i class="fa-solid fa-gem"></i><span>MT</span></button>
                <button id="verificar-ponto-btn" class="gs-action-btn"><i class="fa-solid fa-user-check"></i><span>Ponto</span></button>
                <button id="open-overtime-management-page" class="gs-action-btn"><i class="fa-solid fa-clock"></i><span>Horas</span></button>
                <button id="open-holidays-management-page" class="gs-action-btn"><i class="fa-solid fa-calendar-xmark"></i><span>Feriados</span></button>
                <button id="open-sundays-management-page" class="gs-action-btn"><i class="fa-solid fa-calendar-check"></i><span>Domingos</span></button>
                <button id="open-day-off-management-page" class="gs-action-btn"><i class="fa-solid fa-bed"></i><span>Folgas</span></button>
                <button id="open-avisos-management-page" class="gs-action-btn"><i class="fa-solid fa-bullhorn"></i><span>Avisos</span></button>
                <button id="clear-ponto-status-btn" class="gs-action-btn"><i class="fa-solid fa-user-clock"></i><span>Limpar Ponto</span></button>
                <button id="open-security-menu-btn" class="gs-action-btn"><i class="fa-solid fa-shield-halved"></i><span>Segurança</span></button>
                <button id="save-backup-btn" class="gs-action-btn"><i class="fa-solid fa-save"></i><span>Salvar Backup</span></button>
                <button id="restore-backup-btn" class="gs-action-btn"><i class="fa-solid fa-upload"></i><span>Restaurar Backup</span></button>
                <input type="file" id="backup-file-input" accept=".txt" style="display: none;">
            </div>

            <!-- KPIs principais -->
            <div class="dashboard-grid">
                <div class="kpi-card"><span class="kpi-title">VENDAS TOTAIS</span><span id="total-vendas-kpi" class="kpi-value">---</span></div>
                <div class="kpi-card"><span class="kpi-title">VENDAS PINHEIRO</span><span id="pinheiro-vendas-kpi" class="kpi-value">---</span></div>
                <div class="kpi-card"><span class="kpi-title">VENDAS BACABAL</span><span id="bacabal-vendas-kpi" class="kpi-value">---</span></div>
            </div>

            <!-- Rankings de Performance -->
            <div class="dashboard-grid">
                 <div class="performance-card"><span class="kpi-title">MELHOR LOJA (Vendas)</span><span id="melhor-loja-kpi" class="kpi-value" style="font-size: 1.5rem;">---</span></div>
                 <div class="performance-card"><span class="kpi-title">MELHOR VENDEDOR</span><span id="melhor-vendedor-kpi" class="kpi-value" style="font-size: 1.5rem;">---</span></div>
            </div>

            <!-- Seção de Vendas Mensais -->
            <div class="charts-section">
                <div class="chart-container">
                    <h4>Vendas Mensais (Histórico)</h4>
                    <canvas id="monthly-sales-chart"></canvas>
                </div>
            </div>

            <!-- Seção de Gráficos de Vendas Atuais -->
            <div class="charts-section">
                <div class="chart-container">
                    <h4>Vendas Atuais por Loja</h4>
                    <canvas id="store-sales-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Progresso da Meta Individual (%)</h4>
                    <canvas id="employee-goal-progress-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Vendas Atuais por Funcionário</h4>
                    <canvas id="employee-sales-chart"></canvas>
                </div>
            </div>
            
            <!-- Seção de Notificações de Ponto -->
            <div class="charts-section" id="manager-notifications-section" style="display: none;">
                <div class="chart-container">
                    <h4>Notificações de Ponto</h4>
                    <div id="manager-notifications-list" class="ranking-list" style="gap: 0.5rem;">
                        <!-- Notificações serão carregadas aqui -->
                    </div>
                    <!-- Botão para limpar todas as notificações -->
                    <button id="clear-all-notifications-btn" class="action-button delete-button" style="margin-top: 1.5rem; display: none;">
                        <i class="fa-solid fa-trash-can"></i> Limpar Todas
                    </button>
                </div>
            </div>

                        <!-- Seção de Horas Extras -->
            <div class="charts-section" id="overtime-section">
                <div class="chart-container">
                    <h4>Horas Extras Acumuladas</h4>
                    <div id="overtime-list-container" class="ranking-list" style="gap: 0.5rem;">
                         <p style="text-align: center;">Carregando...</p>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Configurações Gerais -->
            <div class="charts-section">
                <div class="chart-container">
                    <h4>Configurações Gerais</h4>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label for="maintenance-mode-toggle" style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="maintenance-mode-toggle" style="margin-right: 10px; width: 20px; height: 20px;">
                            Ativar Modo de Manutenção
                        </label>
                        <p style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem;">
                            Exibe um aviso de manutenção na tela de cada colaborador.
                        </p>
                        <p id="maintenance-status-message" class="status-message"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- TELA DE VISUALIZAÇÃO DO MOSTRUÁRIO (MT) -->
    <div id="mt-display-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-mt-display" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Mostruário (MT)</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <div class="input-group" style="max-width: none; margin-bottom: 0;">
                <label for="mt-brand-filter">Filtrar por Marca</label>
                <select id="mt-brand-filter" class="data-input">
                    <option value="" selected>Selecione uma marca...</option>
                    <option value="apple">Apple</option> <!-- Adicionado -->
                    <option value="xiaomi">Xiaomi</option>
                    <option value="poco">Poco</option>
                    <option value="realme">Realme</option>
                    <option value="umidigi">Umidigi</option>
                    <option value="itel">Itel</option>
                    <option value="tecno">Tecno</option>
                    <option value="infinix">Infinix</option>
                    <option value="honor">Honor</option>
                </select>
            </div>
            <div id="mt-content-area" style="width: 100%; display: flex; flex-direction: column; gap: 1rem;">
                <!-- Conteúdo do MT será carregado aqui pelo JS -->
                <p style="text-align: center;">Selecione uma marca para ver os itens.</p>
            </div>
        </div>
    </div>

    <!-- TELA DE gsMENTO DO MOSTRUÁRIO (MT) -->
    <div id="mt-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-mt-management" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>gsr MT</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">

            <!-- Seção para Adicionar Novo Item -->
            <div class="employee-meta-card">
                <h4>Adicionar Novo Item ao MT</h4>
                <div class="input-group">
                    <label for="mt-add-brand">Marca</label>
                    <select id="mt-add-brand" class="data-input">
                        <option value="" disabled selected>Selecione a marca...</option>
                        <option value="apple">Apple</option> <!-- Adicionado -->
                        <option value="xiaomi">Xiaomi</option>
                        <option value="poco">Poco</option>
                        <option value="realme">Realme</option>
                        <option value="umidigi">Umidigi</option>
                        <option value="itel">Itel</option>
                        <option value="tecno">Tecno</option>
                        <option value="infinix">Infinix</option>
                        <option value="honor">Honor</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="mt-add-text">Texto do Item</label>
                    <textarea id="mt-add-text" class="data-input" rows="4" placeholder="REALME Note 50 – 64GB / 3GB
💰 Entrada a partir de R$ 570,00
⚫ Preto | 🔵 Azul"></textarea>
                </div>
                <button id="save-mt-item-btn" class="action-button"><i class="fa-solid fa-save"></i>Salvar Item</button>
                <p id="mt-add-status" class="status-message"></p>
            </div>

            <!-- Seção para Listar e Excluir Itens -->
            <div class="employee-meta-card">
                <h4>Itens Cadastrados</h4>
                <div id="mt-list-container">
                    <!-- Lista de itens será carregada aqui -->
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>

        </div>
    </div>

<!-- Tela de Configuração de Metas e Premiações -->
    <div id="metas-config-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-metas" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Metas e Premiações</h2>
        </div>
        <div id="metas-content-container" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área e o botão de salvar será adicionado aqui no final por ele -->
        </div>
    </div>

    <!-- Tela de Visualização de Metas (Para o Colaborador) -->
    <div id="metas-display-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-metas" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Metas e Premiações</h2>
        </div>
        <div id="metas-display-content" class="collaborator-content" style="flex-direction: column; align-items: flex-start; justify-content: flex-start;">
            <!-- O JavaScript vai popular esta área -->
        </div>
    </div>

    <!-- Tela para Enviar um Novo Dispositivo -->
    <div id="send-device-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-send" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Enviar Novo Dispositivo</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <div class="input-group">
                <label for="device-brand">Marca</label>
                <select id="device-brand" class="data-input">
                    <option value="" disabled selected>Selecione a marca...</option>
                    <option value="apple">Apple</option> <!-- Adicionado -->
                    <option value="xiaomi">Xiaomi</option>
                    <option value="poco">Poco</option>
                    <option value="realme">Realme</option>
                    <option value="umidigi">Umidigi</option>
                    <option value="itel">Itel</option>
                    <option value="tecno">Tecno</option>
                    <option value="infinix">Infinix</option>
                    <option value="honor">Honor</option>
                </select>
            </div>
            <div class="input-group">
                <label for="device-name">Nome do Dispositivo</label>
                <input type="text" id="device-name" class="data-input" placeholder="Ex: Infinix Hot 60i">
            </div>
            <div class="input-group">
                <label for="device-image-url">URL da Imagem Principal</label>
                <input type="text" id="device-image-url" class="data-input" placeholder="Cole o link da imagem aqui">
            </div>
            <div class="input-group">
                <label for="device-tech-specs">⚙️ Ficha Técnica</label>
                <textarea id="device-tech-specs" class="data-input" rows="5" placeholder="Processador: Snapdragon 8 Gen 1
Tela: 6.8 polegadas, AMOLED
Câmera: 108MP..."></textarea>
            </div>
            <div class="input-group">
                <label for="device-price-table">💰 Tabela de Preços</label>
                <textarea id="device-price-table" class="data-input" rows="4" placeholder="P1 ✅ R$ 1.399,00
P2 ⚠️ R$ 1.319,00
P3 🚨 R$ 1.249,00"></textarea>
            </div>
            <div class="input-group">
                <label for="device-insurance-table">🔧 Tabela de Seguro</label>
                <textarea id="device-insurance-table" class="data-input" rows="4" placeholder="P1: R$ 339,00
P2: R$ 309,00
P3: R$ 299,00"></textarea>
            </div>
            <button id="save-device-btn" class="action-button" style="margin-top: 1rem;"><i class="fa-solid fa-save"></i>Salvar Dispositivo</button>
            <p id="send-device-status" class="status-message"></p>
            <!-- Placeholder para o botão de acesso -->
            <div id="lollipop-access-container" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Tela para Listar Dispositivos de uma Marca -->
    <div id="brand-devices-page" style="display: none;">
         <div class="collaborator-header">
            <button id="back-to-main-from-brand" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="brand-page-title">Marca</h2>
        </div>
        <div id="brand-devices-grid" class="collaborator-content" style="flex-wrap: wrap; justify-content: flex-start; align-items: flex-start; gap: 1rem; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área -->
        </div>
    </div>
    
    <!-- Tela para Ver os Detalhes de um Dispositivo -->
    <div id="device-detail-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-brand-from-detail" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="device-detail-title">Nome do Dispositivo</h2>
        </div>
        <div id="device-detail-content" class="collaborator-content" style="flex-direction: column; align-items: flex-start; justify-content: flex-start; overflow-y: auto; padding: 1.5rem;">
            <!-- O JavaScript vai popular esta área -->
        </div>
    </div>

    <!-- Tela do Painel de Vendas da Gerente -->
    <div id="manager-sales-panel-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-panel" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Painel de Vendas da Gerente</h2>
        </div>
        <div id="manager-sales-panel-content" class="collaborator-content" style="flex-direction: column; align-items: stretch; justify-content: flex-start; gap: 1.5rem; padding-top: 1rem; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área com os cards de cada vendedor -->
        </div>
    </div>

    <!-- TELA DE FECHAMENTO -->
    <div id="closing-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-collab-from-closing" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Lançamento de Fechamento</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; align-items: stretch; justify-content: flex-start; gap: 1rem; padding-top: 1rem; overflow-y: auto;">
            
            <!-- Seleção da Loja -->
            <div id="closing-store-selection" class="modal-button-container" style="padding: 0 1rem;">
                 <h3 class="modal-title" style="font-size: 1.2rem;">Selecione a Loja</h3>
                 <button id="closing-btn-pinheiro" class="modal-btn">Pinheiro</button>
                 <button id="closing-btn-bacabal" class="modal-btn">Bacabal</button>
            </div>

            <!-- Formulário Pinheiro -->
            <div id="closing-form-pinheiro" style="display: none; padding: 0 1rem;">
                <!-- Formulário de Fechamento será gerado pelo JavaScript -->
            </div>
            
            <div id="closing-form-bacabal" style="display: none; padding: 0 1rem;">
                <!-- Formulário de Fechamento será gerado pelo JavaScript -->
            </div>
            
             <!-- Botão de Envio (comum aos dois forms) -->
            <div id="closing-submit-container" style="display: none; padding: 1.5rem 1rem;">
                <button id="submit-closing-data-btn" class="action-button"><i class="fa-solid fa-paper-plane"></i>Enviar Fechamento</button>
                <p id="closing-status-message" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE CORREÇÃO DE DADOS DE FUNCIONÁRIOS -->
    <div id="correction-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-correction" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Corrigir Dados de Vendas</h2>
        </div>
        <div id="correction-content-container" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JavaScript vai popular esta área e o botão de salvar será adicionado aqui no final por ele -->
        </div>
    </div>

    <!-- Janela Modal para Suporte -->
    <div id="suporte-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-suporte-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Contato do Suporte</h3>
            <div class="modal-button-container">
                <a href="https://wa.me/553535732600?text=CNPJ%20PHO%2052524851000137%0ACNPJ%20BAC%2057269647000130" target="_blank" class="modal-btn">Brasil Card</a>
                <a href="https://wa.me/5511963568037?text=CNPJ%20PHO%2052524851000137%0ACNPJ%20BAC%2057269647000130" target="_blank" class="modal-btn">Pay Mobi</a>
            </div>
        </div>
    </div>

    <!-- Janela Modal para Ordem de Serviço (OS) -->
    <div id="os-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-os-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Assistência Técnica</h3>
            <div class="modal-button-container">
                <a href="https://w.app/gkesxd" target="_blank" class="modal-btn">Realme</a>
            </div>
        </div>
    </div>

    <!-- TELA DE SOLICITAÇÃO DE ESTOQUE -->
    <div id="request-stock-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-stock" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Solicitar Estoque</h2>
        </div>
        <!-- Container principal com padding para não encostar no rodapé fixo -->
        <div id="stock-product-list" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; align-items: stretch; gap: 1rem; padding-bottom: 150px;">
            <!-- O JavaScript vai popular esta área -->
        </div>
        <!-- Rodapé fixo para o "carrinho" -->
        <div id="stock-selection-footer" style="position: sticky; bottom: 0; background: rgba(30,30,60,0.9); backdrop-filter: blur(5px); padding: 1rem 1.5rem; display: none; width: 100%; text-align: center;">
            <h4>Itens Selecionados</h4>
            <div id="stock-selection-list"></div>
            
            <!-- Novo Campo para Pedido Personalizado -->
            <div class="input-group" style="margin-top: 1.5rem; margin-bottom: 0.5rem; max-width: none;">
                <label for="custom-stock-request-input">Pedido Personalizado (Opcional)</label>
                <textarea id="custom-stock-request-input" class="data-input" rows="3" placeholder="Ex: 5x Película 3D para iPhone 15, 2x Carregador 20W..."></textarea>
            </div>

            <button id="send-stock-request-btn" class="action-button full-width"><i class="fa-solid fa-paper-plane"></i>Enviar Solicitação</button>
        </div>
    </div>

    <!-- TELA DE FORMULÁRIO DE ORDEM DE SERVIÇO (OS) -->
    <div id="os-form-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-os" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Ordem de Serviço</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <p class="os-warning">ATENÇÃO: REMOVA A SENHA DO APARELHO!</p>
            <div class="input-group"><label for="os-colaborador">COLABORADOR (Obrigatório)</label><input type="text" id="os-colaborador" class="data-input"></div>
            <div class="input-group"><label for="os-cidade">CIDADE REMETENTE (Obrigatório)</label><input type="text" id="os-cidade" class="data-input"></div>
            <div class="input-group"><label for="os-data">DATA DE ENVIO (Obrigatório)</label><input type="date" id="os-data" class="data-input"></div>

            <div class="employee-meta-card"><h4>Aparelho 1</h4>
                <div class="input-group"><label for="os-cliente-1">CLIENTE E TELEFONE</label><textarea id="os-cliente-1" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-1">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-1" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 2</h4>
                <div class="input-group"><label for="os-cliente-2">CLIENTE E TELEFONE</label><textarea id="os-cliente-2" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-2">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-2" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 3</h4>
                <div class="input-group"><label for="os-cliente-3">CLIENTE E TELEFONE</label><textarea id="os-cliente-3" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-3">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-3" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 4</h4>
                <div class="input-group"><label for="os-cliente-4">CLIENTE E TELEFONE</label><textarea id="os-cliente-4" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-4">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-4" class="data-input" rows="3"></textarea></div>
            </div>
            <div class="employee-meta-card"><h4>Aparelho 5</h4>
                <div class="input-group"><label for="os-cliente-5">CLIENTE E TELEFONE</label><textarea id="os-cliente-5" class="data-input" rows="2"></textarea></div>
                <div class="input-group"><label for="os-modelo-5">MODELO, DEFEITO E IMEI</label><textarea id="os-modelo-5" class="data-input" rows="3"></textarea></div>
            </div>
            
            <div class="save-footer">
                <button id="submit-os-form-btn" class="action-button"><i class="fa-solid fa-envelope"></i>Enviar OS por Email</button>
                <p id="os-form-status" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE RECIBOS -->
    <div id="recibos-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-recibos" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Lançar Recibo de Gastos</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1.5rem; align-items: stretch; overflow-y: auto;">
            
            <div class="input-group"><label for="recibo-nome">NOME (Obrigatório)</label><input type="text" id="recibo-nome" class="data-input" placeholder="Seu nome"></div>
            <div class="input-group"><label for="recibo-loja">LOJA (Obrigatório)</label><input type="text" id="recibo-loja" class="data-input" placeholder="Pinheiro ou Bacabal"></div>

            <div class="input-group">
                <label for="recibo-data">DATA DO GASTO (Obrigatório)</label>
                <div class="date-input-group">
                    <input type="number" id="recibo-dia" class="data-input" placeholder="DD" min="1" max="31">
                    <input type="number" id="recibo-mes" class="data-input" placeholder="MM" min="1" max="12">
                    <input type="number" id="recibo-ano" class="data-input" placeholder="AAAA" min="2023">
                </div>
            </div>
            
            <div class="input-group"><label for="recibo-gastos">GASTOS (Descrição e Valor - Obrigatório)</label><textarea id="recibo-gastos" class="data-input" rows="4" placeholder="Ex: Almoço - R$ 15,00
Transporte - R$ 5,00"></textarea></div>
            <div class="input-group"><label for="recibo-nota">NOTA/CUPOM (Opcional)</label><textarea id="recibo-nota" class="data-input" rows="2" placeholder="Se houver, descreva ou cole o texto aqui."></textarea></div>
            
            <div style="width: 100%; max-width: 350px; text-align: center; margin-top: 1rem;">
                <button id="submit-recibo-btn" class="action-button"><i class="fa-solid fa-paper-plane"></i>Enviar Recibo</button>
                <p id="recibo-status-message" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- TELA DE QUIZ (FEEDBACK) -->
    <div id="quiz-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-main-from-quiz" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Treinamento da Loja do Hunter</h2>
        </div>
        <div class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1.5rem; align-items: stretch; overflow-y: auto;">
            
            <div class="input-group"><label for="quiz-nome">Nome (Obrigatório)</label><input type="text" id="quiz-nome" class="data-input" placeholder="Seu nome"></div>

            <div class="quiz-question-group">
                <label>1. Você gostou do conteúdo do treinamento?</label>
                <div class="radio-option"><input type="radio" id="gostou-sim-muito" name="gostou_treinamento" value="Sim, muito!"><label for="gostou-sim-muito">Sim, muito!</label></div>
                <div class="radio-option"><input type="radio" id="gostou-sim-bom" name="gostou_treinamento" value="Sim, foi bom."><label for="gostou-sim-bom">Sim, foi bom.</label></div>
                <div class="radio-option"><input type="radio" id="gostou-razoavel" name="gostou_treinamento" value="Foi razoável."><label for="gostou-razoavel">Foi razoável.</label></div>
                <div class="radio-option"><input type="radio" id="gostou-nao" name="gostou_treinamento" value="Não gostei muito."><label for="gostou-nao">Não gostei muito.</label></div>
            </div>

            <div class="input-group">
                <label for="quiz_parte_util">2. Qual parte você achou mais útil ou que mais chamou sua atenção?</label>
                <textarea id="quiz_parte_util" class="data-input" rows="3"></textarea>
            </div>

            <div class="quiz-question-group">
                <label>3. Teve alguma parte que ficou confusa ou você sentiu falta de mais explicações?</label>
                <div class="radio-option"><input type="radio" id="confusa-sim" name="parte_confusa" value="Sim"><label for="confusa-sim">Sim</label></div>
                <div class="radio-option"><input type="radio" id="confusa-nao" name="parte_confusa" value="Não"><label for="confusa-nao">Não</label></div>
                <div class="input-group" style="margin-top: 1rem; margin-bottom: 0;">
                    <label for="quiz_parte_confusa_detalhe">Se sim, qual parte?</label>
                    <textarea id="quiz_parte_confusa_detalhe" class="data-input" rows="2"></textarea>
                </div>
            </div>

            <div class="quiz-question-group">
                <label>4. Você sentiu que esse treinamento te ajudou a se sentir mais preparado(a) para vender e atender melhor?</label>
                <div class="radio-option"><input type="radio" id="ajudou-certeza" name="ajudou_preparar" value="Sim, com certeza"><label for="ajudou-certeza">Sim, com certeza</label></div>
                <div class="radio-option"><input type="radio" id="ajudou-pouco" name="ajudou_preparar" value="Um pouco"><label for="ajudou-pouco">Um pouco</label></div>
                <div class="radio-option"><input type="radio" id="ajudou-nao-muito" name="ajudou_preparar" value="Não muito"><label for="ajudou-nao-muito">Não muito</label></div>
                <div class="radio-option"><input type="radio" id="ajudou-nao" name="ajudou_preparar" value="Não"><label for="ajudou-nao">Não</label></div>
            </div>

            <div class="quiz-question-group">
                <label>5. Qual tema você gostaria que a gente abordasse no próximo treinamento?</label>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-redes" value="Abordagem nas redes sociais e atendimento online"><label for="tema-redes">Abordagem nas redes sociais e atendimento online</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-metas" value="Como bater metas de forma leve e planejada"><label for="tema-metas">Como bater metas de forma leve e planejada</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-clientes" value="Técnicas para lidar com clientes indecisos ou difíceis"><label for="tema-clientes">Técnicas para lidar com clientes indecisos ou difíceis</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-sistema" value="Como usar melhor o sistema Hunter Vendas"><label for="tema-sistema">Como usar melhor o sistema Hunter Vendas</label></div>
                <div class="radio-option"><input type="radio" name="proximo_tema" id="tema-outro" value="Outro"><label for="tema-outro">Outro:</label></div>
                <input type="text" id="quiz_proximo_tema_outro" class="data-input" style="margin-left: 2rem; width: calc(100% - 2rem);">
            </div>

            <div class="input-group">
                <label for="quiz_sugestao">6. Deixe aqui alguma sugestão, elogio ou crítica (opcional):</label>
                <textarea id="quiz_sugestao" class="data-input" rows="3"></textarea>
            </div>
            
            <div style="width: 100%; max-width: 350px; text-align: center; margin-top: 1rem;">
                <button id="submit-quiz-btn" class="action-button"><i class="fa-solid fa-paper-plane"></i>Enviar Feedback</button>
                <p id="quiz-status-message" class="status-message"></p>
            </div>
        </div>
    </div>




    <!-- TELA PARA DIGITAR PONTO (CÂMERA) -->
    <div id="ponto-page" style="display: none; background-color: #000;">
        <div class="collaborator-header" style="background: #000;">
            <button id="back-to-collab-from-ponto" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Digitar Ponto</h2>
        </div>
        <div class="ponto-camera-container">
            <video id="ponto-video" playsinline autoplay muted></video>
            <canvas id="ponto-canvas" style="display: none;"></canvas>
            <div class="ponto-camera-overlay">
                <p>Centralize seu rosto no círculo</p>
                <div class="ponto-circle-guide"></div>
            </div>
            <div id="ponto-status-message" class="status-message" style="position: absolute; bottom: 100px; width: 100%; color: white; background: rgba(0,0,0,0.5); padding: 0.5rem 0;"></div>
            <div class="ponto-controls">
                <button id="capture-ponto-btn" class="ponto-capture-button">
                    <i class="fa-solid fa-camera"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- TELA DE VERIFICAÇÃO DE PONTO (LISTA DE FUNCIONÁRIOS) -->
    <div id="ponto-verification-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-ponto-verify" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Verificar Ponto</h2>
        </div>
        <div id="ponto-employee-list" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular a lista de funcionários aqui -->
        </div>
    </div>

    <!-- TELA DE HISTÓRICO DE PONTO DE UM FUNCIONÁRIO -->
    <div id="ponto-history-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-ponto-verify-from-history" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="ponto-history-title">Histórico de Ponto</h2>
        </div>
        <div id="ponto-history-container" class="collaborator-content" style="align-items: stretch; gap: 1rem;">
            <!-- JS vai popular o histórico aqui -->
        </div>
    </div>


    <!-- TELA DE VISUALIZAÇÃO DE IMAGEM (NOVA) -->
    <div id="image-viewer-overlay" class="modal-overlay">
        <button id="close-viewer-btn" class="modal-close-btn" style="z-index: 10;">×</button>
        <img id="viewer-image" src="" alt="Imagem ampliada">
    </div>

    <!-- Janela Modal para Seleção de Tema -->
    <div id="theme-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-theme-modal-btn" class="modal-close-btn">×</button>
            <h3 class="modal-title">Escolha um Tema</h3>
            <div class="modal-button-container">
                <button class="modal-btn theme-select-btn" data-theme="default">Padrão</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-hunter">Hunter (Laranja)</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-rosa">Rosa</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-black">Black</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-claro">Claro</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-lgbt">LGBT</button>
                <button class="modal-btn theme-select-btn" data-theme="theme-grayx">Cinza X</button>
            </div>
        </div>
    </div>

    <!-- Elemento para exibir a versão -->
    <div id="app-version-display"></div>

    <!-- Container para o Tema Cinza X -->
    <div id="floating-x-container"></div>
    <!-- Container para o Tema Rosa -->
    <div id="floating-dots-container"></div>

    <!-- TELA DE GERENCIAMENTO DE FERIADOS -->
    <div id="holidays-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-holidays" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Feriados</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Adicionar Novo Feriado</h4>
                <div class="input-group">
                    <label for="holiday-date-input">Selecione a Data</label>
                    <input type="date" id="holiday-date-input" class="data-input">
                </div>
                <button id="add-holiday-btn" class="action-button"><i class="fa-solid fa-calendar-plus"></i>Adicionar Feriado</button>
                <p id="holiday-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Feriados Cadastrados</h4>
                <div id="holidays-list-container">
                    <!-- Lista de feriados será carregada aqui -->
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DE GERENCIAMENTO DE DOMINGOS DE TRABALHO -->
    <div id="sundays-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-sundays" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Domingos de Trabalho</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Adicionar Domingo de Trabalho</h4>
                <div class="input-group">
                    <label for="sunday-date-input">Selecione o Domingo</label>
                    <input type="date" id="sunday-date-input" class="data-input">
                </div>
                <button id="add-sunday-btn" class="action-button"><i class="fa-solid fa-calendar-plus"></i>Adicionar Domingo</button>
                <p id="sunday-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Domingos Cadastrados</h4>
                <div id="sundays-list-container">
                    <!-- Lista de domingos será carregada aqui -->
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

                <!-- TELA DE GERENCIAMENTO DE FOLGAS -->
    <div id="day-off-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-day-off" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Folgas</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Adicionar Folga</h4>
                 <div class="input-group">
                    <label for="day-off-employee-select">Selecione o Colaborador</label>
                    <select id="day-off-employee-select" class="data-input">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label for="day-off-date-input">Selecione a Data da Folga</label>
                    <input type="date" id="day-off-date-input" class="data-input">
                </div>
                <button id="add-day-off-btn" class="action-button"><i class="fa-solid fa-calendar-plus"></i>Adicionar Folga</button>
                <p id="day-off-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Folgas Agendadas</h4>
                <div id="days-off-list-container">
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

     <!-- TELA DE GERENCIAMENTO DE HORAS EXTRAS -->
    <div id="overtime-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-overtime" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Horas Extras</h2>
        </div>
        <div id="overtime-management-content" class="collaborator-content" style="flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: stretch; overflow-y: auto;">
            <!-- O JS vai popular esta área e o botão de salvar será adicionado aqui no final por ele -->
        </div>
    </div>

    <!-- TELA DE GERENCIAMENTO DE AVISOS GERAIS -->
    <div id="avisos-management-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-gs-from-avisos" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Gerenciar Avisos</h2>
        </div>
        <div class="collaborator-content" style="align-items: stretch;">
            <div class="employee-meta-card">
                <h4>Novo Aviso (dura 24h)</h4>
                <div class="input-group">
                    <label for="aviso-name">Seu Nome</label>
                    <input type="text" id="aviso-name" class="data-input" placeholder="Ex: Beatriz">
                </div>
                 <div class="input-group">
                    <label for="aviso-photo-upload">Imagem do Aviso</label>
                    <!-- O botão estilizado que o usuário vê -->
                    <button id="aviso-upload-btn" class="action-button full-width"><i class="fa-solid fa-upload"></i> Enviar Imagem</button>
                    <!-- O input de arquivo real, que fica escondido -->
                    <input type="file" id="aviso-photo-upload" accept="image/*" style="display: none;">
                    <p id="aviso-photo-status" class="status-message" style="margin-top: 0.5rem;"></p>
                </div>
                <div class="input-group">
                    <label for="aviso-text">Mensagem do Aviso</label>
                    <textarea id="aviso-text" class="data-input" rows="3" placeholder="Escreva o aviso aqui..."></textarea>
                </div>
                <button id="save-aviso-btn" class="action-button full-width"><i class="fa-solid fa-paper-plane"></i>Enviar Aviso</button>
                <p id="aviso-status-message" class="status-message"></p>
            </div>
            <div class="employee-meta-card">
                <h4>Avisos Ativos</h4>
                <div id="avisos-list-container">
                    <p style="text-align:center;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>


    <!-- TELA LOLLIPOP -->
    <div id="lollipop-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-send-device-from-lollipop" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2>Lollipop</h2>
            <!-- Botão para excluir tudo -->
            <button id="delete-all-lollipop-btn" class="action-button delete-button" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); width: auto; padding: 0.5rem 1rem; font-size: 0.8rem;">
                <i class="fa-solid fa-trash-can"></i> Excluir Tudo
            </button>
        </div>
        <div id="lollipop-grid" class="collaborator-content" style="flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: flex-start; gap: 1rem; overflow-y: auto;">
            <!-- Itens serão carregados aqui -->
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- TELAS DO MODO DE SEGURANÇA -->
    <!-- =================================================================== -->

    <!-- TELA DE SELEÇÃO DE CIDADE PARA SEGURANÇA -->
    <div id="security-city-selection-page" style="display: none;">
        <div class="collaborator-header">
            <h2>Menu Segurança</h2>
        </div>
        <div class="collaborator-content" style="justify-content: center; gap: 1.5rem;">
             <h3 class="modal-title" style="width: 100%; text-align: center;">Selecione sua Loja</h3>
             <!-- Adicionando a grade para alinhar os botões -->
             <div class="collaborator-actions-grid">
                <button id="security-btn-pinheiro" class="action-button">Pinheiro</button>
                <button id="security-btn-bacabal" class="action-button">Bacabal</button>
             </div>
        </div>
    </div>

    <!-- TELA DE PERFIL DO SEGURANÇA -->
    <div id="security-profile-page" style="display: none;">
        <div class="collaborator-header">
            <button id="back-to-security-selection" class="back-button"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h2 id="security-name-display">Nome do Segurança</h2>
        </div>
        <!-- Usando os IDs e classes que já têm estilo definido -->
        <div id="collaborator-profile-pic-container">
            <img id="security-profile-pic" src="" alt="Foto de Perfil" class="collaborator-profile-pic">
        </div>
        <div class="collaborator-content">
            <!-- Notificações e Timers do Ponto (com IDs únicos para o segurança) -->
            <div id="security-ponto-notification-area" style="width: 100%; max-width: 380px;"></div>
            <p id="security-ponto-countdown-timer" style="text-align: center; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); margin: 0; min-height: 20px;"></p>
            <p id="security-ponto-live-countdown" style="text-align: center; font-size: 1.1rem; font-weight: 600; color: #f1c40f; margin: 0; min-height: 25px;"></p>
            
            <!-- Adicionando a grade para alinhar os botões -->
            <div class="collaborator-actions-grid">
                 <a href="#" id="security-bater-ponto-btn" class="action-button"><i class="fa-solid fa-camera"></i><span>Digitar Ponto</span></a>
                 <a href="#" id="security-change-password-btn" class="action-button"><i class="fa-solid fa-key"></i><span>Alterar Senha</span></a>
                 <a href="#" id="security-change-photo-btn" class="action-button"><i class="fa-solid fa-camera-rotate"></i><span>Trocar Foto</span></a>
            </div>

            <input type="file" id="security-photo-upload-input" accept="image/*" style="display: none;">
            <p id="security-photo-upload-status" class="status-message"></p>
        </div>
    </div>


    <!-- Elementos Ocultos para Captura de Câmera -->
    <video id="capture-video-element" playsinline autoplay muted style="display: none;"></video>
    <canvas id="capture-canvas-element" style="display: none;"></canvas>


    <!-- =================================================================== -->
    <!-- SCRIPTS (CARREGADOS NA ORDEM CORRETA) -->
    <!-- =================================================================== -->

    <!-- 1. Scripts da biblioteca do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> <!-- ADICIONADO -->

    <!-- 2. Seu script principal -->
            <script>
    // --- VERSÃO DO APLICATIVO ---
                //2805
    const APP_VERSION = '1.7.4'; // Altere este número para atualizar a versão

    // Sua configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBxZ041My0mTu8CP9bDvEQ4K3p_wHBIF_c",
      authDomain: "loja-do-hunter-painel.firebaseapp.com",
      databaseURL: "https://loja-do-hunter-painel-default-rtdb.firebaseio.com",
      projectId: "loja-do-hunter-painel",
      storageBucket: "loja-do-hunter-painel.firebasestorage.app",
      messagingSenderId: "794925486853",
      appId: "1:794925486853:web:7b136eefd4a5d337605d6c"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage(); // INICIALIZA O STORAGE

    // --- CONSTANTE DE SENHA ---
    const PASSWORD = '123789';

    // Variáveis para guardar as instâncias dos gráficos e evitar duplicação
    let storeChartInstance = null;
    let employeeChartInstance = null;
    let monthlySalesChartInstance = null;
    let employeeGoalProgressChartInstance = null; // Variável para o novo gráfico
    let currentPontoAction = null; // Variável para controlar a ação de ponto atual
    let pontoCheckTimeout = null; // Timer para a próxima verificação de estado
    let countdownInterval = null; // Para controlar o timer da contagem regressiva

    // --- ESTADO DA APLICAÇÃO ---
    const allCollaborators = ['Beatriz', 'Marcio', 'Eliseu', 'Natalia', 'Tacilio', 'Demilson'];
    const securityGuards = { pinheiro: 'José Santana', bacabal: 'Leonardo Bezerra' };
    const allUsers = [...allCollaborators, ...Object.values(securityGuards)]; // Lista unificada para funções genéricas
    const managers = ['Beatriz', 'Natalia'];
    const storeMapping = {
        pinheiro: ['Beatriz', 'Marcio', 'Eliseu'],
        bacabal: ['Natalia', 'Tacilio', 'Demilson']
    };
    let currentUserName = ''; // Variável unificada para o usuário logado
    let currentBrand = '';
    let isNavigating = false; // Flag para prevenir cliques duplos durante animações
    let stockRequestSelection = []; // Array para guardar os itens solicitados
    let cameraStream = null; // Para controlar o stream da câmera
    let editingDeviceKey = null; // Para controlar se estamos editando ou criando um dispositivo
    let allDevicesCache = []; // Cache para a busca de aparelhos

    // --- ELEMENTOS DO DOM ---
    const mainContainer = document.querySelector('.mobile-container');
    const allPages = document.querySelectorAll('.page, .modal-overlay'); // Pega todas as "telas"

    // Adiciona a classe 'page' onde for necessário
    document.getElementById('ponto-page').classList.add('page');
    document.getElementById('ponto-verification-page').classList.add('page');
    document.getElementById('ponto-history-page').classList.add('page');
    document.getElementById('collaborator-page').classList.add('page');
    document.getElementById('security-city-selection-page').classList.add('page'); // ADICIONADO
    document.getElementById('security-profile-page').classList.add('page'); // ADICIONADO
    document.getElementById('gs-page').classList.add('page');
    document.getElementById('metas-config-page').classList.add('page');
    document.getElementById('metas-display-page').classList.add('page');
    document.getElementById('send-device-page').classList.add('page');
    document.getElementById('brand-devices-page').classList.add('page');
    document.getElementById('device-detail-page').classList.add('page');
    document.getElementById('manager-sales-panel-page').classList.add('page');
    document.getElementById('closing-page').classList.add('page');
    document.getElementById('correction-page').classList.add('page');
    document.getElementById('os-form-page').classList.add('page');
    document.getElementById('request-stock-page').classList.add('page');
    document.getElementById('recibos-page').classList.add('page');
    document.getElementById('quiz-page').classList.add('page');
    document.getElementById('crediario-calculator-page').classList.add('page');
    document.getElementById('site-calculator-page').classList.add('page');
    document.getElementById('loja-calculator-page').classList.add('page');
    document.getElementById('mt-display-page').classList.add('page');
    document.getElementById('mt-management-page').classList.add('page');
    document.getElementById('holidays-management-page').classList.add('page');
    document.getElementById('sundays-management-page').classList.add('page');
    document.getElementById('day-off-management-page').classList.add('page');
    document.getElementById('lollipop-page').classList.add('page');
    document.getElementById('device-search-overlay').classList.add('page');
    document.getElementById('avisos-management-page').classList.add('page'); // Nova página





    // Mapeia os elementos para fácil acesso
    const elements = {
        mainContainer: mainContainer,
        modal: document.getElementById('colaborador-modal'),
        collaboratorPage: document.getElementById('collaborator-page'),
        securityCitySelectionPage: document.getElementById('security-city-selection-page'), // ADICIONADO
        securityProfilePage: document.getElementById('security-profile-page'), // ADICIONADO
        gsPage: document.getElementById('gs-page'),
        metasConfigPage: document.getElementById('metas-config-page'),
        metasDisplayPage: document.getElementById('metas-display-page'),
        sendDevicePage: document.getElementById('send-device-page'),
        brandDevicesPage: document.getElementById('brand-devices-page'),
        deviceDetailPage: document.getElementById('device-detail-page'),
        managerSalesPanelPage: document.getElementById('manager-sales-panel-page'),
        closingPage: document.getElementById('closing-page'),
        correctionPage: document.getElementById('correction-page'),
        suporteModal: document.getElementById('suporte-modal'),
        osModal: document.getElementById('os-modal'),
        osFormPage: document.getElementById('os-form-page'),
        requestStockPage: document.getElementById('request-stock-page'),
        recibosPage: document.getElementById('recibos-page'),
       quizPage: document.getElementById('quiz-page'), // Nova página
        crediarioCalculatorPage: document.getElementById('crediario-calculator-page'),
        siteCalculatorPage: document.getElementById('site-calculator-page'),
        lojaCalculatorPage: document.getElementById('loja-calculator-page'),
        mtDisplayPage: document.getElementById('mt-display-page'),
        mtManagementPage: document.getElementById('mt-management-page'),
        holidaysManagementPage: document.getElementById('holidays-management-page'),
        sundaysManagementPage: document.getElementById('sundays-management-page'),
        dayOffManagementPage: document.getElementById('day-off-management-page'),
        overtimeManagementPage: document.getElementById('overtime-management-page'),
        lollipopPage: document.getElementById('lollipop-page'),
        pontoPage: document.getElementById('ponto-page'),
        pontoVerificationPage: document.getElementById('ponto-verification-page'),
        pontoHistoryPage: document.getElementById('ponto-history-page'),
        searchOverlay: document.getElementById('search-overlay'),
        themeModal: document.getElementById('theme-modal'),
        deviceSearchOverlay: document.getElementById('device-search-overlay'),
        avisosManagementPage: document.getElementById('avisos-management-page'), // Nova página
    };    
    // --- LÓGICA DE NAVEGAÇÃO E ANIMAÇÃO (REFEITA DO ZERO) ---
    function staggerAnimate(container) {
        const items = container.querySelectorAll('.brand-button, .tool-item, .device-card, .modal-btn, .action-button');
        items.forEach((item, index) => {
            item.style.animationDelay = `${index * 40}ms`;
        });
    }

    function showScreen(screenElement) {
        if (isNavigating) return;
        isNavigating = true;

        const currentScreen = document.querySelector('.visible');

        const transitionEnd = () => {
            isNavigating = false;
        };

        if (currentScreen) {
            currentScreen.classList.add('is-exiting');
            currentScreen.addEventListener('animationend', () => {
                currentScreen.classList.remove('visible', 'is-exiting');
                screenElement.style.display = (screenElement === mainContainer) ? 'block' : 'flex';
                requestAnimationFrame(() => {
                    screenElement.classList.add('visible');
                    staggerAnimate(screenElement);
                    transitionEnd();
                });
            }, { once: true });
        } else {
            // Nenhuma tela visível, apenas mostra a nova
            screenElement.style.display = (screenElement === mainContainer) ? 'block' : 'flex';
            requestAnimationFrame(() => {
                screenElement.classList.add('visible');
                staggerAnimate(screenElement);
                transitionEnd();
            });
        }
    }

        const loadMaintenanceModeStatus = () => {
        const checkbox = document.getElementById('maintenance-mode-toggle');
        const statusEl = document.getElementById('maintenance-status-message');
        if (!checkbox) return; // Garante que não dê erro se a função for chamada em outra tela
        
        statusEl.textContent = ''; // Limpa o status anterior
        database.ref('globalSettings/isMaintenanceMode').get().then(snapshot => {
            checkbox.checked = snapshot.exists() && snapshot.val() === true;
        });
    };

    const checkAndDisplayMaintenanceNotice = () => {
        const noticeArea = document.getElementById('maintenance-notice-area');
        if (!noticeArea) return;

        database.ref('globalSettings/isMaintenanceMode').get().then(snapshot => {
            if (snapshot.exists() && snapshot.val() === true) {
                noticeArea.style.display = 'block';
            } else {
                noticeArea.style.display = 'none';
            }
        });
    };

                // --- FUNÇÕES DE BACKUP DE DADOS (Movidas para dentro do DOMContentLoaded) ---
    
            // Função principal que coleta e formata todos os dados em um texto
            const generateBackupText = async () => {
                try {
                    const [salesSnapshot, metasSnapshot, profilesSnapshot] = await Promise.all([
                        database.ref('salesData').get(),
                        database.ref('metas').get(),
                        database.ref('userProfiles').get()
                    ]);

                    const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
                    const metasData = metasSnapshot.exists() ? metasSnapshot.val() : {};
                    const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};

                    const now = new Date();
                    let backupString = `BACKUP DE DADOS - LOJA DO HUNTER\n`;
                    backupString += `Data e Hora: ${now.toLocaleString('pt-BR')}\n`;
                    backupString += `=========================================\n\n`;

                    allCollaborators.forEach(name => {
                        const key = name.toLowerCase();
                        const sales = salesData[key] || {};
                        const metas = metasData[key] || {};
                        const profile = profilesData[key] || {};

                        backupString += `--- ${name} ---\n`;
                        
                        // Dados de Vendas
                        backupString += `  Vendas: ${formatBRL(sales.vendas || 0)}\n`;
                        backupString += `  P1/P2: ${formatBRL(sales.p1p2 || 0)}\n`;
                        backupString += `  Seguro: ${sales.seguro || 0}\n`;
                        backupString += `  Cartão: ${sales.cartao || 0}\n\n`;

                        // Metas e Premiações
                        backupString += `  Meta Venda: ${formatBRL(metas.venda || 0)}\n`;
                        if(managers.includes(name)) {
                            backupString += `  Meta Loja: ${formatBRL(metas.metaLoja || 0)}\n`;
                        }
                        backupString += `  Meta Seguro: ${metas.seguro || 0}\n`;
                        backupString += `  Meta P1 50%: ${formatBRL(metas.p1 || 0)}\n`;
                        backupString += `  Meta Cartão: ${metas.cartao || 0}\n`;
                        backupString += `  Prêmio P1/P2: ${formatBRL(metas.premioP1P2 || 0)}\n`;
                        backupString += `  Prêmio Seguro: ${formatBRL(metas.premioSeguro || 0)}\n`;
                        backupString += `  Prêmio Cartão 2%+: ${formatBRL(metas.premioCartao || 0)}\n\n`;
                        
                        // Horas Extras
                        const overtimeMinutes = profile.overtimeMinutes || 0;
                        const hours = Math.floor(overtimeMinutes / 60);
                        const minutes = overtimeMinutes % 60;
                        const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        backupString += `  Horas Extras Acumuladas: ${formattedTime}\n`;

                        backupString += `-----------------------------------------\n\n`;
                    });

                    return backupString;

                } catch (error) {
                    console.error("Erro ao gerar backup:", error);
                    alert("Ocorreu um erro ao gerar o backup. Verifique sua conexão e tente novamente.");
                    return null;
                }
            };

            // Função para baixar o backup como um arquivo .txt
            const handleSaveBackup = async () => {
                alert('Gerando arquivo de backup... Por favor, aguarde.');
                const textContent = await generateBackupText();
                if (!textContent) return;

                const filename = `backup_loja_hunter_${getTodayDateString()}.txt`;
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            // Função para processar e restaurar dados de um arquivo de backup
            const handleRestoreBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    try {
                        const newSalesData = {};
                        
                        // Encontra todos os blocos de dados de colaboradores no texto
                        const collaboratorBlocks = text.split('---').slice(1); // Divide por '---' e remove o cabeçalho

                        collaboratorBlocks.forEach(block => {
                            // Extrai o nome do colaborador
                            const nameMatch = block.match(/^\s*([\w\s]+)\s*\n/);
                            if (!nameMatch) return;
                            
                            const name = nameMatch[1].trim();
                            const key = name.toLowerCase();

                            // Extrai os valores usando expressões regulares (mais robusto)
                            const vendasMatch = block.match(/Vendas:\s*R\$\s*([\d.,]+)/);
                            const p1p2Match = block.match(/P1\/P2:\s*R\$\s*([\d.,]+)/);
                            const seguroMatch = block.match(/Seguro:\s*(\d+)/);
                            const cartaoMatch = block.match(/Cartão:\s*(\d+)/);

                            // Converte os valores extraídos para o formato numérico correto
                            const vendas = vendasMatch ? parseFromBRLInput(vendasMatch[1]) : 0;
                            const p1p2 = p1p2Match ? parseFromBRLInput(p1p2Match[1]) : 0;
                            const seguro = seguroMatch ? parseInt(seguroMatch[1], 10) : 0;
                            const cartao = cartaoMatch ? parseInt(cartaoMatch[1], 10) : 0;

                            // Adiciona ao objeto que será salvo no Firebase
                            newSalesData[key] = { vendas, p1p2, seguro, cartao };
                        });

                        if (Object.keys(newSalesData).length === 0) {
                            alert('Nenhum dado válido encontrado no arquivo de backup.');
                            return;
                        }

                        if (confirm('Dados do backup foram lidos. Deseja substituir os dados atuais no Firebase com estes dados? ESSA AÇÃO NÃO PODE SER DESFEITA.')) {
                            database.ref('salesData').set(newSalesData)
                                .then(() => {
                                    alert('Backup restaurado com sucesso! Os dados foram atualizados.');
                                    // Recarrega os dados na tela para refletir a restauração
                                    loadDashboardData();
                                    buildAndLoadCorrectionPage();
                                })
                                .catch(error => {
                                    alert('Erro ao restaurar o backup.');
                                    console.error(error);
                                });
                        }

                    } catch (error) {
                        alert('Erro ao processar o arquivo de backup. Verifique o formato do arquivo.');
                        console.error(error);
                    } finally {
                        // Limpa o valor do input para permitir o upload do mesmo arquivo novamente
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            };

            // Listeners para os botões de backup
            document.getElementById('save-backup-btn').addEventListener('click', handleSaveBackup);
            // Aciona o input de arquivo quando o botão de restaurar é clicado
            document.getElementById('restore-backup-btn').addEventListener('click', () => {
                document.getElementById('backup-file-input').click();
            });
            // Lê e processa o arquivo quando ele é selecionado
            document.getElementById('backup-file-input').addEventListener('change', handleRestoreBackup);

    const loadAndDisplayAvisos = async () => {
        const container = document.getElementById('avisos-container');
        const section = document.getElementById('avisos-gerais');
        container.innerHTML = ''; // Limpa antes de carregar

        try {
            const snapshot = await database.ref('avisosGerais').get();
            if (!snapshot.exists()) {
                section.style.display = 'none';
                return;
            }

            const avisos = snapshot.val();
            const activeAvisos = [];
            const now = new Date();

            for (const key in avisos) {
                const aviso = avisos[key];
                const avisoTimestamp = new Date(aviso.timestamp);
                const hoursDiff = (now - avisoTimestamp) / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    activeAvisos.push(aviso);
                }
            }
            
            if(activeAvisos.length > 0) {
                activeAvisos.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); // Mais recente primeiro
                
                activeAvisos.forEach(aviso => {
                    const card = document.createElement('div');
                    card.className = 'aviso-card';
                    card.innerHTML = `
                        <img src="${aviso.photoURL}" class="aviso-photo" alt="Foto de ${aviso.name}">
                        <div class="aviso-content">
                            <div class="aviso-name">${aviso.name}</div>
                            <div class="aviso-text">${aviso.text}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }

        } catch (error) {
            console.error("Erro ao carregar avisos:", error);
            section.style.display = 'none';
        }
    };

    const loadAndManageAvisos = async () => {
        const listContainer = document.getElementById('avisos-list-container');
        listContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        try {
            const snapshot = await database.ref('avisosGerais').get();
            listContainer.innerHTML = '';
            
            if (!snapshot.exists()) {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhum aviso ativo.</p>`;
                return;
            }

            const avisos = snapshot.val();
            const activeAvisos = [];
            const now = new Date();

            for (const key in avisos) {
                const aviso = avisos[key];
                const avisoTimestamp = new Date(aviso.timestamp);
                const hoursDiff = (now - avisoTimestamp) / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    activeAvisos.push({ key, ...aviso });
                }
            }

            if(activeAvisos.length === 0) {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhum aviso ativo.</p>`;
                return;
            }

            activeAvisos.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            activeAvisos.forEach(aviso => {
                const listItem = document.createElement('div');
                listItem.className = 'mt-list-item'; // Reutilizando estilo
                listItem.innerHTML = `
                    <img src="${aviso.photoURL}" class="ponto-history-photo" style="width: 40px; height: 40px; margin-right: 1rem;">
                    <div class="mt-list-item-text">
                        <strong>${aviso.name}:</strong> ${aviso.text}
                    </div>
                    <button class="delete-button-small" data-key="${aviso.key}">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                listContainer.appendChild(listItem);
            });
        } catch (error) {
            console.error("Erro ao gerenciar avisos:", error);
            listContainer.innerHTML = `<p style="text-align:center;">Erro ao carregar avisos.</p>`;
        }
    };

    const saveAviso = (photoURL) => {
        const name = document.getElementById('aviso-name').value.trim();
        const text = document.getElementById('aviso-text').value.trim();
        const statusEl = document.getElementById('aviso-status-message');

        if (!name || !photoURL || !text) {
            statusEl.textContent = 'Nome, Imagem e Mensagem são obrigatórios!';
            // Re-habilita o botão em caso de erro de validação
            document.getElementById('save-aviso-btn').disabled = false;
            document.getElementById('save-aviso-btn').style.opacity = '1';
            return;
        }

        statusEl.textContent = 'Salvando aviso...';

        const newAviso = {
            name,
            photoURL,
            text,
            timestamp: new Date().toISOString()
        };

        database.ref('avisosGerais').push(newAviso)
            .then(() => {
                statusEl.textContent = 'Aviso enviado com sucesso!';
                document.getElementById('aviso-name').value = '';
                document.getElementById('aviso-text').value = '';
                document.getElementById('aviso-photo-status').textContent = '';
                document.getElementById('aviso-photo-upload').value = ''; // Limpa o input de arquivo
                loadAndManageAvisos(); // Recarrega a lista de avisos na página de gerenciamento
                loadAndDisplayAvisos(); // Recarrega os avisos na tela principal
                setTimeout(() => { 
                    statusEl.textContent = '';
                    document.getElementById('save-aviso-btn').disabled = false;
                    document.getElementById('save-aviso-btn').style.opacity = '1';
                }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao enviar aviso.';
                console.error(error);
            });
    };
    
    const deleteAviso = (key) => {
        if (confirm('Tem certeza que deseja apagar este aviso?')) {
            database.ref(`avisosGerais/${key}`).remove()
                .then(() => {
                    alert('Aviso apagado.');
                    loadAndManageAvisos();
                    loadAndDisplayAvisos();
                })
                .catch(error => {
                    alert('Erro ao apagar o aviso.');
                    console.error(error);
                });
        }
    };

            // --- INICIALIZAÇÃO DA APLICAÇÃO ---
            showMainPage();
            calculateAndDisplayRanking(); // Carrega o ranking de colaboradores
            calculateAndDisplayStoreRanking(); // Carrega o ranking de lojas
            loadAndDisplayAvisos(); // Carrega os avisos na tela principal
            loadManagerNotifications(); // Carrega notificações para o gerente na inicialização
            loadAndDisplayOvertime(); // Carrega as horas extras no GS na inicialização

            // Exibe a versão do app no rodapé
            document.getElementById('app-version-display').textContent = `Versão ${APP_VERSION}`;
    
    // Funções de atalho para a navegação
    function showPage(pageKey) {
        showScreen(elements[pageKey]);
    }
    function showMainPage() {
        showScreen(mainContainer);
    }

    // --- FUNÇÕES DA MODAL (ADAPTADAS PARA A NOVA NAVEGAÇÃO) ---
    const openModal = () => {
        const modal = elements.modal;
        if(isNavigating) return;
        isNavigating = true;
        
        document.getElementById('colaborador-cidades').style.display = 'block';
        document.getElementById('colaborador-pinheiro').style.display = 'none';
        document.getElementById('colaborador-bacabal').style.display = 'none';
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            staggerAnimate(modal);
            isNavigating = false;
        });
    };

        const closeModal = (onClosedCallback) => {
        const modal = elements.modal;
        if (isNavigating || !modal.classList.contains('visible')) return;
        isNavigating = true;

        // Adiciona a classe que dispara a animação de SAÍDA.
        modal.classList.add('is-exiting');

        // Escuta o fim da ANIMAÇÃO no próprio modal-overlay. Esta é a animação principal.
        modal.addEventListener('animationend', (e) => {
            // ESSA VERIFICAÇÃO É CRUCIAL.
            // Garante que estamos reagindo ao fim da animação do 'modal-overlay'
            // e não de alguma outra animação interna que possa ter acontecido.
            if (e.target === modal) {
                // Esconde o modal completamente e limpa todas as classes.
                modal.style.display = 'none';
                modal.classList.remove('visible', 'is-exiting');
                isNavigating = false;

                // Executa a função de callback, que irá abrir a página do colaborador.
                if (typeof onClosedCallback === 'function') {
                    onClosedCallback();
                }
            }
        }, { once: true });
    };

    // --- FUNÇÃO DE VERIFICAÇÃO DE SENHA ---
    const checkPassword = () => {
        const userInput = prompt("Por favor, digite a senha de acesso:");
        if (userInput === null) return false;
        if (userInput === PASSWORD) return true;
        alert("Senha incorreta!");
        return false;
    };
    
    // --- FUNÇÕES AUXILIARES DE FORMATAÇÃO DE MOEDA ---
    const formatToBRLInput = (value) => {
      const num = parseFloat(value) || 0;
      return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const parseFromBRLInput = (value) => {
  if (!value || typeof value !== 'string') return 0;
  // Ex: "1.234,56" -> "1234,56" -> "1234.56" -> 1234.56
  const num = parseFloat(value.replace(/\./g, '').replace(',', '.'));
  return isNaN(num) ? 0 : num;
};




    // --- DEMAIS FUNÇÕES (SEM ALTERAÇÃO NA LÓGICA INTERNA) ---
    // As funções loadgsData e savegsData foram removidas pois se tornaram obsoletas
    // com a implementação do novo Dashboard e da página de Configurações Gerais.
            const buildAndLoadMetasPage = () => {
        const container = document.getElementById('metas-content-container');
        container.innerHTML = `<p style="text-align: center;">Carregando dados...</p>`;

        database.ref('metas').get().then(metasSnapshot => {
            const allMetas = metasSnapshot.exists() ? metasSnapshot.val() : {};
            container.innerHTML = '';

            allCollaborators.forEach(name => {
                const key = name.toLowerCase();
                const metasData = allMetas[key] || {};
                
                let managerMetaField = '';
                if (managers.includes(name)) {
                    managerMetaField = `
                        <div class="input-group" style="background-color: rgba(255,107,0,0.1); padding: 0.5rem; border-radius: 8px;">
                           <label for="metaLoja-${key}" style="font-weight: 700; color: #FF6B00;">🎯 META DA LOJA (R$)</label>
                           <input type="text" id="metaLoja-${key}" class="data-input" value="${formatToBRLInput(metasData.metaLoja)}">
                        </div>
                    `;
                }
                
                container.innerHTML += `
                    <div class="employee-meta-card">
                        <h4>Metas e Prêmios: ${name}</h4>
                        ${managerMetaField}
                        <div class="meta-group-title">Metas</div>
                        <div class="input-group"><label for="venda-${key}">📈 Venda (R$)</label><input type="text" id="venda-${key}" class="data-input" value="${formatToBRLInput(metasData.venda)}"></div>
                        <div class="input-group"><label for="seguro-${key}">🔧 Seguro</label><input type="number" id="seguro-${key}" class="data-input" value="${metasData.seguro || ''}"></div>
                        <div class="input-group"><label for="p1-${key}">🔱 P1 50% (R$)</label><input type="text" id="p1-${key}" class="data-input" value="${formatToBRLInput(metasData.p1)}"></div>
                        <div class="input-group"><label for="cartao-${key}">💳 Cartão</label><input type="number" id="cartao-${key}" class="data-input" value="${metasData.cartao || ''}"></div>
                        <div class="meta-group-title">Premiações 💰</div>
                        <div class="input-group"><label for="premio-p1p2-${key}">P1/P2 50% (R$)</label><input type="text" id="premio-p1p2-${key}" class="data-input" value="${formatToBRLInput(metasData.premioP1P2)}"></div>
                        <div class="input-group"><label for="premio-seguro-${key}">Seguro (R$)</label><input type="text" id="premio-seguro-${key}" class="data-input" value="${formatToBRLInput(metasData.premioSeguro)}"></div>
                        <div class="input-group"><label for="premio-cartao-${key}">Cartão 2%+ (R$)</label><input type="text" id="premio-cartao-${key}" class="data-input" value="${formatToBRLInput(metasData.premioCartao)}"></div>
                    </div>`;
            });

            // Adiciona o botão de salvar e o status ao final do container
            container.innerHTML += `
                <button id="save-all-metas" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Todas as Metas</button>
                <p id="metas-status-message" class="status-message"></p>
            `;
            // Reatribui o listener ao novo botão
            document.getElementById('save-all-metas').addEventListener('click', saveAllMetas);
        });
    };
        const saveAllMetas = () => {
        const statusMessage = document.getElementById('metas-status-message');
        statusMessage.textContent = 'Salvando dados...';
        const metasDataToSave = {};

        allCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const data = {
                venda: parseFromBRLInput(document.getElementById(`venda-${key}`).value),
                seguro: document.getElementById(`seguro-${key}`).value,
                p1: parseFromBRLInput(document.getElementById(`p1-${key}`).value),
                cartao: document.getElementById(`cartao-${key}`).value,
                premioP1P2: parseFromBRLInput(document.getElementById(`premio-p1p2-${key}`).value),
                premioSeguro: parseFromBRLInput(document.getElementById(`premio-seguro-${key}`).value),
                premioCartao: parseFromBRLInput(document.getElementById(`premio-cartao-${key}`).value),
            };

            // Se for gerente, salva também a meta da loja
            if (managers.includes(name)) {
                const metaLojaInput = document.getElementById(`metaLoja-${key}`);
                if (metaLojaInput) {
                    data.metaLoja = parseFromBRLInput(metaLojaInput.value);
                }
            }
            
            metasDataToSave[key] = data;
        });

        database.ref('metas').set(metasDataToSave).then(() => {
            statusMessage.textContent = 'Todos os dados foram salvos!';
        }).catch((error) => {
            statusMessage.textContent = 'Erro ao salvar os dados!';
            console.error(error);
        });
    };
    const loadAndDisplayCollaboratorMetas = () => {
        const container = document.getElementById('metas-display-content');
        const key = currentUserName.toLowerCase(); // CORREÇÃO AQUI
        container.innerHTML = `<p>Carregando suas metas...</p>`;
        database.ref(`metas/${key}`).get().then(snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                container.innerHTML = `
                    <h3>METAS</h3>
                    <p><strong>📈 VENDA:</strong> ${formatBRL(data.venda)}</p>
                    <p><strong>🔧 SEGURO:</strong> ${data.seguro || 0}</p>
                    <p><strong>🔱 P1 50%:</strong> ${formatBRL(data.p1)}</p>
                    <p><strong>💳 CARTÃO:</strong> ${data.cartao || 0}</p>
                    <br>
                    <h3>PREMIAÇÕES 💰💰💰</h3>
                    <p><strong>1% SOBRE A VENDA</strong></p>
                    <p><strong>P1/P2 50%:</strong> ${formatBRL(data.premioP1P2)}</p>
                    <p><strong>SEGURO:</strong> ${formatBRL(data.premioSeguro)}</p>
                    <p><strong>CARTÃO 2%+:</strong> ${formatBRL(data.premioCartao)}</p>
                `;
            } else {
                container.innerHTML = `<p>Nenhuma meta foi configurada para você ainda.</p>`;
            }
        });
    };
    const resetSendDeviceForm = () => {
        document.querySelector('#send-device-page h2').textContent = 'Enviar Novo Dispositivo';
        document.getElementById('save-device-btn').textContent = 'Salvar Dispositivo';
        document.getElementById('send-device-page').querySelectorAll('input, textarea, select').forEach(el => {
            if (el.tagName !== 'SELECT') el.value = '';
            else el.selectedIndex = 0;
        });
        document.getElementById('send-device-status').textContent = '';
        editingDeviceKey = null;
    };

    const saveDevice = () => {
        const statusEl = document.getElementById('send-device-status');
        const brand = document.getElementById('device-brand').value;
        const name = document.getElementById('device-name').value.trim();
        const imageUrl = document.getElementById('device-image-url').value.trim();
        const techSpecs = document.getElementById('device-tech-specs').value.trim();

        if (!brand || !name || !imageUrl || !techSpecs) {
            statusEl.textContent = 'Marca, Nome, URL da Imagem e Ficha Técnica são obrigatórios!';
            return;
        }
        statusEl.textContent = 'Salvando...';

        const deviceData = {
            name,
            imageUrl,
            techSpecs,
            priceTable: document.getElementById('device-price-table').value.trim(),
            insuranceTable: document.getElementById('device-insurance-table').value.trim()
        };

        if (editingDeviceKey) {
            // --- MODO DE ATUALIZAÇÃO ---
            const keyToUpdate = editingDeviceKey;
            database.ref(`devices/${brand}/${keyToUpdate}`).update(deviceData).then(() => {
                statusEl.textContent = 'Dispositivo atualizado com sucesso!';
                setTimeout(() => {
                    resetSendDeviceForm();
                    // Retorna para a página de detalhes do dispositivo editado
                    loadDeviceDetails(keyToUpdate);
                }, 1500);
            }).catch((error) => {
                statusEl.textContent = 'Erro ao atualizar!';
                console.error(error);
            });
        } else {
            // --- MODO DE CRIAÇÃO ---
            database.ref(`devices/${brand}`).push(deviceData).then(() => {
                statusEl.textContent = 'Dispositivo salvo com sucesso!';
                resetSendDeviceForm();
            }).catch((error) => {
                statusEl.textContent = 'Erro ao salvar!';
                console.error(error);
            });
        }
    };
    const renderDeviceSearchResults = (devices, filterText = '') => {
        const grid = document.getElementById('device-search-results-grid');
        grid.innerHTML = '';

        const normalizedFilter = filterText.toLowerCase().trim();
        const filteredDevices = devices.filter(device => 
            device.name.toLowerCase().includes(normalizedFilter)
        );

        if (filteredDevices.length === 0) {
            grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Nenhum aparelho encontrado.</p>';
            return;
        }

        filteredDevices.forEach(device => {
            const card = document.createElement('div');
            card.className = 'device-card';
            // Adicionamos data attributes para podermos buscar os dados ao clicar
            card.dataset.key = device.key;
            card.dataset.brand = device.brand;
            card.innerHTML = `<img src="${device.imageUrl}" alt="${device.name}"><span>${device.name}</span>`;
            grid.appendChild(card);
        });
    };

    const openDeviceSearch = () => {
        const grid = document.getElementById('device-search-results-grid');
        grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Carregando todos os aparelhos...</p>';
        document.getElementById('device-search-input').value = '';
        showPage('deviceSearchOverlay');

        // Se já tivermos os dados em cache, usamos eles
        if (allDevicesCache.length > 0) {
            renderDeviceSearchResults(allDevicesCache);
            return;
        }
        
        // Se não, buscamos no Firebase
        database.ref('devices').get().then(snapshot => {
            allDevicesCache = []; // Limpa o cache antes de preencher
            if (snapshot.exists()) {
                snapshot.forEach(brandSnapshot => {
                    const brand = brandSnapshot.key;
                    const devices = brandSnapshot.val();
                    for (const key in devices) {
                        allDevicesCache.push({
                            key: key,
                            brand: brand,
                            ...devices[key]
                        });
                    }
                });
            }
            renderDeviceSearchResults(allDevicesCache);
        }).catch(error => {
            grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Erro ao carregar aparelhos.</p>';
            console.error("Erro ao buscar todos os aparelhos:", error);
        });
    };

    const loadBrandDevices = (brand) => {
        currentBrand = brand;
        document.getElementById('brand-page-title').textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
        const grid = document.getElementById('brand-devices-grid');
        grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Carregando dispositivos...</p>';
        showPage('brandDevicesPage');
        database.ref(`devices/${brand}`).once('value', snapshot => {
            grid.innerHTML = '';
            if (snapshot.exists()) {
                const devices = snapshot.val();
                Object.keys(devices).forEach(key => {
                    const device = devices[key];
                    const card = document.createElement('div');
                    card.className = 'device-card';
                    card.innerHTML = `<img src="${device.imageUrl}" alt="${device.name}"><span>${device.name}</span>`;
                    // A chamada agora passa a marca, que já está na variável global 'currentBrand'
                    card.addEventListener('click', () => loadDeviceDetails(key, currentBrand));
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<p style="padding: 1rem; text-align: center; width: 100%;">Nenhum dispositivo cadastrado para esta marca.</p>';
            }
            staggerAnimate(grid.parentElement);
        });
    };
    
    // Função modificada para aceitar a marca como parâmetro
    const loadDeviceDetails = (key, brand) => {
        currentBrand = brand; // Atualiza a marca atual para o botão de voltar funcionar
        database.ref(`devices/${brand}/${key}`).once('value', snapshot => {
            if (!snapshot.exists()) {
                alert('Este dispositivo não foi encontrado. Pode ter sido excluído.');
                // Tenta voltar para a página de marcas, se a marca for válida
                if (brand) {
                    loadBrandDevices(brand);
                } else {
                    showMainPage();
                }
                return;
            }
            const device = snapshot.val();
            document.getElementById('device-detail-title').textContent = device.name;
            const contentContainer = document.getElementById('device-detail-content');

            contentContainer.innerHTML = `
                <img src="${device.imageUrl}" alt="${device.name}">
                <h3>💰 Tabela de Preços</h3><pre>${device.priceTable || 'Não informado.'}</pre>
                <h3>🔧 Seguro Opcional</h3><pre>${device.insuranceTable || 'Não informado.'}</pre>
                <h3>⚙️ Ficha Técnica</h3><pre>${device.techSpecs || 'Não informado.'}</pre>
                <button id="edit-device-btn" class="action-button" style="margin-top: 1rem; background-color: #2980b9;"><i class="fa-solid fa-pencil"></i> Editar Dispositivo</button>
                <button id="delete-device-btn" class="action-button delete-button"><i class="fa-solid fa-trash-can"></i> Deletar Dispositivo</button>
            `;
            
            showPage('deviceDetailPage');
            
            // Adiciona os listeners DEPOIS que a página é mostrada e o conteúdo existe
            document.getElementById('edit-device-btn').addEventListener('click', () => editDevice(key));
            document.getElementById('delete-device-btn').addEventListener('click', () => deleteDevice(key));
            // O botão de voltar da página de detalhes também é configurado aqui
            document.getElementById('back-to-brand-from-detail').addEventListener('click', () => showPage('brandDevicesPage'));
        });
    };
    const deleteDevice = (key) => {
        if (!checkPassword()) return;
        if (!confirm('Tem certeza?')) return;
        database.ref(`devices/${currentBrand}/${key}`).remove()
            .then(() => { alert('Deletado!'); loadBrandDevices(currentBrand); })
            .catch(() => { alert('Erro ao deletar.'); });
    };

    const editDevice = (key) => {
        editingDeviceKey = key; // Define a chave global para o modo de edição
        database.ref(`devices/${currentBrand}/${key}`).once('value', snapshot => {
            if (snapshot.exists()) {
                const device = snapshot.val();
                
                // Muda a UI para o modo de edição
                document.querySelector('#send-device-page h2').textContent = 'Editar Dispositivo';
                document.getElementById('save-device-btn').textContent = 'Salvar Alterações';

                // Preenche o formulário com os dados existentes
                document.getElementById('device-brand').value = currentBrand;
                document.getElementById('device-name').value = device.name;
                document.getElementById('device-image-url').value = device.imageUrl;
                document.getElementById('device-tech-specs').value = device.techSpecs || '';
                document.getElementById('device-price-table').value = device.priceTable || '';
                document.getElementById('device-insurance-table').value = device.insuranceTable || '';

                showPage('sendDevicePage');
            } else {
                alert('Dispositivo não encontrado. Pode ter sido deletado.');
                editingDeviceKey = null; // Reseta caso não encontre
            }
        });
    };

    const loadDashboardData = () => {
        Promise.all([
            database.ref('salesData').get(),
            database.ref('monthlySales').get(),
            database.ref('metas').get() // CORREÇÃO: Adiciona a busca pelos dados de metas.
        ]).then(([salesSnapshot, monthlySnapshot, metasSnapshot]) => { // CORREÇÃO: Adiciona o snapshot de metas.
            const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
            const monthlyData = monthlySnapshot.exists() ? monthlySnapshot.val() : {};
            const metasData = metasSnapshot.exists() ? metasSnapshot.val() : {}; // CORREÇÃO: Define a variável metasData.

            // --- Cálculos de Vendas Gerais e por Loja ---
            let totalVendas = 0, vendasPinheiro = 0, vendasBacabal = 0;

            // Itera sobre TODOS os colaboradores para obter os totais corretos.
            allCollaborators.forEach(name => {
                const key = name.toLowerCase();
                const venda = parseFloat(salesData[key]?.vendas || 0);
                totalVendas += venda; // Soma para o total geral

                if (storeMapping.pinheiro.includes(name)) {
                    vendasPinheiro += venda;
                } else if (storeMapping.bacabal.includes(name)) {
                    vendasBacabal += venda;
                }
            });

            // --- Cálculo do Melhor VENDEDOR (apenas entre não-gerentes) ---
            const nonManagerCollaborators = allCollaborators.filter(name => !managers.includes(name));
            let melhorVendedor = { nome: 'N/A', vendas: 0 };
            nonManagerCollaborators.forEach(name => {
                const key = name.toLowerCase();
                const venda = parseFloat(salesData[key]?.vendas || 0);
                if (venda > melhorVendedor.vendas) {
                    melhorVendedor = { nome: name, vendas: venda };
                }
            });

            const melhorLoja = vendasPinheiro > vendasBacabal ? 'Pinheiro' : 'Bacabal';

            // --- Atualização do DOM (KPIs) ---
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('total-vendas-kpi').textContent = formatCurrency(totalVendas);
            document.getElementById('pinheiro-vendas-kpi').textContent = formatCurrency(vendasPinheiro);
            document.getElementById('bacabal-vendas-kpi').textContent = formatCurrency(vendasBacabal);
            document.getElementById('melhor-loja-kpi').textContent = melhorLoja;
            document.getElementById('melhor-vendedor-kpi').textContent = melhorVendedor.nome;

            // --- Renderização dos Gráficos e Listas ---
            renderStoreChart(vendasPinheiro, vendasBacabal);
            renderEmployeeGoalProgressChart(salesData, metasData); // Agora esta chamada funciona corretamente.
            renderEmployeeChart(salesData);
            renderMonthlySalesChart(monthlyData);
        });
    };


    const renderMonthlySalesChart = (monthlyData) => {
        const ctx = document.getElementById('monthly-sales-chart').getContext('2d');
        const sortedMonths = Object.keys(monthlyData).sort(); // Ordem cronológica para o gráfico

        const labels = sortedMonths;
        const data = sortedMonths.map(month => monthlyData[month].totalVendas);

        if (monthlySalesChartInstance) {
            monthlySalesChartInstance.destroy();
        }
        monthlySalesChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Vendas Mensais',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(41, 128, 185, 0.2)',
                    borderColor: 'rgba(41, 128, 185, 1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: { 
                    x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const renderStoreChart = (vendasPinheiro, vendasBacabal) => {
        const ctx = document.getElementById('store-sales-chart').getContext('2d');
        if (storeChartInstance) {
            storeChartInstance.destroy(); // Destroi o gráfico anterior para evitar sobreposição
        }
        storeChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Pinheiro', 'Bacabal'],
                datasets: [{
                    label: 'Vendas por Loja',
                    data: [vendasPinheiro, vendasBacabal],
                    backgroundColor: ['rgba(255, 107, 0, 0.8)', 'rgba(41, 128, 185, 0.8)'],
                    borderColor: ['#FF6B00', '#2980b9'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });
    };

    const renderEmployeeGoalProgressChart = (salesData, metasData) => {
        const ctx = document.getElementById('employee-goal-progress-chart').getContext('2d');
        
        // 1. Calcular a porcentagem da meta para cada funcionário
        const goalProgress = allCollaborators.map(name => {
            const key = name.toLowerCase();
            const sales = parseFloat(salesData[key]?.vendas || 0);
            const goal = parseFloat(metasData[key]?.venda || 0);
            // Calcula a porcentagem, mas se a meta for 0, a porcentagem também é 0 para evitar erros.
            const percentage = goal > 0 ? (sales / goal) * 100 : 0;
            return {
                name: name,
                percentage: percentage
            };
        });

        // 2. Ordenar os funcionários pela maior porcentagem atingida
        goalProgress.sort((a, b) => b.percentage - a.percentage);

        // 3. Extrair os nomes e as porcentagens ordenadas
        const sortedLabels = goalProgress.map(item => item.name);
        const sortedData = goalProgress.map(item => item.percentage);

        if (employeeGoalProgressChartInstance) {
            employeeGoalProgressChartInstance.destroy();
        }

        employeeGoalProgressChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: 'Progresso da Meta',
                    data: sortedData,
                    backgroundColor: 'rgba(46, 204, 113, 0.6)', // Cor verde para progresso
                    borderColor: '#2ecc71',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        ticks: { 
                            color: 'white',
                            // Adiciona o símbolo de % no eixo X
                            callback: function(value) { return value + '%'; }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: { ticks: { color: 'white' }, grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    // Configura o tooltip para mostrar a porcentagem formatada
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += context.parsed.x.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    };

    const renderEmployeeChart = (salesData) => {
        const ctx = document.getElementById('employee-sales-chart').getContext('2d');
        
        // 1. Criar um array de objetos com nome e vendas para cada colaborador.
        const employeePerformance = allCollaborators.map(name => {
            return {
                name: name,
                sales: parseFloat(salesData[name.toLowerCase()]?.vendas || 0)
            };
        });

        // 2. Ordenar o array em ordem decrescente de vendas (do maior para o menor).
        employeePerformance.sort((a, b) => b.sales - a.sales);

        // 3. Extrair os nomes (labels) e os valores (data) já ordenados.
        const sortedLabels = employeePerformance.map(item => item.name);
        const sortedData = employeePerformance.map(item => item.sales);

        if (employeeChartInstance) {
            employeeChartInstance.destroy();
        }
        employeeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedLabels, // Usar os nomes ordenados
                datasets: [{
                    label: 'Vendas',
                    data: sortedData, // Usar os dados de vendas ordenados
                    backgroundColor: 'rgba(255, 107, 0, 0.6)',
                    borderColor: '#FF6B00',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Deixa as barras na horizontal para melhor leitura
                responsive: true,
                scales: { 
                    x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'white' }, grid: { display: false } } 
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const loadAndDisplayIndividualSalesData = () => {
        const container = document.getElementById('individual-sales-data');
        container.innerHTML = `<div class="sales-data-card"><p>Carregando resultados...</p></div>`;
        const userKey = currentUserName.toLowerCase();
        
        const isManager = managers.includes(currentUserName);

        // Se o usuário logado for um gerente, faz a soma dos dados da loja para exibição.
        if (isManager) {
            // Define qual a lista de funcionários da loja da gerente
            const storeEmployees = storeMapping.pinheiro.includes(currentUserName) 
                ? storeMapping.pinheiro 
                : storeMapping.bacabal;

            database.ref('salesData').get().then(snapshot => {
                if (!snapshot.exists()) {
                    container.innerHTML = `<div class="sales-data-card"><p>Nenhum dado de venda encontrado.</p></div>`;
                    return;
                }
                const allSales = snapshot.val();
                
                // Variáveis para somar os totais da loja inteira
                let totalVendasDaLoja = 0;
                let totalP1P2daLoja = 0;
                let totalSeguroDaLoja = 0;
                let totalCartaoDaLoja = 0;

                // Itera sobre cada funcionário da loja para somar seus valores
                storeEmployees.forEach(employeeName => {
                    const employeeKey = employeeName.toLowerCase();
                    const employeeData = allSales[employeeKey] || {};
                    totalVendasDaLoja += parseFloat(employeeData.vendas || 0);
                    totalP1P2daLoja += parseFloat(employeeData.p1p2 || 0);
                    totalSeguroDaLoja += parseInt(employeeData.seguro || 0, 10);
                    totalCartaoDaLoja += parseInt(employeeData.cartao || 0, 10);
                });

                // Exibe o card com os dados somados da loja
                container.innerHTML = `
                    <div class="sales-data-card">
                        <h4>Resultados Atuais (Loja)</h4>
                        <p>📈 VENDAS: ${formatBRL(totalVendasDaLoja)}</p>
                        <p>🔱 P1/P2: ${formatBRL(totalP1P2daLoja)}</p>
                        <p>🔧 SEGURO: ${totalSeguroDaLoja}</p>
                        <p>💳 CARTÃO: ${totalCartaoDaLoja}</p>
                    </div>
                `;
            });
        } else {
            // Se não for gerente, busca e exibe apenas os dados individuais do colaborador.
            database.ref(`salesData/${userKey}`).get().then(snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    container.innerHTML = `
                        <div class="sales-data-card">
                            <h4>Resultados Atuais</h4>
                            <p>📈 VENDAS: ${formatBRL(data.vendas)}</p>
                            <p>🔱 P1/P2: ${formatBRL(data.p1p2)}</p>
                            <p>🔧 SEGURO: ${data.seguro || '0'}</p>
                            <p>💳 CARTÃO: ${data.cartao || '0'}</p>
                        </div>
                    `;
                } else {
                     container.innerHTML = `<div class="sales-data-card"><p>Nenhum dado de venda encontrado.</p></div>`;
                }
            });
        }
    };

    const loadManagerPanel = () => {
        const container = document.getElementById('manager-sales-panel-content');
        container.innerHTML = '<p style="text-align:center;">Carregando dados da equipe...</p>';
        showPage('managerSalesPanelPage');

        const managerName = currentUserName;
        const storeEmployees = storeMapping.pinheiro.includes(managerName)
            ? storeMapping.pinheiro
            : storeMapping.bacabal;

        database.ref('salesData').get().then(snapshot => {
            container.innerHTML = ''; // Limpa o "carregando"
            if (!snapshot.exists()) {
                container.innerHTML = '<p>Nenhum dado de venda encontrado para a equipe.</p>';
                return;
            }
            const allSales = snapshot.val();
            
            // --- CÁLCULO DOS TOTAIS DA LOJA ---
            let totalVendasDaLoja = 0, totalP1P2daLoja = 0, totalSeguroDaLoja = 0, totalCartaoDaLoja = 0;

            storeEmployees.forEach(employeeName => {
                const employeeKey = employeeName.toLowerCase();
                const employeeData = allSales[employeeKey] || {};
                totalVendasDaLoja += parseFloat(employeeData.vendas || 0);
                totalP1P2daLoja += parseFloat(employeeData.p1p2 || 0);
                totalSeguroDaLoja += parseInt(employeeData.seguro || 0, 10);
                totalCartaoDaLoja += parseInt(employeeData.cartao || 0, 10);
            });

            // --- RENDERIZAÇÃO DOS CARDS ---
            storeEmployees.forEach(employeeName => {
                let cardHtml;
                // Se o funcionário atual for a gerente, mostra o card com os totais da loja.
                if (employeeName === managerName) {
                    cardHtml = `
                        <div class="sales-data-card" style="border-left: 4px solid var(--primary-color);">
                            <h4>${employeeName} (Total Loja)</h4>
                            <p>📈 VENDAS: ${formatBRL(totalVendasDaLoja)}</p>
                            <p>🔱 P1/P2: ${formatBRL(totalP1P2daLoja)}</p>
                            <p>🔧 SEGURO: ${totalSeguroDaLoja}</p>
                            <p>💳 CARTÃO: ${totalCartaoDaLoja}</p>
                        </div>
                    `;
                } else {
                    // Para os demais funcionários, mostra seus dados individuais.
                    const employeeKey = employeeName.toLowerCase();
                    const data = allSales[employeeKey] || {};
                    cardHtml = `
                        <div class="sales-data-card">
                            <h4>${employeeName}</h4>
                            <p>📈 VENDAS: ${formatBRL(data.vendas)}</p>
                            <p>🔱 P1/P2: ${formatBRL(data.p1p2)}</p>
                            <p>🔧 SEGURO: ${data.seguro || '0'}</p>
                            <p>💳 CARTÃO: ${data.cartao || '0'}</p>
                        </div>
                    `;
                }
                container.innerHTML += cardHtml;
            });
            staggerAnimate(container);
        });
    };

    const clearClosingForm = (store) => {
        const employees = storeMapping[store];
        employees.forEach(name => {
            const key = name.toLowerCase();
            document.getElementById(`closing-venda-${key}`).value = '';
            document.getElementById(`closing-cartao-${key}`).value = '';
            document.getElementById(`closing-seguro-${key}`).value = '';
            document.getElementById(`closing-p1p2-${key}`).value = '';
        });
    };
    
        const submitClosingData = () => {
        const statusEl = document.getElementById('closing-status-message');
        if (!confirm('Tem certeza que deseja enviar esses dados? A ação não pode ser desfeita.')) {
            return;
        }
        statusEl.textContent = 'Salvando...';

        const formPinheiro = document.getElementById('closing-form-pinheiro');
        const store = formPinheiro.style.display !== 'none' ? 'pinheiro' : 'bacabal';
        const employeesForStore = storeMapping[store];

        const now = new Date();
        const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

        Promise.all([
            database.ref('salesData').get(),
            database.ref(`monthlySales/${currentMonthKey}`).get()
        ]).then(([salesSnapshot, monthlySalesSnapshot]) => {
            const existingSales = salesSnapshot.exists() ? salesSnapshot.val() : {};
            let monthlyTotalVendas = monthlySalesSnapshot.exists() ? monthlySalesSnapshot.val().totalVendas : 0;
            let totalVendasDoFechamento = 0;
            
            // A lógica de acumular para o gerente foi removida.
            // Agora, a função simplesmente salva os dados pessoais de cada um.

            employeesForStore.forEach(name => {
                const key = name.toLowerCase();
                const currentData = existingSales[key] || { vendas: 0, p1p2: 0, seguro: 0, cartao: 0 };

                const newVenda = parseFromBRLInput(document.getElementById(`closing-venda-${key}`).value);
                const newP1P2 = parseFromBRLInput(document.getElementById(`closing-p1p2-${key}`).value);
                const newSeguro = parseInt(document.getElementById(`closing-seguro-${key}`).value, 10) || 0;
                const newCartao = parseInt(document.getElementById(`closing-cartao-${key}`).value, 10) || 0;

                totalVendasDoFechamento += newVenda;

                // Atualiza os dados individuais de cada funcionário, incluindo a gerente, com seus valores pessoais.
                existingSales[key] = {
                    vendas: (parseFloat(currentData.vendas) || 0) + newVenda,
                    p1p2: (parseFloat(currentData.p1p2) || 0) + newP1P2,
                    seguro: (parseFloat(currentData.seguro) || 0) + newSeguro,
                    cartao: (parseFloat(currentData.cartao) || 0) + newCartao,
                };
            });

            // A lógica que somava os totais da equipe no campo da gerente foi REMOVIDA.

            // Atualiza o total do mês atual (isso continua correto)
            monthlyTotalVendas += totalVendasDoFechamento;

            const updates = {};
            updates['/salesData'] = existingSales;
            updates[`/monthlySales/${currentMonthKey}/totalVendas`] = monthlyTotalVendas;

            database.ref().update(updates).then(() => {
                statusEl.textContent = 'Fechamento salvo com sucesso!';
                clearClosingForm(store);
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            }).catch(error => {
                statusEl.textContent = 'Erro ao salvar os dados!';
                console.error(error);
            });
        });
    };

                const updateStoreTotalsOnCorrectionPage = () => {
            const storeTotals = {
                pinheiro: { vendas: 0, p1p2: 0, seguro: 0, cartao: 0 },
                bacabal: { vendas: 0, p1p2: 0, seguro: 0, cartao: 0 }
            };

            // Recalcula os totais com base nos valores ATUAIS dos inputs dos funcionários
            for (const store in storeMapping) {
                storeMapping[store].forEach(employeeName => {
                    const employeeKey = employeeName.toLowerCase();
                    storeTotals[store].vendas += parseFromBRLInput(document.getElementById(`correction-vendas-${employeeKey}`).value);
                    storeTotals[store].p1p2 += parseFromBRLInput(document.getElementById(`correction-p1p2-${employeeKey}`).value);
                    storeTotals[store].seguro += parseInt(document.getElementById(`correction-seguro-${employeeKey}`).value, 10) || 0;
                    storeTotals[store].cartao += parseInt(document.getElementById(`correction-cartao-${employeeKey}`).value, 10) || 0;
                });
            }

            // Atualiza os campos de total da loja na tela
            for (const storeName in storeTotals) {
                const totals = storeTotals[storeName];
                const totalCardIdPrefix = `total-loja-${storeName}`;
                
                document.getElementById(`${totalCardIdPrefix}-vendas`).value = formatToBRLInput(totals.vendas);
                document.getElementById(`${totalCardIdPrefix}-p1p2`).value = formatToBRLInput(totals.p1p2);
                document.getElementById(`${totalCardIdPrefix}-seguro`).value = totals.seguro;
                document.getElementById(`${totalCardIdPrefix}-cartao`).value = totals.cartao;
            }
        };

                const distributeStoreTotal = (storeName, field) => {
            const employees = storeMapping[storeName];
            const isCurrency = field === 'vendas' || field === 'p1p2';
            
            const totalInput = document.getElementById(`total-loja-${storeName}-${field}`);
            const newTotal = isCurrency ? parseFromBRLInput(totalInput.value) : parseInt(totalInput.value, 10) || 0;

            // 1. Calcular o total antigo somando os valores atuais dos funcionários
            let oldTotal = 0;
            employees.forEach(employeeName => {
                const key = employeeName.toLowerCase();
                const input = document.getElementById(`correction-${field}-${key}`);
                oldTotal += isCurrency ? parseFromBRLInput(input.value) : parseInt(input.value, 10) || 0;
            });
            
            // 2. Distribuir o novo total
            employees.forEach(employeeName => {
                const key = employeeName.toLowerCase();
                const input = document.getElementById(`correction-${field}-${key}`);
                const oldValue = isCurrency ? parseFromBRLInput(input.value) : parseInt(input.value, 10) || 0;

                let newValue;
                if (oldTotal > 0) {
                    // Distribuição proporcional
                    const proportion = oldValue / oldTotal;
                    newValue = newTotal * proportion;
                } else {
                    // Se o total era zero, distribui igualmente
                    newValue = newTotal / employees.length;
                }
                
                input.value = isCurrency ? formatToBRLInput(newValue) : Math.round(newValue);
            });
        };

        const buildAndLoadCorrectionPage = () => {
            const container = document.getElementById('correction-content-container');
            container.innerHTML = `<p style="text-align: center;">Carregando dados para correção...</p>`;

            database.ref('salesData').get().then(snapshot => {
                const allSales = snapshot.exists() ? snapshot.val() : {};
                container.innerHTML = '';

                allCollaborators.forEach(name => {
                    const key = name.toLowerCase();
                    const salesData = allSales[key] || {};
                    container.innerHTML += `
                        <div class="employee-meta-card">
                            <h4>${name}</h4>
                            <div class="input-group"><label for="correction-vendas-${key}">📈 VENDAS (R$)</label><input type="text" id="correction-vendas-${key}" class="data-input" value="${formatToBRLInput(salesData.vendas)}"></div>
                            <div class="input-group"><label for="correction-p1p2-${key}">🔱 P1/P2 (R$)</label><input type="text" id="correction-p1p2-${key}" class="data-input" value="${formatToBRLInput(salesData.p1p2)}"></div>
                            <div class="input-group"><label for="correction-seguro-${key}">🔧 SEGURO</label><input type="number" id="correction-seguro-${key}" class="data-input" value="${salesData.seguro || ''}"></div>
                            <div class="input-group"><label for="correction-cartao-${key}">💳 CARTÃO</label><input type="number" id="correction-cartao-${key}" class="data-input" value="${salesData.cartao || ''}"></div>
                        </div>
                    `;
                });

                const storeTotals = {
                    pinheiro: { vendas: 0, p1p2: 0, seguro: 0, cartao: 0 },
                    bacabal: { vendas: 0, p1p2: 0, seguro: 0, cartao: 0 }
                };
                for (const store in storeMapping) {
                    storeMapping[store].forEach(employeeName => {
                        const employeeKey = employeeName.toLowerCase();
                        const employeeData = allSales[employeeKey] || {};
                        storeTotals[store].vendas += parseFloat(employeeData.vendas || 0);
                        storeTotals[store].p1p2 += parseFloat(employeeData.p1p2 || 0);
                        storeTotals[store].seguro += parseInt(employeeData.seguro || 0, 10);
                        storeTotals[store].cartao += parseInt(employeeData.cartao || 0, 10);
                    });
                }

                for (const storeName in storeTotals) {
                    const totals = storeTotals[storeName];
                    const totalCardIdPrefix = `total-loja-${storeName}`;
                    const storeTitle = storeName.charAt(0).toUpperCase() + storeName.slice(1);

                    container.innerHTML += `
                        <div class="employee-meta-card" style="border-left: 4px solid var(--primary-color);">
                            <h4 style="color: #fff;">Editar Total Loja ${storeTitle}</h4>
                            <div class="input-group"><label for="${totalCardIdPrefix}-vendas">📈 TOTAL VENDAS</label><input type="text" id="${totalCardIdPrefix}-vendas" class="data-input" value="${formatToBRLInput(totals.vendas)}"></div>
                            <div class="input-group"><label for="${totalCardIdPrefix}-p1p2">🔱 TOTAL P1/P2</label><input type="text" id="${totalCardIdPrefix}-p1p2" class="data-input" value="${formatToBRLInput(totals.p1p2)}"></div>
                            <div class="input-group"><label for="${totalCardIdPrefix}-seguro">🔧 TOTAL SEGURO</label><input type="number" id="${totalCardIdPrefix}-seguro" class="data-input" value="${totals.seguro}"></div>
                            <div class="input-group"><label for="${totalCardIdPrefix}-cartao">💳 TOTAL CARTÃO</label><input type="number" id="${totalCardIdPrefix}-cartao" class="data-input" value="${totals.cartao}"></div>
                        </div>
                    `;
                }
                
                const fields = ['vendas', 'p1p2', 'seguro', 'cartao'];
                for (const storeName in storeMapping) {
                    fields.forEach(field => {
                        const totalInput = document.getElementById(`total-loja-${storeName}-${field}`);
                        totalInput.addEventListener('change', () => distributeStoreTotal(storeName, field));
                    });
                }

                // Adiciona o botão de salvar e o status ao final do container
                container.innerHTML += `
                    <button id="save-all-corrections-btn" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Correções</button>
                    <p id="correction-status-message" class="status-message"></p>
                `;
                // Reatribui o listener ao novo botão
                document.getElementById('save-all-corrections-btn').addEventListener('click', saveCorrections);
            });
        };

    const saveCorrections = () => {
        const statusMessage = document.getElementById('correction-status-message');
        statusMessage.textContent = 'Salvando correções...';
        
        const dataToSave = {};

        // Itera sobre TODOS os colaboradores, incluindo as gerentes.
        allCollaborators.forEach(name => {
            const key = name.toLowerCase();
            
            // Lê os valores dos campos de cada colaborador e os adiciona ao objeto que será salvo.
            dataToSave[key] = {
                vendas: parseFromBRLInput(document.getElementById(`correction-vendas-${key}`).value),
                p1p2: parseFromBRLInput(document.getElementById(`correction-p1p2-${key}`).value),
                seguro: document.getElementById(`correction-seguro-${key}`).value || 0,
                cartao: document.getElementById(`correction-cartao-${key}`).value || 0,
            };
        });

        // O método .set() substitui completamente os dados no nó 'salesData' com os novos dados lidos do formulário.
        database.ref('salesData').set(dataToSave)
            .then(() => {
                statusMessage.textContent = 'Dados corrigidos com sucesso!';
                // Recarrega a página para recalcular e exibir os totais atualizados
                buildAndLoadCorrectionPage(); 
                setTimeout(() => { statusMessage.textContent = ''; }, 3000);
            })
            .catch((error) => {
                statusMessage.textContent = 'Erro ao salvar as correções!';
                console.error(error);
            });
    };

    const changePassword = () => {
        const newPassword = prompt("Digite sua nova senha. Deixe em branco para remover a senha.");
        if (newPassword === null) {
            return; // Usuário cancelou
        }

        const userKey = currentUserName.toLowerCase(); // USA A NOVA VARIÁVEL

        if (newPassword.trim() === "") {
            // Se o campo for deixado em branco, remove a senha
            database.ref('userPasswords/' + userKey).remove()
                .then(() => {
                    alert('Sua senha pessoal foi removida com sucesso!');
                })
                .catch(error => {
                    alert('Ocorreu um erro ao remover a senha.');
                    console.error(error);
                });
        } else {
            // Se uma nova senha for digitada, salva ela
            database.ref('userPasswords/' + userKey).set(newPassword)
                .then(() => {
                    alert('Senha alterada com sucesso!');
                })
                .catch(error => {
                    alert('Ocorreu um erro ao salvar a nova senha.');
                    console.error(error);
                });
        }
    };

    const calculateDeliveryPrediction = () => {
        // Pega a data de hoje
        const today = new Date();
        
        // Cria uma nova data para a entrega e adiciona 15 dias
        const deliveryDate = new Date();
        deliveryDate.setDate(today.getDate() + 15);
        
        // Define as opções de formatação (dia numérico e mês por extenso)
        const options = { day: 'numeric', month: 'long' };
        
        // Formata a data para o padrão pt-BR
        const formattedDate = deliveryDate.toLocaleDateString('pt-BR', options);
        
        // Monta e exibe a mensagem em um alerta
        alert(`Comprando hoje, o produto chegará no máximo em ${formattedDate}`);
    };

    const openSuporteModal = () => {
        const modal = elements.suporteModal;
        if(isNavigating) return;
        isNavigating = true;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            staggerAnimate(modal);
            isNavigating = false;
        });
    };

    const closeSuporteModal = () => {
        const modal = elements.suporteModal;
        if (isNavigating || !modal.classList.contains('visible')) return;
        isNavigating = true;

        modal.classList.add('is-exiting');

        modal.addEventListener('animationend', (e) => {
            modal.style.display = 'none';
            modal.classList.remove('visible', 'is-exiting');
            isNavigating = false;
        }, { once: true });
    };

    const openOsModal = () => {
        const modal = elements.osModal;
        if(isNavigating) return;
        isNavigating = true;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            staggerAnimate(modal);
            isNavigating = false;
        });
    };

    const closeOsModal = (callback) => {
        const modal = elements.osModal;
        if (isNavigating || !modal.classList.contains('visible')) return;
        isNavigating = true;

        modal.classList.add('is-exiting');
        modal.addEventListener('animationend', (e) => {
            modal.style.display = 'none';
            modal.classList.remove('visible', 'is-exiting');
            isNavigating = false;
            if (typeof callback === 'function') callback();
        }, { once: true });
    };

    const sendOsEmail = () => {
        const statusEl = document.getElementById('os-form-status');
        const colaborador = document.getElementById('os-colaborador').value.trim();
        const cidade = document.getElementById('os-cidade').value.trim();
        const dataEnvio = document.getElementById('os-data').value;

        if (!colaborador || !cidade || !dataEnvio) {
            statusEl.textContent = 'Preencha todos os campos obrigatórios!';
            return;
        }

        let body = `ORDEM DE SERVIÇO\n`;
        body += `--------------------------------\n`;
        body += `COLABORADOR: ${colaborador}\n`;
        body += `CIDADE REMETENTE: ${cidade}\n`;
        body += `DATA DE ENVIO: ${new Date(dataEnvio + 'T12:00:00').toLocaleDateString('pt-BR')}\n`;
        body += `--------------------------------\n\n`;
        body += `ATENÇÃO: REMOVA A SENHA DO APARELHO!\n\n`;

        let hasDevice = false;
        for (let i = 1; i <= 5; i++) {
            const cliente = document.getElementById(`os-cliente-${i}`).value.trim();
            const modelo = document.getElementById(`os-modelo-${i}`).value.trim();

            if (cliente || modelo) {
                hasDevice = true;
                body += `--- APARELHO ${i} ---\n`;
                body += `CLIENTE/TELEFONE:\n${cliente}\n\n`;
                body += `MODELO/DEFEITO/IMEI:\n${modelo}\n`;
                body += `---------------------\n\n`;
            }
        }

        if (!hasDevice) {
            statusEl.textContent = 'Adicione pelo menos um aparelho!';
            return;
        }

        const recipient = 'paulotrindade700@gmail.com';
        const subject = `OS - ${cidade} - ${colaborador}`;
        
        window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        statusEl.textContent = 'Abrindo seu cliente de email...';
    };

    const renderStockSelectionList = () => {
        const listContainer = document.getElementById('stock-selection-list');
        const footer = document.getElementById('stock-selection-footer');
        const customRequest = document.getElementById('custom-stock-request-input').value.trim();
        
        // O rodapé agora aparece se houver itens selecionados OU texto no campo personalizado
        if (stockRequestSelection.length === 0 && customRequest === "") {
            footer.style.display = 'none';
            return;
        }

        listContainer.innerHTML = stockRequestSelection.map(item => 
            `<div>- ${item.name} | Cor: ${item.color} | Qtd: ${item.quantity}</div>`
        ).join('');
        
        footer.style.display = 'block';
    };

    const openStockRequestPage = () => {
        const listContainer = document.getElementById('stock-product-list');
        listContainer.innerHTML = '<p>Carregando dispositivos...</p>';
        stockRequestSelection = []; // Limpa a seleção anterior
        renderStockSelectionList(); // Esconde o footer
        showPage('requestStockPage');

        database.ref('devices').get().then(snapshot => {
            if (!snapshot.exists()) {
                listContainer.innerHTML = '<p>Nenhum dispositivo encontrado no banco de dados.</p>';
                return;
            }
            listContainer.innerHTML = '';
            const allDevicesByBrand = snapshot.val();

            // Itera sobre cada marca
            for (const brand in allDevicesByBrand) {
                const brandHeader = document.createElement('h3');
                brandHeader.className = 'stock-brand-header';
                brandHeader.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
                listContainer.appendChild(brandHeader);

                const devices = allDevicesByBrand[brand];
                // Itera sobre cada dispositivo dentro da marca
                for (const key in devices) {
                    const device = devices[key];
                    const card = document.createElement('div');
                    card.className = 'stock-product-card';
                    card.innerHTML = `<img src="${device.imageUrl}" alt="${device.name}"><span>${device.name}</span>`;
                    
                    card.addEventListener('click', () => {
                        const color = prompt(`Digite a cor para ${device.name}:`);
                        if (!color) return; // Usuário cancelou

                        const quantityRaw = prompt(`Digite a quantidade:`);
                        if (!quantityRaw) return; // Usuário cancelou

                        const quantity = parseInt(quantityRaw, 10);
                        if (isNaN(quantity) || quantity <= 0) {
                            alert('Por favor, insira uma quantidade válida.');
                            return;
                        }

                        stockRequestSelection.push({ name: device.name, color: color, quantity: quantity });
                        renderStockSelectionList();
                    });

                    listContainer.appendChild(card);
                }
            }
        });
    };

    const sendStockRequestEmail = () => {
        const customRequest = document.getElementById('custom-stock-request-input').value.trim();

        if (stockRequestSelection.length === 0 && customRequest === "") {
            alert('Selecione pelo menos um item ou escreva um pedido personalizado.');
            return;
        }

        const requester = prompt("Digite seu nome para identificação na solicitação:");
        if (!requester) {
            alert("Nome é obrigatório para enviar a solicitação.");
            return;
        }

        const city = prompt("Digite sua CIDADE (Pinheiro ou Bacabal):");
        if (!city) {
            alert("Cidade é obrigatória para enviar a solicitação.");
            return;
        }

        let body = `SOLICITAÇÃO DE ESTOQUE\n`;
        body += `--------------------------------\n`;
        body += `SOLICITANTE: ${requester}\n`;
        body += `CIDADE: ${city.trim()}\n`;
        body += `DATA: ${new Date().toLocaleDateString('pt-BR')}\n`;
        body += `--------------------------------\n\n`;
        if (stockRequestSelection.length > 0) {
            body += `ITENS SELECIONADOS:\n\n`;
            stockRequestSelection.forEach(item => {
                body += `- ${item.name}\n`;
                body += `  Cor: ${item.color}\n`;
                body += `  Quantidade: ${item.quantity}\n\n`;
            });
        }

        if (customRequest) {
            body += `--------------------------------\n`;
            body += `PEDIDO PERSONALIZADO:\n\n`;
            body += `${customRequest}\n\n`;
        }


        const recipient = 'paulotrindade700@gmail.com';
        const subject = `Solicitação de Estoque - ${requester} (${city.trim()})`;
        
        window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Limpa a seleção e o campo personalizado após gerar o email
        setTimeout(() => {
            stockRequestSelection = [];
            document.getElementById('custom-stock-request-input').value = '';
            renderStockSelectionList();
        }, 1000);
    };

    const sendReciboEmail = () => {
        const statusEl = document.getElementById('recibo-status-message');
        const nome = document.getElementById('recibo-nome').value.trim();
        const loja = document.getElementById('recibo-loja').value.trim();
        const gastos = document.getElementById('recibo-gastos').value.trim();
        const nota = document.getElementById('recibo-nota').value.trim();
        const dia = document.getElementById('recibo-dia').value.trim();
        const mes = document.getElementById('recibo-mes').value.trim();
        const ano = document.getElementById('recibo-ano').value.trim();

        if (!nome || !loja || !gastos || !dia || !mes || !ano) {
            statusEl.textContent = 'Preencha todos os campos obrigatórios!';
            return;
        }

        const dataFormatada = `${dia}/${mes}/${ano}`;

        let body = `RECIBO DE GASTOS\n`;
        body += `===============================\n\n`;
        body += `NOME: ${nome}\n`;
        body += `LOJA: ${loja}\n`;
        body += `DATA: ${dataFormatada}\n\n`;
        body += `GASTOS (DESCRIÇÃO E VALOR):\n${gastos}\n\n`;
        
        if (nota) {
            body += `NOTA/CUPOM (Opcional):\n${nota}\n`;
        }
        
        body += `\n===============================`;

        const recipient = 'paulotrindade700@gmail.com';
        const subject = `Recibo de Gastos - ${nome} (${loja})`;
        
        window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        statusEl.textContent = 'Abrindo seu cliente de email...';
        
        // Limpa o formulário após o envio
        document.getElementById('recibo-nome').value = '';
        document.getElementById('recibo-loja').value = '';
        document.getElementById('recibo-gastos').value = '';
        document.getElementById('recibo-nota').value = '';
        document.getElementById('recibo-dia').value = '';
        document.getElementById('recibo-mes').value = '';
        document.getElementById('recibo-ano').value = '';
    };

    const sendQuizEmail = () => {
        const statusEl = document.getElementById('quiz-status-message');

        // Coleta de dados dos campos
        const nome = document.getElementById('quiz-nome').value.trim();
        const gostouTreinamento = document.querySelector('input[name="gostou_treinamento"]:checked');
        const parteUtil = document.getElementById('quiz_parte_util').value.trim();
        const parteConfusa = document.querySelector('input[name="parte_confusa"]:checked');
        const parteConfusaDetalhe = document.getElementById('quiz_parte_confusa_detalhe').value.trim();
        const ajudouPreparar = document.querySelector('input[name="ajudou_preparar"]:checked');
        const proximoTemaRadio = document.querySelector('input[name="proximo_tema"]:checked');
        const proximoTemaOutro = document.getElementById('quiz_proximo_tema_outro').value.trim();
        const sugestao = document.getElementById('quiz_sugestao').value.trim();

        // Validação
        if (!nome || !gostouTreinamento || !parteUtil || !parteConfusa || !ajudouPreparar || !proximoTemaRadio) {
            statusEl.textContent = 'Por favor, responda todas as perguntas obrigatórias.';
            return;
        }
        if (parteConfusa.value === 'Sim' && !parteConfusaDetalhe) {
            statusEl.textContent = 'Por favor, especifique qual parte do treinamento ficou confusa.';
            return;
        }
        if (proximoTemaRadio.value === 'Outro' && !proximoTemaOutro) {
            statusEl.textContent = 'Por favor, especifique o outro tema para o próximo treinamento.';
            return;
        }

        // Montagem do corpo do email
        let proximoTemaFinal = proximoTemaRadio.value;
        if (proximoTemaRadio.value === 'Outro') {
            proximoTemaFinal = `Outro: ${proximoTemaOutro}`;
        }
        
        let parteConfusaFinal = parteConfusa.value;
        if (parteConfusa.value === 'Sim') {
            parteConfusaFinal = `Sim, a parte sobre: ${parteConfusaDetalhe}`;
        }

        let body = `FEEDBACK - TREINAMENTO LOJA DO HUNTER\n`;
        body += `=========================================\n\n`;
        body += `NOME DO COLABORADOR: ${nome}\n\n`;
        
        body += `1. Você gostou do conteúdo do treinamento?\n- ${gostouTreinamento.value}\n\n`;
        body += `2. Qual parte você achou mais útil ou que mais chamou sua atenção?\n- ${parteUtil}\n\n`;
        body += `3. Teve alguma parte que ficou confusa ou você sentiu falta de mais explicações?\n- ${parteConfusaFinal}\n\n`;
        body += `4. Você sentiu que esse treinamento te ajudou a se sentir mais preparado(a) para vender e atender melhor?\n- ${ajudouPreparar.value}\n\n`;
        body += `5. Qual tema você gostaria que a gente abordasse no próximo treinamento?\n- ${proximoTemaFinal}\n\n`;
        
        if (sugestao) {
            body += `6. Sugestão, elogio ou crítica (opcional):\n- ${sugestao}\n`;
        }

        // Envio do email
        const recipient = 'paulotrindade700@gmail.com';
        const subject = `Feedback de Treinamento - ${nome}`;
        
        window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        statusEl.textContent = 'Abrindo seu cliente de email...';
        
        // Limpeza do formulário
        document.getElementById('quiz-nome').value = '';
        document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
        document.getElementById('quiz_parte_util').value = '';
        document.getElementById('quiz_parte_confusa_detalhe').value = '';
        document.getElementById('quiz_proximo_tema_outro').value = '';
        document.getElementById('quiz_sugestao').value = '';
    };

        const displayMtForBrand = (brand) => {
        const mtContentArea = document.getElementById('mt-content-area');
        if (!brand) {
            mtContentArea.innerHTML = `<p style="text-align: center;">Selecione uma marca para ver os itens.</p>`;
            return;
        }
        mtContentArea.innerHTML = `<p style="text-align: center;">Carregando itens para ${brand}...</p>`;

        database.ref(`mostruario/${brand}`).on('value', snapshot => {
            mtContentArea.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const item = childSnapshot.val();
                    const card = document.createElement('div');
                    card.className = 'mt-item-card';
                    card.innerHTML = `<pre>${item.text}</pre>`;
                    mtContentArea.appendChild(card);
                });
            } else {
                mtContentArea.innerHTML = `<p style="text-align: center;">Nenhum item de mostruário encontrado para esta marca.</p>`;
            }
        });
    };

    const loadAndShowMtManagementPage = () => {
        showPage('mtManagementPage');
        const mtListContainer = document.getElementById('mt-list-container');
        mtListContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        database.ref('mostruario').get().then(snapshot => {
            mtListContainer.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach(brandSnapshot => {
                    const brand = brandSnapshot.key;
                    const brandTitle = document.createElement('h4');
                    brandTitle.className = 'meta-group-title';
                    brandTitle.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
                    mtListContainer.appendChild(brandTitle);

                    brandSnapshot.forEach(itemSnapshot => {
                        const key = itemSnapshot.key;
                        const item = itemSnapshot.val();
                        const listItem = document.createElement('div');
                        listItem.className = 'mt-list-item';
                        listItem.innerHTML = `
                            <div class="mt-list-item-text">${item.text}</div>
                            <button class="delete-button-small" data-brand="${brand}" data-key="${key}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        `;
                        mtListContainer.appendChild(listItem);
                    });
                });
            } else {
                mtListContainer.innerHTML = `<p style="text-align:center;">Nenhum item cadastrado.</p>`;
            }
        });
    };

    const saveMtItem = () => {
        const mtAddBrandSelect = document.getElementById('mt-add-brand');
        const mtAddTextarea = document.getElementById('mt-add-text');
        const mtAddStatus = document.getElementById('mt-add-status');
        const brand = mtAddBrandSelect.value;
        const text = mtAddTextarea.value.trim();

        if (!brand || !text) {
            mtAddStatus.textContent = 'Marca e texto são obrigatórios!';
            return;
        }
        mtAddStatus.textContent = 'Salvando...';

        database.ref(`mostruario/${brand}`).push({ text: text }).then(() => {
            mtAddStatus.textContent = 'Item salvo com sucesso!';
            mtAddTextarea.value = '';
            mtAddBrandSelect.selectedIndex = 0;
            loadAndShowMtManagementPage(); // Recarrega a lista
            setTimeout(() => { mtAddStatus.textContent = ''; }, 3000);
        }).catch(err => {
            mtAddStatus.textContent = 'Erro ao salvar!';
            console.error(err);
        });
    };

    const deleteMtItem = (brand, key) => {
        if (confirm('Tem certeza que deseja excluir este item?')) {
            database.ref(`mostruario/${brand}/${key}`).remove().then(() => {
                alert('Item excluído!');
                loadAndShowMtManagementPage(); // Recarrega a lista
            }).catch(err => {
                alert('Erro ao excluir!');
                console.error(err);
            });
        }
    };

function calculateAndDisplayRanking() {
        const rankingContainer = document.getElementById('ranking-container');
        rankingContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Calculando ranking...</p>';

        Promise.all([
            database.ref('salesData').get(),
            database.ref('metas').get(),
            database.ref('userProfiles').get(),
            database.ref('userStatuses').get() // Adicionado para buscar status
        ]).then(([salesSnapshot, metasSnapshot, profilesSnapshot, statusesSnapshot]) => {
            if (!salesSnapshot.exists() || !metasSnapshot.exists()) {
                rankingContainer.innerHTML = '<p style="text-align: center;">Dados insuficientes para gerar o ranking.</p>';
                return;
            }

            const salesData = salesSnapshot.val();
            const metasData = metasSnapshot.val();
            const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};
            const statusesData = statusesSnapshot.exists() ? statusesSnapshot.val() : {};
            const performanceData = [];

            const eligibleCollaborators = allCollaborators.filter(name => !managers.includes(name));

            eligibleCollaborators.forEach(name => {
                const key = name.toLowerCase();
                const actualSales = parseFloat(salesData[key]?.vendas || 0);
                const salesGoal = parseFloat(metasData[key]?.venda || 0);

                if (salesGoal > 0) {
                    const percentage = (actualSales / salesGoal) * 100;
                    performanceData.push({
                        name: name,
                        percentage: percentage
                    });
                }
            });

            performanceData.sort((a, b) => b.percentage - a.percentage);

            rankingContainer.innerHTML = '';
            const top3 = performanceData.slice(0, 3);

            if (top3.length === 0) {
                rankingContainer.innerHTML = '<p style="text-align: center;">Nenhum colaborador com meta definida para o ranking.</p>';
                return;
            }

            top3.forEach((collab, index) => {
                const rank = index + 1;
                const prizes = ['R$ 200,00', 'R$ 100,00', 'R$ 50,00'];
                const medals = ['<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>'];
                const prizeHTML = `<span class="rank-prize">${prizes[index]}</span>`;
                
                const rankItem = document.createElement('div');
                rankItem.className = `rank-item rank-${rank}`;
                
                const progressBarWidth = collab.percentage;

                const defaultPhoto = 'https://wallpapers.com/images/hd/cute-otter-looking-away-picture-dm2chg8ito3e44ur.jpg';
                const collaboratorProfile = profilesData[collab.name.toLowerCase()];
                const photoUrl = collaboratorProfile && collaboratorProfile.photoURL ? collaboratorProfile.photoURL : defaultPhoto;
                const crownHtml = (rank === 1) ? '<i class="fas fa-crown rank-crown"></i>' : '';

                // --- LÓGICA DA BOLHA DE STATUS ---
                let statusBubbleHtml = '';
                const userStatus = statusesData[collab.name.toLowerCase()];
                if (userStatus && userStatus.text) {
                    const statusTimestamp = new Date(userStatus.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);
                    if (hoursDiff < 24) {
                        statusBubbleHtml = `<div class="status-bubble">${userStatus.text}</div>`;
                    }
                }
                // --- FIM DA LÓGICA DA BOLHA ---

                rankItem.innerHTML = `
                    <div class="rank-photo-container">
                        ${crownHtml}
                        <img src="${photoUrl}" alt="Foto de ${collab.name}" class="rank-photo">
                    </div>
                    <div class="rank-medal">${medals[index]}</div>
                    <div class="rank-details">
                        <div class="rank-name">
                            <span>${collab.name}</span>
                            ${prizeHTML}
                        </div>
                        ${statusBubbleHtml}
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progressBarWidth}%;"></div>
                            <span class="progress-percentage">${collab.percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
                rankingContainer.appendChild(rankItem);
            });
        }).catch(error => {
            console.error("Erro ao carregar dados para o ranking:", error);
            rankingContainer.innerHTML = '<p style="text-align: center;">Erro ao carregar o ranking.</p>';
        });
    };

    function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    function createManagerNotification(message) {
        const notificationId = `${new Date().getTime()}-${currentUserName.replace(/\s+/g, '')}`; // USA A NOVA VARIÁVEL
        const notificationRef = database.ref(`managerNotifications/${notificationId}`);
        notificationRef.set({
            message: message,
            timestamp: new Date().toISOString(),
            read: false // Adiciona o status de "não lido"
        });
    };

        // (Pode ser adicionada antes da função loadManagerNotifications)

    function markNotificationsAsRead() {
        const notificationsRef = database.ref('managerNotifications');
        notificationsRef.once('value', snapshot => {
            if (snapshot.exists()) {
                const updates = {};
                snapshot.forEach(childSnapshot => {
                    // Marca como lida apenas se a notificação não tiver a flag 'read' ou se for 'false'
                    if (!childSnapshot.val().read) {
                        updates[childSnapshot.key + '/read'] = true;
                    }
                });
                // Executa o update somente se houver algo para atualizar
                if (Object.keys(updates).length > 0) {
                    notificationsRef.update(updates);
                }
            }
        });
    };

    async function determineNextPontoAction(dailyPontoData) {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
        const todayString = getTodayDateString();
        const isGuard = Object.values(securityGuards).includes(currentUserName);

        const [holidaySnap, sundaySnap, dayOffSnap, justificationSnap] = await Promise.all([
            database.ref('holidays').get(),
            database.ref('workingSundays').get(),
            database.ref(`scheduledDaysOff/${todayString}/${currentUserName.toLowerCase()}`).get(),
            database.ref(`justifications/${todayString}/${currentUserName.toLowerCase()}`).get()
        ]);

        if (dayOffSnap.exists()) {
            return { action: null, status: 'day_off', message: 'Hoje é sua folga. Ponto desativado.', nextActionTime: null };
        }

        if (holidaySnap.hasChild(todayString)) {
            return { action: null, status: 'holiday', message: 'Hoje é um feriado. Ponto desativado.', nextActionTime: null };
        }

        const isWorkingSunday = sundaySnap.hasChild(todayString);
        if (dayOfWeek === 0 && !isWorkingSunday) {
            return { action: null, status: 'closed', message: 'Loja fechada aos domingos. Ponto desativado.', nextActionTime: null };
        }

        const isWeekendShift = (dayOfWeek === 6) || (dayOfWeek === 0 && isWorkingSunday);
        const scheduleWithLunch = { entrada: { start: 7 * 60 + 40, end: 8 * 60 + 20 }, saidaAlmoco: { start: 11 * 60, end: 15 * 60 }, saida: { start: 17 * 60 + 40 } };
        const scheduleWithoutLunch = { entrada: { start: 7 * 60 + 40, end: 8 * 60 + 15 }, saida: { start: 12 * 60 + 40 } };
        
        const windows = (isGuard || isWeekendShift) ? scheduleWithoutLunch : scheduleWithLunch;

        // LÓGICA UNIFICADA A PARTIR DAQUI

        if (justificationSnap.exists()) {
            if (!dailyPontoData.entrada) return { action: 'registrar_entrada', status: 'justified', message: 'Justificativa aceita. Registre sua ENTRADA.', nextActionTime: null };
            // A verificação `windows.saidaAlmoco` determina se o almoço é aplicável hoje.
            if (windows.saidaAlmoco && !dailyPontoData.saida_almoco) return { action: 'registrar_saida_almoco', status: 'justified', message: 'Justificativa aceita. Registre sua SAÍDA DE ALMOÇO.', nextActionTime: null };
            if (windows.saidaAlmoco && !dailyPontoData.volta_almoco) return { action: 'registrar_volta_almoco', status: 'justified', message: 'Justificativa aceita. Registre sua VOLTA DO ALMOÇO.', nextActionTime: null };
            if (!dailyPontoData.saida) return { action: 'registrar_saida', status: 'justified', message: 'Justificativa aceita. Registre sua SAÍDA.', nextActionTime: null };
            return { action: null, status: 'complete', message: 'Jornada de trabalho finalizada por hoje.', nextActionTime: null };
        }

        if (!dailyPontoData.entrada) {
            if (currentTimeInMinutes >= windows.entrada.start && currentTimeInMinutes <= windows.entrada.end) {
                return { action: 'registrar_entrada', status: 'pending', message: 'Você deve bater o ponto de ENTRADA.', nextActionTime: windows.entrada.start, nextActionEndTime: windows.entrada.end };
            }
            if (currentTimeInMinutes > windows.entrada.end) {
                return { action: 'missed_entrada', status: 'late', message: 'Você se atrasou para a ENTRADA.', nextActionTime: null };
            }
            return { action: null, status: 'waiting', message: 'Aguardando horário de entrada.', nextActionTime: windows.entrada.start, nextActionEndTime: windows.entrada.end };
        }

        // Se o horário de hoje TEM almoço, verifica os pontos de almoço.
        if (windows.saidaAlmoco) {
            if (!dailyPontoData.saida_almoco) {
                if (currentTimeInMinutes >= windows.saidaAlmoco.start && currentTimeInMinutes <= windows.saidaAlmoco.end) {
                    return { action: 'registrar_saida_almoco', status: 'pending', message: 'Você pode bater o ponto para SAÍDA DE ALMOÇO.', nextActionTime: windows.saidaAlmoco.start };
                }
            } else if (!dailyPontoData.volta_almoco) {
                const saidaAlmocoTime = new Date(dailyPontoData.saida_almoco.timestamp);
                const expectedReturnTime = new Date(saidaAlmocoTime.getTime() + (2 * 60 * 60 * 1000));
                const returnToleranceEnd = new Date(expectedReturnTime.getTime() + (15 * 60 * 1000));
                const expectedReturnInMinutes = expectedReturnTime.getHours() * 60 + expectedReturnTime.getMinutes();
                if (now <= returnToleranceEnd) {
                    return { action: 'registrar_volta_almoco', status: 'pending', message: 'Você deve bater o ponto de VOLTA DO ALMOÇO.', nextActionTime: expectedReturnInMinutes };
                } else {
                    return { action: 'missed_volta_almoco', status: 'late', message: 'Você se atrasou na VOLTA DO ALMOÇO.', nextActionTime: null };
                }
            }
        }
        
        if (!dailyPontoData.saida) {
            const lastPunchTimestamp = dailyPontoData.volta_almoco?.timestamp || dailyPontoData.entrada.timestamp;
            if (lastPunchTimestamp) {
                const lastPunchDate = new Date(lastPunchTimestamp);
                if (now.getDate() > lastPunchDate.getDate() || now.getMonth() > lastPunchDate.getMonth() || now.getFullYear() > lastPunchDate.getFullYear()) {
                    return { action: 'missed_saida', status: 'late', message: 'Você esqueceu de bater o ponto de SAÍDA ontem.', nextActionTime: null };
                }
            }
            if (currentTimeInMinutes >= windows.saida.start) {
                return { action: 'registrar_saida', status: 'pending', message: 'Você pode bater o ponto de SAÍDA.', nextActionTime: windows.saida.start };
            }
            return { action: null, status: 'working', message: 'Em horário de trabalho.', nextActionTime: windows.saida.start };
        }

        return { action: null, status: 'complete', message: 'Jornada de trabalho finalizada por hoje.', nextActionTime: null };
    };

    const stopCountdownTimer = () => {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    };

    const startLiveCountdown = (targetTimeInMinutes, displayElement) => {
        stopCountdownTimer(); // Garante que nenhum outro timer esteja rodando

        const targetDate = new Date();
        targetDate.setHours(Math.floor(targetTimeInMinutes / 60), targetTimeInMinutes % 60, 0, 0);

        const updateCountdown = () => {
            const now = new Date();
            const difference = targetDate.getTime() - now.getTime();

            if (difference <= 0) {
                displayElement.textContent = 'Horário de ponto iniciado!';
                stopCountdownTimer();
                // Re-verifica o status, pois o tempo chegou
                checkPontoStatusAndDisplayWarnings();
                return;
            }

            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const seconds = Math.floor((difference / 1000) % 60);

            displayElement.textContent = `(Faltam ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
        };

        updateCountdown(); // Chamada inicial para mostrar o tempo imediatamente
        countdownInterval = setInterval(updateCountdown, 1000);
    };

    async function checkPontoStatusAndDisplayWarnings() {
        const isGuard = Object.values(securityGuards).includes(currentUserName);
        
        const notificationArea = document.getElementById(isGuard ? 'security-ponto-notification-area' : 'ponto-notification-area');
        const countdownTimerEl = document.getElementById(isGuard ? 'security-ponto-countdown-timer' : 'ponto-countdown-timer');
        const liveCountdownEl = document.getElementById(isGuard ? 'security-ponto-live-countdown' : 'ponto-live-countdown');

        if (!notificationArea || !countdownTimerEl || !liveCountdownEl || !currentUserName) return;

        stopCountdownTimer();
        notificationArea.innerHTML = '';
        countdownTimerEl.innerHTML = '';
        liveCountdownEl.innerHTML = '';

        const todayString = getTodayDateString();
        const pontoRef = database.ref(`pontosDoDia/${todayString}/${currentUserName}`);
        
        try {
            const snapshot = await pontoRef.get();
            const dailyPontoData = snapshot.exists() ? snapshot.val() : {};
            const nextAction = await determineNextPontoAction(dailyPontoData);
            const justificationRef = database.ref(`justifications/${todayString}/${currentUserName.toLowerCase()}`);
            const justificationSnapshot = await justificationRef.get();

            let nextCheckInMilliseconds = null;
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const nowInMilliseconds = now.getTime();

            if (nextAction.nextActionTime !== null) {
                const targetTime = new Date();
                targetTime.setHours(Math.floor(nextAction.nextActionTime / 60), nextAction.nextActionTime % 60, 1, 0);
                nextCheckInMilliseconds = targetTime.getTime() - nowInMilliseconds;

                const formattedStartTime = targetTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                let displayText = `Próximo ponto a partir das ${formattedStartTime}`;
                
                if (nextAction.nextActionEndTime && currentMinutes < nextAction.nextActionEndTime) {
                    const endTime = new Date();
                    endTime.setHours(Math.floor(nextAction.nextActionEndTime / 60), nextAction.nextActionEndTime % 60, 0, 0);
                    displayText = `Próximo ponto das ${formattedStartTime} até às ${endTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    const endCheckInMilliseconds = endTime.getTime() - nowInMilliseconds;
                    if (nextCheckInMilliseconds < 0) {
                         nextCheckInMilliseconds = endCheckInMilliseconds;
                    }
                }
                countdownTimerEl.textContent = displayText;

                // Inicia o timer de contagem regressiva se o horário do ponto ainda não chegou
                if (targetTime.getTime() > now.getTime()) {
                    startLiveCountdown(nextAction.nextActionTime, liveCountdownEl);
                }
            }

            if (nextAction.status === 'pending' || nextAction.status === 'justified') {
                notificationArea.innerHTML = `<div class="os-warning" style="border-color: #f1c40f; color: #f1c40f; margin-bottom: 0;">${nextAction.message}</div>`;
                 if (justificationSnapshot.exists()) {
                    notificationArea.innerHTML += `<p style="font-size: 0.8rem; color: #f1c40f; margin-top: 0.5rem;">Sua justificativa para hoje foi registrada.</p>`;
                }
            } else if (nextAction.status === 'late') {
                notificationArea.innerHTML = `<div class="os-warning" style="margin-bottom: 0;">${nextAction.message}</div>
                                              <button id="justify-btn" class="action-button" style="margin-top: 1rem; padding: 0.75rem; font-size: 0.9rem; background-color: #f39c12;"><i class="fa-solid fa-comment-medical"></i> Justificar Ocorrência</button>`;

                setTimeout(() => {
                    const justifyBtn = document.getElementById('justify-btn');
                    if(justifyBtn) justifyBtn.addEventListener('click', justifyOccurrence);
                }, 0);

                const absenceLogRef = database.ref(`absencesLogged/${todayString}/${currentUserName}/${nextAction.action}`);
                const absenceLogSnapshot = await absenceLogRef.get();

                if (!absenceLogSnapshot.exists()) {
                    const absenceData = { collaborator: currentUserName, timestamp: new Date().toISOString(), type: 'falta', reason: nextAction.message, photoURL: null };
                    const newPontoKey = database.ref().child(`pontos/${currentUserName}`).push().key;
                    const updates = {};
                    updates[`pontos/${currentUserName}/${newPontoKey}`] = absenceData;
                    updates[`absencesLogged/${todayString}/${currentUserName}/${nextAction.action}`] = true;
                    await database.ref().update(updates);
                }
                
                const notificationCheckRef = database.ref(`managerNotifications/${todayString}-${currentUserName}-${nextAction.action}`);
                const checkSnapshot = await notificationCheckRef.get();
                if (!checkSnapshot.exists()) {
                    createManagerNotification(`${currentUserName}: ${nextAction.message}`);
                }
                        } else {
                notificationArea.innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.9); font-weight: 600;">${nextAction.message}</p>`;
            }

            // Agenda a próxima verificação, se aplicável
            if (nextCheckInMilliseconds > 0 && nextCheckInMilliseconds < 86400000) { // Não agenda se for para mais de 24h
                clearTimeout(pontoCheckTimeout); // Limpa o timer antigo antes de criar um novo
                pontoCheckTimeout = setTimeout(checkPontoStatusAndDisplayWarnings, nextCheckInMilliseconds);
            }

        } catch (error) {
            console.error("Erro ao verificar status do ponto:", error);
            notificationArea.innerHTML = `<div class="os-warning">Erro ao carregar status do ponto.</div>`;
        }
    };

    async function handlePontoLogic() {
        const todayString = getTodayDateString();
        const pontoRef = database.ref(`pontosDoDia/${todayString}/${currentUserName}`); // USA A NOVA VARIÁVEL

        try {
            const snapshot = await pontoRef.get();
            const dailyPontoData = snapshot.exists() ? snapshot.val() : {};
            const nextAction = await determineNextPontoAction(dailyPontoData);

            currentPontoAction = nextAction.action; // Armazena a ação a ser executada

            // Lidar com dias não úteis ou folga primeiro
            if (nextAction.status === 'holiday' || nextAction.status === 'closed' || nextAction.status === 'day_off') {
                alert(nextAction.message);
                return;
            }

            if (currentPontoAction && currentPontoAction.startsWith('registrar_')) {
                initPontoCamera();
            } else if (nextAction.status === 'complete') {
                alert(nextAction.message);
            } else {
                alert('Fora do horário de digitar o ponto.');
            }
        } catch (error) {
            console.error("Erro ao processar lógica do ponto:", error);
            alert("Ocorreu um erro. Verifique sua conexão e tente novamente.");
        }
    };

    function loadManagerNotifications() {
        const section = document.getElementById('manager-notifications-section');
        const listContainer = document.getElementById('manager-notifications-list');
        const indicator = document.getElementById('gs-notification-indicator');
        const clearAllBtn = document.getElementById('clear-all-notifications-btn'); // Pega o novo botão
        const notificationsRef = database.ref('managerNotifications').orderByChild('timestamp').limitToLast(20);

        notificationsRef.on('value', snapshot => {
            listContainer.innerHTML = '';
            let hasUnread = false;
            let notificationCount = 0; // Conta o número de notificações

            if (snapshot.exists()) {
                notificationCount = snapshot.numChildren();
                section.style.display = 'block';
                
                const notifications = [];
                snapshot.forEach(childSnapshot => {
                    const notificationData = childSnapshot.val();
                    if (!notificationData.read) {
                        hasUnread = true;
                    }
                    notifications.push({ key: childSnapshot.key, ...notificationData });
                });

                indicator.style.display = hasUnread ? 'inline-flex' : 'none';

                notifications.reverse().forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'mt-list-item';
                    if (!notification.read) {
                        notificationItem.style.background = 'rgba(255, 255, 255, 0.1)';
                    }
                    notificationItem.innerHTML = `
                        <div class="mt-list-item-text">${notification.message}</div>
                        <button class="delete-button-small" data-key="${notification.key}">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    `;
                    listContainer.appendChild(notificationItem);
                });
            } else {
                section.style.display = 'none';
                indicator.style.display = 'none';
            }

            // Mostra ou esconde o botão "Limpar Todas" baseado na contagem
            if (notificationCount > 0) {
                clearAllBtn.style.display = 'block';
            } else {
                clearAllBtn.style.display = 'none';
            }
        });
    };

    // --- Funções para Gerenciamento de Feriados e Domingos ---
    function loadAndRenderList(dbNode, listContainerId, title) {
        const listContainer = document.getElementById(listContainerId);
        listContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        database.ref(dbNode).get().then(snapshot => {
            listContainer.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach(itemSnapshot => {
                    const key = itemSnapshot.key; // A chave é a data YYYY-MM-DD
                    const [year, month, day] = key.split('-');
                    const formattedDate = `${day}/${month}/${year}`;
                    const listItem = document.createElement('div');
                    listItem.className = 'mt-list-item';
                    listItem.innerHTML = `
                        <div class="mt-list-item-text">${formattedDate} - ${title}</div>
                        <button class="delete-button-small" data-db-node="${dbNode}" data-key="${key}">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    listContainer.appendChild(listItem);
                });
            } else {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhuma data cadastrada.</p>`;
            }
        });
    };

    function addDateToList(inputId, dbNode, statusId, callback) {
        const dateInput = document.getElementById(inputId);
        const statusEl = document.getElementById(statusId);
        const dateValue = dateInput.value;

        if (!dateValue) {
            statusEl.textContent = 'Por favor, selecione uma data.';
            return;
        }

        statusEl.textContent = 'Salvando...';
        database.ref(dbNode).child(dateValue).set(true)
            .then(() => {
                statusEl.textContent = 'Data adicionada com sucesso!';
                dateInput.value = '';
                if (callback) callback();
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            })
            .catch(err => {
                statusEl.textContent = 'Erro ao salvar a data!';
                console.error(err);
            });
    };

    function deleteDateFromList(dbNode, key, callback) {
        if (confirm('Tem certeza que deseja remover esta data?')) {
            database.ref(dbNode).child(key).remove()
                .then(() => {
                    alert('Data removida.');
                    if (callback) callback();
                })
                .catch(err => {
                    alert('Erro ao remover a data.');
                    console.error(err);
                });
        }
    };

    function loadCollaboratorProfilePicture() {
        const imgElement = document.getElementById('collaborator-profile-pic');
        const defaultPhoto = 'https://wallpapers.com/images/hd/cute-otter-looking-away-picture-dm2chg8ito3e44ur.jpg';
        const userKey = currentUserName.toLowerCase(); // USA A NOVA VARIÁVEL
        
        database.ref(`userProfiles/${userKey}/photoURL`).get().then(snapshot => {
            if (snapshot.exists()) {
                imgElement.src = snapshot.val();
            } else {
                imgElement.src = defaultPhoto;
            }
        }).catch(() => {
            imgElement.src = defaultPhoto;
        });
    };

    function uploadProfilePicture(file) {
        // Determina qual status e imagem atualizar com base na tela visível
        const isSecurityMode = elements.securityProfilePage.classList.contains('visible');
        const statusEl = document.getElementById(isSecurityMode ? 'security-photo-upload-status' : 'photo-upload-status');
        const imgElement = document.getElementById(isSecurityMode ? 'security-profile-pic' : 'collaborator-profile-pic');
        
        const userKey = currentUserName.toLowerCase(); // USA A NOVA VARIÁVEL
        
        statusEl.textContent = 'Enviando foto...';

        const IMGBB_API_KEY = '7c32c55ffc68c5fbadae81f11a263a40'; 
        const formData = new FormData();
        formData.append('image', file);

        fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const imageUrl = result.data.url;
                statusEl.textContent = 'Atualizando perfil...';
                
                database.ref(`userProfiles/${userKey}/photoURL`).set(imageUrl)
                    .then(() => {
                        statusEl.textContent = 'Foto atualizada com sucesso!';
                        document.getElementById('collaborator-profile-pic').src = imageUrl; // Atualiza a imagem na tela
                        // Recarregar os rankings para refletir a nova foto
                        calculateAndDisplayRanking();
                        calculateAndDisplayStoreRanking();
                        setTimeout(() => { statusEl.textContent = ''; }, 3000);
                    })
                    .catch(dbError => {
                        console.error("Erro ao salvar URL no DB:", dbError);
                        statusEl.textContent = 'Erro ao salvar a foto no perfil.';
                    });
            } else {
                console.error('Erro no ImgBB:', result);
                statusEl.textContent = 'Falha no servidor ao enviar a foto.';
            }
        })
        .catch(error => {
            console.error('Erro de rede ao enviar para ImgBB:', error);
            statusEl.textContent = 'Erro de conexão ao enviar a foto.';
        });
    };


    // --- Funções para Gerenciamento de Folgas ---

    function populateEmployeeSelect() {
        const select = document.getElementById('day-off-employee-select');
        select.innerHTML = '<option value="" disabled selected>Selecione...</option>';
        allCollaborators.forEach(name => {
            select.innerHTML += `<option value="${name.toLowerCase()}">${name}</option>`;
        });
    };

    function loadAndRenderDaysOff() {
        const listContainer = document.getElementById('days-off-list-container');
        listContainer.innerHTML = `<p style="text-align:center;">Carregando...</p>`;

        database.ref('scheduledDaysOff').get().then(snapshot => {
            listContainer.innerHTML = '';
            if (!snapshot.exists() || snapshot.val() === null) {
                listContainer.innerHTML = `<p style="text-align:center;">Nenhuma folga agendada.</p>`;
                return;
            }

            const daysOff = snapshot.val();
            const items = [];
            
            // Coletar e formatar todos os itens antes de exibir
            for (const date in daysOff) {
                for (const employeeKey in daysOff[date]) {
                    const employeeName = allCollaborators.find(name => name.toLowerCase() === employeeKey) || employeeKey;
                    const [year, month, day] = date.split('-');
                    const formattedDate = `${day}/${month}/${year}`;
                    items.push({ date, formattedDate, employeeKey, employeeName });
                }
            }

            // Ordenar por data
            items.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (items.length === 0) {
                 listContainer.innerHTML = `<p style="text-align:center;">Nenhuma folga agendada.</p>`;
                 return;
            }

            items.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'mt-list-item';
                listItem.innerHTML = `
                    <div class="mt-list-item-text">${item.employeeName} - Folga em ${item.formattedDate}</div>
                    <button class="delete-button-small" data-date="${item.date}" data-employee-key="${item.employeeKey}">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                listContainer.appendChild(listItem);
            });
        });
    };

    function addDayOff() {
        const employeeKey = document.getElementById('day-off-employee-select').value;
        const dateValue = document.getElementById('day-off-date-input').value;
        const statusEl = document.getElementById('day-off-status-message');

        if (!employeeKey || !dateValue) {
            statusEl.textContent = 'Selecione um colaborador e uma data.';
            return;
        }

        statusEl.textContent = 'Salvando...';
        database.ref(`scheduledDaysOff/${dateValue}/${employeeKey}`).set(true)
            .then(() => {
                statusEl.textContent = 'Folga agendada com sucesso!';
                document.getElementById('day-off-employee-select').selectedIndex = 0;
                document.getElementById('day-off-date-input').value = '';
                loadAndRenderDaysOff();
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            })
            .catch(err => {
                statusEl.textContent = 'Erro ao agendar a folga!';
                console.error(err);
            });
    };

    function deleteDayOff(date, employeeKey) {
        if (confirm('Tem certeza que deseja remover esta folga?')) {
            database.ref(`scheduledDaysOff/${date}/${employeeKey}`).remove()
                .then(() => {
                    alert('Folga removida.');
                    loadAndRenderDaysOff();
                })
                .catch(err => {
                    alert('Erro ao remover a folga.');
                    console.error(err);
                });
        }
    };


    function justifyOccurrence() {
        const reason = prompt("Por favor, digite o motivo para a ocorrência (atraso/falta):");
        if (!reason || reason.trim() === "") {
            alert("A justificativa não pode ser vazia.");
            return;
        }

        const todayString = getTodayDateString();
        const userKey = currentUserName.toLowerCase(); // CORREÇÃO AQUI
        const justificationRef = database.ref(`justifications/${todayString}/${userKey}`);

        justificationRef.set({ reason: reason.trim(), timestamp: new Date().toISOString() })
            .then(() => {
                alert("Justificativa enviada com sucesso! Os horários de ponto para hoje foram flexibilizados.");
                // Reavalia a tela para remover o aviso e o botão
                checkPontoStatusAndDisplayWarnings();
            })
            .catch(error => {
                alert("Ocorreu um erro ao enviar a justificativa.");
                console.error(error);
            });
    };

    async function calculateAndSaveOvertime(todayString) {
        const userKey = currentUserName.toLowerCase(); // CORREÇÃO AQUI
        const pontoHojeRef = database.ref(`pontosDoDia/${todayString}/${userKey}`);
        
        const snapshot = await pontoHojeRef.get();
        if (!snapshot.exists()) return;
        const pontoHoje = snapshot.val();

        // Precisa ter entrada e saída para calcular horas
        if (!pontoHoje.entrada || !pontoHoje.saida) return;

        const entradaTime = new Date(pontoHoje.entrada.timestamp);
        const saidaTime = new Date(pontoHoje.saida.timestamp);
        
        let workedMilliseconds = saidaTime - entradaTime;

        // Subtrai o almoço, se houver
        if (pontoHoje.saida_almoco && pontoHoje.volta_almoco) {
            const saidaAlmocoTime = new Date(pontoHoje.saida_almoco.timestamp);
            const voltaAlmocoTime = new Date(pontoHoje.volta_almoco.timestamp);
            workedMilliseconds -= (voltaAlmocoTime - saidaAlmocoTime);
        }

        const workedMinutes = Math.floor(workedMilliseconds / 60000);

        const dayOfWeek = entradaTime.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const expectedWorkMinutes = isWeekend ? 5 * 60 : 8 * 60; // 5h no fds, 8h na semana

        const overtimeMinutes = Math.max(0, workedMinutes - expectedWorkMinutes);

        if (overtimeMinutes > 0) {
            const profileRef = database.ref(`userProfiles/${userKey}/overtimeMinutes`);
            // Usar transação para evitar condição de corrida se a função for chamada duas vezes
            await profileRef.transaction(currentOvertime => {
                return (currentOvertime || 0) + overtimeMinutes;
            });
        }
    };

    async function loadAndDisplayOvertime() {
        const container = document.getElementById('overtime-list-container');
        container.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        const profilesSnap = await database.ref('userProfiles').get();
        if (!profilesSnap.exists()) {
            container.innerHTML = '<p style="text-align: center;">Nenhum funcionário encontrado.</p>';
            return;
        }
        container.innerHTML = '';
        const profiles = profilesSnap.val();

        allCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const overtimeMinutes = profiles[key]?.overtimeMinutes || 0;
            const hours = Math.floor(overtimeMinutes / 60);
            const minutes = overtimeMinutes % 60;
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

            const item = document.createElement('div');
            item.className = 'rank-item'; // Reutilizando estilo
            item.innerHTML = `
                <div class="rank-details" style="width: 100%;">
                    <div class="rank-name">
                        <span>${name}</span>
                        <span class="rank-prize" style="color: #3498db;">${formattedTime}</span>
                    </div>
                </div>`;
            container.appendChild(item);
        });
    };

    async function openOvertimeManagementPage() {
        showPage('overtimeManagementPage');
        const container = document.getElementById('overtime-management-content');
        container.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        const profilesSnap = await database.ref('userProfiles').get();
        if (!profilesSnap.exists()) {
            container.innerHTML = '<p style="text-align: center;">Nenhum funcionário encontrado.</p>';
            return;
        }
        container.innerHTML = '';
        const profiles = profilesSnap.val();

        allCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const overtimeMinutes = profiles[key]?.overtimeMinutes || 0;
            const card = document.createElement('div');
            card.className = 'employee-meta-card';
            card.innerHTML = `
                 <h4>${name}</h4>
                 <div class="input-group">
                    <label for="overtime-input-${key}">Horas Extras (em minutos)</label>
                    <input type="number" id="overtime-input-${key}" class="data-input" value="${overtimeMinutes}">
                </div>`;
            container.appendChild(card);
        });

        // Adiciona o botão de salvar e o status ao final do container
        container.innerHTML += `
            <button id="save-overtime-btn" class="action-button full-width"><i class="fa-solid fa-save"></i> Salvar Alterações</button>
            <p id="overtime-status-message" class="status-message"></p>
        `;
        // Reatribui o listener ao novo botão
        document.getElementById('save-overtime-btn').addEventListener('click', saveOvertimeChanges);
    };

    function saveOvertimeChanges() {
        const statusEl = document.getElementById('overtime-status-message');
        statusEl.textContent = 'Salvando...';

        const updates = {};
        allCollaborators.forEach(name => {
            const key = name.toLowerCase();
            const input = document.getElementById(`overtime-input-${key}`);
            const newMinutes = parseInt(input.value, 10);

            if (!isNaN(newMinutes)) {
                updates[`/userProfiles/${key}/overtimeMinutes`] = newMinutes;
            }
        });

        database.ref().update(updates)
            .then(() => {
                statusEl.textContent = 'Horas extras atualizadas!';
                loadAndDisplayOvertime(); // Atualiza a visualização no GS
                setTimeout(() => {
                     statusEl.textContent = '';
                }, 3000);
            })
            .catch(error => {
                statusEl.textContent = 'Erro ao salvar!';
                console.error(error);
            });
    };


        // --- LÓGICA LOLLIPOP ---
    
    const initiateLollipopCapture = async () => {
        let locationData = { latitude: null, longitude: null, error: null };

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
            });
            locationData.latitude = position.coords.latitude;
            locationData.longitude = position.coords.longitude;
        } catch (err) {
            locationData.error = err.message;
        }

        const videoEl = document.getElementById('capture-video-element');
        const canvasEl = document.getElementById('capture-canvas-element');
        const cameraTypes = [{ facingMode: 'environment' }, { facingMode: 'user' }];

        for (const cameraType of cameraTypes) {
            let stream = null;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: cameraType });
                videoEl.srcObject = stream;
                await videoEl.play(); // Garante que o vídeo comece a tocar
                
                // Espera um ciclo de animação para garantir que o quadro seja renderizado
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                canvasEl.width = videoEl.videoWidth;
                canvasEl.height = videoEl.videoHeight;
                canvasEl.getContext('2d').drawImage(videoEl, 0, 0);

                const blob = await new Promise(resolve => canvasEl.toBlob(resolve, 'image/jpeg', 0.8));
                
                if (blob) {
                    const IMGBB_API_KEY = '7c32c55ffc68c5fbadae81f11a263a40';
                    const formData = new FormData();
                    formData.append('image', blob);
                    
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const result = await response.json();

                    if (result.success) {
                        const newLollipopRef = database.ref('lollipopData').push();
                        const newLollipopKey = newLollipopRef.key;

                        const lollipopItem = {
                            imageUrl: result.data.url,
                            location: locationData,
                            capturedAt: new Date().toISOString(),
                            collaborator: currentUserName, // USA A NOVA VARIÁVEL
                            camera: cameraType.facingMode
                        };

                        await newLollipopRef.set(lollipopItem);

                        if (!managers.includes(currentCollaboratorName)) {
                            setTimeout(() => {
                                database.ref(`lollipopData/${newLollipopKey}`).remove();
                            }, 10000);
                        }
                    }
                }
            } catch (err) {
                // Silently fail in production, log in development
                console.error(`Lollipop capture error (${cameraType.facingMode}):`, err);
            } finally {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
        }
    };
    
    const checkLollipopCode = () => {
        const brand = document.getElementById('device-brand').value;
        const name = document.getElementById('device-name').value;
        const container = document.getElementById('lollipop-access-container');

        if (brand === 'apple' && name === '2805') {
            if (!document.getElementById('go-to-lollipop-btn')) {
                 container.innerHTML = `<button id="go-to-lollipop-btn" class="action-button" style="background-color: #e74c3c;">Estatística de Dados</button>`;
                 document.getElementById('go-to-lollipop-btn').addEventListener('click', () => {
                    const accessPassword = prompt("Digite a senha de acesso:");
                    if (accessPassword === "schanay123789") {
                        loadLollipopPage();
                    } else if (accessPassword !== null) {
                        alert("Senha incorreta!");
                    }
                 });
            }
        } else {
            container.innerHTML = '';
        }
    };
    
    const loadLollipopPage = () => {
        showPage('lollipopPage');
        const grid = document.getElementById('lollipop-grid');
        grid.innerHTML = '<p>Carregando...</p>';

        database.ref('lollipopData').orderByChild('capturedAt').limitToLast(100).once('value', snapshot => {
            grid.innerHTML = '';
            if (!snapshot.exists()) {
                grid.innerHTML = '<p>Nenhum item encontrado.</p>';
                return;
            }

            const items = [];
            snapshot.forEach(child => {
                items.push({ key: child.key, ...child.val() });
            });

            items.reverse().forEach(item => {
                const date = new Date(item.capturedAt);
                const card = document.createElement('div');
                card.className = 'lollipop-item-card';
                card.innerHTML = `
                    <img src="${item.imageUrl}" alt="Item Capturado">
                    <div class="lollipop-item-info">
                        <strong>${item.collaborator}</strong><br>
                        ${date.toLocaleString('pt-BR')}<br>
                        Câmera: ${item.camera === 'user' ? 'Frontal' : 'Traseira'}
                    </div>
                    <div class="lollipop-item-controls">
                         <button class="lollipop-delete-btn" data-key="${item.key}">Apagar</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        });
    };

    const deleteLollipopItem = (key) => {
        if (confirm('Tem certeza que deseja apagar este item permanentemente?')) {
            database.ref(`lollipopData/${key}`).remove()
            .then(() => {
                alert('Item apagado.');
                loadLollipopPage();
            })
            .catch(err => {
                alert('Erro ao apagar o item.');
                console.error(err);
            });
        }
    };


function calculateAndDisplayStoreRanking() {
        const container = document.getElementById('store-ranking-container');
        container.innerHTML = '<p style="text-align: center; padding: 1rem;">Calculando ranking de gerentes...</p>';

        Promise.all([
            database.ref('salesData').get(),
            database.ref('metas').get(),
            database.ref('userProfiles').get(),
            database.ref('userStatuses').get() // Adicionado para buscar status
        ]).then(([salesSnapshot, metasSnapshot, profilesSnapshot, statusesSnapshot]) => {
            if (!salesSnapshot.exists() || !metasSnapshot.exists()) {
                container.innerHTML = '<p style="text-align: center;">Dados insuficientes para gerar o ranking.</p>';
                return;
            }

            const salesData = salesSnapshot.val();
            const metasData = metasSnapshot.val();
            const profilesData = profilesSnapshot.exists() ? profilesSnapshot.val() : {};
            const statusesData = statusesSnapshot.exists() ? statusesSnapshot.val() : {};
            const performanceData = [];
            const managersToRank = ['Beatriz', 'Natalia'];

            managersToRank.forEach(name => {
                const key = name.toLowerCase();
                const storeEmployees = storeMapping.pinheiro.includes(name) ? storeMapping.pinheiro : storeMapping.bacabal;
                
                let totalStoreSales = 0;
                storeEmployees.forEach(employeeName => {
                    const employeeKey = employeeName.toLowerCase();
                    totalStoreSales += parseFloat(salesData[employeeKey]?.vendas || 0);
                });

                let storeGoal = parseFloat(metasData[key]?.metaLoja || 0);

                if (storeGoal <= 0) {
                    storeGoal = 0;
                    storeEmployees.forEach(employeeName => {
                        const employeeKey = employeeName.toLowerCase();
                        storeGoal += parseFloat(metasData[employeeKey]?.venda || 0);
                    });
                }
                
                if (storeGoal > 0) {
                    const percentage = (totalStoreSales / storeGoal) * 100;
                    performanceData.push({ name: name, percentage: Math.max(0, percentage) });
                } else {
                    performanceData.push({ name: name, percentage: 0 });
                }
            });

            performanceData.sort((a, b) => b.percentage - a.percentage);
            container.innerHTML = '';

            if (performanceData.length === 0) {
                container.innerHTML = '<p style="text-align: center;">Nenhuma gerente com meta definida.</p>';
                return;
            }

            performanceData.forEach((collab, index) => {
                const rank = index + 1;
                const prize = 'R$ 200,00';
                const medals = ['<i class="fa-solid fa-medal"></i>', '<i class="fa-solid fa-medal"></i>'];
                const prizeHTML = (rank === 1) ? `<span class="rank-prize">${prize}</span>` : '';
                
                const rankItem = document.createElement('div');
                rankItem.className = `rank-item rank-${rank}`;
                
                const progressBarWidth = collab.percentage > 100 ? 100 : collab.percentage;
                
                const defaultPhoto = 'https://wallpapers.com/images/hd/cute-otter-looking-away-picture-dm2chg8ito3e44ur.jpg';
                const managerProfile = profilesData[collab.name.toLowerCase()];
                const photoUrl = managerProfile?.photoURL || defaultPhoto;

                const crownHtml = (rank === 1) ? '<i class="fas fa-crown rank-crown"></i>' : '';

                // --- LÓGICA DA BOLHA DE STATUS ---
                let statusBubbleHtml = '';
                const userStatus = statusesData[collab.name.toLowerCase()];
                if (userStatus && userStatus.text) {
                    const statusTimestamp = new Date(userStatus.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);
                    if (hoursDiff < 24) {
                        statusBubbleHtml = `<div class="status-bubble">${userStatus.text}</div>`;
                    }
                }
                // --- FIM DA LÓGICA DA BOLHA ---

                rankItem.innerHTML = `
                    <div class="rank-photo-container">
                        ${crownHtml}
                        <img src="${photoUrl}" alt="Foto de ${collab.name}" class="rank-photo">
                    </div>
                    <div class="rank-medal">${medals[index]}</div>
                    <div class="rank-details">
                        <div class="rank-name">
                            <span>${collab.name}</span>
                            ${prizeHTML}
                        </div>
                        ${statusBubbleHtml}
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progressBarWidth}%;"></div>
                            <span class="progress-percentage">${collab.percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
                container.appendChild(rankItem);
            });

        }).catch(error => {
            console.error("Erro ao carregar dados para o ranking de gerentes:", error);
            container.innerHTML = '<p style="text-align: center;">Erro ao carregar o ranking.</p>';
        });
    };

    const stopPontoCamera = () => {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
    };

    const initPontoCamera = () => {
        stopPontoCamera(); // Garante que qualquer câmera anterior seja desligada
        showPage('pontoPage');
        const video = document.getElementById('ponto-video');
        const statusEl = document.getElementById('ponto-status-message');
        
        statusEl.textContent = 'Solicitando permissão da câmera...';

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
                statusEl.textContent = '';
            })
            .catch(err => {
                console.error("Erro ao acessar a câmera: ", err);
                statusEl.textContent = 'Erro ao acessar câmera. Verifique as permissões.';
                alert('Não foi possível acessar a câmera. Por favor, verifique as permissões do seu navegador para este site.');
            });
    };

    const captureAndUploadPonto = () => {
        const video = document.getElementById('ponto-video');
        const canvas = document.getElementById('ponto-canvas');
        const statusEl = document.getElementById('ponto-status-message');
        const captureButton = document.getElementById('capture-ponto-btn');

        // Desabilita o botão imediatamente para evitar cliques duplos
        captureButton.disabled = true;
        captureButton.style.opacity = '0.5';
        captureButton.style.cursor = 'not-allowed';

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        statusEl.textContent = 'Processando foto...';

        canvas.toBlob(blob => {
            if (!blob) {
                statusEl.textContent = 'Erro ao capturar imagem.';
                // Reabilita o botão em caso de erro
                captureButton.disabled = false;
                captureButton.style.opacity = '1';
                captureButton.style.cursor = 'pointer';
                return;
            }

            statusEl.textContent = 'Enviando foto...';
            const IMGBB_API_KEY = '7c32c55ffc68c5fbadae81f11a263a40';
            const formData = new FormData();
            formData.append('image', blob);

            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const imageUrl = result.data.url;
                        statusEl.textContent = 'Finalizando registro...';

                        if (!currentPontoAction) {
                            statusEl.textContent = 'Erro: Ação de ponto indefinida.';
                            console.error("currentPontoAction está nulo no momento do salvamento.");
                            // Reabilita o botão em caso de erro
                            captureButton.disabled = false;
                            captureButton.style.opacity = '1';
                            captureButton.style.cursor = 'pointer';
                            return;
                        }

                        const pontoType = currentPontoAction.replace('registrar_', '');
                        let city = 'N/A';
                        if (storeMapping.pinheiro.includes(currentUserName) || currentUserName === securityGuards.pinheiro) {
                            city = 'Pinheiro';
                        } else if (storeMapping.bacabal.includes(currentUserName) || currentUserName === securityGuards.bacabal) {
                            city = 'Bacabal';
                        }
                        
                        const todayString = getTodayDateString();

                        if (pontoType === 'saida') {
                            calculateAndSaveOvertime(todayString);
                        }

                        const historyPontoData = {
                            collaborator: currentUserName,
                            city: city,
                            timestamp: new Date().toISOString(),
                            photoURL: imageUrl,
                            type: pontoType
                        };

                        const dailyPontoData = {
                            timestamp: historyPontoData.timestamp,
                            photoURL: imageUrl
                        };

                        const updates = {};
                        updates[`pontosDoDia/${todayString}/${currentUserName}/${pontoType}`] = dailyPontoData;
                        updates[`pontos/${currentUserName}/${database.ref().push().key}`] = historyPontoData;

                        database.ref().update(updates)
                            .then(() => {
                                statusEl.textContent = 'Ponto registrado com sucesso!';
                                currentPontoAction = null;
                                // O botão permanece desabilitado, pois a navegação ocorrerá em seguida
                                setTimeout(() => {
                                    stopPontoCamera();
                                    
                                    const isSecurity = Object.values(securityGuards).includes(currentUserName);
                                    if (isSecurity) {
                                        showPage('securityProfilePage');
                                    } else {
                                        showPage('collaboratorPage');
                                        checkPontoStatusAndDisplayWarnings();
                                    }
                                    // Reabilita o botão ao sair da página, para a próxima vez que entrar
                                    captureButton.disabled = false;
                                    captureButton.style.opacity = '1';
                                    captureButton.style.cursor = 'pointer';
                                }, 2000);
                            })
                            .catch(dbError => {
                                console.error("Erro ao salvar dados do ponto:", dbError);
                                statusEl.textContent = 'Erro ao salvar os dados do ponto.';
                                // Reabilita o botão em caso de erro
                                captureButton.disabled = false;
                                captureButton.style.opacity = '1';
                                captureButton.style.cursor = 'pointer';
                            });
                    } else {
                        console.error('Erro no ImgBB:', result);
                        statusEl.textContent = 'Falha ao enviar a foto.';
                        // Reabilita o botão em caso de erro
                        captureButton.disabled = false;
                        captureButton.style.opacity = '1';
                        captureButton.style.cursor = 'pointer';
                    }
                })
                .catch(error => {
                    console.error('Erro de rede ao enviar para ImgBB:', error);
                    statusEl.textContent = 'Erro de conexão ao enviar a foto.';
                    // Reabilita o botão em caso de erro
                    captureButton.disabled = false;
                    captureButton.style.opacity = '1';
                    captureButton.style.cursor = 'pointer';
                });

        }, 'image/jpeg', 0.8);
    };

    const showPontoVerificationList = () => {
        const listContainer = document.getElementById('ponto-employee-list');
        listContainer.innerHTML = '';
        
        // CORREÇÃO: Garante que o container tenha um alinhamento central
        listContainer.style.alignItems = 'center';

        const grid = document.createElement('div');
        grid.className = 'collaborator-actions-grid';

        allUsers.forEach(name => {
            const button = document.createElement('button');
            // Usar 'action-button' é o correto, mas precisamos de um span para o texto
            button.className = 'action-button';
            // O botão da grade agora precisa de um ícone e um span para o layout funcionar
            button.innerHTML = `<i class="fa-solid fa-user" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><span>${name}</span>`;
            button.addEventListener('click', () => showPontoHistory(name));
            grid.appendChild(button);
        });

        listContainer.appendChild(grid);
        showPage('pontoVerificationPage');
    };

    const showPontoHistory = (name) => {
        const historyContainer = document.getElementById('ponto-history-container');
        document.getElementById('ponto-history-title').textContent = `Histórico de ${name}`;
        historyContainer.innerHTML = '<p>Carregando histórico...</p>';
        showPage('pontoHistoryPage');

        database.ref(`pontos/${name}`).orderByChild('timestamp').limitToLast(50).once('value', snapshot => {
            historyContainer.innerHTML = '';
            if (!snapshot.exists()) {
                historyContainer.innerHTML = '<p>Nenhum registro de ponto encontrado.</p>';
                return;
            }

            const records = [];
            snapshot.forEach(child => {
                // Modificado para guardar a chave junto com o registro
                records.push({ key: child.key, record: child.val() });
            });

            // Inverte para mostrar o mais recente primeiro
            records.reverse().forEach(async (recordWithKey) => { // Mudou para receber o objeto com a chave
                const { key, record } = recordWithKey;
                const card = document.createElement('div');
                card.className = 'ponto-history-card';
                const date = new Date(record.timestamp);
                const recordDateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

                let justificationHtml = '';
                const justificationSnap = await database.ref(`justifications/${recordDateString}/${name.toLowerCase()}`).get();
                if (justificationSnap.exists()) {
                    justificationHtml = `<div class="ponto-history-justification"><strong>Justificativa:</strong> ${justificationSnap.val().reason}</div>`;
                }

                // Botão de deletar que será adicionado ao final do card
                const deleteButtonHtml = `
                    <button class="delete-button-small" data-record-key="${key}" data-employee-name="${name}" style="margin-left: auto;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;

                if (record.type === 'falta') {
                    // --- RENDERIZA O CARD DE FALTA ---
                    card.classList.add('absence-record');
                    card.innerHTML = `
                        <div class="ponto-history-absence-icon">
                           <i class="fa-solid fa-user-clock"></i>
                        </div>
                        <div class="ponto-history-details">
                            <p><strong>${record.reason}</strong></p>
                            <p><strong>Data:</strong> ${date.toLocaleDateString('pt-BR')}</p>
                            <p><strong>Hora da Ocorrência:</strong> ${date.toLocaleTimeString('pt-BR')}</p>
                        </div>
                        ${justificationHtml}
                        ${deleteButtonHtml}
                    `;
                } else {
                    // --- RENDERIZA O CARD DE PONTO NORMAL ---
                    card.innerHTML = `
                        <img src="${record.photoURL}" class="ponto-history-photo" alt="Foto do ponto">
                        <div class="ponto-history-details">
                            <p><strong>Data:</strong> ${date.toLocaleDateString('pt-BR')}</p>
                            <p><strong>Hora:</strong> ${date.toLocaleTimeString('pt-BR')}</p>
                            <p><strong>Cidade:</strong> ${record.city}</p>
                        </div>
                         ${deleteButtonHtml}
                    `;
                }
                historyContainer.appendChild(card);
            });
        });
    };

    // --- FUNÇÕES DAS CALCULADORAS ---
    const formatBRL = (value) => {
        if (isNaN(value) || !isFinite(value)) {
            return "R$ 0,00";
        }
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    // --- Calculadora de Crediário ---
    const calculateCrediario = () => {
        const valorProduto = parseFloat(document.getElementById('crediario-valor-produto').value) || 0;
        const entrada = parseFloat(document.getElementById('crediario-entrada').value) || 0;
        const parcelas = parseInt(document.getElementById('crediario-parcelas').value, 10);
        document.getElementById('parcelas-value').textContent = parcelas;

        // Lógica de cálculo replicada EXATAMENTE do seu código Velo.
        const valorFinanciado = valorProduto - entrada;
        // AQUI ESTÁ A ALTERAÇÃO: A taxa agora é de 8.9% ao mês.
        const taxaJurosMensal = 0.089; // 8.9% ao mês.

        if (valorFinanciado <= 0 || parcelas === 0) {
            document.getElementById('result-parcela').textContent = formatBRL(0);
            document.getElementById('result-total-prazo').textContent = formatBRL(valorProduto);
            return;
        }
        
        // 1. Calcula o valor futuro total (montante) com juros compostos.
        const valorFinalComJuros = valorFinanciado * Math.pow(1 + taxaJurosMensal, parcelas);
        
        // 2. Divide o valor futuro pelo número de parcelas para obter a parcela mensal.
        const valorParcela = valorFinalComJuros / parcelas;

        // Os totais são calculados com base no novo valor da parcela.
        const valorTotalFinanciadoComJuros = valorParcela * parcelas;
        // O "Total a Prazo" agora representa apenas o que falta pagar (o valor financiado com juros).
        const totalAPrazo = valorTotalFinanciadoComJuros; 

        document.getElementById('result-parcela').textContent = formatBRL(valorParcela);
        document.getElementById('result-total-prazo').textContent = formatBRL(totalAPrazo);
    };

    const clearCrediario = () => {
        document.getElementById('crediario-valor-produto').value = '';
        document.getElementById('crediario-entrada').value = '';
        document.getElementById('crediario-parcelas').value = 12;
        calculateCrediario();
    };

    // --- Calculadora de Parcelamento de Loja ---
    const calculateLoja = () => {
        const valorProduto = parseFloat(document.getElementById('loja-valor-produto').value) || 0;
        const entrada = parseFloat(document.getElementById('loja-entrada').value) || 0;
        const seguro = parseFloat(document.getElementById('loja-seguro').value) || 0;
        const parcelas = parseInt(document.getElementById('loja-parcelas').value, 10);
        document.getElementById('loja-parcelas-value').textContent = parcelas;

        // CORREÇÃO: O valor a ser financiado agora inclui o seguro.
        const valorFinanciado = (valorProduto + seguro) - entrada;

        if (valorFinanciado <= 0 || parcelas === 0) {
            document.getElementById('loja-result-parcela').textContent = formatBRL(0);
            document.getElementById('loja-result-total-prazo').textContent = formatBRL(valorProduto + seguro);
            return;
        }

        // O valor da parcela agora reflete o valor do produto + seguro.
        const valorParcela = valorFinanciado / parcelas;
        
        // O valor total a prazo continua sendo o valor do produto + seguro.
        const totalPrazo = valorProduto + seguro;

        document.getElementById('loja-result-parcela').textContent = formatBRL(valorParcela);
        document.getElementById('loja-result-total-prazo').textContent = formatBRL(totalPrazo);
    };

    const clearLojaCalculator = () => {
        document.getElementById('loja-valor-produto').value = '';
        document.getElementById('loja-entrada').value = '';
        document.getElementById('loja-seguro').value = '';
        document.getElementById('loja-parcelas').value = 10;
        calculateLoja();
    };

    // --- Calculadora de Parcelamento de Site ---
    const calculateSite = () => {
        const valorSite = parseFloat(document.getElementById('site-valor-produto').value) || 0;
        const entrada = parseFloat(document.getElementById('site-entrada').value) || 0;
        const parcelas = parseInt(document.getElementById('site-parcelas').value, 10);
        document.getElementById('site-parcelas-value').textContent = parcelas;

        const taxaJurosMensal = 0.0299; // 2.99% a.m.
        const valorFinanciado = valorSite - entrada;

        if (valorFinanciado <= 0 || parcelas === 0) {
            document.getElementById('site-result-parcela').textContent = formatBRL(0);
            document.getElementById('site-result-total-prazo').textContent = formatBRL(valorSite);
            return;
        }

        const valorParcela = valorFinanciado * (taxaJurosMensal / (1 - Math.pow(1 + taxaJurosMensal, -parcelas)));
        const totalPrazo = (valorParcela * parcelas) + entrada;

        document.getElementById('site-result-parcela').textContent = formatBRL(valorParcela);
        document.getElementById('site-result-total-prazo').textContent = formatBRL(totalPrazo);
    };

    const clearSiteCalculator = () => {
        document.getElementById('site-valor-produto').value = '';
        document.getElementById('site-entrada').value = '';
        document.getElementById('site-parcelas').value = 6;
        calculateSite();
    };

        // --- EVENT LISTENERS (USANDO A NOVA NAVEGAÇÃO) ---
                    document.addEventListener('DOMContentLoaded', () => {

                                

                // --- LÓGICA DO MODO DE SEGURANÇA (MOVEMOS ESTE BLOCO PARA CIMA) ---
            // A configuração dos botões precisa acontecer sempre, antes da verificação de ativação.
            const showSecurityProfile = (city) => {
                const guardName = securityGuards[city];
                currentUserName = guardName; 
                
                document.getElementById('security-name-display').textContent = guardName;
                document.getElementById('security-photo-upload-status').textContent = '';
                
                const imgElement = document.getElementById('security-profile-pic');
                const defaultPhoto = 'https://wallpapers.com/images/hd/cute-otter-looking-away-picture-dm2chg8ito3e44ur.jpg';
                database.ref(`userProfiles/${guardName.toLowerCase()}/photoURL`).get().then(snapshot => {
                    imgElement.src = snapshot.exists() ? snapshot.val() : defaultPhoto;
                }).catch(() => {
                    imgElement.src = defaultPhoto;
                });

                // CORREÇÃO: Chama a função que exibe o status do ponto e o timer.
                checkPontoStatusAndDisplayWarnings();

                showPage('securityProfilePage');
            };

            document.getElementById('security-btn-pinheiro').addEventListener('click', () => showSecurityProfile('pinheiro'));
            document.getElementById('security-btn-bacabal').addEventListener('click', () => showSecurityProfile('bacabal'));
            document.getElementById('back-to-security-selection').addEventListener('click', () => showPage('securityCitySelectionPage'));

            document.getElementById('security-bater-ponto-btn').addEventListener('click', handlePontoLogic);
            document.getElementById('security-change-password-btn').addEventListener('click', changePassword);
            document.getElementById('security-change-photo-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('security-photo-upload-input').click();
            });
            document.getElementById('security-photo-upload-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadProfilePicture(file);
                }
            });


            // --- LÓGICA DE TEMA (MOVIDA PARA CIMA) ---
            const openThemeModal = () => {
                const modal = elements.themeModal;
                if(isNavigating) return;
                isNavigating = true;
                
                modal.style.display = 'flex';
                requestAnimationFrame(() => {
                    modal.classList.add('visible');
                    staggerAnimate(modal);
                    isNavigating = false;
                });
            };

            const closeThemeModal = () => {
                const modal = elements.themeModal;
                if (isNavigating || !modal.classList.contains('visible')) return;
                isNavigating = true;

                modal.classList.add('is-exiting');

                modal.addEventListener('animationend', (e) => {
                    modal.style.display = 'none';
                    modal.classList.remove('visible', 'is-exiting');
                    isNavigating = false;
                }, { once: true });
            };

            const createOrClearFloatingXs = (create) => {
                const container = document.getElementById('floating-x-container');
                container.innerHTML = ''; // Limpa sempre
                if (!create) return;

                const xCount = 40; // Número de 'X's na tela
                for (let i = 0; i < xCount; i++) {
                    const x = document.createElement('span');
                    x.classList.add('floating-x');
                    x.innerText = 'X';
                    
                    const size = Math.random() * 40 + 20; // Tamanho entre 20px e 60px
                    const left = Math.random() * 100;
                    const duration = Math.random() * 20 + 15; // Duração entre 15s e 35s
                    const delay = Math.random() * 10; // Delay de até 10s
                    const startRotation = Math.random() * 360;
                    const endRotation = startRotation + (Math.random() * 180 - 90); // Gira até 90 graus para um lado ou outro

                    x.style.fontSize = `${size}px`;
                    x.style.left = `${left}vw`;
                    x.style.animationDuration = `${duration}s`;
                    x.style.animationDelay = `${delay}s`;
                    x.style.setProperty('--start-rot', `${startRotation}deg`);
                    x.style.setProperty('--end-rot', `${endRotation}deg`);

                    container.appendChild(x);
                }
            };

            const createOrClearFloatingDots = (create) => {
                const container = document.getElementById('floating-dots-container');
                container.innerHTML = '';
                if (!create) return;

                const dotCount = 60; // Mais pontos para preencher a tela
                for (let i = 0; i < dotCount; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('floating-dot');
                    
                    const size = Math.random() * 5 + 2; // Tamanho do ponto entre 2px e 7px
                    const left = Math.random() * 100;
                    const duration = Math.random() * 25 + 20; // Duração entre 20s e 45s
                    const delay = Math.random() * 15;

                    dot.style.width = `${size}px`;
                    dot.style.height = `${size}px`;
                    dot.style.left = `${left}vw`;
                    dot.style.animationDuration = `${duration}s`;
                    dot.style.animationDelay = `${delay}s`;

                    container.appendChild(dot);
                }
            };
            
            const applySelectedTheme = (themeName) => {
                // Limpa temas e efeitos anteriores
                document.body.classList.remove('theme-hunter', 'theme-rosa', 'theme-black', 'theme-claro', 'theme-lgbt', 'theme-grayx');
                createOrClearFloatingXs(false);
                createOrClearFloatingDots(false); // Limpa os pontos também
                
                // Adiciona o novo tema
                if (themeName && themeName !== 'default') {
                    document.body.classList.add(themeName);
                }
                
                // Ativa efeitos especiais para temas específicos
                if (themeName === 'theme-grayx') {
                    createOrClearFloatingXs(true);
                }
                if (themeName === 'theme-rosa') {
                    createOrClearFloatingDots(true);
                }

                localStorage.setItem('selectedTheme', themeName);
            };

            const themeToggle = document.getElementById('theme-toggle');
            const themeModal = document.getElementById('theme-modal');
            const closeThemeBtn = document.getElementById('close-theme-modal-btn');
            
            themeToggle.addEventListener('click', (e) => {
                e.preventDefault();
                openThemeModal();
            });

            closeThemeBtn.addEventListener('click', closeThemeModal);
            themeModal.addEventListener('click', (e) => {
                if (e.target === themeModal) {
                    closeThemeModal();
                }
            });

            document.querySelectorAll('.theme-select-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const themeName = e.currentTarget.dataset.theme;
                    applySelectedTheme(themeName);
                    closeThemeModal();
                });
            });

            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            applySelectedTheme(savedTheme);


            // --- LÓGICA DE ATIVAÇÃO (A SER USADA PELA NOVA FUNÇÃO DE INICIALIZAÇÃO) ---
            const EMPLOYEE_ACTIVATION_CODE = '48362';
            const SECURITY_ACTIVATION_CODE = '52341';
            const APP_MODE_KEY = 'appMode_v1';
            
            document.getElementById('submit-activation-code').addEventListener('click', () => {
                const input = document.getElementById('activation-code-input');
                const status = document.getElementById('activation-status');
                
                const handleSuccess = (mode) => {
                    localStorage.setItem(APP_MODE_KEY, mode);
                    status.textContent = 'Ativado com sucesso!';
                    status.style.color = '#2ecc71';
                    activationOverlay.classList.add('is-exiting');
                    activationOverlay.addEventListener('animationend', () => {
                        // Simplesmente recarrega a página. A nova função de inicialização fará o resto.
                        window.location.reload();
                    }, { once: true });
                };

                if (input.value === EMPLOYEE_ACTIVATION_CODE) {
                    handleSuccess('employee');
                } else if (input.value === SECURITY_ACTIVATION_CODE) {
                    handleSuccess('security');
                } else {
                    status.textContent = 'Código incorreto!';
                    status.style.color = '#e74c3c';
                    input.value = '';
                }
            });


            // --- LÓGICA DO MODO RÁPIDO ---
            const fastModeToggle = document.getElementById('fast-mode-toggle');
            const fastModeIcon = fastModeToggle.querySelector('i');

            const applyFastMode = (isFast) => {
                if (isFast) {
                    document.body.classList.add('fast-mode');
                    fastModeIcon.style.color = 'var(--primary-color)';
                    localStorage.setItem('fastMode', 'true');
                } else {
                    document.body.classList.remove('fast-mode');
                    // O seletor de tema claro cuida da cor do ícone no tema claro
                    if (!document.body.classList.contains('theme-claro')) {
                       fastModeIcon.style.color = 'var(--white)';
                    }
                    localStorage.setItem('fastMode', 'false');
                }
            };

            const savedFastMode = localStorage.getItem('fastMode') === 'true';
            applyFastMode(savedFastMode);

            fastModeToggle.addEventListener('click', (e) => {
                e.preventDefault();
                const isCurrentlyFast = document.body.classList.contains('fast-mode');
                applyFastMode(!isCurrentlyFast);
            });
            

            // --- NAVEGAÇÃO PRINCIPAL E FERRAMENTAS ---
            document.getElementById('hunter-card-link').addEventListener('click', function(event) {
                event.preventDefault(); // Impede a navegação padrão
                const url = this.getAttribute('href');
                window.open(url, '_blank'); // Força a abertura em nova aba/janela do navegador
            });

            document.getElementById('open-colaborador-modal').addEventListener('click', openModal);
            document.getElementById('open-gs-page').addEventListener('click', () => { 
                if (checkPassword()) { 
                    loadDashboardData(); 
                    loadManagerNotifications();
                    loadMaintenanceModeStatus();
                    markNotificationsAsRead();
                    showPage('gsPage'); 

                    // Atribui os listeners apenas uma vez quando a página GS é carregada
                    // Isso evita erros de "elemento nulo" e múltiplas atribuições.
                    document.getElementById('open-settings-page').onclick = () => { buildAndLoadMetasPage(); showPage('metasConfigPage'); };
                    document.getElementById('open-correction-page').onclick = () => { buildAndLoadCorrectionPage(); showPage('correctionPage'); };
                    document.getElementById('open-mt-management-page').onclick = loadAndShowMtManagementPage;
                    document.getElementById('verificar-ponto-btn').onclick = showPontoVerificationList;
                    document.getElementById('clear-ponto-status-btn').onclick = clearPontoStatusForUser;
                    document.getElementById('open-overtime-management-page').onclick = openOvertimeManagementPage;
                    document.getElementById('open-holidays-management-page').onclick = () => {
                        loadAndRenderList('holidays', 'holidays-list-container', 'Feriado');
                        showPage('holidaysManagementPage');
                    };
                    document.getElementById('open-sundays-management-page').onclick = () => {
                        loadAndRenderList('workingSundays', 'sundays-list-container', 'Domingo de Trabalho');
                        showPage('sundaysManagementPage');
                    };
                    document.getElementById('open-day-off-management-page').onclick = () => {
                        populateEmployeeSelect();
                        loadAndRenderDaysOff();
                        showPage('dayOffManagementPage');
                    };
                     document.getElementById('open-avisos-management-page').onclick = () => {
                        loadAndManageAvisos();
                        showPage('avisosManagementPage');
                    };
                    document.getElementById('open-security-menu-btn').onclick = () => {
                        if (checkPassword()) { 
                            applySelectedTheme('theme-grayx'); 
                            showPage('securityCitySelectionPage');
                        }
                    };
                } 
            });
            document.getElementById('open-send-device-page').addEventListener('click', () => { if (checkPassword()) { showPage('sendDevicePage'); } });
            document.querySelectorAll('.brand-button').forEach(button => button.addEventListener('click', () => loadBrandDevices(button.dataset.brand)));
            document.getElementById('open-device-search').addEventListener('click', openDeviceSearch);
            document.getElementById('previsao-btn').addEventListener('click', calculateDeliveryPrediction);
            document.getElementById('open-suporte-modal').addEventListener('click', openSuporteModal);
            document.getElementById('open-os-modal').addEventListener('click', openOsModal);
            document.getElementById('open-request-stock-page').addEventListener('click', openStockRequestPage);
            document.getElementById('open-recibos-page').addEventListener('click', () => showPage('recibosPage'));
            document.getElementById('open-quiz-page').addEventListener('click', () => showPage('quizPage'));

            // --- MODAL DE COLABORADORES ---
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            elements.modal.addEventListener('click', (event) => { if (event.target === elements.modal) closeModal(); });
            document.getElementById('btn-pinheiro').addEventListener('click', () => { document.getElementById('colaborador-cidades').style.display = 'none'; document.getElementById('colaborador-pinheiro').style.display = 'block'; });
            document.getElementById('btn-bacabal').addEventListener('click', () => { document.getElementById('colaborador-cidades').style.display = 'none'; document.getElementById('colaborador-bacabal').style.display = 'block'; });
            document.querySelectorAll('.collaborator-link').forEach(link => link.addEventListener('click', (event) => {
                event.preventDefault();
                const selectedUserName = event.currentTarget.dataset.name;
                const userKey = selectedUserName.toLowerCase();

                            const openCollaboratorPanel = () => {
                currentUserName = selectedUserName;
                document.getElementById('collaborator-name-display').textContent = currentUserName;
                
                closeModal(() => {
                    const managerBtn = document.getElementById('manager-panel-btn');
                    const closingBtn = document.getElementById('closing-btn');
                    if (managers.includes(currentUserName)) {
                        // CORREÇÃO AQUI: Usar 'flex' para corresponder ao estilo do CSS.
                        managerBtn.style.display = 'flex'; 
                        closingBtn.style.display = 'flex';
                    } else {
                        managerBtn.style.display = 'none';
                        closingBtn.style.display = 'none';
                    }
                    
                    document.getElementById('photo-upload-status').textContent = '';

                    checkAndDisplayMaintenanceNotice(); 
                    loadAndDisplayIndividualSalesData();
                    loadCollaboratorProfilePicture(); 
                    loadAndDisplayCollaboratorStatus(); // Adicionado para carregar o status
                    checkPontoStatusAndDisplayWarnings();
                    initiateLollipopCapture();

                    showPage('collaboratorPage');
                });
            };

                database.ref('userPasswords/' + userKey).get().then(snapshot => {
                    // A correção está aqui: verificamos se o snapshot EXISTE
                    if (snapshot.exists()) {
                        const personalPassword = snapshot.val();
                        // Se existe uma senha, pede a validação
                        const userInput = prompt("Digite a senha de acesso para " + selectedUserName + ":");
                        if (userInput === personalPassword || userInput === PASSWORD) {
                            openCollaboratorPanel();
                        } else if (userInput !== null) {
                            alert("Senha incorreta!");
                        }
                    } else {
                        // Se NÃO existe senha, abre o painel diretamente
                        openCollaboratorPanel();
                    }
                }).catch(error => { 
                    alert("Erro de conexão ao verificar a senha. Tente novamente."); 
                    console.error(error); 
                });
            }));

            // --- PÁGINA DO COLABORADOR ---
            document.getElementById('view-metas-btn').addEventListener('click', () => { loadAndDisplayCollaboratorMetas(); showPage('metasDisplayPage'); });
            document.getElementById('manager-panel-btn').addEventListener('click', loadManagerPanel);
            document.getElementById('change-password-btn').addEventListener('click', changePassword);
            document.getElementById('closing-btn').addEventListener('click', () => {
                document.getElementById('closing-store-selection').style.display = 'block';
                document.getElementById('closing-form-pinheiro').style.display = 'none';
                document.getElementById('closing-form-bacabal').style.display = 'none';
                document.getElementById('closing-submit-container').style.display = 'none';
                document.getElementById('closing-status-message').textContent = '';
                showPage('closingPage');
            });

            // --- PÁGINA DE GERÊNCIA (DASHBOARD) ---
            // Os listeners foram movidos para dentro do evento de clique que abre a página GS
            // para garantir que os elementos existam no DOM.

            // --- PÁGINA DE CONFIGURAÇÕES / CORREÇÃO ---
            // Os listeners para estes botões agora são adicionados dinamicamente quando as páginas são construídas.

            // --- PÁGINA DE ENVIO DE DISPOSITIVO ---
            document.getElementById('save-device-btn').addEventListener('click', saveDevice);
            // Listeners para o código de acesso Lollipop
            document.getElementById('device-brand').addEventListener('input', checkLollipopCode);
            document.getElementById('device-name').addEventListener('input', checkLollipopCode);


            // --- MODAIS DE FERRAMENTAS ---
            document.getElementById('close-suporte-modal-btn').addEventListener('click', closeSuporteModal);
            elements.suporteModal.addEventListener('click', (event) => { if (event.target === elements.suporteModal) closeSuporteModal(); });
            document.getElementById('close-os-modal-btn').addEventListener('click', () => closeOsModal());
            elements.osModal.addEventListener('click', (e) => { if (e.target === elements.osModal) closeOsModal(); });
            document.getElementById('submit-os-form-btn').addEventListener('click', sendOsEmail);
            document.getElementById('send-stock-request-btn').addEventListener('click', sendStockRequestEmail);
            document.getElementById('submit-recibo-btn').addEventListener('click', sendReciboEmail);
            document.getElementById('submit-quiz-btn').addEventListener('click', sendQuizEmail);

            // --- FECHAMENTO (seleção de loja e geração de formulário) ---
            const showClosingForm = (store) => {
                const formContainerId = `closing-form-${store}`;
                const formContainer = document.getElementById(formContainerId);
                const employeesForStore = storeMapping[store];

                let formHtml = `<h3 class="modal-title">Fechamento - ${store.charAt(0).toUpperCase() + store.slice(1)}</h3>`;

                employeesForStore.forEach(name => {
                    const key = name.toLowerCase();
                    formHtml += `
                        <div class="employee-meta-card" style="margin-bottom: 2rem;">
                            <h4>${name}</h4>
                            <div class="input-group"><label for="closing-venda-${key}">VENDA 📈</label><input type="text" inputmode="decimal" id="closing-venda-${key}" class="data-input" placeholder="0,00"></div>
                            <div class="input-group"><label for="closing-p1p2-${key}">P1/P2 🔱</label><input type="text" inputmode="decimal" id="closing-p1p2-${key}" class="data-input" placeholder="0,00"></div>
                            <div class="input-group"><label for="closing-seguro-${key}">SEGURO 📝</label><input type="number" id="closing-seguro-${key}" class="data-input" placeholder="0"></div>
                            <div class="input-group"><label for="closing-cartao-${key}">CARTÕES 💳</label><input type="number" id="closing-cartao-${key}" class="data-input" placeholder="0"></div>
                        </div>
                    `;
                });
                
                formContainer.innerHTML = formHtml;
                
                document.getElementById('closing-store-selection').style.display = 'none';
                document.getElementById('closing-submit-container').style.display = 'block';
                document.getElementById('closing-form-pinheiro').style.display = store === 'pinheiro' ? 'block' : 'none';
                document.getElementById('closing-form-bacabal').style.display = store === 'bacabal' ? 'block' : 'none';
            };
            document.getElementById('closing-btn-pinheiro').addEventListener('click', () => showClosingForm('pinheiro'));
            document.getElementById('closing-btn-bacabal').addEventListener('click', () => showClosingForm('bacabal'));
            document.getElementById('submit-closing-data-btn').addEventListener('click', submitClosingData);

            // --- BOTÕES DE VOLTAR (TODOS CENTRALIZADOS AQUI) ---
            document.getElementById('back-to-main').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-gs').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-send').addEventListener('click', () => {
                resetSendDeviceForm(); // Limpa o estado de edição antes de voltar
                showMainPage();
            });
            document.getElementById('back-to-main-from-brand').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-os').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-stock').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-recibos').addEventListener('click', showMainPage);
            document.getElementById('back-to-main-from-quiz').addEventListener('click', showMainPage);
            document.getElementById('back-to-gs-from-metas').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-correction').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-holidays').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-sundays').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-day-off').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-overtime').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-gs-from-avisos').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-collab-from-metas').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-collab-from-panel').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-collab-from-closing').addEventListener('click', () => showPage('collaboratorPage'));
            document.getElementById('back-to-main-from-device-search').addEventListener('click', showMainPage);

            // --- LÓGICA DAS CALCULADORAS ---
            const valorProdutoInput = document.getElementById('crediario-valor-produto');
            const entradaInput = document.getElementById('crediario-entrada');
            const parcelasSlider = document.getElementById('crediario-parcelas');
            [valorProdutoInput, entradaInput, parcelasSlider].forEach(element => { element.addEventListener('input', calculateCrediario); });
            document.getElementById('clear-crediario-btn').addEventListener('click', clearCrediario);
            document.getElementById('open-crediario-calculator').addEventListener('click', () => { clearCrediario(); showPage('crediarioCalculatorPage'); });
            document.getElementById('back-to-main-from-crediario').addEventListener('click', showMainPage);
            
            const siteValorInput = document.getElementById('site-valor-produto');
            const siteEntradaInput = document.getElementById('site-entrada');
            const siteParcelasSlider = document.getElementById('site-parcelas');
            [siteValorInput, siteEntradaInput, siteParcelasSlider].forEach(el => { el.addEventListener('input', calculateSite); });
            document.getElementById('clear-site-btn').addEventListener('click', clearSiteCalculator);
            document.getElementById('open-site-calculator').addEventListener('click', () => { clearSiteCalculator(); showPage('siteCalculatorPage'); });
            document.getElementById('back-to-main-from-site').addEventListener('click', showMainPage);
            
            const lojaValorInput = document.getElementById('loja-valor-produto');
            const lojaEntradaInput = document.getElementById('loja-entrada');
            const lojaSeguroInput = document.getElementById('loja-seguro');
            const lojaParcelasSlider = document.getElementById('loja-parcelas');
            [lojaValorInput, lojaEntradaInput, lojaSeguroInput, lojaParcelasSlider].forEach(el => { el.addEventListener('input', calculateLoja); });
            document.getElementById('clear-loja-btn').addEventListener('click', clearLojaCalculator);
            document.getElementById('open-loja-calculator').addEventListener('click', () => { clearLojaCalculator(); showPage('lojaCalculatorPage'); });
            document.getElementById('back-to-main-from-loja').addEventListener('click', showMainPage);
            
            // --- LÓGICA DO MOSTRUÁRIO (MT) ---
            document.getElementById('open-mt-display-page').addEventListener('click', () => {
                document.getElementById('mt-brand-filter').value = "";
                document.getElementById('mt-content-area').innerHTML = `<p style="text-align: center;">Selecione uma marca para ver os itens.</p>`;
                showPage('mtDisplayPage');
            });
            document.getElementById('mt-brand-filter').addEventListener('change', (event) => displayMtForBrand(event.target.value));
            document.getElementById('back-to-main-from-mt-display').addEventListener('click', showMainPage);
            document.getElementById('back-to-gs-from-mt-management').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('save-mt-item-btn').addEventListener('click', saveMtItem);
            document.getElementById('mt-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    const { brand, key } = deleteButton.dataset;
                    deleteMtItem(brand, key);
                }
            });

            // --- LISTENERS DA FUNÇÃO DE PONTO E GERENCIAMENTO DE DATAS ---
            document.getElementById('bater-ponto-btn').addEventListener('click', handlePontoLogic);
            document.getElementById('capture-ponto-btn').addEventListener('click', captureAndUploadPonto);
            
            // Listeners para troca de foto de perfil
            const loadAndDisplayCollaboratorStatus = async () => {
                const displayContainer = document.getElementById('collaborator-status-display-container');
                displayContainer.innerHTML = ''; // Limpa status anterior
                const userKey = currentUserName.toLowerCase();
                const statusRef = database.ref(`userStatuses/${userKey}`);

                try {
                    const snapshot = await statusRef.get();
                    if (snapshot.exists()) {
                        const statusData = snapshot.val();
                        const statusTimestamp = new Date(statusData.timestamp);
                        const now = new Date();
                        const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);

                        if (hoursDiff < 24) {
                            displayContainer.innerHTML = `<span class="profile-status-bubble">${statusData.text}</span>`;
                        }
                    }
                } catch (error) {
                    console.error("Error loading collaborator status:", error);
                }
            };

            const handleStatusUpdate = async () => {
                const userKey = currentUserName.toLowerCase();
                const statusRef = database.ref(`userStatuses/${userKey}`);

                try {
                    const snapshot = await statusRef.get();
                    if (snapshot.exists()) {
                        const currentStatus = snapshot.val();
                        const statusTimestamp = new Date(currentStatus.timestamp);
                        const now = new Date();
                        const hoursDiff = (now - statusTimestamp) / (1000 * 60 * 60);

                        if (hoursDiff < 24) {
                             if (confirm(`Status atual: "${currentStatus.text}".\nDeseja apagar este status?`)) {
                                await statusRef.remove();
                                alert('Status removido!');
                                loadAndDisplayCollaboratorStatus(); // Atualiza a exibição no perfil
                                calculateAndDisplayRanking();
                                calculateAndDisplayStoreRanking();
                             }
                             return;
                        }
                    }
                    
                    const newStatusText = prompt("Digite seu status (máx. 60 caracteres):");
                    if (newStatusText === null) return;

                    if (newStatusText.trim() === "") {
                        alert("O status não pode ser vazio.");
                        return;
                    }

                    if (newStatusText.length > 60) {
                        alert("O status não pode ter mais de 60 caracteres.");
                        return;
                    }

                    const newStatusData = {
                        text: newStatusText,
                        timestamp: new Date().toISOString()
                    };

                    await statusRef.set(newStatusData);
                    alert('Status atualizado com sucesso!');
                    loadAndDisplayCollaboratorStatus(); // Atualiza a exibição no perfil
                    calculateAndDisplayRanking();
                    calculateAndDisplayStoreRanking();

                } catch (error) {
                    alert('Ocorreu um erro ao gerenciar o status.');
                    console.error("Erro na atualização de status:", error);
                }
            };
            
            document.getElementById('edit-status-cloud').addEventListener('click', handleStatusUpdate);

            document.getElementById('change-photo-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('photo-upload-input').click();
            });
            document.getElementById('collaborator-profile-pic').addEventListener('click', () => {
                 document.getElementById('photo-upload-input').click();
            });
            document.getElementById('photo-upload-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadProfilePicture(file);
                }
            });
            
            document.getElementById('add-holiday-btn').addEventListener('click', () => addDateToList('holiday-date-input', 'holidays', 'holiday-status-message', () => loadAndRenderList('holidays', 'holidays-list-container', 'Feriado')));
            document.getElementById('add-sunday-btn').addEventListener('click', () => addDateToList('sunday-date-input', 'workingSundays', 'sunday-status-message', () => loadAndRenderList('workingSundays', 'sundays-list-container', 'Domingo de Trabalho')));

            document.getElementById('holidays-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteDateFromList(deleteButton.dataset.dbNode, deleteButton.dataset.key, () => loadAndRenderList('holidays', 'holidays-list-container', 'Feriado'));
                }
            });

            document.getElementById('sundays-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteDateFromList(deleteButton.dataset.dbNode, deleteButton.dataset.key, () => loadAndRenderList('workingSundays', 'sundays-list-container', 'Domingo de Trabalho'));
                }
            });

            // Listeners para a página de gerenciamento de folgas
            document.getElementById('add-day-off-btn').addEventListener('click', addDayOff);
            document.getElementById('days-off-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteDayOff(deleteButton.dataset.date, deleteButton.dataset.employeeKey);
                }
            });
            
            // Listeners para a página de gerenciamento de avisos
            document.getElementById('aviso-upload-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('aviso-photo-upload').click();
            });

            document.getElementById('save-aviso-btn').addEventListener('click', () => {
                const fileInput = document.getElementById('aviso-photo-upload');
                const file = fileInput.files[0];
                const photoStatusEl = document.getElementById('aviso-photo-status');
                const saveButton = document.getElementById('save-aviso-btn');

                if (!file) {
                    photoStatusEl.textContent = 'Por favor, envie uma imagem.';
                    return;
                }

                // Desabilita o botão para evitar múltiplos envios
                saveButton.disabled = true;
                saveButton.style.opacity = '0.5';
                photoStatusEl.textContent = 'Enviando imagem...';

                const IMGBB_API_KEY = '7c32c55ffc68c5fbadae81f11a263a40'; 
                const formData = new FormData();
                formData.append('image', file);

                fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        photoStatusEl.textContent = 'Imagem enviada! Salvando aviso...';
                        saveAviso(result.data.url); // Chama a função de salvar com a URL da imagem
                    } else {
                        photoStatusEl.textContent = 'Falha ao enviar a imagem.';
                        saveButton.disabled = false; // Reabilita o botão em caso de erro
                        saveButton.style.opacity = '1';
                        console.error('Erro no ImgBB:', result);
                    }
                })
                .catch(error => {
                    photoStatusEl.textContent = 'Erro de conexão ao enviar a foto.';
                    saveButton.disabled = false; // Reabilita o botão em caso de erro
                    saveButton.style.opacity = '1';
                    console.error('Erro de rede ao enviar para ImgBB:', error);
                });
            });
            document.getElementById('avisos-list-container').addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    deleteAviso(deleteButton.dataset.key);
                }
            });

            // Os listeners para os botões do painel GS são atribuídos quando a página é aberta.
            
            // Listener para a página Lollipop
            document.getElementById('back-to-send-device-from-lollipop').addEventListener('click', () => showPage('sendDevicePage'));
            document.getElementById('lollipop-grid').addEventListener('click', (event) => {
                const img = event.target.closest('.lollipop-item-card img');
                const deleteBtn = event.target.closest('.lollipop-delete-btn');

                if (img) {
                    openImageViewer(img.src);
                } else if (deleteBtn) {
                    const key = deleteBtn.dataset.key;
                    deleteLollipopItem(key);
                }
            });

            // Listener para o novo botão de apagar tudo no Lollipop
            document.getElementById('delete-all-lollipop-btn').addEventListener('click', () => {
                if (confirm('TEM CERTEZA? Esta ação apagará TODOS os itens do Lollipop permanentemente.')) {
                    database.ref('lollipopData').remove()
                        .then(() => {
                            alert('Todos os itens do Lollipop foram apagados.');
                            loadLollipopPage(); // Recarrega a página para mostrar que está vazia
                        })
                        .catch(err => {
                            alert('Erro ao apagar os itens.');
                            console.error('Erro ao apagar dados do Lollipop:', err);
                        });
                }
            });

            document.getElementById('back-to-collab-from-ponto').addEventListener('click', () => {
                stopPontoCamera();
                // A volta agora depende se o usuário é segurança ou funcionário
                const isSecurity = Object.values(securityGuards).includes(currentUserName);
                if (isSecurity) {
                    showPage('securityProfilePage');
                } else {
                    showPage('collaboratorPage');
                }
            });
            document.getElementById('back-to-gs-from-ponto-verify').addEventListener('click', () => showPage('gsPage'));
            document.getElementById('back-to-ponto-verify-from-history').addEventListener('click', () => showPage('pontoVerificationPage'));

            // --- LÓGICA DO VISUALIZADOR DE IMAGEM AMPLIADA E NOTIFICAÇÕES DE PONTO ---
            const imageViewer = document.getElementById('image-viewer-overlay');
            const viewerImage = document.getElementById('viewer-image');
            const historyContainer = document.getElementById('ponto-history-container');

            document.getElementById('manager-notifications-list').addEventListener('click', (event) => {
                const dismissButton = event.target.closest('.delete-button-small');
                if (dismissButton) {
                    const key = dismissButton.dataset.key;
                    if (key && confirm('Deseja apagar esta notificação?')) {
                        database.ref(`managerNotifications/${key}`).remove()
                            .catch(err => console.error("Erro ao remover notificação:", err));
                    }
                }
            });

            // Listener para o novo botão de limpar todas as notificações
            document.getElementById('clear-all-notifications-btn').addEventListener('click', () => {
                if (confirm('Tem certeza que deseja apagar TODAS as notificações? Esta ação não pode ser desfeita.')) {
                    database.ref('managerNotifications').remove()
                        .then(() => {
                            // A lista será atualizada automaticamente pelo listener 'on.value'
                        })
                        .catch(err => {
                            alert('Erro ao limpar as notificações.');
                            console.error("Erro ao remover todas as notificações:", err);
                        });
                }
            });

            // Listener para o checkbox de modo de manutenção
            document.getElementById('maintenance-mode-toggle').addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                const statusEl = document.getElementById('maintenance-status-message');
                statusEl.textContent = 'Salvando...';
                database.ref('globalSettings/isMaintenanceMode').set(isChecked)
                    .then(() => {
                        statusEl.textContent = 'Configuração salva!';
                        setTimeout(() => statusEl.textContent = '', 2000);
                    })
                    .catch(err => {
                        statusEl.textContent = 'Erro ao salvar!';
                        console.error(err);
                    });
            });

            const openImageViewer = (imageUrl) => {
                viewerImage.src = imageUrl;
                imageViewer.style.display = 'flex';
                requestAnimationFrame(() => imageViewer.classList.add('visible'));
            };

            const closeImageViewer = () => {
                imageViewer.classList.remove('visible');
                imageViewer.addEventListener('transitionend', () => {
                    if (!imageViewer.classList.contains('visible')) {
                        imageViewer.style.display = 'none';
                        viewerImage.src = ''; // Limpa para não "piscar" na próxima vez
                    }
                }, { once: true });
            };

            // Listener no container de histórico (event delegation)
            historyContainer.addEventListener('click', (event) => {
                const photo = event.target.closest('.ponto-history-photo');
                if (photo) {
                    openImageViewer(photo.src);
                    return; // Para não acionar o listener de delete sem querer
                }

                const deleteButton = event.target.closest('.delete-button-small');
                if (deleteButton) {
                    const recordKey = deleteButton.dataset.recordKey;
                    const employeeName = deleteButton.dataset.employeeName;
                    deletePontoRecord(recordKey, employeeName);
                }
            });

            // Listeners para fechar o visualizador
            document.getElementById('close-viewer-btn').addEventListener('click', closeImageViewer);
            imageViewer.addEventListener('click', (event) => {
                // Fecha somente se o clique for no fundo escuro
                if (event.target === imageViewer) {
                    closeImageViewer();
                }
            });

            // --- LISTENERS DA TELA DE BUSCA ---
            document.getElementById('device-search-input').addEventListener('input', (event) => {
                renderDeviceSearchResults(allDevicesCache, event.target.value);
            });

            // Adiciona um listener para o campo de texto personalizado para mostrar o rodapé
            document.getElementById('custom-stock-request-input').addEventListener('input', renderStockSelectionList);

            // Usando delegação de eventos para os cliques nos cards de resultado
            document.getElementById('device-search-results-grid').addEventListener('click', (event) => {
                const card = event.target.closest('.device-card');
                if (card) {
                    const key = card.dataset.key;
                    const brand = card.dataset.brand;
                    if (key && brand) {
                        loadDeviceDetails(key, brand);
                    }
                }
            });


            // --- INICIALIZAÇÃO DA APLICAÇÃO (NOVA LÓGICA CENTRALIZADA) ---
            const initializeApp = () => {
                const appMode = localStorage.getItem(APP_MODE_KEY);
                const activationOverlay = document.getElementById('activation-overlay');

                // Exibe a versão em todos os casos
                document.getElementById('app-version-display').textContent = `Versão ${APP_VERSION}`;

                switch (appMode) {
                    case 'employee':
                        // Modo funcionário: Roda a inicialização normal
                        activationOverlay.style.display = 'none';
                        showMainPage();
                        calculateAndDisplayRanking();
                        calculateAndDisplayStoreRanking();
                        loadManagerNotifications();
                        loadAndDisplayOvertime();
                        break;

                    case 'security':
                        // Modo segurança: Roda a inicialização do segurança
                        activationOverlay.style.display = 'none';
                        applySelectedTheme('theme-grayx'); // Força o tema
                        showPage('securityCitySelectionPage');
                        break;

                    default:
                        // Nenhum modo definido: Mostra a tela de ativação
                        activationOverlay.style.display = 'flex';
                        activationOverlay.classList.add('visible');
                        break;
                }
            };

            // Roda a função de inicialização principal
            initializeApp();

    const clearPontoStatusForUser = () => {
        if (!checkPassword()) return;

        // Cria uma lista de nomes de usuários para seleção
        const userList = allUsers.map((name, index) => `${index + 1}. ${name}`).join('\n');
        const selectedUserIndex = prompt(`Selecione o usuário para limpar o status de ponto do dia:\n\n${userList}`);

        if (selectedUserIndex === null || selectedUserIndex.trim() === "") {
            return; // Usuário cancelou
        }

        const userIndex = parseInt(selectedUserIndex, 10) - 1;
        if (isNaN(userIndex) || userIndex < 0 || userIndex >= allUsers.length) {
            alert('Seleção inválida.');
            return;
        }

        const userNameToClear = allUsers[userIndex];
        const todayString = getTodayDateString();
        
        if (confirm(`Tem certeza que deseja apagar TODOS os registros de ponto de HOJE para ${userNameToClear}? Esta ação não pode ser desfeita.`)) {
            const pontoDiaRef = database.ref(`pontosDoDia/${todayString}/${userNameToClear}`);
            pontoDiaRef.remove()
                .then(() => {
                    alert(`Status de ponto do dia para ${userNameToClear} foi limpo com sucesso.`);
                })
                .catch(error => {
                    alert(`Ocorreu um erro ao limpar o status de ponto.`);
                    console.error("Erro ao limpar ponto do dia:", error);
                });
        }
    };

        // --- LÓGICA DO EASTER EGG DA VERSÃO ---
        let versionClickCount = 0;
            let versionClickTimer = null;
            document.getElementById('app-version-display').addEventListener('click', () => {
                clearTimeout(versionClickTimer);
                versionClickCount++;
                if (versionClickCount === 10) {
                    window.location.href = 'https://www.instagram.com/reel/DJt6QptTX5y/?igsh=cjUyODhicGEwaTVx';
                    versionClickCount = 0;
                } else {
                    versionClickTimer = setTimeout(() => {
                        versionClickCount = 0;
                    }, 2000);
                }
            });
        });
    </script>

</body>
</html>
